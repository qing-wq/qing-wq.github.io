<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>Go GC VS Java GC</title>
    <url>/2023/11/03/Go-GC-Vs-Java-GC/</url>
    <content><![CDATA[<p>ä¹‹å‰é¢è¯•çš„æ—¶å€™è¢«é¢è¯•å®˜é—®åˆ°è¿‡è¿™ä¸ªé—®é¢˜ï¼Œä½†æ˜¯å½“æ—¶å¯¹Goçš„GCä¸€ç‚¹ä¹Ÿä¸äº†è§£ã€‚äºæ˜¯åæ¥æ•´ç†äº†ä¸€ä¸‹ï¼Œå‘ç°Goçš„GCç®—æ³•çœŸæœ‰æ„æ€ã€‚æœ¬æ–‡å¯¹æ¯”äº†Javaå’ŒGoåœ¨GCç®—æ³•ä¸Šçš„çš„åŒºåˆ«ï¼š</p>
<h1 id="Java-GC"><a href="#Java-GC" class="headerlink" title="Java GC"></a>Java GC</h1><p>Javaçš„GCä½¿ç”¨<strong>åˆ†ä»£å›æ”¶ç®—æ³•</strong>ï¼Œå°†å †å†…å­˜åˆ’åˆ†ä¸ºæ–°ç”Ÿä»£å’Œè€å¹´ä»£ï¼Œä¸€èˆ¬æƒ…å†µä¸‹åœ¨<strong>æ–°ç”Ÿä»£ä½¿ç”¨æ ‡è®°-å¤åˆ¶ç®—æ³•ï¼Œè€å¹´ä»£ä½¿ç”¨æ ‡è®°-æ¸…é™¤æˆ–æ ‡è®°-æ•´ç†ç®—æ³•</strong></p>
<p>åˆ†ä»£GCä¾èµ–åˆ†ä»£å‡è®¾ï¼Œå³GCå°†ä¸»è¦çš„å›æ”¶ç›®æ ‡æ”¾åœ¨æ–°åˆ›å»ºçš„å¯¹è±¡ä¸Šï¼ˆå­˜æ´»æ—¶é—´çŸ­ï¼Œæ›´å€¾å‘äºè¢«å›æ”¶ï¼‰ï¼Œè€Œéé¢‘ç¹æ£€æŸ¥æ‰€æœ‰å¯¹è±¡ã€‚</p>
<p>åœ¨Javaä¸­ï¼Œä¸åŒçš„åƒåœ¾å›æ”¶å™¨ä½¿ç”¨çš„åƒåœ¾å›æ”¶ç®—æ³•ä¸åŒï¼š</p>
<ul>
<li>JDK 8ï¼šParallel Scavenge</li>
<li>JDK 9 ~ JDK20: G1</li>
</ul>
<span id="more"></span>

<p><strong>ç‰¹ç‚¹ï¼š</strong></p>
<ul>
<li>éƒ½ä¼šé€ æˆSTWï¼Œè¿™æ˜¯å½±å“æ€§èƒ½æœ€ä¸»è¦çš„å› ç´ </li>
<li>éƒ¨åˆ†ç®—æ³•è¿˜ä¼šäº§ç”Ÿå¤§é‡ç©ºé—´ç¢ç‰‡</li>
</ul>
<p>ä»‹ç»ä¸€ä¸‹Javaä¸­æ¯”è¾ƒç»å…¸çš„åƒåœ¾å›æ”¶å™¨ï¼š</p>
<h3 id="CMS"><a href="#CMS" class="headerlink" title="CMS"></a>CMS</h3><p><strong>ä»¥è·å–æœ€çŸ­å›æ”¶åœé¡¿æ—¶é—´ä¸ºç›®æ ‡</strong>ï¼Œä½¿ç”¨äº†<strong>æ ‡è®°-æ¸…é™¤</strong> ç®—æ³•ï¼Œ<strong>ç¬¬ä¸€æ¬¡å®ç°äº†è®©åƒåœ¾æ”¶é›†çº¿ç¨‹ä¸ç”¨æˆ·çº¿ç¨‹ï¼ˆåŸºæœ¬ä¸Šï¼‰åŒæ—¶å·¥ä½œ</strong></p>
<ul>
<li>ä¸»è¦ä¼˜ç‚¹ï¼š<strong>å¹¶å‘æ”¶é›†ã€ä½åœé¡¿</strong></li>
<li>ç¼ºç‚¹ï¼š<strong>å¯¹ CPU èµ„æºæ•æ„Ÿ</strong>ï¼Œ<strong>ä¼šäº§ç”Ÿå¤§é‡ç©ºé—´ç¢ç‰‡</strong></li>
</ul>
<h3 id="G1"><a href="#G1" class="headerlink" title="G1"></a>G1</h3><p>G1 æ”¶é›†å™¨åœ¨åå°ç»´æŠ¤äº†ä¸€ä¸ª<strong>ä¼˜å…ˆåˆ—è¡¨</strong>ï¼Œæ¯æ¬¡æ ¹æ®å…è®¸çš„æ”¶é›†æ—¶é—´ï¼Œä¼˜å…ˆé€‰æ‹©å›æ”¶ä»·å€¼æœ€å¤§çš„ Region(è¿™ä¹Ÿå°±æ˜¯å®ƒçš„åå­— <strong>Garbage-First</strong> çš„ç”±æ¥) ã€‚è¿™ç§ä½¿ç”¨ Region åˆ’åˆ†å†…å­˜ç©ºé—´ä»¥åŠæœ‰ä¼˜å…ˆçº§çš„åŒºåŸŸå›æ”¶æ–¹å¼ï¼Œä¿è¯äº† G1 æ”¶é›†å™¨åœ¨æœ‰é™æ—¶é—´å†…å¯ä»¥å°½å¯èƒ½é«˜çš„æ”¶é›†æ•ˆç‡ï¼‰ã€‚</p>
<p>G1ä½¿ç”¨<strong>æ ‡è®°-æ•´ç†</strong>ç®—æ³•</p>
<h1 id="Go-GC"><a href="#Go-GC" class="headerlink" title="Go GC"></a>Go GC</h1><p>Golangçš„åƒåœ¾å›æ”¶ç®—æ³•ä½¿ç”¨çš„æ˜¯<em><strong>æ— åˆ†ä»£ã€ä¸æ•´ç†ã€å¹¶å‘</strong>çš„</em><em>ä¸‰è‰²æ ‡è®°æ¸…æ‰«ç®—æ³•</em>**ã€‚åŸå› åœ¨äºï¼š</p>
<ul>
<li>Go è¿è¡Œæ—¶çš„åˆ†é…ç®—æ³•åŸºäº<code>tcmalloc</code>ï¼Œ<strong>åŸºæœ¬ä¸Šæ²¡æœ‰ç¢ç‰‡é—®é¢˜</strong>ï¼Œå¯¹å¯¹è±¡è¿›è¡Œæ•´ç†ä¸ä¼šå¸¦æ¥å®è´¨æ€§çš„æ€§èƒ½æå‡ã€‚</li>
<li>Go çš„ç¼–è¯‘å™¨ä¼šé€šè¿‡<strong>é€ƒé€¸åˆ†æ</strong>å°†å¤§éƒ¨åˆ†æ–°ç”Ÿå¯¹è±¡å­˜å‚¨åœ¨æ ˆä¸Šï¼Œåªæœ‰é‚£äº›éœ€è¦é•¿æœŸå­˜åœ¨çš„å¯¹è±¡æ‰ä¼šè¢«åˆ†é…åˆ°éœ€è¦è¿›è¡Œåƒåœ¾å›æ”¶çš„å †ä¸­ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œåˆ†ä»£<code>GC</code>å›æ”¶çš„é‚£äº›å­˜æ´»æ—¶é—´çŸ­çš„å¯¹è±¡åœ¨ Go ä¸­æ˜¯ç›´æ¥è¢«åˆ†é…åˆ°æ ˆä¸Šï¼Œå½“<code>goroutine</code>æ­»äº¡åæ ˆä¹Ÿä¼šè¢«ç›´æ¥å›æ”¶ï¼Œä¸éœ€è¦<code>GC</code>çš„å‚ä¸ï¼Œè¿›è€Œåˆ†ä»£å‡è®¾å¹¶æ²¡æœ‰å¸¦æ¥ç›´æ¥ä¼˜åŠ¿ã€‚</li>
<li>å¼•å…¥äº†<strong>æ··åˆå±éšœæœºåˆ¶</strong>ï¼Œèƒ½å¤Ÿè®©Go çš„åƒåœ¾å›æ”¶å™¨éƒ¨åˆ†é˜¶æ®µä¸ç”¨æˆ·ä»£ç å¹¶å‘æ‰§è¡Œï¼Œå¤§å¤§ç¼©çŸ­äº†STWçš„æ—¶é—´</li>
</ul>
]]></content>
      <categories>
        <category>Java VS Go</category>
      </categories>
  </entry>
  <entry>
    <title>GraphQLå…¥é—¨</title>
    <url>/2024/04/13/GraphQL%E5%85%A5%E9%97%A8/</url>
    <content><![CDATA[<blockquote>
<p>æœ€è¿‘å·¥ä½œä¸­ç”¨åˆ°äº†è¿™ä¸ªæŠ€æœ¯ã€ŒGraphQLã€ï¼Œæœ¬æ–‡è®°å½•ä¸€ä¸‹å…¥é—¨å­¦ä¹ è¿‡ç¨‹</p>
</blockquote>
<h2 id="1-åŸºç¡€æ¦‚å¿µ"><a href="#1-åŸºç¡€æ¦‚å¿µ" class="headerlink" title="1 åŸºç¡€æ¦‚å¿µ"></a>1 åŸºç¡€æ¦‚å¿µ</h2><h3 id="1-1-æ“ä½œç±»å‹-Operation-Type"><a href="#1-1-æ“ä½œç±»å‹-Operation-Type" class="headerlink" title="1.1 æ“ä½œç±»å‹ Operation Type"></a>1.1 æ“ä½œç±»å‹ Operation Type</h3><ol>
<li><code>query</code>ï¼šæŸ¥è¯¢æ•°æ®ï¼Œç›¸å½“äºCRUD ä¸­çš„ R</li>
<li><code>mutation</code>ï¼šå˜æ›´ï¼Œå¯¹æ•°æ®è¿›è¡Œå˜æ›´ï¼Œæ¯”å¦‚å¢åŠ ã€åˆ é™¤ã€ä¿®æ”¹ï¼ŒCRUD ä¸­çš„ CUD</li>
<li><code>substription</code>ï¼šè®¢é˜…ï¼Œå½“æ•°æ®å‘ç”Ÿæ›´æ”¹ï¼Œè¿›è¡Œæ¶ˆæ¯æ¨é€</li>
</ol>
<h3 id="1-2-å¯¹è±¡ç±»å‹å’Œæ ‡é‡ç±»å‹-Object-Type-Scalar-Type"><a href="#1-2-å¯¹è±¡ç±»å‹å’Œæ ‡é‡ç±»å‹-Object-Type-Scalar-Type" class="headerlink" title="1.2 å¯¹è±¡ç±»å‹å’Œæ ‡é‡ç±»å‹ Object Type &amp; Scalar Type"></a>1.2 å¯¹è±¡ç±»å‹å’Œæ ‡é‡ç±»å‹ Object Type &amp; Scalar Type</h3><ol>
<li><strong>å¯¹è±¡ç±»å‹</strong>ï¼šç”¨æˆ·åœ¨ schema ä¸­å®šä¹‰çš„ <code>type</code></li>
<li><strong>æ ‡é‡ç±»å‹</strong>ï¼šGraphQL ä¸­å†…ç½®æœ‰ä¸€äº›æ ‡é‡ç±»å‹ <code>String</code>ã€<code>Int</code>ã€<code>Float</code>ã€<code>Boolean</code>ã€<code>ID</code>ï¼Œç”¨æˆ·ä¹Ÿå¯ä»¥å®šä¹‰è‡ªå·±çš„æ ‡é‡ç±»å‹</li>
</ol>
<span id="more"></span>

<p>ä¾‹å¦‚ï¼š</p>
<figure class="highlight graphql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> MetaData <span class="punctuation">{</span></span><br><span class="line">    <span class="symbol">fileName</span><span class="punctuation">:</span> String<span class="punctuation">!</span></span><br><span class="line">    <span class="symbol">fileId</span><span class="punctuation">:</span> ID</span><br><span class="line"><span class="punctuation">}</span></span><br></pre></td></tr></tbody></table></figure>

<p>å…¶ä¸­<code>MetaData</code>æ˜¯å¯¹è±¡ç±»å‹ï¼Œ<code>String</code>ã€<code>ID</code>ç­‰åˆ™æ˜¯æ ‡é‡ç±»å‹ï¼Œ<code>!</code>è¡¨ç¤ºéç©ºæ ‡é‡</p>
<p>å¦‚æœä¸€ä¸ª GraphQL æœåŠ¡æ¥å—åˆ°äº†ä¸€ä¸ª <code>query</code>ï¼Œé‚£ä¹ˆè¿™ä¸ª <code>query</code> å°†ä» <code>Root Query</code> å¼€å§‹æŸ¥æ‰¾ï¼Œæ‰¾åˆ°å¯¹è±¡ç±»å‹æ—¶åˆ™ä½¿ç”¨å®ƒçš„è§£æå‡½æ•° Resolver æ¥è·å–å†…å®¹ï¼Œå¦‚æœè¿”å›çš„æ˜¯å¯¹è±¡ç±»å‹åˆ™ç»§ç»­ä½¿ç”¨è§£æå‡½æ•°è·å–å†…å®¹ï¼Œå¦‚æœè¿”å›çš„æ˜¯æ ‡é‡ç±»å‹åˆ™ç»“æŸè·å–ï¼Œç›´åˆ°æ‰¾åˆ°æœ€åä¸€ä¸ªæ ‡é‡ç±»å‹ã€‚</p>
<h3 id="1-3-æ¨¡å¼-Schema"><a href="#1-3-æ¨¡å¼-Schema" class="headerlink" title="1.3 æ¨¡å¼ Schema"></a>1.3 æ¨¡å¼ Schema</h3><p>Schemaå®šä¹‰äº†å­—æ®µçš„ç±»å‹ã€æ•°æ®çš„ç»“æ„ï¼Œæè¿°äº†æ¥å£æ•°æ®è¯·æ±‚çš„è§„åˆ™ï¼ŒSchema ä½¿ç”¨ä¸€ä¸ªç®€å•çš„å¼ºç±»å‹æ¨¡å¼è¯­æ³•ï¼Œç§°ä¸ºæ¨¡å¼æè¿°è¯­è¨€ï¼ˆSchema Definition Language, <em><strong>SDL</strong></em>ï¼‰</p>
<p>å¦‚ä¸‹æ˜¯ä¸€ä¸ªSchemaçš„demoï¼š</p>
<figure class="highlight graphql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> <span class="keyword">Query</span> <span class="punctuation">{</span></span><br><span class="line">    metaData<span class="punctuation">(</span><span class="symbol">fileId</span><span class="punctuation">:</span> ID<span class="punctuation">)</span><span class="punctuation">:</span> MetaData</span><br><span class="line"><span class="punctuation">}</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> <span class="keyword">Mutation</span> <span class="punctuation">{</span></span><br><span class="line">    createMetaData<span class="punctuation">(</span><span class="symbol">fileId</span><span class="punctuation">:</span> ID, <span class="symbol">fileName</span><span class="punctuation">:</span> String, <span class="symbol">fileType</span><span class="punctuation">:</span> String<span class="punctuation">)</span><span class="punctuation">:</span> MetaData</span><br><span class="line"><span class="punctuation">}</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> MetaData <span class="punctuation">{</span></span><br><span class="line">    <span class="symbol">fileName</span><span class="punctuation">:</span> String<span class="punctuation">!</span></span><br><span class="line">    <span class="symbol">fileType</span><span class="punctuation">:</span> String</span><br><span class="line"><span class="punctuation">}</span></span><br></pre></td></tr></tbody></table></figure>

<p>Schema æ–‡ä»¶ä» Queryã€Mutationã€Subscription å…¥å£å¼€å§‹å®šä¹‰äº†å„ä¸ªå¯¹è±¡ç±»å‹æˆ–æ ‡é‡ç±»å‹ï¼Œè¿™äº›å­—æ®µçš„ç±»å‹ä¹Ÿå¯èƒ½æ˜¯å…¶ä»–çš„å¯¹è±¡ç±»å‹æˆ–æ ‡é‡ç±»å‹ï¼Œç»„æˆä¸€ä¸ª<strong>æ ‘å½¢ç»“æ„</strong>ï¼Œè€Œç”¨æˆ·åœ¨å‘æœåŠ¡ç«¯å‘é€è¯·æ±‚çš„æ—¶å€™ï¼Œæ²¿ç€è¿™ä¸ªæ ‘é€‰æ‹©ä¸€ä¸ªæˆ–å¤šä¸ªåˆ†æ”¯å°±å¯ä»¥è·å–å¤šç»„ä¿¡æ¯ã€‚</p>
<p>æ³¨æ„ï¼šåœ¨ Query æŸ¥è¯¢å­—æ®µæ—¶ï¼Œæ˜¯å¹¶è¡Œæ‰§è¡Œçš„ï¼Œè€Œåœ¨ Mutation å˜æ›´çš„æ—¶å€™ï¼Œæ˜¯çº¿æ€§æ‰§è¡Œï¼Œä¸€ä¸ªæ¥ç€ä¸€ä¸ªï¼Œé˜²æ­¢åŒæ—¶å˜æ›´å¸¦æ¥çš„ç«æ€é—®é¢˜ï¼Œæ¯”å¦‚è¯´æˆ‘ä»¬åœ¨ä¸€ä¸ªè¯·æ±‚ä¸­å‘é€äº†ä¸¤ä¸ª Mutationï¼Œé‚£ä¹ˆå‰ä¸€ä¸ªå°†å§‹ç»ˆåœ¨åä¸€ä¸ªä¹‹å‰æ‰§è¡Œã€‚</p>
<h3 id="1-4-è§£æå‡½æ•°-Resolver"><a href="#1-4-è§£æå‡½æ•°-Resolver" class="headerlink" title="1.4 è§£æå‡½æ•° Resolver"></a>1.4 è§£æå‡½æ•° Resolver</h3><p>å‰ç«¯è¯·æ±‚ä¿¡æ¯åˆ°è¾¾åç«¯ä¹‹åï¼Œéœ€è¦ç”±è§£æå‡½æ•° Resolver æ¥æä¾›æ•°æ®ï¼š</p>
<figure class="highlight graphql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">query</span> <span class="punctuation">{</span></span><br><span class="line">  hello</span><br><span class="line"><span class="punctuation">}</span></span><br></pre></td></tr></tbody></table></figure>

<p>å¯¹åº”çš„åŒåçš„è§£æå‡½æ•°åº”è¯¥æ˜¯è¿™æ ·çš„ï¼š</p>
<figure class="highlight graphql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="symbol">Query</span><span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">  hello <span class="punctuation">(</span>parent, args, context, info<span class="punctuation">)</span> <span class="punctuation">{</span></span><br><span class="line">    return <span class="punctuation">...</span></span><br><span class="line">  <span class="punctuation">}</span></span><br><span class="line"><span class="punctuation">}</span></span><br></pre></td></tr></tbody></table></figure>

<p>è§£æå‡½æ•°æ¥å—å››ä¸ªå‚æ•°ï¼Œåˆ†åˆ«ä¸º</p>
<ol>
<li><code>parent</code>ï¼šå½“å‰ä¸Šä¸€ä¸ªè§£æå‡½æ•°çš„è¿”å›å€¼</li>
<li><code>args</code>ï¼šæŸ¥è¯¢ä¸­ä¼ å…¥çš„å‚æ•°</li>
<li><code>context</code>ï¼šæä¾›ç»™æ‰€æœ‰è§£æå™¨çš„ä¸Šä¸‹æ–‡ä¿¡æ¯</li>
<li><code>info</code>ï¼šä¸€ä¸ªä¿å­˜ä¸å½“å‰æŸ¥è¯¢ç›¸å…³çš„å­—æ®µç‰¹å®šä¿¡æ¯ä»¥åŠ schema è¯¦ç»†ä¿¡æ¯çš„å€¼</li>
</ol>
<p>è§£æå‡½æ•°çš„è¿”å›å€¼å¯ä»¥æ˜¯ä¸€ä¸ªå…·ä½“çš„å€¼ï¼Œä¹Ÿå¯ä»¥æ˜¯ Promise æˆ– Promise æ•°ç»„ã€‚</p>
<h3 id="1-5-è¯·æ±‚æ ¼å¼"><a href="#1-5-è¯·æ±‚æ ¼å¼" class="headerlink" title="1.5 è¯·æ±‚æ ¼å¼"></a>1.5 è¯·æ±‚æ ¼å¼</h3><p>ä¸‹é¢æ¼”ç¤ºå¦‚ä½•é€šè¿‡ Get/Post æ–¹å¼æ¥æ‰§è¡Œä¸‹é¢çš„ GraphQL æŸ¥è¯¢ï¼š</p>
<p><strong>æŸ¥è¯¢æ–‡æ¡£</strong></p>
<figure class="highlight graphql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">query</span> <span class="punctuation">{</span></span><br><span class="line">  me <span class="punctuation">{</span></span><br><span class="line">    name</span><br><span class="line">  <span class="punctuation">}</span></span><br><span class="line"><span class="punctuation">}</span></span><br></pre></td></tr></tbody></table></figure>

<p>Get/Postè¯·æ±‚æ–¹å¼ï¼š</p>
<figure class="highlight json"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// Get æ–¹å¼</span></span><br><span class="line">http<span class="punctuation">:</span><span class="comment">//localhost:8080/graphql?query={me{name}}</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Post æ–¹å¼çš„è¯·æ±‚ä½“</span></span><br><span class="line"><span class="punctuation">{</span></span><br><span class="line">  <span class="attr">"query"</span><span class="punctuation">:</span> <span class="string">"{me{name}}"</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">"operationName"</span><span class="punctuation">:</span> <span class="string">""</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">"variables"</span><span class="punctuation">:</span> <span class="punctuation">{</span> <span class="attr">"name"</span><span class="punctuation">:</span> <span class="string">"value"</span><span class="punctuation">,</span> ... <span class="punctuation">}</span></span><br><span class="line"><span class="punctuation">}</span></span><br></pre></td></tr></tbody></table></figure>

<p>æ ‡å‡†çš„ GraphQL POST è¯·æ±‚åº”å½“åœ¨ HTTP header ä¸­å£°æ˜ <code>Content-Type: application/json</code>ï¼Œå¹¶ä¸”ä½¿ç”¨ JSON æ ¼å¼çš„å†…å®¹ã€‚</p>
<p><strong>è¿”å›çš„æ ¼å¼</strong></p>
<figure class="highlight json"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// æ­£ç¡®è¿”å›</span></span><br><span class="line"><span class="punctuation">{</span></span><br><span class="line">  <span class="attr">"data"</span><span class="punctuation">:</span> <span class="punctuation">{</span> ... <span class="punctuation">}</span></span><br><span class="line"><span class="punctuation">}</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// æ‰§è¡Œæ—¶å‘ç”Ÿé”™è¯¯</span></span><br><span class="line"><span class="punctuation">{</span></span><br><span class="line">  <span class="attr">"errors"</span><span class="punctuation">:</span> <span class="punctuation">[</span> ... <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">}</span></span><br></pre></td></tr></tbody></table></figure>

<p>GraphQLä¹Ÿæä¾›äº†æ–¹ä¾¿çš„å›¾å½¢åŒ–ç•Œé¢å¸®åŠ©æ„å»ºGraphQLè¯·æ±‚ï¼š</p>
<blockquote>
<p>å·¦è¾¹æ˜¯è¯·æ±‚ä¿¡æ¯æ ï¼Œå·¦ä¸‹æ˜¯è¯·æ±‚å‚æ•°æ å’Œè¯·æ±‚å¤´è®¾ç½®æ ï¼Œå³è¾¹æ˜¯è¿”å›å‚æ•°æ </p>
</blockquote>
<p><img src="/../images/GraphQL%E5%85%A5%E9%97%A8/image_B7PpTjmpqj.png"></p>
<h2 id="2-GraphQL-Java"><a href="#2-GraphQL-Java" class="headerlink" title="2 GraphQL-Java"></a>2 GraphQL-Java</h2><p>å…ˆçœ‹ä¸€ä¸‹å®˜ç½‘Demoï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloWorld</span> {</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">      <span class="comment">//schemaå®šä¹‰ï¼ŒåŒ…å«ä¸€ä¸ªhelloçš„æŸ¥è¯¢æ–¹æ³•</span></span><br><span class="line">      <span class="type">String</span> <span class="variable">schema</span> <span class="operator">=</span> <span class="string">"type Query{hello: String} schema{query: Query}"</span>;</span><br><span class="line">      <span class="type">SchemaParser</span> <span class="variable">schemaParser</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SchemaParser</span>();</span><br><span class="line">      <span class="comment">// åŠ è½½schemaå¹¶è§£æä¸ºTypeDefinitionRegistry</span></span><br><span class="line">      <span class="type">TypeDefinitionRegistry</span> <span class="variable">typeDefinitionRegistry</span> <span class="operator">=</span> schemaParser.parse(schema);</span><br><span class="line">      <span class="comment">// å®šä¹‰helloæ–¹æ³•è§¦å‘çš„æ“ä½œ</span></span><br><span class="line">      <span class="type">RuntimeWiring</span> <span class="variable">runtimeWiring</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RuntimeWiring</span>()</span><br><span class="line">              .type(<span class="string">"Query"</span>, builder -&gt; builder.dataFetcher(<span class="string">"hello"</span>, <span class="keyword">new</span> <span class="title class_">StaticDataFetcher</span>(<span class="string">"world"</span>)))</span><br><span class="line">              .build();</span><br><span class="line"></span><br><span class="line">      <span class="type">SchemaGenerator</span> <span class="variable">schemaGenerator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SchemaGenerator</span>();</span><br><span class="line">      <span class="type">GraphQLSchema</span> <span class="variable">graphQLSchema</span> <span class="operator">=</span> schemaGenerator.makeExecutableSchema(typeDefinitionRegistry, runtimeWiring);</span><br><span class="line">      <span class="comment">// æ„å»ºGraphQLå®ä¾‹</span></span><br><span class="line">      <span class="type">GraphQL</span> <span class="variable">build</span> <span class="operator">=</span> GraphQL.newGraphQL(graphQLSchema).build();</span><br><span class="line">      <span class="type">ExecutionResult</span> <span class="variable">executionResult</span> <span class="operator">=</span> build.execute(<span class="string">"{hello}"</span>);</span><br><span class="line"></span><br><span class="line">      System.out.println(executionResult.getData().toString());  <span class="comment">// result: {hello=world}</span></span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>é€šè¿‡è¿™ä¸ªDemoï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹GraphQLçš„å®ç°éœ€è¦å“ªäº›å…³é”®ç»„ä»¶ï¼š</p>
<h3 id="2-1-TypeDefinitionRegistry"><a href="#2-1-TypeDefinitionRegistry" class="headerlink" title="2.1 TypeDefinitionRegistry"></a>2.1 TypeDefinitionRegistry</h3><p><strong>ç±»å‹å®šä¹‰</strong>ã€‚åœ¨Javaä»£ç ä¸­ï¼Œé€šè¿‡åŠ è½½Schemaæ–‡ä»¶æˆ–æè¿°ï¼Œå°†å…¶è§£æä¸º<code>TypeDefinitionRegistry</code>ã€‚</p>
<h3 id="2-2-RuntimeWiring"><a href="#2-2-RuntimeWiring" class="headerlink" title="2.2 RuntimeWiring"></a>2.2 RuntimeWiring</h3><p><strong>è¿è¡Œæ—¶ç»‡å…¥</strong>ã€‚ä»…æœ‰SchemaåŠå…¶ç±»å‹å®šä¹‰è¿˜ä¸å¤Ÿï¼Œåœ¨Javaä¸­è¦å®é™…è¿è¡ŒGraphQLï¼Œè¿˜éœ€è¦æ˜¾å¼æŒ‡å®šå®šä¹‰ä¸­çš„æ¯ä¸ªæ“ä½œï¼Œè¯¥è§¦å‘ä»€ä¹ˆæ ·çš„è¡Œä¸ºï¼Œ<em>ç›¸å½“äºResolverå‡½æ•°</em></p>
<p>ä¾‹å¦‚ï¼Œåœ¨æœ¬ä¾‹ä¸­ï¼Œ<code>builder -&gt; builder.dataFetcher("hello", new StaticDataFetcher("world")</code>è¡¨ç¤ºå½“æŸ¥è¯¢Queryç±»å‹ä¸‹çš„helloå­—æ®µæ—¶ï¼Œè¿”å›å€¼ä¸ºâ€worldâ€ã€‚</p>
<h3 id="2-3-GraphQL"><a href="#2-3-GraphQL" class="headerlink" title="2.3 GraphQL"></a>2.3 GraphQL</h3><p><strong>æ ¸å¿ƒç»„ä»¶</strong>ã€‚GraphQLå®ä¾‹æ˜¯æˆ‘ä»¬ä½¿ç”¨GraphQLæœ€å…³é”®çš„ç»„ä»¶ï¼Œè´Ÿè´£å¯¹GraphQLè¯·æ±‚è¿›è¡Œå“åº”</p>
<p>åœ¨ç»“åˆå‰é¢<code>TypeDefinitionRegistry</code>å’Œ<code>RuntimeWiring</code>çš„åŸºç¡€ä¸Šï¼Œç”Ÿæˆçš„å¯è¿è¡Œçš„GraphQLå®ä¾‹</p>
<h3 id="2-4-ExecutionResult"><a href="#2-4-ExecutionResult" class="headerlink" title="2.4 ExecutionResult"></a>2.4 ExecutionResult</h3><p>æ¯æ¬¡æ‰§è¡ŒGraphQLæ“ä½œæ—¶ï¼Œè¿”å›çš„<strong>ç»“æœå¯¹è±¡</strong>ã€‚</p>
<p>å…¶ä¸­åŒ…å«errorå­—æ®µï¼Œç”¨äºä¿å­˜æ‰§è¡Œè¿‡ç¨‹ä¸­çš„æŠ¥é”™ä¿¡æ¯ï¼›dataå­—æ®µï¼Œç”¨äºè·å–æ‰§è¡Œç»“æœè¿”å›å€¼ã€‚</p>
<h3 id="2-5-DataFetchers"><a href="#2-5-DataFetchers" class="headerlink" title="2.5 DataFetchers"></a>2.5 DataFetchers</h3><p><em><strong>Schemaä¸­çš„æ¯ä¸ªå­—æ®µéƒ½æœ‰ä¸€ä¸ª<code>DataFethcer</code>ä¸ä¹‹å…³è”ï¼Œ</strong></em>åœ¨æŸ¥è¯¢æ‰§è¡Œçš„æ—¶å€™ï¼Œå®ƒä¼šä¸ºæŸ¥è¯¢è¯­å¥ä¸­çš„æ¯ä¸ªå­—æ®µè°ƒç”¨åˆé€‚çš„<code>DataFetcher</code></p>
<p><code>DataFetcher</code>æ˜¯ä¸€ä¸ªæ¥å£ï¼Œæ ¸å¿ƒæ–¹æ³•æ˜¯<code>get()</code>ï¼Œåªæœ‰ä¸€ä¸ª<code>DataFetcherEnvironment</code>å‚æ•°ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">DataFetcher</span>&lt;T&gt; {</span><br><span class="line"></span><br><span class="line">    T <span class="title function_">get</span><span class="params">(DataFetchingEnvironment environment)</span> <span class="keyword">throws</span> Exception;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><code>DataFetchingEnvironment</code>ä¸­åŒ…å«å‰ç«¯ä¼ é€’çš„å­—æ®µå‚æ•°ï¼Œ<code>DataFetchers</code>å¤æ‚æ ¹æ®è¿™äº›å‚æ•°æŸ¥æ‰¾åˆ°å¯¹åº”çš„æ•°æ®</p>
<p>ä¸‹é¢è¿™å¼ å›¾éå¸¸å½¢è±¡ç”»çš„ï¼ˆè™½ç„¶ä¸æ˜¯æˆ‘ç”»çš„ğŸ˜†ï¼‰</p>
<p><img src="/../images/GraphQL%E5%85%A5%E9%97%A8/image_hy8ZUSywws.png"></p>
<h2 id="3-å®è·µ"><a href="#3-å®è·µ" class="headerlink" title="3 å®è·µ"></a>3 å®è·µ</h2><blockquote>
<p>â€œTalk is cheap. Show me the code.â€</p>
</blockquote>
<p>åœºæ™¯ï¼šåˆ›å»ºä¸€ä¸ªæ–‡ä»¶æœåŠ¡å™¨ï¼Œèƒ½å¤Ÿä¸Šä¼ å’Œä¸‹è½½æ–‡ä»¶ï¼Œå¹¶å¯ä»¥ä¿å­˜å’ŒæŸ¥è¯¢æ–‡ä»¶çš„å…ƒæ•°æ®</p>
<p>å…ˆå®šä¹‰ä¸€ä¸ªSchemeæ–‡ä»¶<code>schema.graphqls</code>ï¼š</p>
<figure class="highlight graphql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> <span class="keyword">Query</span> <span class="punctuation">{</span></span><br><span class="line">    metaData<span class="punctuation">(</span><span class="symbol">fileId</span><span class="punctuation">:</span> ID<span class="punctuation">)</span><span class="punctuation">:</span> MetaData</span><br><span class="line"><span class="punctuation">}</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> <span class="keyword">Mutation</span> <span class="punctuation">{</span></span><br><span class="line">    createMetaData<span class="punctuation">(</span><span class="symbol">fileId</span><span class="punctuation">:</span> ID, <span class="symbol">fileName</span><span class="punctuation">:</span> String, <span class="symbol">fileType</span><span class="punctuation">:</span> String<span class="punctuation">)</span><span class="punctuation">:</span> MetaData</span><br><span class="line"><span class="punctuation">}</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> MetaData <span class="punctuation">{</span></span><br><span class="line">    <span class="symbol">fileName</span><span class="punctuation">:</span> String</span><br><span class="line">    <span class="symbol">fileType</span><span class="punctuation">:</span> String</span><br><span class="line"><span class="punctuation">}</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">mutation</span> createMetaData <span class="punctuation">{</span></span><br><span class="line">    createMetaData<span class="punctuation">(</span><span class="symbol">fileId</span><span class="punctuation">:</span> <span class="string">"%s"</span>, <span class="symbol">fileName</span><span class="punctuation">:</span> <span class="string">"%s"</span>, <span class="symbol">fileType</span><span class="punctuation">:</span> <span class="string">"%s"</span><span class="punctuation">)</span> <span class="punctuation">{</span></span><br><span class="line">        fileName,</span><br><span class="line">        fileType</span><br><span class="line">    <span class="punctuation">}</span></span><br><span class="line"><span class="punctuation">}</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">query</span> <span class="punctuation">{</span></span><br><span class="line">    metaData<span class="punctuation">(</span><span class="symbol">fileId</span><span class="punctuation">:</span> <span class="string">"%s"</span><span class="punctuation">)</span> <span class="punctuation">{</span></span><br><span class="line">        fileName,</span><br><span class="line">        fileType</span><br><span class="line">    <span class="punctuation">}</span></span><br><span class="line"><span class="punctuation">}</span></span><br></pre></td></tr></tbody></table></figure>

<p>æˆ‘ä»¬å®šä¹‰ä¸€ä¸ªç±»<code>GraphQLFactory</code>ï¼Œç”¨äºæ„å»ºGraphQLå®ä¾‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GraphQLFactory</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> GraphQL graphQL;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowire</span></span><br><span class="line">    <span class="keyword">private</span> SpringSQLQueryDataFetcher queryDataFetcher;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowire</span></span><br><span class="line">    <span class="keyword">private</span> SpringSQLMutationDataFetcher mutationDataFetcher;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> <span class="keyword">throws</span> IOException {</span><br><span class="line">        <span class="keyword">final</span> <span class="type">String</span> <span class="variable">schemaString</span> <span class="operator">=</span> getGraphQLSchemaResourceAsString(<span class="string">"schema.graphqls"</span>);</span><br><span class="line">        <span class="keyword">final</span> <span class="type">GraphQLSchema</span> <span class="variable">graphQLSchema</span> <span class="operator">=</span> buildSchema(schemaString, queryDataFetcher, mutationDataFetcher);</span><br><span class="line">        <span class="keyword">return</span> GraphQL.newGraphQL(graphQLSchema).build();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> GraphQLSchema <span class="title function_">buildSchema</span><span class="params">(</span></span><br><span class="line"><span class="params">            <span class="keyword">final</span> <span class="meta">@NotNull</span> String schemaString,</span></span><br><span class="line"><span class="params">            <span class="keyword">final</span> <span class="meta">@NotNull</span> DataFetcher&lt;MetaData&gt; queryDataFetcher,</span></span><br><span class="line"><span class="params">            <span class="keyword">final</span> <span class="meta">@NotNull</span> DataFetcher&lt;MetaData&gt; mutationDataFetcher</span></span><br><span class="line"><span class="params">    )</span> {</span><br><span class="line">        <span class="keyword">final</span> <span class="type">TypeDefinitionRegistry</span> <span class="variable">typeDefinitionRegistry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SchemaParser</span>().parse(schemaString);</span><br><span class="line">        <span class="keyword">final</span> <span class="type">RuntimeWiring</span> <span class="variable">runtimeWiring</span> <span class="operator">=</span> buildWiring(queryDataFetcher, mutationDataFetcher);</span><br><span class="line">        <span class="keyword">final</span> <span class="type">SchemaGenerator</span> <span class="variable">schemaGenerator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SchemaGenerator</span>();</span><br><span class="line">        <span class="keyword">return</span> schemaGenerator.makeExecutableSchema(typeDefinitionRegistry, runtimeWiring);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> RuntimeWiring <span class="title function_">buildWiring</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> RuntimeWiring.newRuntimeWiring()</span><br><span class="line">                .type(newTypeWiring(<span class="string">"Query"</span>).dataFetcher(<span class="string">"metaData"</span>, queryDataFetcher))</span><br><span class="line">                .type(newTypeWiring(<span class="string">"Mutation"</span>).dataFetcher(<span class="string">"createMetaData"</span>, mutationDataFetcher))</span><br><span class="line">                .build();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@NotNull</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getGraphQLSchemaResourceAsString</span><span class="params">(<span class="meta">@NotNull</span> <span class="keyword">final</span> String resourceName)</span> {</span><br><span class="line">        <span class="meta">@SuppressWarnings("ConstantConditions")</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">Scanner</span> <span class="variable">scanner</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(</span><br><span class="line">                Thread</span><br><span class="line">                        .currentThread()</span><br><span class="line">                        .getContextClassLoader()</span><br><span class="line">                        .getResourceAsStream(Objects.requireNonNull(resourceName))</span><br><span class="line">        )</span><br><span class="line">                .useDelimiter(<span class="string">"\\A"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (scanner.hasNext()) {</span><br><span class="line">            <span class="keyword">return</span> scanner.next();</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> String.format(<span class="string">"GraphQL schema file not found: '%s'"</span>, resourceName);</span><br><span class="line">        LOG.error(message);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(message);</span><br><span class="line">    }   </span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>æ¥ä¸‹æ¥æˆ‘ä»¬åˆ›å»ºå¯¹åº”çš„<code>DataFetchers</code>ï¼Œåˆ†åˆ«å¯¹Schemaä¸­å®šä¹‰çš„<code>createMetaData</code>å’Œ<code>metaData</code>æ–¹æ³•è¿›è¡Œå®ç°ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringSQLQueryDataFetcher</span> <span class="keyword">implements</span> <span class="title class_">DataFetcher</span>&lt;MetaData&gt; {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> MetaData <span class="title function_">get</span><span class="params">(<span class="keyword">final</span> DataFetchingEnvironment dataFetchingEnvironment)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        <span class="keyword">final</span> <span class="type">String</span> <span class="variable">fileId</span> <span class="operator">=</span> dataFetchingEnvironment.getArgument(FILE_ID);</span><br><span class="line">        <span class="comment">// select from db</span></span><br><span class="line">        <span class="type">MetaData</span> <span class="variable">metaData</span> <span class="operator">=</span> getMetaDataByFileId(fileId);</span><br><span class="line">        <span class="keyword">return</span> metaData;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringSQLMutationDataFetcher</span> <span class="keyword">implements</span> <span class="title class_">DataFetcher</span>&lt;MetaData&gt; {</span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">FILE_ID</span> <span class="operator">=</span> <span class="string">"fileId"</span>;</span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">FILE_NAME</span> <span class="operator">=</span> <span class="string">"fileName"</span>;</span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">FILE_TYPE</span> <span class="operator">=</span> <span class="string">"fileType"</span>;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="keyword">public</span> MetaData <span class="title function_">get</span><span class="params">(<span class="keyword">final</span> DataFetchingEnvironment dataFetchingEnvironment)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">      <span class="keyword">final</span> <span class="type">String</span> <span class="variable">fileId</span> <span class="operator">=</span> dataFetchingEnvironment.getArgument(FILE_ID);</span><br><span class="line">      <span class="keyword">final</span> <span class="type">String</span> <span class="variable">fileName</span> <span class="operator">=</span> dataFetchingEnvironment.getArgument(FILE_NAME);</span><br><span class="line">      <span class="keyword">final</span> <span class="type">String</span> <span class="variable">fileType</span> <span class="operator">=</span> dataFetchingEnvironment.getArgument(FILE_TYPE);</span><br><span class="line"></span><br><span class="line">      updateMetaData(fileId, fileName, fileType);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> MetaData.of(</span><br><span class="line">              Stream.of(</span><br><span class="line">                      <span class="keyword">new</span> <span class="title class_">AbstractMap</span>.SimpleImmutableEntry&lt;&gt;(FILE_NAME, fileName),</span><br><span class="line">                      <span class="keyword">new</span> <span class="title class_">AbstractMap</span>.SimpleImmutableEntry&lt;&gt;(FILE_TYPE, fileType)</span><br><span class="line">              ).collect(Collectors.toMap(Map.Entry::getKey, Map.Entry::getValue))</span><br><span class="line">      );</span><br><span class="line">   }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<hr>
<p>å‚è€ƒï¼š</p>
<ul>
<li><a href="https://juejin.cn/post/7066694688090095652" title="Graphql+SpringBootçœ‹è¿™ä¸€ç¯‡å°±å¤Ÿäº†">Graphql+SpringBootçœ‹è¿™ä¸€ç¯‡å°±å¤Ÿäº†</a></li>
<li><a href="https://www.cnblogs.com/pku-liuqiang/p/11496914.html" title="GraphQL Java-å…¥é—¨æŒ‡å—">GraphQL Java-å…¥é—¨æŒ‡å—</a></li>
</ul>
]]></content>
      <categories>
        <category>æ—¥å¸¸å°è®°</category>
      </categories>
      <tags>
        <tag>GraphQL</tag>
      </tags>
  </entry>
  <entry>
    <title>Beançš„åˆå§‹åŒ–æµç¨‹</title>
    <url>/2024/03/31/Bean%E7%9A%84%E5%88%9D%E5%A7%8B%E5%8C%96%E6%B5%81%E7%A8%8B/</url>
    <content><![CDATA[<p>Beanç”Ÿå‘½å‘¨æœŸçš„å¤§è‡´è¿‡ç¨‹ï¼šå®ä¾‹åŒ–â†’å±æ€§æ³¨å…¥â†’åˆå§‹åŒ–â†’é”€æ¯</p>
<p><img src="/../images/Bean%E7%9A%84%E5%88%9D%E5%A7%8B%E5%8C%96%E6%B5%81%E7%A8%8B/bean.svg"></p>
<p>æœ¬æ–‡ä¸»è¦æ¢è®¨ä¸€ä¸‹åˆå§‹åŒ–è¿™ä¸ªè¿‡ç¨‹ï¼š</p>
<h2 id="åˆå§‹åŒ–ç”Ÿå‘½é’©å­"><a href="#åˆå§‹åŒ–ç”Ÿå‘½é’©å­" class="headerlink" title="åˆå§‹åŒ–ç”Ÿå‘½é’©å­"></a>åˆå§‹åŒ–ç”Ÿå‘½é’©å­</h2><p>è¯¥é˜¶æ®µä¸»è¦åšbeançš„åˆå§‹åŒ–æ“ä½œï¼ŒåŒ…æ‹¬ï¼š<strong>å›è°ƒAwareæ¥å£</strong>ã€<strong>å›è°ƒåˆå§‹åŒ–æ–¹æ³•</strong>ã€<strong>ç”Ÿæˆä»£ç†å¯¹è±¡</strong>ç­‰ï¼š</p>
<ol>
<li><p><strong>å›è°ƒ<code>Aware</code>æ¥å£</strong></p>
<p> åŒ…æ‹¬<code>BeanNameAware</code>ã€<code>BeanFactoryAware</code>ç­‰</p>
</li>
<li><p><strong><code>BeanPostProcessors</code>å‰ç½®å¤„ç†å™¨</strong></p>
<ul>
<li><code>ApplicationContextAwareProcessor</code>ï¼šå›è°ƒä¸€äº›Awareæ¥å£ï¼Œå¦‚ï¼š<ul>
<li><code>ApplicationContextAware</code>ï¼šæ³¨å…¥<code>context</code>å¯¹è±¡</li>
<li><code>EnvironmentAware</code>ï¼šæ³¨å…¥<code>Environment</code>å¯¹è±¡</li>
</ul>
</li>
<li><code>InitDestroyAnnotationBeanPostProcessor</code>ï¼šè°ƒç”¨<code>@PostConstruct</code>æ ‡æ³¨çš„æ–¹æ³•</li>
</ul>
</li>
<li><p><strong>å›è°ƒåˆå§‹åŒ–æ–¹æ³•</strong></p>
<ul>
<li><code>initializingBean</code>çš„<code>afterPropertiesSet()</code></li>
<li>Beançš„<code>init-method</code></li>
</ul>
</li>
<li><p><strong><code>BeanPostProcessors</code>åç½®å¤„ç†å™¨</strong></p>
<p> å¸¸ç”¨äºè¿”å›ä»£ç†å¯¹è±¡ã€‚</p>
<p> å…¶ä¸­<code>AbstractAutoProxyCreator</code>å’Œ <code>AbstractAdvisingBeanPostProcessor</code>éƒ½æœ‰å¯èƒ½äº§ç”Ÿä»£ç†å¯¹è±¡ï¼Œå¦‚ï¼š</p>
<ul>
<li><code>AsyncAnnotationBeanPostProcessor</code>ï¼šå¯¹<code>@Async</code>è¿›è¡Œä»£ç†</li>
<li><code>InfrastructureAdvisorAutoProxyCreator</code>ï¼šå¯¹<code>@Transactional</code>è¿›è¡Œä»£ç†</li>
</ul>
</li>
<li><p>æŠŠæœ€ç»ˆç”Ÿæˆçš„ä»£ç†å¯¹è±¡æ”¾å…¥<strong>å•ä¾‹æ± </strong>ï¼ˆæºç ä¸­å«åš<code>singletonObjects</code>ï¼‰ä¸­</p>
</li>
</ol>
<h1 id="æºç è§£æ"><a href="#æºç è§£æ" class="headerlink" title="æºç è§£æ"></a>æºç è§£æ</h1><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> Object <span class="title function_">initializeBean</span><span class="params">(String beanName, Object bean, <span class="meta">@Nullable</span> RootBeanDefinition mbd)</span> {</span><br><span class="line">  <span class="comment">// 1: å›è°ƒAwareæ¥å£ä¸­çš„æ–¹æ³•</span></span><br><span class="line">  invokeAwareMethods(beanName, bean);</span><br><span class="line"></span><br><span class="line">   <span class="type">Object</span> <span class="variable">wrappedBean</span> <span class="operator">=</span> bean;</span><br><span class="line">   <span class="keyword">if</span> (mbd == <span class="literal">null</span> || !mbd.isSynthetic()) {</span><br><span class="line">      <span class="comment">// 2: è°ƒç”¨å‰ç½®å¤„ç†å™¨</span></span><br><span class="line">      wrappedBean = applyBeanPostProcessorsBeforeInitialization(wrappedBean, beanName);</span><br><span class="line">   }</span><br><span class="line"></span><br><span class="line">   <span class="keyword">try</span> {</span><br><span class="line">      <span class="comment">// 3: å®Œæˆinitæ–¹æ³•å›è°ƒ</span></span><br><span class="line">      invokeInitMethods(beanName, wrappedBean, mbd);</span><br><span class="line">   }</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 4: è°ƒç”¨åç½®å¤„ç†å™¨</span></span><br><span class="line">   <span class="keyword">if</span> (mbd == <span class="literal">null</span> || !mbd.isSynthetic()) {</span><br><span class="line">      wrappedBean = applyBeanPostProcessorsAfterInitialization(wrappedBean, beanName);</span><br><span class="line">   }</span><br><span class="line"></span><br><span class="line">   <span class="keyword">return</span> wrappedBean;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
]]></content>
      <categories>
        <category>Springæºç ç³»åˆ—</category>
      </categories>
      <tags>
        <tag>Springæºç é˜…è¯»</tag>
      </tags>
  </entry>
  <entry>
    <title>Goè¯­è¨€åŸºç¡€</title>
    <url>/2023/09/01/Go%E8%AF%AD%E8%A8%80%E5%9F%BA%E7%A1%80/</url>
    <content><![CDATA[<h2 id="ç¯å¢ƒæ­å»º"><a href="#ç¯å¢ƒæ­å»º" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h2><ul>
<li><strong>GOPATH</strong>ï¼šä»£è¡¨ Go è¯­è¨€é¡¹ç›®çš„å·¥ä½œç›®å½•ï¼Œåœ¨ Go Module æ¨¡å¼ä¹‹å‰éå¸¸é‡è¦ï¼Œç°åœ¨åŸºæœ¬ä¸Šç”¨æ¥å­˜æ”¾ä½¿ç”¨ go get å‘½ä»¤è·å–çš„é¡¹ç›®ã€‚</li>
<li><strong>GOBIN</strong>ï¼šä»£è¡¨ Go ç¼–è¯‘ç”Ÿæˆçš„ç¨‹åºçš„å®‰è£…ç›®å½•ï¼Œæ¯”å¦‚é€šè¿‡ go install å‘½ä»¤ï¼Œä¼šæŠŠç”Ÿæˆçš„ Go ç¨‹åºå®‰è£…åˆ° GOBIN ç›®å½•ä¸‹ï¼Œä»¥ä¾›ä½ åœ¨ç»ˆç«¯ä½¿ç”¨ã€‚</li>
<li>Goä»£ç†ï¼š<code>GOPROXY=https://goproxy.cn</code></li>
</ul>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">export</span> GOROOT=/usr/local/go </span><br><span class="line"><span class="built_in">export</span> GOPATH=<span class="variable">$HOME</span>/MyDoucument/code/goProject</span><br><span class="line"><span class="built_in">export</span> GOBIN=<span class="variable">$GOPATH</span>/bin</span><br><span class="line"><span class="built_in">export</span> GO111MODULE=on</span><br></pre></td></tr></tbody></table></figure>

<h3 id="ç¼–è¯‘å‘å¸ƒ"><a href="#ç¼–è¯‘å‘å¸ƒ" class="headerlink" title="ç¼–è¯‘å‘å¸ƒ"></a>ç¼–è¯‘å‘å¸ƒ</h3><p><code>go build</code>ç¼–è¯‘ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶</p>
<p><code>go install</code>æŠŠå®ƒå®‰è£…åˆ° <code>$GOBIN</code> ç›®å½•æˆ–è€…ä»»æ„ä½ç½®</p>
<h3 id="è·¨å¹³å°ç¼–è¯‘"><a href="#è·¨å¹³å°ç¼–è¯‘" class="headerlink" title="è·¨å¹³å°ç¼–è¯‘"></a>è·¨å¹³å°ç¼–è¯‘</h3><p>Go è¯­è¨€é€šè¿‡ä¸¤ä¸ªç¯å¢ƒå˜é‡æ¥æ§åˆ¶è·¨å¹³å°ç¼–è¯‘ï¼Œå®ƒä»¬åˆ†åˆ«æ˜¯ <code>GOOS</code> å’Œ <code>GOARCH</code> ã€‚</p>
<ul>
<li><strong>GOOS</strong>ï¼šä»£è¡¨è¦ç¼–è¯‘çš„ç›®æ ‡æ“ä½œç³»ç»Ÿï¼Œå¸¸è§çš„æœ‰ Linuxã€Windowsã€Darwin ç­‰ã€‚</li>
<li><strong>GOARCH</strong>ï¼šä»£è¡¨è¦ç¼–è¯‘çš„ç›®æ ‡å¤„ç†å™¨æ¶æ„ï¼Œå¸¸è§çš„æœ‰ 386ã€AMD64ã€ARM64 ç­‰ã€‚</li>
</ul>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">GOOS=linux GOARCH=amd64 go build ./ch01/main.go</span><br></pre></td></tr></tbody></table></figure>

<h1 id="åŸºæœ¬æ•°æ®ç±»å‹"><a href="#åŸºæœ¬æ•°æ®ç±»å‹" class="headerlink" title="åŸºæœ¬æ•°æ®ç±»å‹"></a>åŸºæœ¬æ•°æ®ç±»å‹</h1><h3 id="æ•´å‹"><a href="#æ•´å‹" class="headerlink" title="æ•´å‹"></a>æ•´å‹</h3><ul>
<li><strong>æœ‰ç¬¦å·æ•´å‹</strong>ï¼šå¦‚ <code>int</code>ã€<code>int8</code>ã€<code>int16</code>ã€<code>int32</code> å’Œ <code>int64</code>ã€‚</li>
<li><strong>æ— ç¬¦å·æ•´å‹</strong>ï¼šå¦‚ <code>uint</code>ã€<code>uint8</code>ã€<code>uint16</code>ã€<code>uint32</code> å’Œ <code>uint64</code>ã€‚</li>
</ul>
<p>é™¤äº†æœ‰ç”¨â€œä½â€ï¼ˆbitï¼‰å¤§å°è¡¨ç¤ºçš„æ•´å‹å¤–ï¼Œè¿˜æœ‰ int å’Œ uint è¿™ä¸¤ä¸ªæ²¡æœ‰å…·ä½“ bit å¤§å°çš„æ•´å‹ï¼Œå®ƒä»¬çš„å¤§å°å¯èƒ½æ˜¯ 32bitï¼Œä¹Ÿå¯èƒ½æ˜¯ 64bitï¼Œå’Œç¡¬ä»¶è®¾å¤‡ CPU æœ‰å…³ã€‚</p>
<h3 id="æµ®ç‚¹æ•°"><a href="#æµ®ç‚¹æ•°" class="headerlink" title="æµ®ç‚¹æ•°"></a>æµ®ç‚¹æ•°</h3><ul>
<li><code>float32</code> </li>
<li><code>float64</code></li>
</ul>
<h3 id="å¤æ•°"><a href="#å¤æ•°" class="headerlink" title="å¤æ•°"></a>å¤æ•°</h3><ul>
<li><code>complex64</code></li>
<li><code>complex128</code></li>
</ul>
<p>å¤æ•°æœ‰å®éƒ¨å’Œè™šéƒ¨ï¼Œ<code>complex64</code>çš„å®éƒ¨å’Œè™šéƒ¨ä¸º32ä½ï¼Œ<code>complex128</code>çš„å®éƒ¨å’Œè™šéƒ¨ä¸º64ä½</p>
<h3 id="å¸ƒå°”å€¼"><a href="#å¸ƒå°”å€¼" class="headerlink" title="å¸ƒå°”å€¼"></a>å¸ƒå°”å€¼</h3><p><code>bool</code></p>
<ul>
<li>å¸ƒå°”ç±»å‹å˜é‡çš„é»˜è®¤å€¼ä¸ºfalseã€‚</li>
<li>Go è¯­è¨€ä¸­ä¸å…è®¸å°†æ•´å‹å¼ºåˆ¶è½¬æ¢ä¸ºå¸ƒå°”å‹.</li>
<li>å¸ƒå°”å‹æ— æ³•å‚ä¸æ•°å€¼è¿ç®—ï¼Œä¹Ÿæ— æ³•ä¸å…¶ä»–ç±»å‹è¿›è¡Œè½¬æ¢</li>
</ul>
<h3 id="å­—ç¬¦ä¸²"><a href="#å­—ç¬¦ä¸²" class="headerlink" title="å­—ç¬¦ä¸²"></a>å­—ç¬¦ä¸²</h3><p>*** Go è¯­è¨€é‡Œçš„å­—ç¬¦ä¸²çš„å†…éƒ¨å®ç°ä½¿ç”¨UTF-8ç¼–ç ï¼Œæ¯ä¸ªå­—ç¬¦ä¸²çš„åº•å±‚éƒ½æ˜¯byteæ•°ç»„***</p>
<ul>
<li><em><strong>byteï¼šç›¸å½“äºuint8</strong></em></li>
<li><em><strong>runeï¼šç›¸å½“äºint32</strong></em><ul>
<li>Go ä½¿ç”¨äº†ç‰¹æ®Š <code>rune</code> ç±»å‹æ¥å¤„ç† <code>Unicode</code>ï¼ˆå¤åˆå­—ç¬¦ï¼ŒåŒ…æ‹¬ä¸­æ–‡ã€æ—¥æ–‡ç­‰ç”¨å¤šå­—èŠ‚è¡¨ç¤ºå­—ç¬¦ï¼‰</li>
</ul>
</li>
</ul>
<figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">//utf-8éå†</span></span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="built_in">len</span>(str); i++ {</span><br><span class="line">    ch := str[i]</span><br><span class="line">    fmt.Printf(<span class="string">"%c \n"</span>, ch)</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">//Unicodeéå†</span></span><br><span class="line"><span class="keyword">for</span> _, ch1 := <span class="keyword">range</span> str {</span><br><span class="line">    fmt.Printf(<span class="string">"%c \n"</span>, ch1)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<hr>
<h2 id="Arrayã€Sliceã€Map"><a href="#Arrayã€Sliceã€Map" class="headerlink" title="Arrayã€Sliceã€Map"></a>Arrayã€Sliceã€Map</h2><p><img src="/../images/Go%E8%AF%AD%E8%A8%80%E5%9F%BA%E7%A1%80/image_MkJ3W3cuce.png"></p>
<figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line">array1:=[<span class="number">5</span>]<span class="type">string</span>{<span class="number">1</span>:<span class="string">"b"</span>,<span class="number">3</span>:<span class="string">"d"</span>}</span><br><span class="line"></span><br><span class="line">slice:=array[start:end]</span><br><span class="line"></span><br><span class="line">slice1:=<span class="built_in">make</span>([]<span class="type">string</span>,<span class="number">4</span>,<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">slice2:=<span class="built_in">append</span>(slice1,<span class="string">"f"</span>)</span><br><span class="line"></span><br><span class="line">nameAgeMap:=<span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">string</span>]<span class="type">int</span>)</span><br><span class="line"></span><br><span class="line">nameAgeMap:=<span class="keyword">map</span>[<span class="type">string</span>]<span class="type">int</span>{<span class="string">"é£é›ªæ— æƒ…"</span>:<span class="number">20</span>}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<blockquote>
<p>ğŸ“Œæç¤º</p>
<p>åœ¨åˆ›å»ºæ–°åˆ‡ç‰‡çš„æ—¶å€™ï¼Œæœ€å¥½è¦è®©æ–°åˆ‡ç‰‡çš„é•¿åº¦å’Œå®¹é‡ä¸€æ ·ï¼Œè¿™æ ·åœ¨è¿½åŠ æ“ä½œçš„æ—¶å€™å°±ä¼šç”Ÿæˆæ–°çš„åº•å±‚æ•°ç»„ï¼Œä»è€Œå’ŒåŸæœ‰æ•°ç»„åˆ†ç¦»ï¼Œå°±ä¸ä¼šå› ä¸ºå…±ç”¨åº•å±‚æ•°ç»„å¯¼è‡´ä¿®æ”¹å†…å®¹çš„æ—¶å€™å½±å“å¤šä¸ªåˆ‡ç‰‡ã€‚</p>
</blockquote>
<h2 id="å‡½æ•°å’Œæ–¹æ³•"><a href="#å‡½æ•°å’Œæ–¹æ³•" class="headerlink" title="å‡½æ•°å’Œæ–¹æ³•"></a>å‡½æ•°å’Œæ–¹æ³•</h2><p>åœ¨ Go è¯­è¨€ä¸­ï¼Œæ–¹æ³•å’Œå‡½æ•°æ˜¯ä¸¤ä¸ªæ¦‚å¿µï¼Œä½†åˆéå¸¸ç›¸ä¼¼ï¼Œä¸åŒç‚¹åœ¨äºæ–¹æ³•å¿…é¡»è¦æœ‰ä¸€ä¸ªæ¥æ”¶è€…ï¼Œè¿™ä¸ªæ¥æ”¶è€…æ˜¯ä¸€ä¸ªç±»å‹ï¼Œè¿™æ ·æ–¹æ³•å°±å’Œè¿™ä¸ªç±»å‹ç»‘å®šåœ¨ä¸€èµ·ï¼Œç§°ä¸ºè¿™ä¸ªç±»å‹çš„æ–¹æ³•ã€‚</p>
<ul>
<li>å‡½æ•°ï¼šæ­£å¸¸çš„ä»£ç é€»è¾‘</li>
<li>æ–¹æ³•ï¼šç‰¹å®šç±»å‹æ‰æœ‰ï¼Œç›¸å½“äºå¯¹è±¡çš„æ–¹æ³•</li>
</ul>
<h3 id="å€¼ç±»å‹æ¥æ”¶è€…å’ŒæŒ‡é’ˆç±»å‹æ¥æ”¶è€…"><a href="#å€¼ç±»å‹æ¥æ”¶è€…å’ŒæŒ‡é’ˆç±»å‹æ¥æ”¶è€…" class="headerlink" title="å€¼ç±»å‹æ¥æ”¶è€…å’ŒæŒ‡é’ˆç±»å‹æ¥æ”¶è€…"></a>å€¼ç±»å‹æ¥æ”¶è€…å’ŒæŒ‡é’ˆç±»å‹æ¥æ”¶è€…</h3><ul>
<li>å€¼ç±»å‹æ¥æ”¶è€…ï¼šä¸ä¼šæ”¹å˜åŸæ¥çš„å¯¹è±¡ï¼Œç›¸å½“äºæ“ä½œå¯¹è±¡çš„æ‹·è´</li>
<li>æŒ‡é’ˆç±»å‹æ¥æ”¶è€…ï¼šé€šè¿‡æŒ‡é’ˆå¯ä»¥è·å–å¯¹è±¡åœ°å€ï¼Œå¯ä»¥ç›´æ¥æ”¹å˜åŸæ¥çš„å¯¹è±¡</li>
</ul>
<blockquote>
<p>æç¤ºï¼šåœ¨è°ƒç”¨æ–¹æ³•çš„æ—¶å€™ï¼Œä¼ é€’çš„æ¥æ”¶è€…æœ¬è´¨ä¸Šéƒ½æ˜¯å‰¯æœ¬ï¼Œåªä¸è¿‡ä¸€ä¸ªæ˜¯è¿™ä¸ªå€¼çš„å‰¯æœ¬ï¼Œä¸€æ˜¯æŒ‡å‘è¿™ä¸ªå€¼æŒ‡é’ˆçš„å‰¯æœ¬ã€‚æŒ‡é’ˆå…·æœ‰æŒ‡å‘åŸæœ‰å€¼çš„ç‰¹æ€§ï¼Œæ‰€ä»¥ä¿®æ”¹äº†æŒ‡é’ˆæŒ‡å‘çš„å€¼ï¼Œä¹Ÿå°±ä¿®æ”¹äº†åŸæœ‰çš„å€¼ã€‚<em><strong>æˆ‘ä»¬å¯ä»¥ç®€å•åœ°ç†è§£ä¸ºå€¼æ¥æ”¶è€…ä½¿ç”¨çš„æ˜¯å€¼çš„å‰¯æœ¬æ¥è°ƒç”¨æ–¹æ³•ï¼Œè€ŒæŒ‡é’ˆæ¥æ”¶è€…ä½¿ç”¨å®é™…çš„å€¼æ¥è°ƒç”¨æ–¹æ³•ã€‚</strong></em></p>
</blockquote>
<blockquote>
<p>ğŸ“Œå€¼æ¥å—è€…æ–¹æ³•ä¸ä¼šæ”¹å˜åŸå§‹ç»“æ„ä½“å®ä¾‹</p>
</blockquote>
<ul>
<li>å¦‚æœä½¿ç”¨ä¸€ä¸ªå€¼ç±»å‹å˜é‡è°ƒç”¨æŒ‡é’ˆç±»å‹æ¥æ”¶è€…çš„æ–¹æ³•ï¼ŒGo è¯­è¨€ç¼–è¯‘å™¨ä¼šè‡ªåŠ¨å¸®æˆ‘ä»¬å–æŒ‡é’ˆè°ƒç”¨ï¼Œä»¥æ»¡è¶³æŒ‡é’ˆæ¥æ”¶è€…çš„è¦æ±‚ã€‚</li>
<li>åŒæ ·çš„åŸç†ï¼Œå¦‚æœä½¿ç”¨ä¸€ä¸ªæŒ‡é’ˆç±»å‹å˜é‡è°ƒç”¨å€¼ç±»å‹æ¥æ”¶è€…çš„æ–¹æ³•ï¼ŒGo è¯­è¨€ç¼–è¯‘å™¨ä¼šè‡ªåŠ¨å¸®æˆ‘ä»¬è§£å¼•ç”¨è°ƒç”¨ï¼Œä»¥æ»¡è¶³å€¼ç±»å‹æ¥æ”¶è€…çš„è¦æ±‚ã€‚</li>
</ul>
<h3 id="å€¼ç±»å‹è°ƒç”¨è€…å’ŒæŒ‡é’ˆç±»å‹è°ƒç”¨è€…"><a href="#å€¼ç±»å‹è°ƒç”¨è€…å’ŒæŒ‡é’ˆç±»å‹è°ƒç”¨è€…" class="headerlink" title="å€¼ç±»å‹è°ƒç”¨è€…å’ŒæŒ‡é’ˆç±»å‹è°ƒç”¨è€…"></a>å€¼ç±»å‹è°ƒç”¨è€…å’ŒæŒ‡é’ˆç±»å‹è°ƒç”¨è€…</h3><p>åœ¨å®˜æ–¹effective goæ–‡æ¡£ä¸­ï¼Œå¯¹ä¸¤è€…åŒºåˆ«æè¿°å¦‚ä¸‹ï¼š</p>
<ul>
<li><em><strong>å€¼æ–¹æ³•ï¼ˆvalue methodsï¼‰å¯ä»¥é€šè¿‡æŒ‡é’ˆå’Œå€¼è°ƒç”¨ï¼Œä½†æ˜¯æŒ‡é’ˆæ–¹æ³•ï¼ˆpointer methodsï¼‰åªèƒ½é€šè¿‡æŒ‡é’ˆæ¥è°ƒç”¨</strong></em><em><strong>ã€‚</strong></em></li>
<li>ä½†æœ‰ä¸€ä¸ªä¾‹å¤–ï¼Œå¦‚æœæŸä¸ªå€¼æ˜¯å¯å¯»å€çš„ï¼ˆaddressableï¼Œæˆ–è€…è¯´<em>å·¦å€¼</em>ï¼‰ï¼Œé‚£ä¹ˆç¼–è¯‘å™¨ä¼šåœ¨å€¼è°ƒç”¨æŒ‡é’ˆæ–¹æ³•æ—¶è‡ªåŠ¨æ’å…¥å–åœ°å€ç¬¦ï¼Œä½¿å¾—åœ¨æ­¤æƒ…å½¢ä¸‹çœ‹èµ·æ¥åƒæŒ‡é’ˆæ–¹æ³•ä¹Ÿå¯ä»¥é€šè¿‡å€¼æ¥è°ƒç”¨ã€‚</li>
</ul>
<hr>
<p>æ€»ç»“ï¼š</p>
<ul>
<li>ä¸ç®¡æ˜¯æ™®é€šå¯¹è±¡è¿˜æ˜¯æŒ‡é’ˆï¼Œéƒ½å¯ä»¥è°ƒç”¨ä»–ä»¬çš„å€¼æ–¹æ³•å’ŒæŒ‡é’ˆæ–¹æ³•ï¼Œå› ä¸ºç¼–è¯‘å™¨ä¼šè‡ªè¡Œå¤„ç†ï¼ˆè¯­æ³•ç³–</li>
<li><strong>é‡äº‹ä¸å†³è¯·ç”¨pointer methodï¼ï¼ï¼</strong></li>
</ul>
<h3 id="é€šè¿‡å˜é‡è°ƒç”¨æ–¹æ³•"><a href="#é€šè¿‡å˜é‡è°ƒç”¨æ–¹æ³•" class="headerlink" title="é€šè¿‡å˜é‡è°ƒç”¨æ–¹æ³•"></a>é€šè¿‡å˜é‡è°ƒç”¨æ–¹æ³•</h3><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line">student := Student(<span class="string">"my name is xiaoming, I am "</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ–¹æ³•èµ‹å€¼ç»™å˜é‡</span></span><br><span class="line">sm := Student.stu</span><br><span class="line">sm2 := (*Student).stu2</span><br><span class="line">sm(student, <span class="number">2</span>)</span><br><span class="line">sm2(&amp;student)</span><br><span class="line">student.stu(<span class="number">1</span>)</span><br></pre></td></tr></tbody></table></figure>

<h2 id="ç»“æ„ä½“å’Œæ¥å£"><a href="#ç»“æ„ä½“å’Œæ¥å£" class="headerlink" title="ç»“æ„ä½“å’Œæ¥å£"></a>ç»“æ„ä½“å’Œæ¥å£</h2><p>ç»“æ„ä½“å®šä¹‰ï¼š</p>
<figure class="highlight c"><table><tbody><tr><td class="code"><pre><span class="line">type Stu <span class="class"><span class="keyword">struct</span>{</span></span><br><span class="line">  name <span class="built_in">string</span></span><br><span class="line">  age <span class="type">int</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// åŒ¿åç»“æ„ä½“ å˜é‡ </span></span><br><span class="line">var stu <span class="class"><span class="keyword">struct</span> {</span></span><br><span class="line">  name <span class="built_in">string</span></span><br><span class="line">  age <span class="type">int</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// åŒ¿åç»“æ„ä½“å˜é‡å¦ä¸€ç§å†™æ³•</span></span><br><span class="line">newCar := <span class="keyword">struct</span> {</span><br><span class="line">  Make    <span class="built_in">string</span> `json:<span class="string">"make"</span>`</span><br><span class="line">  Model   <span class="built_in">string</span> `json:<span class="string">"model"</span>`</span><br><span class="line">  Mileage <span class="type">int</span>    `json:<span class="string">"mileage"</span>`</span><br><span class="line">}{}</span><br><span class="line"></span><br><span class="line"><span class="comment">// MyStringer interface</span></span><br><span class="line">type MyStringer interface{</span><br><span class="line">  myString() <span class="built_in">string</span></span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<p><em><strong>ä»¥æŒ‡é’ˆç±»å‹æ¥æ”¶è€…å®ç°æ¥å£çš„æ—¶å€™ï¼Œåªæœ‰å¯¹åº”çš„æŒ‡é’ˆç±»å‹å®ä¾‹æ‰è¢«è®¤ä¸ºå®ç°äº†è¯¥æ¥å£ã€‚</strong></em></p>
<p><img src="/../images/Go%E8%AF%AD%E8%A8%80%E5%9F%BA%E7%A1%80/Ciqc1F-yPMSAZ4k7AABU_GW4VxE080_qJvRefMHb8.png"></p>
<h3 id="å·¥å‚å‡½æ•°ï¼ˆæ„é€ å‡½æ•°ï¼‰"><a href="#å·¥å‚å‡½æ•°ï¼ˆæ„é€ å‡½æ•°ï¼‰" class="headerlink" title="å·¥å‚å‡½æ•°ï¼ˆæ„é€ å‡½æ•°ï¼‰"></a>å·¥å‚å‡½æ•°ï¼ˆæ„é€ å‡½æ•°ï¼‰</h3><p>å·¥å‚å‡½æ•°ä¸€èˆ¬ç”¨äºåˆ›å»ºè‡ªå®šä¹‰çš„ç»“æ„ä½“ï¼Œä¾¿äºä½¿ç”¨è€…è°ƒç”¨</p>
<figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewPerson</span><span class="params">(name <span class="type">string</span>)</span></span> *person {</span><br><span class="line">    <span class="keyword">return</span> &amp;person{name:name}</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<h3 id="ç»§æ‰¿å’Œç»„åˆ"><a href="#ç»§æ‰¿å’Œç»„åˆ" class="headerlink" title="ç»§æ‰¿å’Œç»„åˆ"></a>ç»§æ‰¿å’Œç»„åˆ</h3><p>åœ¨ Go è¯­è¨€ä¸­æ²¡æœ‰ç»§æ‰¿çš„æ¦‚å¿µï¼Œæ‰€ä»¥ç»“æ„ã€æ¥å£ä¹‹é—´ä¹Ÿæ²¡æœ‰çˆ¶å­å…³ç³»ï¼ŒGo è¯­è¨€æå€¡çš„æ˜¯ç»„åˆï¼Œåˆ©ç”¨ç»„åˆè¾¾åˆ°ä»£ç å¤ç”¨çš„ç›®çš„ï¼Œè¿™ä¹Ÿæ›´çµæ´»ã€‚</p>
<figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// ç»„åˆ</span></span><br><span class="line">p:=person{</span><br><span class="line">    age:<span class="number">30</span>,</span><br><span class="line">    name:<span class="string">"é£é›ªæ— æƒ…"</span>,</span><br><span class="line">    address:address{</span><br><span class="line">        province: <span class="string">"åŒ—äº¬"</span>,</span><br><span class="line">        city:     <span class="string">"åŒ—äº¬"</span>,</span><br><span class="line">    },</span><br><span class="line">}</span><br><span class="line"><span class="comment">//åƒä½¿ç”¨è‡ªå·±çš„å­—æ®µä¸€æ ·ï¼Œç›´æ¥ä½¿ç”¨</span></span><br><span class="line">fmt.Println(p.province)</span><br></pre></td></tr></tbody></table></figure>

<p>ç±»å‹ç»„åˆåï¼Œå¤–éƒ¨ç±»å‹ä¸ä»…å¯ä»¥ä½¿ç”¨å†…éƒ¨ç±»å‹çš„å­—æ®µï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨å†…éƒ¨ç±»å‹çš„æ–¹æ³•ï¼Œå°±åƒä½¿ç”¨è‡ªå·±çš„æ–¹æ³•ä¸€æ ·ã€‚<br><strong>æ–¹æ³•è¦†å†™</strong>ï¼šå¦‚æœå¤–éƒ¨ç±»å‹å®šä¹‰äº†å’Œå†…éƒ¨ç±»å‹åŒæ ·çš„æ–¹æ³•ï¼Œé‚£ä¹ˆå¤–éƒ¨ç±»å‹çš„ä¼šè¦†ç›–å†…éƒ¨ç±»å‹ï¼Œè¿™å°±æ˜¯ã€‚</p>
<h3 id="ç±»å‹æ–­è¨€"><a href="#ç±»å‹æ–­è¨€" class="headerlink" title="ç±»å‹æ–­è¨€"></a>ç±»å‹æ–­è¨€</h3><p>ç±»å‹æ–­è¨€ç”¨æ¥åˆ¤æ–­ä¸€ä¸ªæ¥å£çš„å€¼æ˜¯å¦æ˜¯å®ç°è¯¥æ¥å£çš„æŸä¸ªå…·ä½“ç±»å‹ã€‚</p>
<p>æ¥å£å¼•ç”¨æ‹¥æœ‰æ–­è¨€èƒ½åŠ›ï¼Œç”¨äºåˆ¤æ–­å½“å‰å¼•ç”¨æ˜¯å¦å±äºæŸä¸ªå¯¹è±¡çš„å®ä¾‹</p>
<figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// æ¥å£å¼•ç”¨æŒ‡å‘å­ç±»å®ä¾‹</span></span><br><span class="line"><span class="keyword">var</span> myInterface MyInterface = NewTest(<span class="string">"test"</span>, <span class="number">18</span>, <span class="string">"test"</span>)</span><br><span class="line"><span class="comment">// åˆ¤æ–­myInterfaceæ˜¯å¦æ˜¯Testç±»å‹</span></span><br><span class="line"><span class="keyword">if</span> _, ok := myInterface.(*Test);!ok {</span><br><span class="line">  <span class="built_in">panic</span>(<span class="string">"myInterface ä¸æ˜¯ Testå®ä¾‹"</span>)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><strong>åœ¨ç±»å‹æ–­è¨€çš„æ—¶å€™ï¼ŒåŒæ—¶å®Œæˆäº†ç±»å‹è½¬æ¢</strong></p>
<h2 id="Error"><a href="#Error" class="headerlink" title="Error"></a>Error</h2><p>åœ¨ Go è¯­è¨€ä¸­ï¼Œé”™è¯¯æ˜¯é€šè¿‡å†…ç½®çš„ error æ¥å£è¡¨ç¤ºçš„ï¼š</p>
<figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// error å®šä¹‰</span></span><br><span class="line"><span class="keyword">type</span> <span class="type">error</span> <span class="keyword">interface</span> {</span><br><span class="line">   Error() <span class="type">string</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// å·¥å‚å‡½æ•°</span></span><br><span class="line">errors.New(<span class="string">"error"</span>)</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<p><strong>è‡ªå®šä¹‰å¼‚å¸¸</strong></p>
<figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> commonError <span class="keyword">struct</span> {</span><br><span class="line">  errorCode <span class="type">int</span>    <span class="comment">//é”™è¯¯ç </span></span><br><span class="line">  errorMsg  <span class="type">string</span> <span class="comment">//é”™è¯¯ä¿¡æ¯</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"> <span class="comment">// å®ç°äº†Error()å°±æ˜¯è‡ªå®šä¹‰å¼‚å¸¸ </span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(ce *commonError)</span></span> Error() <span class="type">string</span> {</span><br><span class="line">  <span class="keyword">return</span> ce.errorMsg</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="Error-Wrapping"><a href="#Error-Wrapping" class="headerlink" title="Error Wrapping"></a>Error Wrapping</h3><p>ä¸Šè¿°è‡ªå®šä¹‰å¼‚å¸¸å¯ä»¥æ»¡è¶³æˆ‘ä»¬çš„éœ€æ±‚ï¼Œä½†æ˜¯éå¸¸çƒ¦çï¼Œå› ä¸ºæ—¢è¦å®šä¹‰æ–°çš„ç±»å‹è¿˜è¦å®ç° error æ¥å£ã€‚</p>
<p> Go è¯­è¨€ 1.13 ç‰ˆæœ¬å¼€å§‹ï¼ŒGo æ ‡å‡†åº“æ–°å¢äº† Error Wrapping åŠŸèƒ½ï¼Œè®©æˆ‘ä»¬å¯ä»¥åŸºäºä¸€ä¸ªå­˜åœ¨çš„ error ç”Ÿæˆæ–°çš„ errorï¼Œå¹¶ä¸”å¯ä»¥ä¿ç•™åŸ error ä¿¡æ¯ã€‚</p>
<figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// wrap</span></span><br><span class="line">e := errors.New(<span class="string">"åŸå§‹é”™è¯¯e"</span>)</span><br><span class="line">w := fmt.Errorf(<span class="string">"Wrapäº†ä¸€ä¸ªé”™è¯¯:%w"</span>, e)</span><br><span class="line">fmt.Println(w)   <span class="comment">// wrapäº†ä¸€ä¸ªé”™è¯¯:åŸå§‹é”™è¯¯e</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Unwrap</span></span><br><span class="line">fmt.Println(errors.Unwrap(w))   <span class="comment">// åŸå§‹é”™è¯¯e</span></span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<h3 id="errors-Is"><a href="#errors-Is" class="headerlink" title="errors.Is"></a>errors.Is</h3><p>æœ‰äº† Error Wrapping åï¼Œä½ ä¼šå‘ç°åŸæ¥ç”¨çš„åˆ¤æ–­ä¸¤ä¸ª error æ˜¯ä¸æ˜¯åŒä¸€ä¸ª error çš„æ–¹æ³•å¤±æ•ˆäº†ï¼Œæ¯”å¦‚ Go è¯­è¨€æ ‡å‡†åº“ç»å¸¸ç”¨åˆ°çš„å¦‚ä¸‹ä»£ç ä¸­çš„æ–¹å¼ï¼š</p>
<figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line">fmt.Println(errors.Is(w, e))  <span class="comment">// true</span></span><br><span class="line">fmt.Println(e == os.ErrExist) <span class="comment">// false</span></span><br></pre></td></tr></tbody></table></figure>

<p><code>errors.ls</code></p>
<figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Is</span><span class="params">(err, target <span class="type">error</span>)</span></span> <span class="type">bool</span></span><br></pre></td></tr></tbody></table></figure>

<p>ä»¥ä¸Šå°±æ˜¯errors.Is å‡½æ•°çš„å®šä¹‰ï¼Œå¯ä»¥è§£é‡Šä¸ºï¼š</p>
<ul>
<li>å¦‚æœ err å’Œ target æ˜¯åŒä¸€ä¸ªï¼Œé‚£ä¹ˆè¿”å› trueã€‚</li>
<li>å¦‚æœ err æ˜¯ä¸€ä¸ª wrapping errorï¼Œtarget ä¹ŸåŒ…å«åœ¨è¿™ä¸ªåµŒå¥— error é“¾ä¸­çš„è¯ï¼Œä¹Ÿè¿”å› trueã€‚</li>
</ul>
<blockquote>
<p>ğŸ“Œå¯ä»¥ç®€å•åœ°æ¦‚æ‹¬ä¸ºï¼Œä¸¤ä¸ª error ç›¸ç­‰æˆ– err åŒ…å« target çš„æƒ…å†µä¸‹è¿”å› trueï¼Œå…¶ä½™è¿”å› falseã€‚</p>
</blockquote>
<h3 id="errors-As"><a href="#errors-As" class="headerlink" title="errors.As"></a>errors.As</h3><p>åŒæ ·çš„åŸå› ï¼Œæœ‰äº† error åµŒå¥—åï¼Œerror æ–­è¨€ä¹Ÿä¸èƒ½ç”¨äº†ï¼Œå› ä¸ºä½ ä¸çŸ¥é“ä¸€ä¸ª error æ˜¯å¦è¢«åµŒå¥—ï¼ŒåˆåµŒå¥—äº†å‡ å±‚ã€‚æ‰€ä»¥ Go è¯­è¨€ä¸ºè§£å†³è¿™ä¸ªé—®é¢˜æä¾›äº† errors.As å‡½æ•°ï¼Œæ¯”å¦‚å‰é¢ error æ–­è¨€çš„ä¾‹å­ï¼Œå¯ä»¥ä½¿ç”¨  errors.As å‡½æ•°é‡å†™ï¼Œæ•ˆæœæ˜¯ä¸€æ ·çš„ï¼Œå¦‚ä¸‹é¢çš„ä»£ç æ‰€ç¤ºï¼š</p>
<figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> cm *commonError</span><br><span class="line"><span class="keyword">if</span> errors.As(err,&amp;cm){</span><br><span class="line">   fmt.Println(<span class="string">"é”™è¯¯ä»£ç ä¸º:"</span>,cm.errorCode,<span class="string">"ï¼Œé”™è¯¯ä¿¡æ¯ä¸ºï¼š"</span>,cm.errorMsg)</span><br><span class="line">} <span class="keyword">else</span> {</span><br><span class="line">   fmt.Println(sum)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="Deferred"><a href="#Deferred" class="headerlink" title="Deferred"></a>Deferred</h3><p>defer è¯­å¥å¸¸è¢«ç”¨äºæˆå¯¹çš„æ“ä½œï¼Œå¦‚æ–‡ä»¶çš„æ‰“å¼€å’Œå…³é—­ï¼ŒåŠ é”å’Œé‡Šæ”¾é”ï¼Œè¿æ¥çš„å»ºç«‹å’Œæ–­å¼€ç­‰ã€‚ä¸ç®¡å¤šä¹ˆå¤æ‚çš„æ“ä½œï¼Œéƒ½å¯ä»¥ä¿è¯èµ„æºè¢«æ­£ç¡®åœ°é‡Šæ”¾ã€‚</p>
<figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ReadFile</span><span class="params">(filename <span class="type">string</span>)</span></span> ([]<span class="type">byte</span>, <span class="type">error</span>) {</span><br><span class="line">   f, err := os.Open(filename)</span><br><span class="line">   <span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">   }</span><br><span class="line">   <span class="keyword">defer</span> f.Close()</span><br><span class="line">   <span class="comment">//çœç•¥æ— å…³ä»£ç </span></span><br><span class="line">   <span class="keyword">return</span> readAll(f, n)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<ol>
<li>åœ¨ä¸€ä¸ªæ–¹æ³•æˆ–è€…å‡½æ•°ä¸­ï¼Œå¯ä»¥æœ‰å¤šä¸ª defer è¯­å¥ï¼›</li>
<li>defer æœ‰ä¸€ä¸ªè°ƒç”¨æ ˆï¼Œå¤šä¸ª defer è¯­å¥çš„æ‰§è¡Œé¡ºåºä¾ç…§<strong>åè¿›å…ˆå‡º</strong>çš„åŸåˆ™ã€‚</li>
</ol>
<h3 id="Panic"><a href="#Panic" class="headerlink" title="Panic"></a>Panic</h3><p>Go è¯­è¨€æ˜¯ä¸€é—¨é™æ€çš„å¼ºç±»å‹è¯­è¨€ï¼Œå¾ˆå¤šé—®é¢˜éƒ½å°½å¯èƒ½åœ°åœ¨ç¼–è¯‘æ—¶æ•è·ï¼Œä½†æ˜¯æœ‰ä¸€äº›åªèƒ½åœ¨è¿è¡Œæ—¶æ£€æŸ¥ï¼Œæ¯”å¦‚æ•°ç»„è¶Šç•Œè®¿é—®ã€ä¸ç›¸åŒçš„ç±»å‹å¼ºåˆ¶è½¬æ¢ç­‰ï¼Œè¿™ç±»è¿è¡Œæ—¶çš„é—®é¢˜ä¼šå¼•èµ· panic å¼‚å¸¸ã€‚é™¤äº†è¿è¡Œæ—¶å¯ä»¥äº§ç”Ÿ panic å¤–ï¼Œæˆ‘ä»¬è‡ªå·±ä¹Ÿå¯ä»¥æŠ›å‡º panic å¼‚å¸¸ã€‚</p>
<figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">panic</span><span class="params">(v <span class="keyword">interface</span>{})</span></span></span><br></pre></td></tr></tbody></table></figure>

<blockquote>
<p><code>interface{}</code> æ˜¯ç©ºæ¥å£çš„æ„æ€ï¼Œåœ¨ Go è¯­è¨€ä¸­ä»£è¡¨ä»»æ„ç±»å‹ã€‚</p>
</blockquote>
<p>panic å¼‚å¸¸æ˜¯ä¸€ç§éå¸¸ä¸¥é‡çš„æƒ…å†µï¼Œä¼šè®©ç¨‹åºä¸­æ–­è¿è¡Œï¼Œä½¿ç¨‹åºå´©æºƒï¼Œæ‰€ä»¥<strong>å¦‚æœæ˜¯ä¸å½±å“ç¨‹åºè¿è¡Œçš„é”™è¯¯ï¼Œä¸è¦ä½¿ç”¨ panicï¼Œä½¿ç”¨æ™®é€šé”™è¯¯ error å³å¯ã€‚</strong></p>
<h4 id="Recover-æ•è·-Panic-å¼‚å¸¸"><a href="#Recover-æ•è·-Panic-å¼‚å¸¸" class="headerlink" title="Recover æ•è· Panic å¼‚å¸¸"></a>Recover æ•è· Panic å¼‚å¸¸</h4><p>é€šå¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¸å¯¹ panic å¼‚å¸¸åšä»»ä½•å¤„ç†ï¼Œå› ä¸ºæ—¢ç„¶å®ƒæ˜¯å½±å“ç¨‹åºè¿è¡Œçš„å¼‚å¸¸ï¼Œå°±è®©å®ƒç›´æ¥å´©æºƒå³å¯ã€‚ä½†æ˜¯ä¹Ÿçš„ç¡®æœ‰ä¸€äº›ç‰¹ä¾‹ï¼Œæ¯”å¦‚<strong>åœ¨****ç¨‹åºå´©æºƒå‰åšä¸€äº›èµ„æºé‡Šæ”¾çš„å¤„ç†</strong>ï¼Œè¿™æ—¶å€™å°±éœ€è¦ä» panic å¼‚å¸¸ä¸­æ¢å¤ï¼Œæ‰èƒ½å®Œæˆå¤„ç†ã€‚</p>
<figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">connectMySQL</span><span class="params">(ip, username, password <span class="type">string</span>)</span></span> {</span><br><span class="line">  <span class="keyword">if</span> ip == <span class="string">""</span> {</span><br><span class="line">    <span class="built_in">panic</span>(<span class="string">"ipä¸èƒ½ä¸ºç©º"</span>)</span><br><span class="line">  }</span><br><span class="line">  <span class="comment">//çœç•¥å…¶ä»–ä»£ç </span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">  <span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> {</span><br><span class="line">    <span class="keyword">if</span> p := <span class="built_in">recover</span>(); p != <span class="literal">nil</span> {</span><br><span class="line">      fmt.Println(p)</span><br><span class="line">    }</span><br><span class="line">  }()</span><br><span class="line">  connectMySQL(<span class="string">""</span>, <span class="string">"root"</span>, <span class="string">"123456"</span>)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h1 id="å¹¶å‘åŸºç¡€"><a href="#å¹¶å‘åŸºç¡€" class="headerlink" title="å¹¶å‘åŸºç¡€"></a>å¹¶å‘åŸºç¡€</h1><h2 id="åç¨‹ï¼ˆGoroutineï¼‰"><a href="#åç¨‹ï¼ˆGoroutineï¼‰" class="headerlink" title="åç¨‹ï¼ˆGoroutineï¼‰"></a>åç¨‹ï¼ˆGoroutineï¼‰</h2><p>Go è¯­è¨€ä¸­æ²¡æœ‰çº¿ç¨‹çš„æ¦‚å¿µï¼Œåªæœ‰åç¨‹ï¼Œä¹Ÿç§°ä¸º goroutineã€‚</p>
<figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">go</span> function()</span><br></pre></td></tr></tbody></table></figure>

<h2 id="Channel"><a href="#Channel" class="headerlink" title="Channel"></a>Channel</h2><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line">ch:=<span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">string</span>)</span><br></pre></td></tr></tbody></table></figure>

<ol>
<li>æ¥æ”¶ï¼šè·å– chan ä¸­çš„å€¼ï¼Œæ“ä½œç¬¦ä¸º<code> &lt;- chan</code>ã€‚</li>
<li>å‘é€ï¼šå‘ chan å‘é€å€¼ï¼ŒæŠŠå€¼æ”¾åœ¨ chan ä¸­ï¼Œæ“ä½œç¬¦ä¸º <code>chan &lt;-</code>ã€‚</li>
</ol>
<h3 id="æ— ç¼“å†²-channel"><a href="#æ— ç¼“å†²-channel" class="headerlink" title="æ— ç¼“å†² channel"></a><strong>æ— ç¼“å†² channel</strong></h3><p>æ— ç¼“å†² channelï¼Œå®ƒçš„å®¹é‡æ˜¯ 0ï¼Œä¸èƒ½å­˜å‚¨ä»»ä½•æ•°æ®ã€‚æ‰€ä»¥æ— ç¼“å†² channel åªèµ·åˆ°ä¼ è¾“æ•°æ®çš„ä½œç”¨ï¼Œæ•°æ®å¹¶ä¸ä¼šåœ¨ channel ä¸­åšä»»ä½•åœç•™ã€‚è¿™ä¹Ÿæ„å‘³ç€ï¼Œæ— ç¼“å†² channel çš„å‘é€å’Œæ¥æ”¶æ“ä½œæ˜¯åŒæ—¶è¿›è¡Œçš„ï¼Œå®ƒä¹Ÿå¯ä»¥ç§°ä¸ºåŒæ­¥ channelã€‚</p>
<h3 id="æœ‰ç¼“å†²-channel"><a href="#æœ‰ç¼“å†²-channel" class="headerlink" title="æœ‰ç¼“å†² channel"></a>æœ‰ç¼“å†² channel</h3><p>æœ‰ç¼“å†² channel ç±»ä¼¼ä¸€ä¸ªå¯é˜»å¡çš„é˜Ÿåˆ—ï¼Œå†…éƒ¨çš„å…ƒç´ <em><strong>å…ˆè¿›å…ˆå‡º</strong></em>ã€‚é€šè¿‡ make å‡½æ•°çš„ç¬¬äºŒä¸ªå‚æ•°å¯ä»¥æŒ‡å®š channel å®¹é‡çš„å¤§å°ï¼Œè¿›è€Œåˆ›å»ºä¸€ä¸ªæœ‰ç¼“å†² channelã€‚</p>
<figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line">cacheCh:=<span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">int</span>,<span class="number">5</span>)</span><br></pre></td></tr></tbody></table></figure>

<p><img src="/../images/Go%E8%AF%AD%E8%A8%80%E5%9F%BA%E7%A1%80/CgqCHl-7fzmAVLu0AACSjW-neAE188_bGrO7t8IpW.png"></p>
<p>ä¸€ä¸ªæœ‰ç¼“å†² channel å…·å¤‡ä»¥ä¸‹ç‰¹ç‚¹ï¼š</p>
<ol>
<li>æœ‰ç¼“å†² channel çš„å†…éƒ¨æœ‰ä¸€ä¸ªç¼“å†²é˜Ÿåˆ—ï¼›</li>
<li>å‘é€æ“ä½œæ˜¯å‘é˜Ÿåˆ—çš„å°¾éƒ¨æ’å…¥å…ƒç´ ï¼Œå¦‚æœé˜Ÿåˆ—å·²æ»¡ï¼Œåˆ™é˜»å¡ç­‰å¾…ï¼Œç›´åˆ°å¦ä¸€ä¸ª goroutine æ‰§è¡Œï¼Œæ¥æ”¶æ“ä½œé‡Šæ”¾é˜Ÿåˆ—çš„ç©ºé—´ï¼›</li>
<li>æ¥æ”¶æ“ä½œæ˜¯ä»é˜Ÿåˆ—çš„å¤´éƒ¨è·å–å…ƒç´ å¹¶æŠŠå®ƒä»é˜Ÿåˆ—ä¸­åˆ é™¤ï¼Œå¦‚æœé˜Ÿåˆ—ä¸ºç©ºï¼Œåˆ™é˜»å¡ç­‰å¾…ï¼Œç›´åˆ°å¦ä¸€ä¸ª goroutine æ‰§è¡Œï¼Œå‘é€æ“ä½œæ’å…¥æ–°çš„å…ƒç´ ã€‚</li>
</ol>
<figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// è·å–é˜Ÿåˆ—å®¹é‡å’Œå…ƒç´ ä¸ªæ•°ï¼š</span></span><br><span class="line">fmt.Println(<span class="string">"cacheChå®¹é‡ä¸º:"</span>,<span class="built_in">cap</span>(cacheCh),<span class="string">",å…ƒç´ ä¸ªæ•°ä¸ºï¼š"</span>,<span class="built_in">len</span>(cacheCh))</span><br><span class="line"></span><br><span class="line"><span class="comment">// å…³é—­ channel</span></span><br><span class="line"><span class="built_in">close</span>(cacheCh)</span><br></pre></td></tr></tbody></table></figure>

<p>å¦‚æœä¸€ä¸ª channel è¢«å…³é—­äº†ï¼Œå°±ä¸èƒ½å‘é‡Œé¢å‘é€æ•°æ®äº†ï¼Œå¦‚æœå‘é€çš„è¯ï¼Œä¼šå¼•èµ· painc å¼‚å¸¸ã€‚ä½†æ˜¯è¿˜å¯ä»¥æ¥æ”¶ channel é‡Œçš„æ•°æ®ï¼Œå¦‚æœ channel é‡Œæ²¡æœ‰æ•°æ®çš„è¯ï¼Œæ¥æ”¶çš„æ•°æ®æ˜¯å…ƒç´ ç±»å‹çš„é›¶å€¼ã€‚</p>
<h3 id="å•å‘-channel"><a href="#å•å‘-channel" class="headerlink" title="å•å‘ channel"></a>å•å‘ channel</h3><p>æœ‰æ—¶å€™ï¼Œæˆ‘ä»¬æœ‰ä¸€äº›ç‰¹æ®Šçš„ä¸šåŠ¡éœ€æ±‚ï¼Œæ¯”å¦‚é™åˆ¶ä¸€ä¸ª channel åªå¯ä»¥æ¥æ”¶ä½†æ˜¯ä¸èƒ½å‘é€ï¼Œæˆ–è€…é™åˆ¶ä¸€ä¸ª channel åªèƒ½å‘é€ä½†ä¸èƒ½æ¥æ”¶ï¼Œè¿™ç§ channel ç§°ä¸ºå•å‘ channelã€‚</p>
<figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line">onlySend := <span class="built_in">make</span>(<span class="keyword">chan</span>&lt;- <span class="type">int</span>)</span><br><span class="line">onlyReceive:=<span class="built_in">make</span>(&lt;-<span class="keyword">chan</span> <span class="type">int</span>)</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<h3 id="select-å¤šè·¯å¤ç”¨"><a href="#select-å¤šè·¯å¤ç”¨" class="headerlink" title="select å¤šè·¯å¤ç”¨"></a>select å¤šè·¯å¤ç”¨</h3><blockquote>
<p>å°æç¤ºï¼šå¤šè·¯å¤ç”¨å¯ä»¥ç®€å•åœ°ç†è§£ä¸ºï¼ŒN ä¸ª channel ä¸­ï¼Œä»»æ„ä¸€ä¸ª channel æœ‰æ•°æ®äº§ç”Ÿï¼Œselect éƒ½å¯ä»¥ç›‘å¬åˆ°ï¼Œç„¶åæ‰§è¡Œç›¸åº”çš„åˆ†æ”¯ï¼Œæ¥æ”¶æ•°æ®å¹¶å¤„ç†ã€‚</p>
</blockquote>
<figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> {</span><br><span class="line">   <span class="keyword">case</span> i1 = &lt;-c1:</span><br><span class="line">     <span class="comment">//todo</span></span><br><span class="line">   <span class="keyword">case</span> c2 &lt;- i2:</span><br><span class="line">     <span class="comment">//todo</span></span><br><span class="line">   <span class="keyword">default</span>:</span><br><span class="line">     <span class="comment">// default todo</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h2 id="sync-åŒ…"><a href="#sync-åŒ…" class="headerlink" title="sync åŒ…"></a>sync åŒ…</h2><blockquote>
<p>å°æŠ€å·§ï¼šä½¿ç”¨ go buildã€go runã€go test è¿™äº› Go è¯­è¨€å·¥å…·é“¾æä¾›çš„å‘½ä»¤æ—¶ï¼Œæ·»åŠ  <code>-race</code> æ ‡è¯†å¯ä»¥å¸®ä½ æ£€æŸ¥ Go è¯­è¨€ä»£ç æ˜¯å¦å­˜åœ¨èµ„æºç«äº‰ã€‚</p>
</blockquote>
<h3 id="sync-Mutex"><a href="#sync-Mutex" class="headerlink" title="sync.Mutex"></a><strong>sync.Mutex</strong></h3><p>äº’æ–¥é”ï¼Œé¡¾åæ€ä¹‰ï¼ŒæŒ‡çš„æ˜¯åœ¨åŒä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªåç¨‹æ‰§è¡ŒæŸæ®µä»£ç ï¼Œå…¶ä»–åç¨‹éƒ½è¦ç­‰å¾…è¯¥åç¨‹æ‰§è¡Œå®Œæ¯•åæ‰èƒ½ç»§ç»­æ‰§è¡Œã€‚</p>
<p>Mutex çš„ <code>Lock</code> å’Œ <code>Unlock</code> æ–¹æ³•æ€»æ˜¯æˆå¯¹å‡ºç°ï¼Œè€Œä¸”è¦ç¡®ä¿ Lock è·å¾—é”åï¼Œä¸€å®šæ‰§è¡Œ UnLock é‡Šæ”¾é”</p>
<figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">var</span>(</span><br><span class="line">   sum <span class="type">int</span></span><br><span class="line">   mutex sync.Mutex</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">add</span><span class="params">(i <span class="type">int</span>)</span></span> {</span><br><span class="line">   mutex.Lock()</span><br><span class="line">   sum += i</span><br><span class="line">   mutex.Unlock()</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<blockquote>
<p>å°æç¤ºï¼šä»¥ä¸Šè¢«åŠ é”ä¿æŠ¤çš„ sum+=i ä»£ç ç‰‡æ®µåˆç§°ä¸º<strong>ä¸´ç•ŒåŒº</strong>ã€‚åœ¨åŒæ­¥çš„ç¨‹åºè®¾è®¡ä¸­ï¼Œä¸´ç•ŒåŒºæ®µæŒ‡çš„æ˜¯ä¸€ä¸ªè®¿é—®å…±äº«èµ„æºçš„ç¨‹åºç‰‡æ®µï¼Œè€Œè¿™äº›å…±äº«èµ„æºåˆæœ‰æ— æ³•åŒæ—¶è¢«å¤šä¸ªåç¨‹è®¿é—®çš„ç‰¹æ€§ã€‚</p>
</blockquote>
<h3 id="sync-RWMutex"><a href="#sync-RWMutex" class="headerlink" title="sync.RWMutex"></a>sync.RWMutex</h3><p>goä¸­çš„è¯»å†™é”ã€‚ä½¿ç”¨ï¼š</p>
<figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> mutex sync.RWMutex</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">readSum</span><span class="params">()</span></span> <span class="type">int</span> {</span><br><span class="line"></span><br><span class="line">   <span class="comment">//åªè·å–è¯»é”</span></span><br><span class="line">   mutex.RLock()</span><br><span class="line">   <span class="keyword">defer</span> mutex.RUnlock()</span><br><span class="line">   b:=sum</span><br><span class="line"></span><br><span class="line">   <span class="keyword">return</span> b</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="sync-WaitGroup"><a href="#sync-WaitGroup" class="headerlink" title="sync.WaitGroup"></a>sync.WaitGroup</h3><p>ç›¸å½“äºJavaä¸­çš„***<code>CountDownLatch</code>***ï¼Œç”¨äºæœ€ç»ˆå®Œæˆçš„åœºæ™¯ï¼Œå…³é”®ç‚¹åœ¨äºä¸€å®šè¦ç­‰å¾…æ‰€æœ‰åç¨‹éƒ½æ‰§è¡Œå®Œæ¯•ã€‚</p>
<figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">run</span><span class="params">()</span></span>{</span><br><span class="line"></span><br><span class="line">   <span class="keyword">var</span> wg sync.WaitGroup</span><br><span class="line"></span><br><span class="line">   <span class="comment">//å› ä¸ºè¦ç›‘æ§110ä¸ªåç¨‹ï¼Œæ‰€ä»¥è®¾ç½®è®¡æ•°å™¨ä¸º110</span></span><br><span class="line">   wg.Add(<span class="number">110</span>)</span><br><span class="line">   <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">100</span>; i++ {</span><br><span class="line">      <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> {</span><br><span class="line">         <span class="comment">//è®¡æ•°å™¨å€¼å‡1</span></span><br><span class="line">         <span class="keyword">defer</span> wg.Done()</span><br><span class="line">         add(<span class="number">10</span>)</span><br><span class="line">      }()</span><br><span class="line">   }</span><br><span class="line"></span><br><span class="line">   <span class="keyword">for</span> i:=<span class="number">0</span>; i&lt;<span class="number">10</span>;i++ {</span><br><span class="line">      <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> {</span><br><span class="line">         <span class="comment">//è®¡æ•°å™¨å€¼å‡1</span></span><br><span class="line">         <span class="keyword">defer</span> wg.Done()</span><br><span class="line">         fmt.Println(<span class="string">"å’Œä¸º:"</span>,readSum())</span><br><span class="line">      }()</span><br><span class="line">   }</span><br><span class="line"></span><br><span class="line">   <span class="comment">//ä¸€ç›´ç­‰å¾…ï¼Œç›´åˆ°è®¡æ•°å™¨å€¼ä¸º0</span></span><br><span class="line">   wg.Wait()</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="sync-Once"><a href="#sync-Once" class="headerlink" title="sync.Once"></a>sync.Once</h3><p>è®©ä»£ç åªæ‰§è¡Œä¸€æ¬¡ï¼Œå“ªæ€•æ˜¯åœ¨é«˜å¹¶å‘çš„æƒ…å†µä¸‹ï¼Œæ¯”å¦‚åˆ›å»ºä¸€ä¸ªå•ä¾‹ã€‚</p>
<figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">   doOnce()</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">doOnce</span><span class="params">()</span></span> {</span><br><span class="line">   <span class="keyword">var</span> once sync.Once</span><br><span class="line">   onceBody := <span class="function"><span class="keyword">func</span><span class="params">()</span></span> {</span><br><span class="line">      fmt.Println(<span class="string">"Only once"</span>)</span><br><span class="line">   }</span><br><span class="line"></span><br><span class="line">   <span class="comment">//ç”¨äºç­‰å¾…åç¨‹æ‰§è¡Œå®Œæ¯•</span></span><br><span class="line">   done := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">bool</span>)</span><br><span class="line"></span><br><span class="line">   <span class="comment">//å¯åŠ¨10ä¸ªåç¨‹æ‰§è¡Œonce.Do(onceBody)</span></span><br><span class="line">   <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ {</span><br><span class="line">      <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> {</span><br><span class="line">         <span class="comment">//æŠŠè¦æ‰§è¡Œçš„å‡½æ•°(æ–¹æ³•)ä½œä¸ºå‚æ•°ä¼ ç»™once.Doæ–¹æ³•å³å¯</span></span><br><span class="line">         once.Do(onceBody)</span><br><span class="line">         done &lt;- <span class="literal">true</span></span><br><span class="line">      }()</span><br><span class="line">   }</span><br><span class="line"></span><br><span class="line">   <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ {</span><br><span class="line">      &lt;-done</span><br><span class="line">   }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="sync-Cond"><a href="#sync-Cond" class="headerlink" title="sync.Cond"></a>sync.Cond</h3><p>sync.Cond å¯ä»¥ç”¨äºå‘å·æ–½ä»¤ï¼Œä¸€å£°ä»¤ä¸‹æ‰€æœ‰åç¨‹éƒ½å¯ä»¥å¼€å§‹æ‰§è¡Œï¼Œå…³é”®ç‚¹åœ¨äºåç¨‹å¼€å§‹çš„æ—¶å€™æ˜¯ç­‰å¾…çš„ï¼Œè¦ç­‰å¾… sync.Cond å”¤é†’æ‰èƒ½æ‰§è¡Œã€‚</p>
<figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">//10ä¸ªäººèµ›è·‘ï¼Œ1ä¸ªè£åˆ¤å‘å·æ–½ä»¤</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">race</span><span class="params">()</span></span>{</span><br><span class="line"></span><br><span class="line">   cond :=sync.NewCond(&amp;sync.Mutex{})</span><br><span class="line">   <span class="keyword">var</span> wg sync.WaitGroup</span><br><span class="line">   wg.Add(<span class="number">11</span>)</span><br><span class="line"></span><br><span class="line">   <span class="keyword">for</span> i:=<span class="number">0</span>;i&lt;<span class="number">10</span>; i++ {</span><br><span class="line">      <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(num <span class="type">int</span>)</span></span> {</span><br><span class="line">         <span class="keyword">defer</span>  wg.Done()</span><br><span class="line">         fmt.Println(num,<span class="string">"å·å·²ç»å°±ä½"</span>)</span><br><span class="line">         cond.L.Lock()</span><br><span class="line">         cond.Wait()<span class="comment">//ç­‰å¾…å‘ä»¤æªå“</span></span><br><span class="line">         fmt.Println(num,<span class="string">"å·å¼€å§‹è·‘â€¦â€¦"</span>)</span><br><span class="line">         cond.L.Unlock()</span><br><span class="line">      }(i)</span><br><span class="line">   }</span><br><span class="line"></span><br><span class="line">   <span class="comment">//ç­‰å¾…æ‰€æœ‰goroutineéƒ½è¿›å…¥waitçŠ¶æ€</span></span><br><span class="line">   time.Sleep(<span class="number">2</span>*time.Second)</span><br><span class="line"></span><br><span class="line">   <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> {</span><br><span class="line">      <span class="keyword">defer</span>  wg.Done()</span><br><span class="line">      fmt.Println(<span class="string">"è£åˆ¤å·²ç»å°±ä½ï¼Œå‡†å¤‡å‘ä»¤æª"</span>)</span><br><span class="line">      fmt.Println(<span class="string">"æ¯”èµ›å¼€å§‹ï¼Œå¤§å®¶å‡†å¤‡è·‘"</span>)</span><br><span class="line">      cond.Broadcast()<span class="comment">//å‘ä»¤æªå“</span></span><br><span class="line">   }()</span><br><span class="line">   <span class="comment">//é˜²æ­¢å‡½æ•°æå‰è¿”å›é€€å‡º</span></span><br><span class="line">   wg.Wait()</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<ol>
<li><strong>Wait</strong>ï¼Œé˜»å¡å½“å‰åç¨‹ï¼Œç›´åˆ°è¢«å…¶ä»–åç¨‹è°ƒç”¨ Broadcast æˆ–è€… Signal æ–¹æ³•å”¤é†’ï¼Œä½¿ç”¨çš„æ—¶å€™éœ€è¦åŠ é”ï¼Œä½¿ç”¨ sync.Cond ä¸­çš„é”å³å¯ï¼Œä¹Ÿå°±æ˜¯ L å­—æ®µã€‚</li>
<li><strong>Signal</strong>ï¼Œå”¤é†’ä¸€ä¸ªç­‰å¾…æ—¶é—´æœ€é•¿çš„åç¨‹ã€‚</li>
<li><strong>Broadcast</strong>ï¼Œå”¤é†’æ‰€æœ‰ç­‰å¾…çš„åç¨‹ã€‚</li>
</ol>
<blockquote>
<p>æ³¨æ„ï¼šåœ¨è°ƒç”¨ Signal æˆ–è€… Broadcast ä¹‹å‰ï¼Œè¦ç¡®ä¿ç›®æ ‡åç¨‹å¤„äº Wait é˜»å¡çŠ¶æ€ï¼Œä¸ç„¶ä¼šå‡ºç°æ­»é”é—®é¢˜ã€‚</p>
</blockquote>
<p>å¦‚æœä½ ä»¥å‰å­¦è¿‡ Javaï¼Œä¼šå‘ç° sync.Cond å’Œ Java çš„ç­‰å¾…å”¤é†’æœºåˆ¶å¾ˆåƒï¼Œå®ƒçš„ä¸‰ä¸ªæ–¹æ³• Waitã€Signalã€Broadcast å°±åˆ†åˆ«å¯¹åº” Java ä¸­çš„ waitã€notifyã€notifyAllã€‚</p>
<h2 id="Context"><a href="#Context" class="headerlink" title="Context"></a>Context</h2><blockquote>
<p>ä¸€ä¸ªä»»åŠ¡ä¼šæœ‰å¾ˆå¤šä¸ªåç¨‹åä½œå®Œæˆï¼Œä¸€æ¬¡ HTTP è¯·æ±‚ä¹Ÿä¼šè§¦å‘å¾ˆå¤šä¸ªåç¨‹çš„å¯åŠ¨ï¼Œè€Œè¿™äº›åç¨‹æœ‰å¯èƒ½ä¼šå¯åŠ¨æ›´å¤šçš„å­åç¨‹ï¼Œå¹¶ä¸”æ— æ³•é¢„çŸ¥æœ‰å¤šå°‘å±‚åç¨‹ã€æ¯ä¸€å±‚æœ‰å¤šå°‘ä¸ªåç¨‹ã€‚</p>
<p>å¦‚æœå› ä¸ºæŸäº›åŸå› å¯¼è‡´ä»»åŠ¡ç»ˆæ­¢äº†ï¼ŒHTTP è¯·æ±‚å–æ¶ˆäº†ï¼Œé‚£ä¹ˆå®ƒä»¬å¯åŠ¨çš„åç¨‹æ€ä¹ˆåŠï¼Ÿè¯¥å¦‚ä½•å–æ¶ˆå‘¢ï¼Ÿå› ä¸ºå–æ¶ˆè¿™äº›åç¨‹å¯ä»¥èŠ‚çº¦å†…å­˜ï¼Œæå‡æ€§èƒ½ï¼ŒåŒæ—¶é¿å…ä¸å¯é¢„æ–™çš„ Bugã€‚</p>
<p>Context å°±æ˜¯ç”¨æ¥ç®€åŒ–è§£å†³è¿™äº›é—®é¢˜çš„ï¼Œå¹¶ä¸”æ˜¯å¹¶å‘å®‰å…¨çš„ã€‚Context æ˜¯ä¸€ä¸ªæ¥å£ï¼Œå®ƒå…·å¤‡æ‰‹åŠ¨ã€å®šæ—¶ã€è¶…æ—¶å‘å‡ºå–æ¶ˆä¿¡å·ã€ä¼ å€¼ç­‰åŠŸèƒ½ï¼Œä¸»è¦ç”¨äºæ§åˆ¶å¤šä¸ªåç¨‹ä¹‹é—´çš„åä½œï¼Œå°¤å…¶æ˜¯å–æ¶ˆæ“ä½œã€‚ä¸€æ—¦å–æ¶ˆæŒ‡ä»¤ä¸‹è¾¾ï¼Œé‚£ä¹ˆè¢« Context è·Ÿè¸ªçš„è¿™äº›åç¨‹éƒ½ä¼šæ”¶åˆ°å–æ¶ˆä¿¡å·ï¼Œå°±å¯ä»¥åšæ¸…ç†å’Œé€€å‡ºæ“ä½œã€‚</p>
</blockquote>
<figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> Context <span class="keyword">interface</span> {</span><br><span class="line"></span><br><span class="line">   Deadline() (deadline time.Time, ok <span class="type">bool</span>)</span><br><span class="line">   Done() &lt;-<span class="keyword">chan</span> <span class="keyword">struct</span>{}</span><br><span class="line">   Err() <span class="type">error</span></span><br><span class="line">   Value(key <span class="keyword">interface</span>{}) <span class="keyword">interface</span>{}</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="Context-æ ‘"><a href="#Context-æ ‘" class="headerlink" title="Context æ ‘"></a>Context æ ‘</h3><p>Go è¯­è¨€æä¾›äº†å‡½æ•°å¯ä»¥å¸®åŠ©æˆ‘ä»¬ç”Ÿæˆä¸åŒçš„ Contextï¼Œé€šè¿‡è¿™äº›å‡½æ•°å¯ä»¥ç”Ÿæˆä¸€é¢— Context æ ‘ï¼Œè¿™æ · Context æ‰å¯ä»¥å…³è”èµ·æ¥ï¼Œçˆ¶ Context å‘å‡ºå–æ¶ˆä¿¡å·çš„æ—¶å€™ï¼Œå­ Context ä¹Ÿä¼šå‘å‡ºï¼Œè¿™æ ·å°±å¯ä»¥æ§åˆ¶ä¸åŒå±‚çº§çš„åç¨‹é€€å‡ºã€‚</p>
<p>ä»ä½¿ç”¨åŠŸèƒ½ä¸Šåˆ†ï¼Œæœ‰å››ç§å®ç°å¥½çš„ Contextã€‚</p>
<ol>
<li><strong>ç©º Context</strong>ï¼šä¸å¯å–æ¶ˆï¼Œæ²¡æœ‰æˆªæ­¢æ—¶é—´ï¼Œä¸»è¦ç”¨äº Context æ ‘çš„æ ¹èŠ‚ç‚¹ã€‚</li>
<li><strong>å¯å–æ¶ˆçš„ Context</strong>ï¼šç”¨äºå‘å‡ºå–æ¶ˆä¿¡å·ï¼Œå½“å–æ¶ˆçš„æ—¶å€™ï¼Œå®ƒçš„å­ Context ä¹Ÿä¼šå–æ¶ˆã€‚</li>
<li><strong>å¯å®šæ—¶å–æ¶ˆçš„ Context</strong>ï¼šå¤šäº†ä¸€ä¸ªå®šæ—¶çš„åŠŸèƒ½ã€‚</li>
<li><strong>å€¼ Context</strong>ï¼šç”¨äºå­˜å‚¨ä¸€ä¸ª key-value é”®å€¼å¯¹ã€‚</li>
</ol>
<p><img src="/../images/Go%E8%AF%AD%E8%A8%80%E5%9F%BA%E7%A1%80/CgqCHl_EyHOARbBqAAKzKmhclWo807_j9j7DgBnzy.png"></p>
<p><code> context.Background()</code>è·å–ä¸€ä¸ªæ ¹èŠ‚ç‚¹ Contextã€‚</p>
<hr>
<p> Context æ ‘è¦æ€ä¹ˆç”Ÿæˆå‘¢ï¼Ÿ</p>
<ol>
<li>**<code>WithCancel(parent Context)</code>**ï¼šç”Ÿæˆä¸€ä¸ªå¯å–æ¶ˆçš„ Contextã€‚<ol>
<li>**<code>WithDeadline(parent Context, d time.Time)</code>**ï¼šç”Ÿæˆä¸€ä¸ªå¯å®šæ—¶å–æ¶ˆçš„ Contextï¼Œå‚æ•° d ä¸ºå®šæ—¶å–æ¶ˆçš„å…·ä½“æ—¶é—´ã€‚<ol>
<li>**<code>WithTimeout(parent Context, timeout time.Duration)</code>**ï¼šç”Ÿæˆä¸€ä¸ªå¯è¶…æ—¶å–æ¶ˆçš„ Contextï¼Œå‚æ•° timeout ç”¨äºè®¾ç½®å¤šä¹…åå–æ¶ˆ</li>
</ol>
</li>
</ol>
</li>
<li>**<code>WithValue(parent Context, key, val interface{})</code>**ï¼šç”Ÿæˆä¸€ä¸ªå¯æºå¸¦ key-value é”®å€¼å¯¹çš„ Contextã€‚</li>
</ol>
<p>ä»¥ä¸Šå››ä¸ªç”Ÿæˆ Context çš„å‡½æ•°ä¸­ï¼Œå‰ä¸‰ä¸ªéƒ½å±äºå¯å–æ¶ˆçš„ Contextï¼Œå®ƒä»¬æ˜¯ä¸€ç±»å‡½æ•°ï¼Œæœ€åä¸€ä¸ªæ˜¯å€¼ Contextï¼Œç”¨äºå­˜å‚¨ä¸€ä¸ª key-value é”®å€¼å¯¹ã€‚</p>
<h1 id="æŒ‡é’ˆ"><a href="#æŒ‡é’ˆ" class="headerlink" title="æŒ‡é’ˆ"></a>æŒ‡é’ˆ</h1><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">    name:=<span class="string">"xiaoming"</span></span><br><span class="line">    <span class="keyword">var</span> nameP *<span class="type">string</span> = &amp;name</span><br><span class="line">    fmt.Println(*nameP)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<ul>
<li><p>è·å–ä¸€ä¸ªå˜é‡çš„æŒ‡é’ˆéå¸¸å®¹æ˜“ï¼Œä½¿ç”¨å–åœ°å€ç¬¦ &amp; å°±å¯ä»¥</p>
</li>
<li><p>æŒ‡é’ˆç±»å‹å°±æ˜¯åœ¨å¯¹åº”çš„ç±»å‹å‰åŠ  * å·</p>
</li>
<li><p>æŒ‡é’ˆç±»å‹éå¸¸å»‰ä»·ï¼Œåªå ç”¨ 4 ä¸ªæˆ–è€… 8 ä¸ªå­—èŠ‚çš„å†…å­˜å¤§å°ã€‚</p>
</li>
<li><p><em><strong>é€šè¿‡ var å£°æ˜çš„æŒ‡é’ˆå˜é‡è¿˜æ²¡æœ‰åˆ†é…å†…å­˜</strong></em>ï¼Œå› ä¸ºè¿™æ—¶å€™å®ƒä»…ä»…æ˜¯ä¸ªå˜é‡ï¼Œæ˜¯ä¸èƒ½ç›´æ¥èµ‹å€¼å’Œå–å€¼çš„ï¼Œå®ƒçš„å€¼æ˜¯ nil </p>
<p><img src="/../images/Go%E8%AF%AD%E8%A8%80%E5%9F%BA%E7%A1%80/image_xouftL6NE6.png" alt="ç›´æ¥èµ‹å€¼å’Œå–å€¼" title="ç›´æ¥èµ‹å€¼å’Œå–å€¼"></p>
<p>è§£å†³æ–¹æ³•ï¼šå°†ä¸€å—å†…å­˜åœ°å€<code>&amp;m</code>èµ‹å€¼ç»™æŒ‡é’ˆå˜é‡<code>*p</code></p>
<figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> p *<span class="type">int</span></span><br><span class="line"><span class="keyword">var</span> m <span class="type">int</span></span><br><span class="line">p = &amp;m</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>é€šè¿‡newåˆ›å»ºçš„æŒ‡é’ˆæ˜¯å­˜åœ¨å†…å­˜åœ°å€çš„ï¼Œå¯ä»¥ç›´æ¥èµ‹å€¼</p>
<ul>
<li><code>var intP *int = new(int)</code></li>
</ul>
</li>
</ul>
<h1 id="å‚æ•°ä¼ é€’"><a href="#å‚æ•°ä¼ é€’" class="headerlink" title="å‚æ•°ä¼ é€’"></a>å‚æ•°ä¼ é€’</h1><p><strong>ä¸¥æ ¼æ¥è¯´ï¼ŒGo è¯­è¨€æ²¡æœ‰å¼•ç”¨ç±»å‹</strong>ï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥æŠŠ mapã€chan ç§°ä¸ºå¼•ç”¨ç±»å‹ï¼Œè¿™æ ·ä¾¿äºç†è§£ã€‚é™¤äº† mapã€chan ä¹‹å¤–ï¼ŒGo è¯­è¨€ä¸­çš„å‡½æ•°ã€æ¥å£ã€slice åˆ‡ç‰‡ã€æŒ‡é’ˆéƒ½å¯ä»¥ç§°ä¸ºå¼•ç”¨ç±»å‹ã€‚</p>
<p><img src="/../images/Go%E8%AF%AD%E8%A8%80%E5%9F%BA%E7%A1%80/image_B8036E8m0p.png"></p>
<p>æ€»ç»“ï¼š</p>
<p>åœ¨ Go è¯­è¨€ä¸­ï¼Œ<strong>å‡½æ•°çš„å‚æ•°ä¼ é€’åªæœ‰å€¼ä¼ é€’</strong>ï¼Œè€Œä¸”ä¼ é€’çš„å®å‚éƒ½æ˜¯åŸå§‹æ•°æ®çš„ä¸€ä»½æ‹·è´ã€‚</p>
<p>å¦‚æœæ‹·è´çš„å†…å®¹æ˜¯å€¼ç±»å‹çš„ï¼Œé‚£ä¹ˆåœ¨å‡½æ•°ä¸­å°±æ— æ³•ä¿®æ”¹åŸå§‹æ•°æ®ï¼›</p>
<p>å¦‚æœæ‹·è´çš„å†…å®¹æ˜¯æŒ‡é’ˆï¼ˆæˆ–è€…å¯ä»¥ç†è§£ä¸ºå¼•ç”¨ç±»å‹ mapã€chan ç­‰ï¼‰ï¼Œé‚£ä¹ˆå°±å¯ä»¥åœ¨å‡½æ•°ä¸­ä¿®æ”¹åŸå§‹æ•°æ®ã€‚</p>
<h1 id="å†…å­˜åˆ†é…"><a href="#å†…å­˜åˆ†é…" class="headerlink" title="å†…å­˜åˆ†é…"></a>å†…å­˜åˆ†é…</h1><ul>
<li>æŒ‡é’ˆç±»å‹çš„å˜é‡å¦‚æœæ²¡æœ‰åˆ†é…å†…å­˜ï¼Œå°±é»˜è®¤æ˜¯é›¶å€¼ nilï¼Œå®ƒæ²¡æœ‰æŒ‡å‘çš„å†…å­˜ï¼Œæ‰€ä»¥æ— æ³•ä½¿ç”¨ï¼Œå¼ºè¡Œä½¿ç”¨å°±ä¼šå¾—åˆ°ä»¥ä¸Š nil æŒ‡é’ˆé”™è¯¯</li>
<li>å¯¹äºå€¼ç±»å‹æ¥è¯´ï¼Œå³ä½¿åªå£°æ˜ä¸€ä¸ªå˜é‡ï¼Œæ²¡æœ‰å¯¹å…¶åˆå§‹åŒ–ï¼Œè¯¥å˜é‡ä¹Ÿä¼šæœ‰åˆ†é…å¥½çš„å†…å­˜ã€‚</li>
<li>ä¸¤ä¸ªå…³é”®å‡½æ•°ï¼šnewå’Œmake</li>
</ul>
<h2 id="new"><a href="#new" class="headerlink" title="new"></a>new</h2><p>new å‡½æ•°åªç”¨äºåˆ†é…å†…å­˜ï¼Œå¹¶ä¸”æŠŠå†…å­˜æ¸…é›¶ï¼Œä¹Ÿå°±æ˜¯è¿”å›ä¸€ä¸ªæŒ‡å‘å¯¹åº”ç±»å‹é›¶å€¼çš„æŒ‡é’ˆã€‚new å‡½æ•°ä¸€èˆ¬ç”¨äºéœ€è¦æ˜¾å¼åœ°è¿”å›æŒ‡é’ˆçš„æƒ…å†µï¼Œä¸æ˜¯å¤ªå¸¸ç”¨ã€‚</p>
<h2 id="make"><a href="#make" class="headerlink" title="make"></a>make</h2><p>make å‡½æ•°åªç”¨äº sliceã€chan å’Œ map è¿™ä¸‰ç§å†…ç½®ç±»å‹çš„åˆ›å»ºå’Œåˆå§‹åŒ–ï¼Œå› ä¸ºè¿™ä¸‰ç§ç±»å‹çš„ç»“æ„æ¯”è¾ƒå¤æ‚ï¼Œæ¯”å¦‚ slice è¦æå‰åˆå§‹åŒ–å¥½å†…éƒ¨å…ƒç´ çš„ç±»å‹ï¼Œslice çš„é•¿åº¦å’Œå®¹é‡ç­‰ï¼Œè¿™æ ·æ‰å¯ä»¥æ›´å¥½åœ°ä½¿ç”¨å®ƒä»¬ã€‚</p>
<h1 id="åå°„"><a href="#åå°„" class="headerlink" title="åå°„"></a>åå°„</h1><ul>
<li><p><strong><code>reflect.Value</code></strong> å’Œ**<code>reflect.Type</code>**</p>
<p>åœ¨ Go è¯­è¨€çš„åå°„å®šä¹‰ä¸­ï¼Œä»»ä½•æ¥å£éƒ½ç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼šæ¥å£çš„å…·ä½“ç±»å‹ï¼Œä»¥åŠå…·ä½“ç±»å‹å¯¹åº”çš„å€¼ã€‚æ¯”å¦‚ var i int = 3ï¼Œå› ä¸º <code>interface{}</code> å¯ä»¥è¡¨ç¤ºä»»ä½•ç±»å‹ï¼Œæ‰€ä»¥å˜é‡ i å¯ä»¥è½¬ä¸º interface{}ã€‚å…¶ä¸­ Value ä¸ºå˜é‡çš„å€¼ï¼Œå³ 3ï¼Œè€Œ Type ä¸ºå˜é‡çš„ç±»å‹ï¼Œå³ intã€‚</p>
<figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line">i:=<span class="number">3</span></span><br><span class="line">iv:=reflect.ValueOf(i)</span><br><span class="line">it:=reflect.TypeOf(i)</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>ä¿®æ”¹å˜é‡</p>
<p>è¦ä¿®æ”¹ä¸€ä¸ªå˜é‡çš„å€¼ï¼Œæœ‰å‡ ä¸ªå…³é”®ç‚¹ï¼šä¼ é€’æŒ‡é’ˆï¼ˆå¯å¯»å€ï¼‰ï¼Œé€šè¿‡ Elem æ–¹æ³•è·å–æŒ‡å‘çš„å€¼ï¼Œæ‰å¯ä»¥ä¿è¯å€¼å¯ä»¥è¢«ä¿®æ”¹ï¼Œreflect.Value ä¸ºæˆ‘ä»¬æä¾›äº† CanSet æ–¹æ³•åˆ¤æ–­æ˜¯å¦å¯ä»¥ä¿®æ”¹è¯¥å˜é‡ã€‚</p>
<figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line">ipv := reflect.ValueOf(&amp;i)</span><br><span class="line">ipv.Elem().SetInt(<span class="number">4</span>)</span><br><span class="line">fmt.Println(i)</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>åå°„çš„ä¸‰å¤§å®šå¾‹</p>
<ol>
<li>ä»»ä½•æ¥å£å€¼ <code>interface{}</code> éƒ½å¯ä»¥åå°„å‡ºåå°„å¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯ reflect.Value å’Œ reflect.Typeï¼Œé€šè¿‡å‡½æ•° reflect.ValueOf å’Œ reflect.TypeOf è·å¾—ã€‚</li>
<li>åå°„å¯¹è±¡ä¹Ÿå¯ä»¥è¿˜åŸä¸º interface{} å˜é‡ï¼Œä¹Ÿå°±æ˜¯ç¬¬ 1 æ¡å®šå¾‹çš„å¯é€†æ€§ï¼Œé€šè¿‡ reflect.Value ç»“æ„ä½“çš„ Interface æ–¹æ³•è·å¾—ã€‚</li>
<li>è¦ä¿®æ”¹åå°„çš„å¯¹è±¡ï¼Œè¯¥å€¼å¿…é¡»å¯è®¾ç½®ï¼Œä¹Ÿå°±æ˜¯å¯å¯»å€ï¼Œå‚è€ƒä¸ŠèŠ‚è¯¾ä¿®æ”¹å˜é‡çš„å€¼é‚£ä¸€èŠ‚çš„å†…å®¹ç†è§£ã€‚</li>
</ol>
</li>
</ul>
<h1 id="SliceHeader"><a href="#SliceHeader" class="headerlink" title="SliceHeader"></a>SliceHeader</h1><ul>
<li><p>åœ¨ Go è¯­è¨€ä¸­ï¼Œåˆ‡ç‰‡å…¶å®æ˜¯ä¸€ä¸ªç»“æ„ä½“ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š</p>
<p><img src="/../images/Go%E8%AF%AD%E8%A8%80%E5%9F%BA%E7%A1%80/image_GCPR--tEED.png"></p>
<p>SliceHeader æ˜¯åˆ‡ç‰‡åœ¨è¿è¡Œæ—¶çš„è¡¨ç°å½¢å¼ï¼Œå®ƒæœ‰ä¸‰ä¸ªå­—æ®µ Dataã€Len å’Œ Capã€‚</p>
<ol>
<li>Data ç”¨æ¥æŒ‡å‘å­˜å‚¨åˆ‡ç‰‡å…ƒç´ çš„æ•°ç»„ã€‚</li>
<li>Len ä»£è¡¨åˆ‡ç‰‡çš„é•¿åº¦ã€‚</li>
<li>Cap ä»£è¡¨åˆ‡ç‰‡çš„å®¹é‡ã€‚</li>
</ol>
</li>
<li><p>ä¼˜ç‚¹</p>
<ol>
<li>æ”¯æŒåŠ¨æ€æ‰©å®¹</li>
<li>åˆ‡ç‰‡çš„æœ¬è´¨æ˜¯ SliceHeaderï¼Œåˆå› ä¸ºå‡½æ•°çš„å‚æ•°æ˜¯å€¼ä¼ é€’ï¼Œæ‰€ä»¥ä¼ é€’çš„æ˜¯ SliceHeader çš„å‰¯æœ¬ï¼Œè€Œä¸æ˜¯åº•å±‚æ•°ç»„çš„å‰¯æœ¬ã€‚è¿™æ—¶å€™åˆ‡ç‰‡çš„ä¼˜åŠ¿å°±ä½“ç°å‡ºæ¥äº†ï¼Œå› ä¸º SliceHeader çš„å‰¯æœ¬å†…å­˜å ç”¨éå¸¸å°‘ï¼Œå³ä½¿æ˜¯ä¸€ä¸ªéå¸¸å¤§çš„åˆ‡ç‰‡ï¼Œä¹Ÿé¡¶å¤šå ç”¨ 24 ä¸ªå­—èŠ‚çš„å†…å­˜ï¼Œè¿™å°±è§£å†³äº†å¤§æ•°ç»„åœ¨ä¼ å‚æ—¶å†…å­˜æµªè´¹çš„é—®é¢˜ã€‚</li>
</ol>
</li>
</ul>
<h1 id="æµ‹è¯•"><a href="#æµ‹è¯•" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h1><ul>
<li>æµ‹è¯•æ–‡ä»¶ä»¥_test.goç»“å°¾</li>
<li>æµ‹è¯•å‡½æ•°ä»¥Testxxxï¼ˆxxxä¸ºæµ‹è¯•å‡½æ•°åï¼‰å¼€å¤´</li>
</ul>
<p>å‡è®¾ç¼–å†™çš„å‡½æ•°åœ¨<em>ch18/main.go</em>ä¸­ï¼š<code>go test -v ./ch18</code></p>
<hr>
<ul>
<li>go test -v â€“coverprofile=ch18.cover ./ch18ï¼šå¾—åˆ°ä¸€ä¸ªå•å…ƒæµ‹è¯•è¦†ç›–ç‡æ–‡ä»¶</li>
</ul>
<h2 id="åŸºå‡†æµ‹è¯•"><a href="#åŸºå‡†æµ‹è¯•" class="headerlink" title="åŸºå‡†æµ‹è¯•"></a>åŸºå‡†æµ‹è¯•</h2><p>è¡¡é‡ä»£ç çš„æ€§èƒ½</p>
<ul>
<li><p>å‡½æ•°å¿…é¡»ä»¥ Benchmark å¼€å¤´</p>
</li>
<li><p>å‡½æ•°çš„ç­¾åå¿…é¡»æ¥æ”¶ä¸€ä¸ªæŒ‡å‘ testing.B ç±»å‹çš„æŒ‡é’ˆï¼Œå¹¶ä¸”ä¸èƒ½è¿”å›ä»»ä½•å€¼ï¼›</p>
</li>
<li><p>æœ€åçš„ for å¾ªç¯å¾ˆé‡è¦ï¼Œè¢«æµ‹è¯•çš„ä»£ç è¦æ”¾åˆ°å¾ªç¯é‡Œï¼›</p>
</li>
<li><p>b.N æ˜¯åŸºå‡†æµ‹è¯•æ¡†æ¶æä¾›çš„ï¼Œè¡¨ç¤ºå¾ªç¯çš„æ¬¡æ•°ï¼Œå› ä¸ºéœ€è¦åå¤è°ƒç”¨æµ‹è¯•çš„ä»£ç ï¼Œæ‰å¯ä»¥è¯„ä¼°æ€§èƒ½ã€‚</p>
</li>
<li><p>è¿è¡Œï¼š<code>go test -bench=. ./ch18</code></p>
<p><img src="/../images/Go%E8%AF%AD%E8%A8%80%E5%9F%BA%E7%A1%80/image_TRt00J58vX.png"></p>
</li>
<li><p>è®¡æ—¶æ–¹æ³•</p>
<p><img src="/../images/Go%E8%AF%AD%E8%A8%80%E5%9F%BA%E7%A1%80/image_3wVKmmQ8bg.png"></p>
</li>
<li><p>å†…å­˜ç»Ÿè®¡</p>
<p><img src="/../images/Go%E8%AF%AD%E8%A8%80%E5%9F%BA%E7%A1%80/image_MfFsm1QCxq.png"></p>
</li>
<li><p>å¹¶å‘åŸºå‡†æµ‹è¯•</p>
<p><img src="/../images/Go%E8%AF%AD%E8%A8%80%E5%9F%BA%E7%A1%80/image_MgQUA96T3S.png"></p>
</li>
</ul>
<h1 id="æ³›å‹"><a href="#æ³›å‹" class="headerlink" title="æ³›å‹"></a>æ³›å‹</h1><p>Goçš„æ³›å‹ä½¿ç”¨<code>interface</code>å®ç°</p>
<ul>
<li>an approximation element <code>~T</code> restricts to all types whose underlying type is T: ä»£è¡¨åº•å±‚ç±»å‹æ˜¯<code>T</code></li>
<li>a union element <code>T1 | T2 | ...</code> restricts to any of the listed elements: ä»£è¡¨<code>æˆ–</code>,ç±»å‹åˆ—è¡¨ä¹‹ä¸€ã€‚</li>
</ul>
<figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// ä»»æ„ç±»å‹ any</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">f</span>[<span class="title">T1</span>, <span class="title">T2</span> <span class="title">any</span>]<span class="params">(x <span class="type">int</span>, y T1)</span></span> T2 {</span><br><span class="line">    ...</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Integer <span class="keyword">interface</span> {</span><br><span class="line">  Signed | Unsigned</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Signed <span class="keyword">interface</span> {</span><br><span class="line">  ~<span class="type">int</span> | ~<span class="type">int8</span> | ~<span class="type">int16</span> | ~<span class="type">int32</span> | ~<span class="type">int64</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Unsigned <span class="keyword">interface</span> {</span><br><span class="line">  ~<span class="type">uint</span> | ~<span class="type">uint8</span> | ~<span class="type">uint16</span> | ~<span class="type">uint32</span> | ~<span class="type">uint64</span> | ~<span class="type">uintptr</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ³›å‹æŠ½è±¡</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Abs</span>[<span class="title">T</span> <span class="title">Integer</span>]<span class="params">(input T)</span></span> T {</span><br><span class="line">  <span class="keyword">if</span> input &lt; <span class="number">0</span> {</span><br><span class="line">    <span class="keyword">return</span> -input</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">return</span> input</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
]]></content>
      <categories>
        <category>å­¦ä¹ ç¬”è®°</category>
      </categories>
      <tags>
        <tag>golang</tag>
      </tags>
  </entry>
  <entry>
    <title>JUCåŸºç¡€</title>
    <url>/2023/09/03/JUC%E5%9F%BA%E7%A1%80/</url>
    <content><![CDATA[<h1 id="åŸºç¡€çŸ¥è¯†"><a href="#åŸºç¡€çŸ¥è¯†" class="headerlink" title="åŸºç¡€çŸ¥è¯†"></a>åŸºç¡€çŸ¥è¯†</h1><h2 id="çº¿ç¨‹çš„çŠ¶æ€"><a href="#çº¿ç¨‹çš„çŠ¶æ€" class="headerlink" title="çº¿ç¨‹çš„çŠ¶æ€"></a>çº¿ç¨‹çš„çŠ¶æ€</h2><p>çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸåˆ†ä¸ºäº”ç§çŠ¶æ€ï¼š</p>
<ul>
<li>æ–°ç”Ÿ <code>NEW</code></li>
<li>è¿è¡Œ <code>RUNNABLE</code></li>
<li>é˜»å¡ <code>BLOCKED</code></li>
<li>ç­‰å¾… <code>WAITING</code></li>
<li>è¶…æ—¶ç­‰å¾…<code>TIME_WAITING</code></li>
<li>ç»ˆæ­¢ <code>TERMINATED</code></li>
</ul>
<p>åœ¨æ“ä½œç³»ç»Ÿå±‚é¢ï¼Œçº¿ç¨‹æœ‰ READY å’Œ RUNNING çŠ¶æ€ï¼›è€Œåœ¨ JVM å±‚é¢ï¼Œåªèƒ½çœ‹åˆ° RUNNABLE çŠ¶æ€</p>
<span id="more"></span>

<p><strong>ä¸ºä»€ä¹ˆ JVM æ²¡æœ‰åŒºåˆ†è¿™ä¸¤ç§çŠ¶æ€å‘¢ï¼Ÿ</strong> </p>
<p> ç°åœ¨çš„æ—¶åˆ†å¤šä»»åŠ¡æ“ä½œç³»ç»Ÿæ¶æ„é€šå¸¸éƒ½æ˜¯ç”¨æ‰€è°“çš„â€œæ—¶é—´åˆ†ç‰‡â€æ–¹å¼è¿›è¡ŒæŠ¢å å¼è½®è½¬è°ƒåº¦ã€‚è¿™ä¸ªæ—¶é—´åˆ†ç‰‡é€šå¸¸æ˜¯å¾ˆå°çš„ï¼Œä¸€ä¸ªçº¿ç¨‹ä¸€æ¬¡æœ€å¤šåªèƒ½åœ¨ CPU ä¸Šè¿è¡Œæ¯”å¦‚ 10-20ms çš„æ—¶é—´ï¼ˆæ­¤æ—¶å¤„äº running çŠ¶æ€ï¼‰ï¼Œä¹Ÿå³å¤§æ¦‚åªæœ‰ 0.01 ç§’è¿™ä¸€é‡çº§ï¼Œæ—¶é—´ç‰‡ç”¨åå°±è¦è¢«åˆ‡æ¢ä¸‹æ¥æ”¾å…¥è°ƒåº¦é˜Ÿåˆ—çš„æœ«å°¾ç­‰å¾…å†æ¬¡è°ƒåº¦ã€‚ï¼ˆä¹Ÿå³å›åˆ° ready çŠ¶æ€ï¼‰ã€‚<em>çº¿ç¨‹åˆ‡æ¢çš„å¦‚æ­¤ä¹‹å¿«ï¼ŒåŒºåˆ†è¿™ä¸¤ç§çŠ¶æ€å°±æ²¡ä»€ä¹ˆæ„ä¹‰äº†ã€‚</em></p>
<h2 id="wait-sleep"><a href="#wait-sleep" class="headerlink" title="wait/sleep"></a>wait/sleep</h2><p><strong>åŒºåˆ«</strong>ï¼š</p>
<ul>
<li><p><strong><code>sleep()</code></strong>** æ–¹æ³•æ²¡æœ‰é‡Šæ”¾é”ï¼Œè€Œ <strong><strong><code>wait()</code></strong></strong> æ–¹æ³•é‡Šæ”¾äº†é”** ã€‚è¿™æ˜¯å› ä¸º<code>sleep()</code> æ˜¯ <code>Thread</code> ç±»çš„é™æ€æœ¬åœ°æ–¹æ³•ï¼Œä¸ä¼šæ“ä½œå¯¹è±¡é”ï¼Œè€Œ<code>wait()</code> åˆ™æ˜¯ <code>Object</code> ç±»çš„æœ¬åœ°æ–¹æ³•ï¼Œè®©è·å¾—å¯¹è±¡é”çš„çº¿ç¨‹å®ç°ç­‰å¾…</p>
</li>
<li><p><code>wait()</code> æ–¹æ³•è¢«è°ƒç”¨åï¼Œ<em>çº¿ç¨‹ä¸ä¼šè‡ªåŠ¨è‹é†’</em>ï¼Œéœ€è¦åˆ«çš„çº¿ç¨‹è°ƒç”¨åŒä¸€ä¸ªå¯¹è±¡ä¸Šçš„ <code>notify()</code>æˆ–è€… <code>notifyAll()</code> æ–¹æ³•ã€‚<code>sleep()</code>æ–¹æ³•æ‰§è¡Œå®Œæˆåï¼Œçº¿ç¨‹ä¼šè‡ªåŠ¨è‹é†’ï¼Œæˆ–è€…ä¹Ÿå¯ä»¥ä½¿ç”¨ <code>wait(long timeout)</code> è¶…æ—¶åçº¿ç¨‹ä¼šè‡ªåŠ¨è‹é†’ã€‚</p>
</li>
</ul>
<p>å› æ­¤ï¼Œ<code>wait()</code> é€šå¸¸è¢«ç”¨äºçº¿ç¨‹é—´äº¤äº’/é€šä¿¡ï¼Œ<code>sleep()</code>é€šå¸¸è¢«ç”¨äºæš‚åœå½“å‰çº¿ç¨‹çš„æ‰§è¡Œã€‚</p>
<p><strong>ä¸ºä»€ä¹ˆ wait() æ–¹æ³•ä¸å®šä¹‰åœ¨ Thread ä¸­ï¼Ÿ</strong></p>
<p><code>wait()</code> æ˜¯è®©è·å¾—å¯¹è±¡é”çš„çº¿ç¨‹å®ç°ç­‰å¾…ï¼Œä¼šè‡ªåŠ¨é‡Šæ”¾å½“å‰çº¿ç¨‹å æœ‰çš„å¯¹è±¡é”ã€‚æ¯ä¸ªå¯¹è±¡éƒ½æ‹¥æœ‰å¯¹è±¡é”ï¼Œæ—¢ç„¶è¦é‡Šæ”¾å½“å‰çº¿ç¨‹å æœ‰çš„å¯¹è±¡é”å¹¶è®©å…¶è¿›å…¥ç­‰å¾…çŠ¶æ€ï¼Œè‡ªç„¶æ˜¯è¦æ“ä½œå¯¹åº”çš„å¯¹è±¡è€Œéå½“å‰çš„çº¿ç¨‹ã€‚</p>
<h2 id="Synchronized"><a href="#Synchronized" class="headerlink" title="Synchronized"></a>Synchronized</h2><p><strong>å…¬å¹³é”ï¼š</strong> ååˆ†å…¬å¹³ï¼Œå¿…é¡»å…ˆæ¥ååˆ°ï¼›</p>
<p><strong>éå…¬å¹³é”ï¼š</strong> ååˆ†ä¸å…¬å¹³ï¼Œå¯ä»¥æ’é˜Ÿï¼›**(é»˜è®¤)**</p>
<h2 id="Locké”"><a href="#Locké”" class="headerlink" title="Locké”"></a>Locké”</h2><p>lockä¸‰éƒ¨æ›²</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="number">1.</span> Lock lock=<span class="keyword">new</span> <span class="title class_">ReentrantLock</span>();</span><br><span class="line"></span><br><span class="line"><span class="number">2.</span> lock.lock() åŠ é”</span><br><span class="line"></span><br><span class="line"><span class="number">3.</span> <span class="keyword">finally</span>=&gt; è§£é”ï¼šlock.unlock();</span><br></pre></td></tr></tbody></table></figure>

<h2 id="Synchronizedé”-ä¸Locké”-çš„åŒºåˆ«"><a href="#Synchronizedé”-ä¸Locké”-çš„åŒºåˆ«" class="headerlink" title="Synchronizedé” ä¸Locké” çš„åŒºåˆ«"></a>Synchronizedé” ä¸Locké” çš„åŒºåˆ«</h2><ul>
<li>Synchronized æ— æ³•åˆ¤æ–­è·å–<strong>é”çš„çŠ¶æ€</strong>ï¼ŒLockå¯ä»¥åˆ¤æ–­</li>
<li>Synchronized ä¼š<strong>è‡ªåŠ¨é‡Šæ”¾é”</strong>ï¼Œlockå¿…é¡»è¦æ‰‹åŠ¨åŠ é”å’Œæ‰‹åŠ¨é‡Šæ”¾é”ï¼å¯èƒ½ä¼šé‡åˆ°æ­»é”</li>
<li>Synchronized çº¿ç¨‹1(è·å¾—é”-&gt;é˜»å¡)ã€çº¿ç¨‹2(ç­‰å¾…)ï¼›lockå°±ä¸ä¸€å®šä¼šä¸€ç›´ç­‰å¾…ä¸‹å»ï¼Œlockä¼šæœ‰ä¸€ä¸ª<strong>trylock</strong>å»å°è¯•è·å–é”ï¼Œä¸ä¼šé€ æˆé•¿ä¹…çš„ç­‰å¾…ã€‚</li>
<li>Synchronized <strong>æ˜¯å¯é‡å…¥é”</strong>ï¼Œä¸å¯ä»¥ä¸­æ–­çš„ï¼Œ<strong>éå…¬å¹³çš„</strong>ï¼›Lockæ˜¯å¯é‡å…¥çš„ï¼Œå¯ä»¥åˆ¤æ–­é”ï¼Œå¯ä»¥è‡ªå·±è®¾ç½®å…¬å¹³é”å’Œéå…¬å¹³é”ï¼›</li>
<li>Synchronized é€‚åˆé”å°‘é‡çš„ä»£ç åŒæ­¥é—®é¢˜ï¼ŒLocké€‚åˆé”å¤§é‡çš„åŒæ­¥ä»£ç ï¼›</li>
</ul>
<h2 id="Callableæ¥å£"><a href="#Callableæ¥å£" class="headerlink" title="Callableæ¥å£"></a>Callableæ¥å£</h2><p>å®ç°ç±»ï¼š<code>FutureTask</code>ï¼Œå¯ä»¥è·å–åˆ°çº¿ç¨‹æ‰§è¡Œå®Œæ¯•çš„ç»“æœ</p>
<p><code>Callable</code>ä¸<code>Runable</code>çš„åŒºåˆ«ï¼š</p>
<ul>
<li><code>Callable</code>å¯ä»¥æœ‰è¿”å›å€¼</li>
<li><code>Callable</code>å¯ä»¥æŠ›å‡ºå¼‚å¸¸ï¼Œè€Œ<code>Runnable</code>ä¸èƒ½æŠ›å‡ºè¢«æ£€æŸ¥çš„å¼‚å¸¸</li>
<li>å¯åŠ¨æ–¹æ³•ä¸åŒ</li>
</ul>
<h2 id="çº¿ç¨‹å®‰å…¨ç±»é›†åˆ"><a href="#çº¿ç¨‹å®‰å…¨ç±»é›†åˆ" class="headerlink" title="çº¿ç¨‹å®‰å…¨ç±»é›†åˆ"></a>çº¿ç¨‹å®‰å…¨ç±»é›†åˆ</h2><h3 id="Listç±»"><a href="#Listç±»" class="headerlink" title="Listç±»"></a>Listç±»</h3><ul>
<li><p><code>Vector</code></p>
</li>
<li><p><code>Collections.synchronizedList()</code></p>
</li>
<li><p><code>CopyOnWriteArrayList</code></p>
<p>  é€‚ç”¨äºè¯»å¤šå†™å°‘çš„åœºæ™¯</p>
<p>  æ ¸å¿ƒæ€æƒ³æ˜¯ï¼šå¦‚æœæœ‰å¤šä¸ªè°ƒç”¨è€…åŒæ—¶è¦æ±‚ç›¸åŒçš„èµ„æºï¼Œä»–ä»¬ä¼šå…±åŒè·å–ç›¸åŒçš„æŒ‡é’ˆæŒ‡å‘ç›¸åŒçš„èµ„æºï¼Œç›´åˆ°æŸä¸ªè°ƒç”¨è€…è§†å›¾ä¿®æ”¹èµ„æºå†…å®¹æ—¶ï¼Œç³»ç»Ÿæ‰ä¼šçœŸæ­£å¤åˆ¶ä¸€ä»½ä¸“ç”¨å‰¯æœ¬ç»™è¯¥è°ƒç”¨è€…ï¼Œè€Œå…¶ä»–è°ƒç”¨è€…æ‰€è§åˆ°çš„æœ€åˆçš„èµ„æºä»ç„¶ä¿æŒä¸å˜ã€‚</p>
<p>  è¯»çš„æ—¶å€™ä¸éœ€è¦åŠ é”ï¼Œå¦‚æœè¯»çš„æ—¶å€™æœ‰å¤šä¸ªçº¿ç¨‹æ­£åœ¨å‘CopyOnWriteArrayListæ·»åŠ æ•°æ®ï¼Œè¯»è¿˜æ˜¯ä¼šè¯»åˆ°æ—§çš„æ•°æ®ï¼Œå› ä¸ºå†™çš„æ—¶å€™ä¸ä¼šé”ä½æ—§çš„CopyOnWriteArrayListã€‚</p>
</li>
</ul>
<p>**<code>CopyOnWriteArrayList</code><strong>æ¯”</strong><code>Vector</code>**åŒºåˆ«ï¼Ÿ</p>
<ul>
<li>**<code>Vector</code><strong>åº•å±‚æ˜¯ä½¿ç”¨</strong><code>synchronized</code>**å…³é”®å­—æ¥å®ç°çš„ï¼Œæ•ˆç‡ä½ä¸‹</li>
<li>**<code>CopyOnWriteArrayList</code>**ä½¿ç”¨çš„æ˜¯Locké”ï¼Œæ›´åŠ é«˜æ•ˆ</li>
</ul>
<h3 id="Setç±»"><a href="#Setç±»" class="headerlink" title="Setç±»"></a>Setç±»</h3><ul>
<li><code>Collections.synchronizedSet()</code></li>
<li><code>CopyOnWriteArraySet</code></li>
</ul>
<h3 id="Mapç±»"><a href="#Mapç±»" class="headerlink" title="Mapç±»"></a>Mapç±»</h3><ul>
<li><code>Collections.synchronizedMap()</code></li>
<li><code>ConcurrentHashMap</code></li>
<li><code>HashTable</code></li>
</ul>
<h1 id="çº¿ç¨‹é€šä¿¡"><a href="#çº¿ç¨‹é€šä¿¡" class="headerlink" title="çº¿ç¨‹é€šä¿¡"></a>çº¿ç¨‹é€šä¿¡</h1><h2 id="ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…é—®é¢˜"><a href="#ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…é—®é¢˜" class="headerlink" title="ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…é—®é¢˜"></a>ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…é—®é¢˜</h2><p>è¿™æ˜¯ä¸€ä¸ªç»å…¸çš„çº¿ç¨‹é€šä¿¡é—®é¢˜ã€‚ä¸¤ç»„çº¿ç¨‹å…±äº«ä¸€ä¸ªç¼“å†²åŒºã€‚ç”Ÿäº§è€…å°†æ•°æ®æ”¾å…¥ç¼“å†²åŒºï¼Œæ¶ˆè´¹è€…å°†æ•°æ®ä»ç¼“å†²åŒºå–å‡º</p>
<p>demoå¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ProviderConsumer</span>{</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">num</span>  <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ¤æ–­ç­‰å¾…ã€ä¸šåŠ¡ã€é€šçŸ¥</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">increment</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException {</span><br><span class="line">        <span class="keyword">if</span> (num &gt; <span class="number">0</span>) {</span><br><span class="line">            <span class="built_in">this</span>.wait();</span><br><span class="line">        }</span><br><span class="line">        num++;</span><br><span class="line">       System.out.println(Thread.currentThread().getName() + <span class="string">" increment num "</span> + num);</span><br><span class="line">        <span class="built_in">this</span>.notifyAll();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">decrement</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException {</span><br><span class="line">        <span class="keyword">if</span> (num == <span class="number">0</span>) {</span><br><span class="line">            <span class="built_in">this</span>.wait();</span><br><span class="line">        }</span><br><span class="line">        num--;</span><br><span class="line">       System.out.println(Thread.currentThread().getName() + <span class="string">" decrement num "</span> + num);</span><br><span class="line">        <span class="built_in">this</span>.notifyAll();</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">        <span class="type">ProviderConsumer</span> <span class="variable">providerConsumer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ProviderConsumer</span>();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; {</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) {</span><br><span class="line">                <span class="keyword">try</span> {</span><br><span class="line">                    providerConsumer.increment();</span><br><span class="line">                } <span class="keyword">catch</span> (InterruptedException e) {</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        }, <span class="string">"A"</span>).start();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; {</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) {</span><br><span class="line">                <span class="keyword">try</span> {</span><br><span class="line">                    providerConsumer.decrement();</span><br><span class="line">                } <span class="keyword">catch</span> (InterruptedException e) {</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        }, <span class="string">"B"</span>).start();</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<p><strong>è™šå‡å”¤é†’é—®é¢˜</strong></p>
<blockquote>
<p>å½“ä¸€å®šçš„æ¡ä»¶è§¦å‘æ—¶ä¼šå”¤é†’å¾ˆå¤šåœ¨é˜»å¡æ€çš„çº¿ç¨‹ï¼Œä½†åªæœ‰éƒ¨åˆ†çš„çº¿ç¨‹å”¤é†’æ˜¯æœ‰ç”¨çš„ï¼Œå…¶ä½™çº¿ç¨‹çš„å”¤é†’æ˜¯å¤šä½™çš„ã€‚  </p>
</blockquote>
<p>  <a href="https://blog.csdn.net/weixin_45668482/article/details/117373700?ydreferer=aHR0cHM6Ly9jbi5iaW5nLmNvbS8=">https://blog.csdn.net/weixin_45668482/article/details/117373700?ydreferer=aHR0cHM6Ly9jbi5iaW5nLmNvbS8%3D</a></p>
<p>è§£å†³è™šå‡å”¤é†’é—®é¢˜ï¼šåº”è¯¥å°†å”¤é†’æ”¾åœ¨å¾ªç¯ä¸­ï¼Œä¸æ»¡è¶³æ¡ä»¶éœ€è¦ç»§ç»­ç­‰å¾…</p>
<p>æ¢å¥è¯è¯´ï¼šå°†ifæ›¿æ¢æˆwhileã€‚å½“ä½¿ç”¨<code>notifyAll()</code>æ—¶ï¼Œæ‰€æœ‰çš„çº¿ç¨‹éƒ½å°†è¢«å”¤é†’ï¼Œå¦‚æœä½¿ç”¨çš„æ˜¯ifï¼Œä¸ä¼šå†æ¬¡è¿›è¡Œæ¡ä»¶åˆ¤æ–­ï¼Œå› æ­¤è¢«å”¤é†’çš„å¯èƒ½æ˜¯æ¶ˆè´¹è€…ï¼Œä¹Ÿå¯èƒ½æ˜¯ç”Ÿäº§è€…ã€‚è€Œä½¿ç”¨whileçš„æ—¶å€™ï¼Œä¼šå†æ¬¡è¿›è¡Œç­‰å¾…åˆ¤æ–­ï¼Œä»è€Œé¿å…è™šå‡å”¤é†’é—®é¢˜ã€‚</p>
<h3 id="Lock-Conditionå®ç°"><a href="#Lock-Conditionå®ç°" class="headerlink" title="Lock + Conditionå®ç°"></a>Lock + Conditionå®ç°</h3><p>Locké”çš„Conditionå¯ä»¥ç²¾å‡†é€šçŸ¥å”¤é†’çš„çº¿ç¨‹ï¼Œä»è€Œ<strong>æ§åˆ¶å¤šä¸ªçº¿ç¨‹çš„æ‰§è¡Œé¡ºåº</strong></p>
<p>demoï¼šå¤šä¸ªçº¿ç¨‹è½®æµè¾“å‡ºA B C</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">TestCondition</span> {</span><br><span class="line">    <span class="keyword">private</span> <span class="type">Lock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>();</span><br><span class="line">    <span class="keyword">private</span> <span class="type">Condition</span> <span class="variable">condition1</span> <span class="operator">=</span> lock.newCondition();</span><br><span class="line">    <span class="keyword">private</span> <span class="type">Condition</span> <span class="variable">condition2</span> <span class="operator">=</span> lock.newCondition();</span><br><span class="line">    <span class="keyword">private</span> <span class="type">Condition</span> <span class="variable">condition3</span> <span class="operator">=</span> lock.newCondition();</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">num</span> <span class="operator">=</span> <span class="number">1</span>; <span class="comment">// 1A 2B 3C</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">printA</span><span class="params">()</span> {</span><br><span class="line">        lock.lock();</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="comment">// ä¸šåŠ¡ä»£ç  åˆ¤æ–­ -&gt; æ‰§è¡Œ -&gt; é€šçŸ¥</span></span><br><span class="line">            <span class="keyword">while</span> (num != <span class="number">1</span>) {</span><br><span class="line">                condition1.await();</span><br><span class="line">            }</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">"==&gt; AAAA"</span> );</span><br><span class="line">            num = <span class="number">2</span>;</span><br><span class="line">            condition2.signal();</span><br><span class="line">        }<span class="keyword">catch</span> (Exception e) {</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        }<span class="keyword">finally</span> {</span><br><span class="line">            lock.unlock();</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">printB</span><span class="params">()</span> {</span><br><span class="line">        lock.lock();</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="keyword">while</span> (num != <span class="number">2</span>) {</span><br><span class="line">                condition2.await();</span><br><span class="line">            }</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">"==&gt; BBBB"</span> );</span><br><span class="line">            num = <span class="number">3</span>;</span><br><span class="line">            condition3.signal();</span><br><span class="line">        }<span class="keyword">catch</span> (Exception e) {</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        }<span class="keyword">finally</span> {</span><br><span class="line">            lock.unlock();</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">printC</span><span class="params">()</span> {</span><br><span class="line">        lock.lock();</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="keyword">while</span> (num != <span class="number">3</span>) {</span><br><span class="line">                condition3.await();</span><br><span class="line">            }</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">"==&gt; CCCC"</span> );</span><br><span class="line">            num = <span class="number">1</span>;</span><br><span class="line">            condition1.signal();</span><br><span class="line">        }<span class="keyword">catch</span> (Exception e) {</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        }<span class="keyword">finally</span> {</span><br><span class="line">            lock.unlock();</span><br><span class="line">        }</span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure>

<h3 id="BlockingQueueå®ç°ç”Ÿäº§è€…æ¶ˆè´¹è€…é—®é¢˜"><a href="#BlockingQueueå®ç°ç”Ÿäº§è€…æ¶ˆè´¹è€…é—®é¢˜" class="headerlink" title="BlockingQueueå®ç°ç”Ÿäº§è€…æ¶ˆè´¹è€…é—®é¢˜"></a>BlockingQueueå®ç°ç”Ÿäº§è€…æ¶ˆè´¹è€…é—®é¢˜</h3><p>BlockingQueueæ˜¯Javaè‡ªå¸¦çš„é˜»å¡é˜Ÿåˆ—ï¼Œå†…éƒ¨çš„åŸç†ä¹Ÿæ˜¯ä½¿ç”¨äº†ReentrantLock + Conditionå®ç°</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">    BlockingQueue&lt;Object&gt; queue = <span class="keyword">new</span> <span class="title class_">ArrayBlockingQueue</span>&lt;&gt;(<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">Runnable</span> <span class="variable">producer</span> <span class="operator">=</span> () -&gt; {</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) {</span><br><span class="line">            <span class="keyword">try</span> {</span><br><span class="line">                queue.put(<span class="keyword">new</span> <span class="title class_">Object</span>());</span><br><span class="line">            } <span class="keyword">catch</span> (InterruptedException e) {</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    };</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(producer).start();</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(producer).start();</span><br><span class="line">    </span><br><span class="line">    <span class="type">Runnable</span> <span class="variable">consumer</span> <span class="operator">=</span> () -&gt; {</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) {</span><br><span class="line">            <span class="keyword">try</span> {</span><br><span class="line">                queue.take();</span><br><span class="line">            } <span class="keyword">catch</span> (InterruptedException e) {</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    };</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(consumer).start();</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(consumer).start();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h1 id="Javaä¸­çš„çº¿ç¨‹åä½œ"><a href="#Javaä¸­çš„çº¿ç¨‹åä½œ" class="headerlink" title="Javaä¸­çš„çº¿ç¨‹åä½œ"></a>Javaä¸­çš„çº¿ç¨‹åä½œ</h1><h3 id="CountDownLatch"><a href="#CountDownLatch" class="headerlink" title="CountDownLatch"></a>CountDownLatch</h3><p>å€’è®¡æ•°é”å­˜å™¨ï¼Œå¯ä»¥ç”¨ä½œä¸€ä¸ª<strong>ç®€å•çš„å¼€/å…³é”å­˜å™¨ï¼Œæˆ–è€…é—¨</strong>ï¼šæ‰€æœ‰çº¿ç¨‹è°ƒç”¨<code>await()</code>åœ¨é—¨å£ç­‰å¾…ï¼Œç›´åˆ°è¢«è°ƒç”¨<code>countDown()</code>çš„çº¿ç¨‹æ‰“å¼€ã€‚</p>
<p>CountDownLatchä¸€ä¸ªæœ‰ç”¨çš„å±æ€§æ˜¯ï¼Œå®ƒä¸è¦æ±‚è°ƒç”¨countDownçº¿ç¨‹ç­‰å¾…è®¡æ•°åˆ°è¾¾é›¶ä¹‹å‰ç›¸äº’ç­‰å¾…ï¼Œå®ƒåªæ˜¯é˜»æ­¢ä»»ä½•çº¿ç¨‹é€šè¿‡awaitï¼Œç›´åˆ°æ‰€æœ‰çº¿ç¨‹å¯ä»¥é€šè¿‡ã€‚</p>
<p>å¸¸ç”¨æ–¹æ³•ï¼š</p>
<ul>
<li>**<code>countDown()</code>**å‡ä¸€æ“ä½œï¼›</li>
<li><strong><code>await()</code></strong> ç­‰å¾…è®¡æ•°å™¨å½’é›¶</li>
</ul>
<h3 id="CyclickBarrier"><a href="#CyclickBarrier" class="headerlink" title="CyclickBarrier"></a>CyclickBarrier</h3><p>å¾ªç¯å±éšœï¼Œå®ƒå…è®¸ä¸€ç»„çº¿ç¨‹å…¨éƒ¨ç­‰å¾…å½¼æ­¤è¾¾åˆ°å…±åŒå±éšœç‚¹çš„åŒæ­¥è¾…åŠ©ã€‚å¾ªç¯é˜»å¡åœ¨æ¶‰åŠå›ºå®šå¤§å°çš„çº¿ç¨‹æ–¹çš„ç¨‹åºä¸­å¾ˆæœ‰ç”¨ï¼Œè¿™äº›çº¿ç¨‹å¿…é¡»å¶å°”ç­‰å¾…å½¼æ­¤ã€‚å±éšœè¢«ç§°ä¸ºå¾ªç¯ï¼Œå› ä¸ºå®ƒå¯ä»¥åœ¨ç­‰å¾…çš„çº¿ç¨‹è¢«é‡Šæ”¾ä¹‹åé‡æ–°ä½¿ç”¨ã€‚</p>
<p>å¸¸ç”¨æ–¹æ³•åŒ…æ‹¬ï¼š</p>
<ul>
<li><strong><code>await()</code></strong>: è°ƒç”¨è¯¥æ–¹æ³•çš„çº¿ç¨‹åˆ°è¾¾å±éšœç‚¹ï¼Œå¹¶ç­‰å¾…å…¶ä»–çº¿ç¨‹åˆ°è¾¾ã€‚å¦‚æœæ˜¯æœ€åä¸€ä¸ªåˆ°è¾¾çš„çº¿ç¨‹ï¼Œå°†æ‰§è¡Œå¯é€‰çš„ä»»åŠ¡ã€‚</li>
<li><code>await(long timeout, TimeUnit unit)</code>: è°ƒç”¨è¯¥æ–¹æ³•çš„çº¿ç¨‹åˆ°è¾¾å±éšœç‚¹ï¼Œå¹¶ç­‰å¾…å…¶ä»–çº¿ç¨‹åˆ°è¾¾ï¼Œä½†æœ€å¤šç­‰å¾…æŒ‡å®šçš„æ—¶é—´ã€‚</li>
<li><code>getParties()</code>: è¿”å›éœ€è¦åˆ°è¾¾å±éšœç‚¹çš„æ€»çº¿ç¨‹æ•°ã€‚</li>
<li><code>isBroken()</code>: æ£€æŸ¥å±éšœæ˜¯å¦è¢«ç ´åï¼ˆæ˜¯å¦æœ‰çº¿ç¨‹ç­‰å¾…è¶…æ—¶ï¼‰ã€‚</li>
</ul>
<p>**<code>CyclicBarrier </code>****ä¸ ****<code>CountDownLatch </code>**<strong>åŒºåˆ«</strong></p>
<ul>
<li><code>CountDownLatch</code>æ˜¯ä¸€æ¬¡æ€§çš„ï¼Œ<code>CyclicBarrier</code> æ˜¯å¯ä»¥é‡ç”¨çš„</li>
<li><code>CountDownLatch</code>ä¸­æœ‰ä¸¤ä¸ªå…³é”®ï¼Œä¸€ä¸ªæ˜¯<code>countDown()</code>ï¼Œä¸€ä¸ªæ˜¯<code>awit()</code>ï¼Œè°ƒç”¨<code>awit()</code>çš„çº¿ç¨‹éœ€è¦ç­‰å¾…ï¼Œè°ƒç”¨<code>countDown()</code>çš„çº¿ç¨‹ä¼šå°†å€’è®¡æ—¶-1ï¼Œä¸åŒçš„çº¿ç¨‹èŒè´£å¯èƒ½æ˜¯ä¸åŒçš„ï¼Œè¢«ç®¡ç†çš„æ˜¯è°ƒç”¨äº†<code>awit()</code>çš„çº¿ç¨‹ï¼Œè®¡æ•°å™¨å¯ä»¥æ˜¯å•ç‹¬çš„é€»è¾‘ã€‚</li>
</ul>
<h3 id="Semaphore"><a href="#Semaphore" class="headerlink" title="Semaphore"></a>Semaphore</h3><p>ä¿¡å·é‡ï¼Œç”¨äºæ§åˆ¶åŒæ—¶è®¿é—®æŸä¸ªèµ„æºçš„çº¿ç¨‹æ•°é‡ã€‚å®ƒå¯ä»¥ç”¨æ¥é™åˆ¶å¹¶å‘è®¿é—®çš„çº¿ç¨‹æ•°ï¼Œæˆ–è€…ç”¨äºçº¿ç¨‹é—´çš„ä¿¡å·é€šçŸ¥ã€‚</p>
<p><code>Semaphore</code> ç»´æŠ¤äº†ä¸€ç»„è®¸å¯ï¼ˆpermitsï¼‰ï¼Œçº¿ç¨‹åœ¨è®¿é—®èµ„æºä¹‹å‰å¿…é¡»å…ˆè·å¾—è®¸å¯ï¼Œå¦‚æœè®¸å¯æ•°ä¸è¶³ï¼Œåˆ™çº¿ç¨‹å¿…é¡»ç­‰å¾…ï¼Œç›´åˆ°æœ‰å¯ç”¨çš„è®¸å¯ä¸ºæ­¢ã€‚æ¯ä¸ª <code>Semaphore</code> å¯¹è±¡éƒ½æœ‰ä¸€ä¸ªåˆå§‹è®¸å¯æ•°ï¼Œè¡¨ç¤ºå¯åŒæ—¶è®¿é—®è¯¥èµ„æºçš„çº¿ç¨‹æ•°ã€‚</p>
<p>å‡è®¾ä¿¡å·é‡åˆå§‹æ•°é‡ä¸ºsemï¼š</p>
<p>  P æ“ä½œï¼šç”³è¯·ä¸€ä¸ªè®¸å¯ï¼Œå°† sem å‡ 1ï¼Œç›¸å‡åï¼Œå¦‚æœ <code>sem &lt; 0</code>ï¼Œåˆ™è¿›ç¨‹/çº¿ç¨‹è¿›å…¥é˜»å¡ç­‰å¾…ï¼Œå¦åˆ™ç»§ç»­ï¼Œè¡¨æ˜ P æ“ä½œå¯èƒ½ä¼šé˜»å¡ï¼›</p>
<p>  V æ“ä½œï¼šé‡Šæ”¾ä¸€ä¸ªè®¸å¯ï¼Œå°† sem åŠ  1ï¼Œç›¸åŠ åï¼Œå¦‚æœ<code> sem &lt;= 0</code>ï¼Œå”¤é†’ä¸€ä¸ªç­‰å¾…ä¸­çš„è¿›ç¨‹/çº¿ç¨‹ï¼Œè¡¨æ˜ V æ“ä½œä¸ä¼šé˜»å¡ï¼›</p>
<p>å¸¸ç”¨æ–¹æ³•ï¼š</p>
<ul>
<li><strong><code>acquire()</code></strong>: è·å–ä¸€ä¸ªè®¸å¯ï¼Œå¦‚æœæ²¡æœ‰å¯ç”¨è®¸å¯ï¼Œåˆ™çº¿ç¨‹ä¼šè¢«é˜»å¡ï¼Œç›´åˆ°æœ‰å¯ç”¨è®¸å¯ã€‚</li>
<li><strong><code>release()</code></strong>: é‡Šæ”¾ä¸€ä¸ªè®¸å¯ï¼Œå°†å…¶è¿”å›ç»™ <code>Semaphore</code>ã€‚</li>
<li><code>tryAcquire()</code>: å°è¯•è·å–ä¸€ä¸ªè®¸å¯ï¼Œå¦‚æœè·å–æˆåŠŸåˆ™è¿”å› trueï¼Œå¦åˆ™è¿”å› falseã€‚</li>
<li><code>availablePermits()</code>: è¿”å›å½“å‰å¯ç”¨çš„è®¸å¯æ•°ã€‚</li>
</ul>
<h2 id="ReadWriteLock"><a href="#ReadWriteLock" class="headerlink" title="ReadWriteLock"></a>ReadWriteLock</h2><p>è¯»å†™é”ï¼Œæ§åˆ¶å¯¹å…±äº«èµ„æºè®¿é—®çš„åŒæ­¥æœºåˆ¶ã€‚å®ƒå…è®¸å¤šä¸ªçº¿ç¨‹åŒæ—¶è¯»å–èµ„æºï¼Œä½†åªå…è®¸ä¸€ä¸ªçº¿ç¨‹ç‹¬å å†™å…¥èµ„æºã€‚</p>
<p>ReadWriteLockçš„ç›®çš„æ˜¯åœ¨èµ„æºè¢«è¯»å–çš„é¢‘ç‡é«˜äºå†™å…¥çš„æƒ…å†µä¸‹ä¼˜åŒ–æ€§èƒ½ã€‚é€šè¿‡å…è®¸å¹¶å‘è¯»å–ï¼Œå¤šä¸ªçº¿ç¨‹å¯ä»¥åŒæ—¶è®¿é—®èµ„æºï¼Œè¿™å¯ä»¥æé«˜ååé‡å¹¶å‡å°‘çº¿ç¨‹ä¹‹é—´çš„ç«äº‰ã€‚ç„¶è€Œï¼Œå½“ä¸€ä¸ªçº¿ç¨‹å¸Œæœ›ä¿®æ”¹èµ„æºæ—¶ï¼Œå®ƒéœ€è¦ç‹¬å è®¿é—®ä»¥ç¡®ä¿ä¸€è‡´æ€§ã€‚</p>
<h2 id="Fork-Join"><a href="#Fork-Join" class="headerlink" title="Fork/Join"></a>Fork/Join</h2><p>æ ¸å¿ƒæ€æƒ³ï¼š<strong>åˆ†è€Œæ²»ä¹‹</strong></p>
<p>Fork-Joinæ¨¡å‹çš„æ ¸å¿ƒæ€æƒ³æ˜¯å…³é”®æ¦‚å¿µæ˜¯â€forkâ€ï¼ˆåˆ†å‰ï¼‰å’Œâ€joinâ€ï¼ˆåˆå¹¶ï¼‰ï¼Œå³å°†ä¸€ä¸ªå¤§ä»»åŠ¡åˆ’åˆ†ä¸ºè‹¥å¹²ä¸ªå°ä»»åŠ¡ï¼Œç„¶åå¹¶è¡Œåœ°æ‰§è¡Œè¿™äº›å°ä»»åŠ¡ï¼Œæœ€åå°†å®ƒä»¬çš„ç»“æœç»„åˆèµ·æ¥å¾—åˆ°æœ€ç»ˆçš„ç»“æœã€‚è¿™ä¸ªè¿‡ç¨‹å¯ä»¥é€’å½’åœ°è¿›è¡Œï¼Œå³æ¯ä¸ªå°ä»»åŠ¡ä¹Ÿå¯ä»¥å†æ¬¡åˆ’åˆ†æˆæ›´å°çš„å­ä»»åŠ¡ï¼Œç›´åˆ°ä»»åŠ¡çš„è§„æ¨¡è¶³å¤Ÿå°ä»¥è‡³äºå¯ä»¥è¢«ç›´æ¥æ‰§è¡Œã€‚</p>
<p>ä¸¤ä¸ªå®ç°ç±»ï¼š</p>
<ul>
<li><code>RecursiveTask</code>æœ‰è¿”å›å€¼</li>
<li><code>RecursiveAction</code>æ²¡æœ‰è¿”å›å€¼</li>
</ul>
<p>Fork/Joinæ¡†æ¶çš„ä¼˜åŠ¿åœ¨äºå®ƒèƒ½å¤Ÿè‡ªåŠ¨åœ°å°†ä»»åŠ¡åˆ’åˆ†æˆåˆé€‚çš„å¤§å°ï¼Œå¹¶åˆ©ç”¨å¤šæ ¸å¤„ç†å™¨ä¸Šçš„å¹¶è¡Œæ€§æé«˜ç¨‹åºçš„æ€§èƒ½ã€‚å®ƒä¹Ÿæä¾›äº†ä¸€äº›ä¼˜åŒ–æŠ€æœ¯ï¼Œå¦‚<em><strong>å·¥ä½œçªƒå–ï¼ˆwork stealingï¼‰</strong></em>ï¼Œå¯ä»¥ç¡®ä¿å„ä¸ªçº¿ç¨‹åœ¨æ‰§è¡Œä»»åŠ¡æ—¶èƒ½å¤Ÿå……åˆ†åˆ©ç”¨ç³»ç»Ÿèµ„æºã€‚</p>
<h3 id="å·¥ä½œçªƒå–åŸç†"><a href="#å·¥ä½œçªƒå–åŸç†" class="headerlink" title="å·¥ä½œçªƒå–åŸç†"></a>å·¥ä½œçªƒå–åŸç†</h3><ol>
<li>æ¯ä¸ªå·¥ä½œçº¿ç¨‹éƒ½æœ‰ä¸€ä¸ªæœ¬åœ°çš„å·¥ä½œé˜Ÿåˆ—ï¼ˆ<em>åŒç«¯é˜Ÿåˆ—</em>ï¼‰ï¼Œç”¨äºå­˜å‚¨å¾…æ‰§è¡Œçš„ä»»åŠ¡ã€‚ä½¿ç”¨åŒç«¯é˜Ÿåˆ—ä½œä¸ºæœ¬åœ°å·¥ä½œé˜Ÿåˆ—çš„å¥½å¤„åœ¨äºï¼Œå·¥ä½œçº¿ç¨‹å¯ä»¥é«˜æ•ˆåœ°ä»é˜Ÿåˆ—çš„å¤´éƒ¨æˆ–å°¾éƒ¨æ‰§è¡Œæ’å…¥å’Œåˆ é™¤æ“ä½œã€‚å½“å·¥ä½œçº¿ç¨‹æ‰§è¡Œä»»åŠ¡æ—¶ï¼Œå®ƒä¼šä»é˜Ÿåˆ—çš„å¤´éƒ¨è·å–ä»»åŠ¡å¹¶æ‰§è¡Œï¼›è€Œå½“å·¥ä½œçº¿ç¨‹å°è¯•çªƒå–ä»»åŠ¡æ—¶ï¼Œå®ƒä¼šä»é˜Ÿåˆ—çš„å°¾éƒ¨æ’å…¥çªƒå–åˆ°çš„ä»»åŠ¡ã€‚</li>
<li>å½“ä¸€ä¸ªå·¥ä½œçº¿ç¨‹çš„æœ¬åœ°å·¥ä½œé˜Ÿåˆ—ä¸ºç©ºæ—¶ï¼Œå®ƒä¼šå°è¯•ä»å…¶ä»–å·¥ä½œçº¿ç¨‹çš„å·¥ä½œé˜Ÿåˆ—ä¸­çªƒå–ä»»åŠ¡ã€‚è¿™ä¸ªçªƒå–çš„ç›®æ ‡é€šå¸¸æ˜¯é€‰æ‹©ä¸€ä¸ªç›¸å¯¹è¾ƒç¹å¿™çš„å·¥ä½œçº¿ç¨‹ï¼Œå³å…¶å·¥ä½œé˜Ÿåˆ—ä¸­æœ‰æ›´å¤šä»»åŠ¡ç­‰å¾…æ‰§è¡Œã€‚</li>
<li>å·¥ä½œçº¿ç¨‹å¯ä»¥ä»ç›®æ ‡å·¥ä½œçº¿ç¨‹çš„å·¥ä½œé˜Ÿåˆ—çš„é¡¶éƒ¨ï¼ˆå¤´éƒ¨ï¼‰æˆ–è€…åº•éƒ¨ï¼ˆå°¾éƒ¨ï¼‰çªƒå–ä»»åŠ¡ã€‚é€‰æ‹©çªƒå–çš„ä½ç½®å¯ä»¥æ ¹æ®å…·ä½“çš„å®ç°ç­–ç•¥æ¥ç¡®å®šï¼Œä¸åŒçš„å®ç°æ–¹å¼å¯èƒ½æœ‰æ‰€ä¸åŒã€‚</li>
<li>çªƒå–ä»»åŠ¡çš„è¿‡ç¨‹é€šå¸¸æ˜¯é€šè¿‡çº¿ç¨‹é—´çš„åŸå­æ“ä½œæ¥å®ç°çš„ï¼Œä»¥ç¡®ä¿å¹¶å‘çš„æ­£ç¡®æ€§ã€‚ä¾‹å¦‚ï¼Œå¯ä»¥ä½¿ç”¨CASï¼ˆCompare and Swapï¼‰æ“ä½œæ¥ä¿è¯ä»»åŠ¡çš„çªƒå–æ˜¯åŸå­çš„ã€‚</li>
<li>å½“ä¸€ä¸ªå·¥ä½œçº¿ç¨‹æˆåŠŸåœ°çªƒå–åˆ°ä»»åŠ¡åï¼Œå®ƒä¼šå°†ä»»åŠ¡æ·»åŠ åˆ°è‡ªå·±çš„æœ¬åœ°å·¥ä½œé˜Ÿåˆ—ä¸­ï¼Œå¹¶ç»§ç»­æ‰§è¡Œçªƒå–åˆ°çš„ä»»åŠ¡ã€‚</li>
</ol>
]]></content>
      <categories>
        <category>å¹¶å‘ç¼–ç¨‹</category>
      </categories>
      <tags>
        <tag>JUC</tag>
      </tags>
  </entry>
  <entry>
    <title>LSTMå¤ç°</title>
    <url>/2024/10/28/LSTM%E5%A4%8D%E7%8E%B0/</url>
    <content><![CDATA[<h2 id="å¼•è¨€"><a href="#å¼•è¨€" class="headerlink" title="å¼•è¨€"></a>å¼•è¨€</h2><p>é•¿çŸ­æœŸè®°å¿†ç½‘ç»œï¼ˆLong Short-Term Memory, LSTMï¼‰æ˜¯ä¸€ç§ç‰¹æ®Šçš„å¾ªç¯ç¥ç»ç½‘ç»œï¼ˆRecurrent Neural Network, RNNï¼‰ï¼Œèƒ½å¤Ÿæœ‰æ•ˆåœ°å­¦ä¹ å’Œè®°å¿†é•¿æœŸä¾èµ–å…³ç³»ã€‚ç”±äºå…¶åœ¨å¤„ç†åºåˆ—æ•°æ®æ–¹é¢çš„å“è¶Šè¡¨ç°ï¼ŒLSTMåœ¨è‡ªç„¶è¯­è¨€å¤„ç†ã€è¯­éŸ³è¯†åˆ«ã€æ—¶é—´åºåˆ—é¢„æµ‹ç­‰é¢†åŸŸå¾—åˆ°äº†å¹¿æ³›åº”ç”¨ã€‚æœ¬æ–‡å°†é€šè¿‡ä»‹ç»LSTMçš„åŸºæœ¬åŸç†ï¼Œå¹¶ç»“åˆæºç å®ç°ï¼Œå¸®åŠ©è¯»è€…æ·±å…¥ç†è§£å¹¶å¤ç°LSTMæ¨¡å‹ã€‚</p>
<p><img src="/../images/LSTM%E5%A4%8D%E7%8E%B0/image_miFIeYOq26.png" alt="LSTMæ¶æ„ç¤ºæ„å›¾ LSTMæ¶æ„ç¤ºæ„å›¾ " title="LSTMæ¶æ„ç¤ºæ„å›¾ LSTMæ¶æ„ç¤ºæ„å›¾ "></p>
<h2 id="LSTMä»‹ç»"><a href="#LSTMä»‹ç»" class="headerlink" title="LSTMä»‹ç»"></a>LSTMä»‹ç»</h2><h3 id="1-å¾ªç¯ç¥ç»ç½‘ç»œï¼ˆRNNï¼‰æ¦‚è¿°"><a href="#1-å¾ªç¯ç¥ç»ç½‘ç»œï¼ˆRNNï¼‰æ¦‚è¿°" class="headerlink" title="1. å¾ªç¯ç¥ç»ç½‘ç»œï¼ˆRNNï¼‰æ¦‚è¿°"></a>1. å¾ªç¯ç¥ç»ç½‘ç»œï¼ˆRNNï¼‰æ¦‚è¿°</h3><p>å¾ªç¯ç¥ç»ç½‘ç»œï¼ˆRNNï¼‰æ˜¯ä¸€ç§ç”¨äºå¤„ç†åºåˆ—æ•°æ®çš„ç¥ç»ç½‘ç»œç»“æ„ã€‚ä¸ä¼ ç»Ÿçš„å‰é¦ˆç¥ç»ç½‘ç»œä¸åŒï¼ŒRNNå…·æœ‰å†…éƒ¨çš„å¾ªç¯è¿æ¥ï¼Œèƒ½å¤Ÿåœ¨éšè—å±‚ä¸­ä¿ç•™å‰ä¸€æ—¶åˆ»çš„ä¿¡æ¯ï¼Œä»è€Œæ•æ‰åºåˆ—ä¸­çš„æ—¶åºç‰¹å¾ã€‚ç„¶è€Œï¼Œæ ‡å‡†çš„RNNåœ¨å¤„ç†è¾ƒé•¿åºåˆ—æ—¶ï¼Œå®¹æ˜“å‡ºç°æ¢¯åº¦æ¶ˆå¤±æˆ–æ¢¯åº¦çˆ†ç‚¸çš„é—®é¢˜ï¼Œå¯¼è‡´æ¨¡å‹éš¾ä»¥å­¦ä¹ é•¿æœŸä¾èµ–å…³ç³»ã€‚</p>
<h3 id="2-LSTMçš„è¯ç”Ÿ"><a href="#2-LSTMçš„è¯ç”Ÿ" class="headerlink" title="2. LSTMçš„è¯ç”Ÿ"></a>2. LSTMçš„è¯ç”Ÿ</h3><p><strong>RNNå­˜åœ¨çš„é—®é¢˜</strong>ï¼šRNNè™½ç„¶åœ¨ç†è®ºä¸Šå¯ä»¥ä¿ç•™æ‰€æœ‰å†å²æ—¶åˆ»çš„ä¿¡æ¯ï¼Œä½†åœ¨å®é™…ä½¿ç”¨æ—¶ï¼Œä¿¡æ¯çš„ä¼ é€’å¾€å¾€ä¼šå› ä¸ºæ—¶é—´é—´éš”å¤ªé•¿è€Œé€æ¸è¡°å‡ï¼Œä¼ é€’ä¸€æ®µæ—¶åˆ»ä»¥åå…¶ä¿¡æ¯çš„ä½œç”¨æ•ˆæœå°±å¤§å¤§é™ä½äº†ã€‚å› æ­¤ï¼Œæ™®é€šRNNå¯¹äºä¿¡æ¯çš„é•¿æœŸä¾èµ–é—®é¢˜æ²¡æœ‰å¾ˆå¥½çš„å¤„ç†åŠæ³•ã€‚è€ŒLSTMå…‹æœäº†è¿™ä¸ªé—®é¢˜ï¼Œå¯ä»¥å­¦ä¹ é•¿æœŸä¾èµ–ä¿¡æ¯</p>
<p>LSTMç”±Hochreiterå’ŒSchmidhuberåœ¨1997å¹´æå‡ºï¼Œæ—¨åœ¨è§£å†³æ ‡å‡†RNNåœ¨é•¿åºåˆ—ä¸­çš„è®­ç»ƒå›°éš¾ã€‚LSTMé€šè¿‡å¼•å…¥é—¨æ§æœºåˆ¶ï¼Œæœ‰æ•ˆåœ°æ§åˆ¶ä¿¡æ¯çš„æµåŠ¨ï¼Œèƒ½å¤Ÿåœ¨è¾ƒé•¿æ—¶é—´æ­¥å†…ä¿æŒæœ‰ç”¨çš„ä¿¡æ¯ï¼ŒåŒæ—¶è¿‡æ»¤æ‰æ— å…³æˆ–å¹²æ‰°çš„ä¿¡æ¯ã€‚</p>
<p>LSTMçš„å…³é”®æ˜¯ç»†èƒçŠ¶æ€ Ctï¼Œç”¨æ¥ä¿å­˜å½“å‰LSTMçš„çŠ¶æ€ä¿¡æ¯å¹¶ä¼ é€’åˆ°ä¸‹ä¸€æ—¶åˆ»çš„LSTMä¸­ï¼Œä¹Ÿå°±æ˜¯RNNä¸­é‚£æ ¹â€œè‡ªå¾ªç¯â€çš„ç®­å¤´ã€‚å½“å‰çš„LSTMæ¥æ”¶æ¥è‡ªä¸Šä¸€ä¸ªæ—¶åˆ»çš„ç»†èƒçŠ¶æ€ Ctâˆ’1ï¼Œå¹¶ä¸å½“å‰LSTMæ¥æ”¶çš„ä¿¡å·è¾“å…¥ xtå…±åŒä½œç”¨äº§ç”Ÿå½“å‰LSTMçš„ç»†èƒçŠ¶æ€ Ct</p>
<h3 id="3-LSTMçš„ç»“æ„ä¸å·¥ä½œåŸç†"><a href="#3-LSTMçš„ç»“æ„ä¸å·¥ä½œåŸç†" class="headerlink" title="3. LSTMçš„ç»“æ„ä¸å·¥ä½œåŸç†"></a>3. LSTMçš„ç»“æ„ä¸å·¥ä½œåŸç†</h3><p>LSTMå•å…ƒä¸»è¦ç”±ä»¥ä¸‹å‡ ä¸ªéƒ¨åˆ†ç»„æˆï¼š</p>
<ul>
<li><strong>é—å¿˜é—¨ï¼ˆForget Gateï¼‰</strong>ï¼šå†³å®šä¿ç•™å¤šå°‘è¿‡å»çš„ä¿¡æ¯ã€‚</li>
<li><strong>è¾“å…¥é—¨ï¼ˆInput Gateï¼‰</strong>ï¼šå†³å®šå¼•å…¥å¤šå°‘æ–°çš„ä¿¡æ¯ã€‚</li>
<li><strong>è¾“å‡ºé—¨ï¼ˆOutput Gateï¼‰</strong>ï¼šå†³å®šå°†å¤šå°‘å½“å‰çš„ä¿¡æ¯è¾“å‡ºã€‚</li>
</ul>
<p>æ¯ä¸ªé—¨éƒ½ç”±ä¸€ä¸ªSigmoidç¥ç»ç½‘ç»œå±‚ç»„æˆï¼Œè¾“å‡ºå€¼åœ¨0åˆ°1ä¹‹é—´ï¼Œç”¨ä»¥æ§åˆ¶ä¿¡æ¯çš„æµåŠ¨ã€‚å…·ä½“ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="https://colah.github.io/posts/2015-08-Understanding-LSTMs/img/LSTM3-chain.png" alt="LSTMå•å…ƒç»“æ„" title="LSTMå•å…ƒç»“æ„"></p>
<p><em>å›¾2ï¼šLSTMå•å…ƒç»“æ„</em></p>
<h4 id="å…·ä½“è®¡ç®—è¿‡ç¨‹"><a href="#å…·ä½“è®¡ç®—è¿‡ç¨‹" class="headerlink" title="å…·ä½“è®¡ç®—è¿‡ç¨‹"></a>å…·ä½“è®¡ç®—è¿‡ç¨‹</h4><p>å‡è®¾åœ¨æ—¶é—´æ­¥$t$ï¼Œè¾“å…¥ä¸º$x_t$ï¼Œå‰ä¸€æ—¶åˆ»çš„éšè—çŠ¶æ€ä¸º$h_{t-1}$ï¼Œç»†èƒçŠ¶æ€ä¸º$c_{t-1}$ï¼Œåˆ™LSTMçš„è®¡ç®—è¿‡ç¨‹å¦‚ä¸‹ï¼š</p>
<ol>
<li><p><strong>é—å¿˜é—¨</strong>ï¼š</p>
 <span>
 $$
 f_t = \sigma(W_f \cdot [h_{t-1}, x_t] + b_f) 
 $$
 </span>
</li>
<li><p><strong>è¾“å…¥é—¨</strong>ï¼š</p>
</li>
</ol>
<span>
   $$
   i_t = \sigma(W_i \cdot [h_{t-1}, x_t] + b_i) 
   $$
</span>

<span>
   $$
   \tilde{C}_t = \tanh(W_C \cdot [h_{t-1}, x_t] + b_C) 
   $$
</span>

<ol start="3">
<li><p><strong>æ›´æ–°ç»†èƒçŠ¶æ€</strong>ï¼š</p>
<p>$$<br>C_t = f_t * C_{t-1} + i_t * \tilde{C}_t<br>$$</p>
</li>
<li><p><strong>è¾“å‡ºé—¨</strong>ï¼š</p>
<p>$$<br>o_t = \sigma(W_o \cdot [h_{t-1}, x_t] + b_o)<br>$$</p>
<p>$$<br>h_t = o_t * \tanh(C_t)<br>$$</p>
</li>
</ol>
<p>å…¶ä¸­ï¼Œ$\sigma$è¡¨ç¤ºSigmoidå‡½æ•°ï¼Œ$*$è¡¨ç¤ºé€å…ƒç´ ç›¸ä¹˜ã€‚</p>
<h2 id="LSTMæºç å®ç°"><a href="#LSTMæºç å®ç°" class="headerlink" title="LSTMæºç å®ç°"></a>LSTMæºç å®ç°</h2><p>æœ¬æ–‡å°†ä»¥PyTorchæ¡†æ¶ä¸ºä¾‹ï¼Œæ‰‹æŠŠæ‰‹å®ç°ä¸€ä¸ªç®€å•çš„LSTMç½‘ç»œï¼Œå¹¶åº”ç”¨äºå­—ç¬¦çº§çš„æ–‡æœ¬é¢„æµ‹ä»»åŠ¡ã€‚</p>
<h3 id="1-ç¯å¢ƒå‡†å¤‡"><a href="#1-ç¯å¢ƒå‡†å¤‡" class="headerlink" title="1. ç¯å¢ƒå‡†å¤‡"></a>1. ç¯å¢ƒå‡†å¤‡</h3><p>é¦–å…ˆï¼Œç¡®ä¿å·²ç»å®‰è£…äº†PyTorchã€‚å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤è¿›è¡Œå®‰è£…ï¼š</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">pip install torch</span><br></pre></td></tr></tbody></table></figure>

<h3 id="2-æ•°æ®å‡†å¤‡"><a href="#2-æ•°æ®å‡†å¤‡" class="headerlink" title="2. æ•°æ®å‡†å¤‡"></a>2. æ•°æ®å‡†å¤‡</h3><p>ä»¥èå£«æ¯”äºšçš„æ–‡æœ¬ä¸ºä¾‹ï¼Œæˆ‘ä»¬å°†å…¶ä½œä¸ºè®­ç»ƒæ•°æ®ï¼Œç”¨äºé¢„æµ‹ä¸‹ä¸€ä¸ªå­—ç¬¦ã€‚</p>
<figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"><span class="keyword">import</span> torch.optim <span class="keyword">as</span> optim</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¯»å–æ–‡æœ¬æ•°æ®</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">'shakespeare.txt'</span>, <span class="string">'r'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    text = f.read()</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºå­—ç¬¦åˆ°ç´¢å¼•çš„æ˜ å°„</span></span><br><span class="line">chars = <span class="built_in">sorted</span>(<span class="built_in">list</span>(<span class="built_in">set</span>(text)))</span><br><span class="line">char_to_idx = {ch: i <span class="keyword">for</span> i, ch <span class="keyword">in</span> <span class="built_in">enumerate</span>(chars)}</span><br><span class="line">idx_to_char = {i: ch <span class="keyword">for</span> i, ch <span class="keyword">in</span> <span class="built_in">enumerate</span>(chars)}</span><br><span class="line"></span><br><span class="line">vocab_size = <span class="built_in">len</span>(chars)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f'å­—ç¬¦é›†å¤§å°: <span class="subst">{vocab_size}</span>'</span>)</span><br></pre></td></tr></tbody></table></figure>

<h3 id="3-æ¨¡å‹å®šä¹‰"><a href="#3-æ¨¡å‹å®šä¹‰" class="headerlink" title="3. æ¨¡å‹å®šä¹‰"></a>3. æ¨¡å‹å®šä¹‰</h3><p>å®šä¹‰ä¸€ä¸ªLSTMç±»ï¼Œç»§æ‰¿è‡ª<code>nn.Module</code>ã€‚</p>
<figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">LSTMModel</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, input_size, hidden_size, output_size, num_layers=<span class="number">1</span></span>):</span><br><span class="line">        <span class="built_in">super</span>(LSTMModel, <span class="variable language_">self</span>).__init__()</span><br><span class="line">        <span class="variable language_">self</span>.hidden_size = hidden_size</span><br><span class="line">        <span class="variable language_">self</span>.num_layers = num_layers</span><br><span class="line"></span><br><span class="line">        <span class="comment"># å®šä¹‰LSTMå±‚</span></span><br><span class="line">        <span class="variable language_">self</span>.lstm = nn.LSTM(input_size, hidden_size, num_layers, batch_first=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># å®šä¹‰å…¨è¿æ¥å±‚</span></span><br><span class="line">        <span class="variable language_">self</span>.fc = nn.Linear(hidden_size, output_size)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x, hidden</span>):</span><br><span class="line">        <span class="comment"># LSTMå‰å‘ä¼ æ’­</span></span><br><span class="line">        out, hidden = <span class="variable language_">self</span>.lstm(x, hidden)</span><br><span class="line">        <span class="comment"># å–æœ€åä¸€ä¸ªæ—¶é—´æ­¥çš„è¾“å‡º</span></span><br><span class="line">        out = out[:, -<span class="number">1</span>, :]</span><br><span class="line">        out = <span class="variable language_">self</span>.fc(out)</span><br><span class="line">        <span class="keyword">return</span> out, hidden</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">init_hidden</span>(<span class="params">self, batch_size</span>):</span><br><span class="line">        <span class="comment"># åˆå§‹åŒ–éšè—çŠ¶æ€å’Œç»†èƒçŠ¶æ€</span></span><br><span class="line">        weight = <span class="built_in">next</span>(<span class="variable language_">self</span>.parameters()).data</span><br><span class="line">        hidden = (weight.new(<span class="variable language_">self</span>.num_layers, batch_size, <span class="variable language_">self</span>.hidden_size).zero_(),</span><br><span class="line">                  weight.new(<span class="variable language_">self</span>.num_layers, batch_size, <span class="variable language_">self</span>.hidden_size).zero_())</span><br><span class="line">        <span class="keyword">return</span> hidden</span><br></pre></td></tr></tbody></table></figure>

<h3 id="4-æ¨¡å‹è®­ç»ƒ"><a href="#4-æ¨¡å‹è®­ç»ƒ" class="headerlink" title="4. æ¨¡å‹è®­ç»ƒ"></a>4. æ¨¡å‹è®­ç»ƒ</h3><p>å®šä¹‰è®­ç»ƒå‡½æ•°ï¼Œå¹¶è¿›è¡Œæ¨¡å‹è®­ç»ƒã€‚</p>
<figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># è¶…å‚æ•°</span></span><br><span class="line">input_size = vocab_size</span><br><span class="line">hidden_size = <span class="number">128</span></span><br><span class="line">output_size = vocab_size</span><br><span class="line">num_layers = <span class="number">2</span></span><br><span class="line">num_epochs = <span class="number">20</span></span><br><span class="line">batch_size = <span class="number">64</span></span><br><span class="line">seq_length = <span class="number">100</span></span><br><span class="line">learning_rate = <span class="number">0.002</span></span><br><span class="line"></span><br><span class="line">model = LSTMModel(input_size, hidden_size, output_size, num_layers)</span><br><span class="line">loss_fn = nn.CrossEntropyLoss()</span><br><span class="line">optimizer = optim.Adam(model.parameters(), lr=learning_rate)</span><br><span class="line"></span><br><span class="line"><span class="comment"># å‡†å¤‡æ•°æ®é›†</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create_sequences</span>(<span class="params">text, seq_length</span>):</span><br><span class="line">    sequences = []</span><br><span class="line">    targets = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(text) - seq_length):</span><br><span class="line">        seq = text[i:i+seq_length]</span><br><span class="line">        target = text[i+seq_length]</span><br><span class="line">        sequences.append([char_to_idx[ch] <span class="keyword">for</span> ch <span class="keyword">in</span> seq])</span><br><span class="line">        targets.append(char_to_idx[target])</span><br><span class="line">    <span class="keyword">return</span> sequences, targets</span><br><span class="line"></span><br><span class="line">sequences, targets = create_sequences(text, seq_length)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f'æ€»åºåˆ—æ•°: <span class="subst">{<span class="built_in">len</span>(sequences)}</span>'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># è½¬æ¢ä¸ºå¼ é‡</span></span><br><span class="line">inputs = torch.tensor(sequences, dtype=torch.long)</span><br><span class="line">targets = torch.tensor(targets, dtype=torch.long)</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®­ç»ƒå¾ªç¯</span></span><br><span class="line"><span class="keyword">for</span> epoch <span class="keyword">in</span> <span class="built_in">range</span>(num_epochs):</span><br><span class="line">    hidden = model.init_hidden(batch_size)</span><br><span class="line">    epoch_loss = <span class="number">0</span></span><br><span class="line">    num_batches = <span class="built_in">len</span>(inputs) // batch_size</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(inputs) - batch_size, batch_size):</span><br><span class="line">        x = inputs[i:i+batch_size]</span><br><span class="line">        y = targets[i:i+batch_size]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># ç‹¬çƒ­ç¼–ç </span></span><br><span class="line">        x_one_hot = torch.zeros(batch_size, seq_length, input_size)</span><br><span class="line">        x_one_hot.scatter_(<span class="number">2</span>, x.unsqueeze(<span class="number">2</span>), <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        hidden = <span class="built_in">tuple</span>([h.data <span class="keyword">for</span> h <span class="keyword">in</span> hidden])</span><br><span class="line"></span><br><span class="line">        <span class="comment"># å‰å‘ä¼ æ’­</span></span><br><span class="line">        outputs, hidden = model(x_one_hot, hidden)</span><br><span class="line">        loss = loss_fn(outputs, y)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># åå‘ä¼ æ’­å’Œä¼˜åŒ–</span></span><br><span class="line">        optimizer.zero_grad()</span><br><span class="line">        loss.backward()</span><br><span class="line">        optimizer.step()</span><br><span class="line"></span><br><span class="line">        epoch_loss += loss.item()</span><br><span class="line"></span><br><span class="line">    avg_loss = epoch_loss / num_batches</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f'Epoch [<span class="subst">{epoch+<span class="number">1</span>}</span>/<span class="subst">{num_epochs}</span>], Loss: <span class="subst">{avg_loss:<span class="number">.4</span>f}</span>'</span>)</span><br></pre></td></tr></tbody></table></figure>

<h3 id="5-æ¨¡å‹é¢„æµ‹"><a href="#5-æ¨¡å‹é¢„æµ‹" class="headerlink" title="5. æ¨¡å‹é¢„æµ‹"></a>5. æ¨¡å‹é¢„æµ‹</h3><p>è®­ç»ƒå®Œæˆåï¼Œå¯ä»¥ä½¿ç”¨æ¨¡å‹ç”Ÿæˆæ–‡æœ¬ã€‚</p>
<figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">generate_text</span>(<span class="params">model, start_str, length, hidden_size</span>):</span><br><span class="line">    model.<span class="built_in">eval</span>()</span><br><span class="line">    chars = [ch <span class="keyword">for</span> ch <span class="keyword">in</span> start_str]</span><br><span class="line">    input_seq = torch.tensor([[char_to_idx[ch] <span class="keyword">for</span> ch <span class="keyword">in</span> start_str]], dtype=torch.long)</span><br><span class="line">    input_one_hot = torch.zeros(<span class="number">1</span>, <span class="built_in">len</span>(start_str), vocab_size)</span><br><span class="line">    input_one_hot.scatter_(<span class="number">2</span>, input_seq.unsqueeze(<span class="number">2</span>), <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    hidden = model.init_hidden(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> torch.no_grad():</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(start_str) - <span class="number">1</span>):</span><br><span class="line">            _, hidden = model(input_one_hot[:, i:i+<span class="number">1</span>, :], hidden)</span><br><span class="line"></span><br><span class="line">        last_char = input_one_hot[:, -<span class="number">1</span>, :]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(length):</span><br><span class="line">            out, hidden = model(last_char.unsqueeze(<span class="number">1</span>), hidden)</span><br><span class="line">            _, predicted = torch.<span class="built_in">max</span>(out, <span class="number">1</span>)</span><br><span class="line">            predicted_char = idx_to_char[predicted.item()]</span><br><span class="line">            chars.append(predicted_char)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># å‡†å¤‡ä¸‹ä¸€ä¸ªè¾“å…¥</span></span><br><span class="line">            last_char = torch.zeros(<span class="number">1</span>, <span class="number">1</span>, vocab_size)</span><br><span class="line">            last_char[<span class="number">0</span>, <span class="number">0</span>, predicted] = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="string">''</span>.join(chars)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç”Ÿæˆæ–‡æœ¬ç¤ºä¾‹</span></span><br><span class="line">start_str = <span class="string">"To be, or not to be, that is the question:\n"</span></span><br><span class="line">generated = generate_text(model, start_str, <span class="number">200</span>, hidden_size)</span><br><span class="line"><span class="built_in">print</span>(generated)</span><br></pre></td></tr></tbody></table></figure>

<hr>
<h2 id="å‚è€ƒæ–‡çŒ®"><a href="#å‚è€ƒæ–‡çŒ®" class="headerlink" title="å‚è€ƒæ–‡çŒ®"></a>å‚è€ƒæ–‡çŒ®</h2><ol>
<li><a href="https://colah.github.io/posts/2015-08-Understanding-LSTMs/" title="Understanding LSTM Networks">Understanding LSTM Networks</a></li>
<li><a href="https://pytorch.org/docs/stable/index.html" title="PyTorchå®˜æ–¹æ–‡æ¡£">PyTorchå®˜æ–¹æ–‡æ¡£</a></li>
<li><a href="https://chauby.github.io/2020/01/30/LSTM/" title="æ·±å…¥æµ…å‡ºLSTMåŠå…¶Pythonä»£ç å®ç°">æ·±å…¥æµ…å‡ºLSTMåŠå…¶Pythonä»£ç å®ç°</a></li>
</ol>
]]></content>
      <categories>
        <category>AI</category>
      </categories>
  </entry>
  <entry>
    <title>Javaä¸­çš„çº¿ç¨‹æ± </title>
    <url>/2023/02/03/Java%E7%BA%BF%E7%A8%8B%E6%B1%A0/</url>
    <content><![CDATA[<h2 id="çº¿ç¨‹æ± çš„åˆ›å»º"><a href="#çº¿ç¨‹æ± çš„åˆ›å»º" class="headerlink" title="çº¿ç¨‹æ± çš„åˆ›å»º"></a>çº¿ç¨‹æ± çš„åˆ›å»º</h2><p>ä½¿ç”¨<code>Executors</code>åˆ›å»ºçº¿ç¨‹æ± ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="type">ExecutorService</span> <span class="variable">threadPool</span> <span class="operator">=</span> Executors.newSingleThreadExecutor(); <span class="comment">//å•ä¸ªçº¿ç¨‹</span></span><br><span class="line"><span class="type">ExecutorService</span> <span class="variable">threadPool2</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">5</span>); <span class="comment">//åˆ›å»ºä¸€ä¸ªå›ºå®šçš„çº¿ç¨‹æ± çš„å¤§å°</span></span><br><span class="line"><span class="type">ExecutorService</span> <span class="variable">threadPool3</span> <span class="operator">=</span> Executors.newCachedThreadPool(); <span class="comment">//å¯ä¼¸ç¼©çš„çº¿ç¨‹æ± </span></span><br></pre></td></tr></tbody></table></figure>

<p>ä½†æ˜¯ä¸å»ºè®®ä½¿ç”¨<code>Executors</code>åˆ›å»ºçº¿ç¨‹æ± ï¼Œåœ¨é˜¿é‡Œå·´å·´æŠ€æœ¯è§„èŒƒä¸­å†™æœ‰ï¼š</p>
<p><img src="/../images/Java%E7%BA%BF%E7%A8%8B%E6%B1%A0/image-20240903160832255.png" alt="image-20240903160832255"></p>
<span id="more"></span>

<blockquote>
<p>ä½¿ç”¨<code>Executors</code>åˆ›å»ºçº¿ç¨‹æ± çš„æœ¬è´¨å®é™…ä¸Šä¹Ÿæ˜¯è°ƒç”¨äº†<code>ThreadPoolExecutor</code>åˆ›å»ºçº¿ç¨‹æ± ï¼Œä½†æ˜¯åˆ›å»ºçš„çº¿ç¨‹æ± é»˜è®¤é…ç½®ä¸å¤ªåˆç†ï¼Ÿ</p>
</blockquote>
<h2 id="TreadPoolExector"><a href="#TreadPoolExector" class="headerlink" title="TreadPoolExector"></a>TreadPoolExector</h2><p><code>ThreadPoolExecutor</code>çš„æ„é€ æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">ThreadPoolExecutor</span><span class="params">(<span class="type">int</span> corePoolSize, </span></span><br><span class="line"><span class="params">                          <span class="type">int</span> maximumPoolSize, </span></span><br><span class="line"><span class="params">                          <span class="type">long</span> keepAliveTime, </span></span><br><span class="line"><span class="params">                          TimeUnit unit, </span></span><br><span class="line"><span class="params">                          BlockingQueue&lt;Runnable&gt; workQueue, </span></span><br><span class="line"><span class="params">                          ThreadFactory threadFactory, </span></span><br><span class="line"><span class="params">                          RejectedExecutionHandler handler)</span> {</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><code>ThreadPoolExecutor</code>çš„æ„é€ å‡½æ•°å…·æœ‰ä»¥ä¸‹ä¸ƒä¸ªå‚æ•°ï¼Œå®ƒä»¬åˆ†åˆ«æ˜¯ï¼š</p>
<ol>
<li><p><code>corePoolSize</code>ï¼ˆæ ¸å¿ƒçº¿ç¨‹æ•°ï¼‰ï¼š</p>
<p> å®ƒæŒ‡å®šäº†çº¿ç¨‹æ± ä¸­ä¿æŒæ´»åŠ¨çŠ¶æ€çš„æ ¸å¿ƒçº¿ç¨‹æ•°é‡ã€‚æ ¸å¿ƒçº¿ç¨‹æ˜¯ä¸€ç›´å­˜æ´»çš„çº¿ç¨‹ï¼Œå³ä½¿å®ƒä»¬å¤„äºç©ºé—²çŠ¶æ€ä¹Ÿä¸ä¼šè¢«å›æ”¶ã€‚å½“æœ‰æ–°ä»»åŠ¡æäº¤æ—¶ï¼Œæ ¸å¿ƒçº¿ç¨‹ä¼šç«‹å³æ‰§è¡Œä»»åŠ¡ã€‚å¦‚æœä½¿ç”¨çš„æ˜¯æ— ç•Œé˜Ÿåˆ—ï¼Œçº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°æ°¸è¿œä¸ä¼šè¶…è¿‡æ ¸å¿ƒçº¿ç¨‹æ•°ã€‚</p>
</li>
<li><p><code>maximumPoolSize</code>ï¼ˆæœ€å¤§çº¿ç¨‹æ•°ï¼‰ï¼š</p>
<p> å®ƒå®šä¹‰äº†çº¿ç¨‹æ± ä¸­å…è®¸åˆ›å»ºçš„æœ€å¤§çº¿ç¨‹æ•°é‡ã€‚å½“å·¥ä½œé˜Ÿåˆ—å·²æ»¡ä¸”å½“å‰çº¿ç¨‹æ•°å°äºæœ€å¤§çº¿ç¨‹æ•°æ—¶ï¼Œçº¿ç¨‹æ± ä¼šåˆ›å»ºæ–°çš„çº¿ç¨‹æ¥æ‰§è¡Œä»»åŠ¡ã€‚å¦‚æœä½¿ç”¨çš„æ˜¯æœ‰ç•Œé˜Ÿåˆ—ï¼Œå½“é˜Ÿåˆ—å·²æ»¡ä¸”çº¿ç¨‹æ•°è¾¾åˆ°æœ€å¤§å€¼æ—¶ï¼Œæ–°çš„ä»»åŠ¡ä¼šè§¦å‘æ‹’ç»ç­–ç•¥ã€‚</p>
</li>
<li><p><code>keepAliveTime</code>ï¼ˆçº¿ç¨‹ç©ºé—²è¶…æ—¶æ—¶é—´ï¼‰ï¼š</p>
<p> å®ƒè¡¨ç¤ºéæ ¸å¿ƒçº¿ç¨‹ç©ºé—²çš„æœ€å¤§æ—¶é—´ã€‚å½“çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°è¶…è¿‡æ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œå¹¶ä¸”ç©ºé—²æ—¶é—´è¶…è¿‡è¯¥å€¼æ—¶ï¼Œå¤šä½™çš„çº¿ç¨‹ä¼šè¢«ç»ˆæ­¢å¹¶ä»çº¿ç¨‹æ± ä¸­ç§»é™¤ï¼Œä»¥å‡å°‘èµ„æºæ¶ˆè€—ã€‚æ–°ä»»åŠ¡åˆ°è¾¾æ—¶ï¼Œå¦‚æœçº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°å°äºæ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œå¯èƒ½ä¼šé‡æ–°åˆ›å»ºçº¿ç¨‹ã€‚</p>
</li>
<li><p><code>unit</code>ï¼ˆç©ºé—²è¶…æ—¶æ—¶é—´çš„å•ä½ï¼‰ï¼š</p>
<p> ç”¨äºæŒ‡å®š<code>keepAliveTime</code>å‚æ•°çš„å•ä½ï¼Œå¯ä»¥æ˜¯<code>TimeUnit.SECONDS</code>ã€<code>TimeUnit.MILLISECONDS</code>ç­‰ã€‚</p>
</li>
<li><p><code>workQueue</code>ï¼ˆå·¥ä½œé˜Ÿåˆ—ï¼‰ï¼š</p>
<p> å®ƒå®šä¹‰äº†ç”¨äºä¿å­˜å¾…æ‰§è¡Œä»»åŠ¡çš„é˜»å¡é˜Ÿåˆ—ã€‚å½“ä»»åŠ¡æäº¤åˆ°çº¿ç¨‹æ± æ—¶ï¼Œå¦‚æœçº¿ç¨‹æ•°å°äºæ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œä¼šåˆ›å»ºæ–°çº¿ç¨‹æ¥æ‰§è¡Œä»»åŠ¡ã€‚å¦‚æœçº¿ç¨‹æ•°è¾¾åˆ°æ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œè€Œå·¥ä½œé˜Ÿåˆ—æœªæ»¡ï¼Œåˆ™å°†ä»»åŠ¡æ”¾å…¥é˜Ÿåˆ—ä¸­ç­‰å¾…æ‰§è¡Œã€‚å·¥ä½œé˜Ÿåˆ—å¯ä»¥æ˜¯æœ‰ç•Œé˜Ÿåˆ—ï¼ˆå¦‚<code>ArrayBlockingQueue</code>ï¼‰æˆ–æ— ç•Œé˜Ÿåˆ—ï¼ˆå¦‚<code>LinkedBlockingQueue</code>ï¼‰ã€‚</p>
</li>
<li><p><code>threadFactory</code>ï¼ˆçº¿ç¨‹å·¥å‚ï¼Œå¯é€‰ï¼‰ï¼š</p>
<p> çº¿ç¨‹å·¥å‚æŒ‡å®šåˆ›å»ºçº¿ç¨‹çš„æ–¹å¼ï¼Œç”¨äºåˆ›å»ºæ–°çº¿ç¨‹çš„å·¥å‚å¯¹è±¡ã€‚çº¿ç¨‹å·¥å‚å¯ä»¥æ ¹æ®éœ€è¦å¯¹çº¿ç¨‹è¿›è¡Œè‡ªå®šä¹‰é…ç½®ï¼Œä¾‹å¦‚è®¾ç½®çº¿ç¨‹åå­—ã€è®¾ç½®çº¿ç¨‹ä¼˜å…ˆçº§ç­‰ã€‚å¦‚æœæœªæŒ‡å®šï¼Œå°†ä½¿ç”¨é»˜è®¤çš„<code>DefaultThreadFactory</code></p>
</li>
<li><p><code>handler</code>ï¼ˆæ‹’ç»ç­–ç•¥ï¼Œå¯é€‰ï¼‰ï¼š</p>
<p> å®ƒå®šä¹‰äº†å½“çº¿ç¨‹æ± æ— æ³•æ¥å—æ–°ä»»åŠ¡æ—¶çš„å¤„ç†æ–¹å¼ã€‚æ‹’ç»ç­–ç•¥å¯ä»¥æ˜¯é¢„å®šä¹‰çš„å‡ ç§ç­–ç•¥ï¼Œå¦‚æŠ›å‡ºå¼‚å¸¸ã€ä¸¢å¼ƒä»»åŠ¡ã€é˜»å¡ç­‰ã€‚ä¹Ÿå¯ä»¥æ ¹æ®éœ€è¦è‡ªå®šä¹‰æ‹’ç»ç­–ç•¥å®ç°<code>RejectedExecutionHandler</code>æ¥å£ã€‚</p>
</li>
</ol>
<p>æˆ‘ä»¬å¯ä»¥è¿™æ ·ç±»æ¯”ï¼š</p>
<p><img src="/../images/Java%E7%BA%BF%E7%A8%8B%E6%B1%A0/image-20240903161026674.png" alt="image-20240903161026674"><br><em><strong>æ³¨æ„ï¼šæ ¸å¿ƒçº¿ç¨‹æ²¡æœ‰ç©ºé—²æ—¶ï¼Œè¶…é‡ä»»åŠ¡é¦–å…ˆæ”¾å…¥é˜Ÿåˆ—ä¸­ï¼Œé˜Ÿåˆ—æ»¡äº†æ‰ä¼šå¼€æ™®é€šçº¿ç¨‹å¤„ç†ï¼</strong></em></p>
<p>å¦‚æœ<code>corePoolSize</code>ä¸º0ï¼Œåˆ™è¦ä½¿ç”¨<code>SynchronousQueue</code>é¿å…æ— é™é˜»å¡ã€‚å› ä¸ºæ ¸å¿ƒçº¿ç¨‹ä¸º0æ—¶ï¼Œä»»åŠ¡ä¼šå…ˆæ”¾å…¥é˜Ÿåˆ—ä¸­ï¼Œé˜Ÿåˆ—æ”¾ä¸ä¸‹äº†å†ä½¿ç”¨æ™®é€šçº¿ç¨‹ï¼Œå¦‚æœé˜Ÿåˆ—æ˜¯æ— é™çš„å°±ä¼šå¯¼è‡´ä¸€ç›´é˜»å¡</p>
<h3 id="å·¥ä½œé˜Ÿåˆ—-BlockQueue"><a href="#å·¥ä½œé˜Ÿåˆ—-BlockQueue" class="headerlink" title="å·¥ä½œé˜Ÿåˆ— BlockQueue"></a>å·¥ä½œé˜Ÿåˆ— BlockQueue</h3><p>ä½¿ç”¨ç”¨<code>ThreadPoolExecutor</code>éœ€è¦æŒ‡å®šä¸€ä¸ª<code>BlockingQueue</code>ä»»åŠ¡ç­‰å¾…é˜Ÿåˆ—ã€‚</p>
<p>BlockingQueueï¼ˆé˜»å¡é˜Ÿåˆ—ï¼‰å®šä¹‰äº†ä¸€ç»„ç”¨äºæ’å…¥ã€è·å–å’Œæ£€æŸ¥å…ƒç´ çš„æ–¹æ³•ã€‚ä¸æ™®é€šçš„é˜Ÿåˆ—ä¸åŒï¼ŒBlockingQueueåœ¨é˜Ÿåˆ—ä¸ºç©ºæ—¶ï¼Œè·å–å…ƒç´ çš„æ“ä½œä¼šè¢«é˜»å¡ï¼Œç›´åˆ°é˜Ÿåˆ—ä¸­æœ‰å¯ç”¨å…ƒç´ ä¸ºæ­¢ã€‚åŒæ ·åœ°ï¼Œå½“é˜Ÿåˆ—å·²æ»¡æ—¶ï¼Œæ’å…¥å…ƒç´ çš„æ“ä½œä¹Ÿä¼šè¢«é˜»å¡ï¼Œç›´åˆ°é˜Ÿåˆ—æœ‰ç©ºé—²ç©ºé—´ä¸ºæ­¢ã€‚</p>
<p>BlockQueueæœ‰å››ç»„APIï¼š</p>
<p><img src="/../images/Java%E7%BA%BF%E7%A8%8B%E6%B1%A0/image-20240903161114544.png" alt="image-20240903161114544"></p>
<p>BlockingQueueæä¾›äº†å¤šä¸ªå®ç°ç±»ï¼Œå…¶ä¸­å¸¸ç”¨çš„æœ‰ä»¥ä¸‹å‡ ç§ï¼š</p>
<ol>
<li><code>ArrayBlockingQueue</code>ï¼šåŸºäºæ•°ç»„å®ç°çš„æœ‰ç•Œé˜»å¡é˜Ÿåˆ—ã€‚å®ƒåœ¨æ„é€ æ—¶éœ€è¦æŒ‡å®šé˜Ÿåˆ—çš„å®¹é‡ï¼Œå¹¶ä¸”åœ¨é˜Ÿåˆ—å·²æ»¡æ—¶ä¼šé˜»å¡æ’å…¥æ“ä½œï¼Œç›´åˆ°æœ‰ç©ºé—²ç©ºé—´ã€‚</li>
<li><code>LinkedBlockingQueue</code>ï¼šåŸºäºé“¾è¡¨å®ç°çš„å¯é€‰æœ‰ç•Œæˆ–æ— ç•Œé˜»å¡é˜Ÿåˆ—ã€‚å¦‚æœæ„é€ æ—¶ä¸æŒ‡å®šå®¹é‡ï¼Œåˆ™é˜Ÿåˆ—å¤§å°é»˜è®¤ä¸ºæ— é™åˆ¶ã€‚</li>
<li><code>PriorityBlockingQueue</code>ï¼šåŸºäºä¼˜å…ˆçº§å †å®ç°çš„æ— ç•Œé˜»å¡é˜Ÿåˆ—ã€‚å…ƒç´ æŒ‰ç…§ä¼˜å…ˆçº§è¿›è¡Œæ’åºï¼Œå¯ä»¥è‡ªå®šä¹‰æ¯”è¾ƒå™¨ã€‚</li>
<li><code>SynchronousQueue</code>ï¼šåŒæ­¥é˜Ÿåˆ—ã€‚æ˜¯ä¸€ä¸ªæ²¡æœ‰å®¹é‡çš„é˜»å¡é˜Ÿåˆ—ï¼Œä»»ä½•ä¸€æ¬¡æ’å…¥æ“ä½œçš„å…ƒç´ éƒ½è¦ç­‰å¾…ç›¸å¯¹çš„åˆ é™¤/è¯»å–æ“ä½œï¼Œå¦åˆ™è¿›è¡Œè¡Œè¡Œæ’å…¥æ“ä½œçš„çº¿ç¨‹å°±è¦ä¸€ç›´ç­‰å¾…,åä¹‹äº¦ç„¶<ol>
<li>è¿›å»ä¸€ä¸ªå…ƒç´ ï¼Œå¿…é¡»ç­‰å¾…å–å‡ºæ¥ä¹‹åï¼Œæ‰èƒ½å†å¾€é‡Œé¢æ”¾å…¥ä¸€ä¸ªå…ƒç´ </li>
<li>ä½¿ç”¨locké”ä¿è¯çº¿ç¨‹å®‰å…¨çš„</li>
</ol>
</li>
<li><code>DelayQueue</code>ï¼šåŸºäºä¼˜å…ˆçº§å †å®ç°çš„å»¶è¿Ÿé˜»å¡é˜Ÿåˆ—ã€‚å…¶ä¸­çš„å…ƒç´ å¿…é¡»å®ç°<code>Delayed</code>æ¥å£ï¼Œåªæœ‰ç»è¿‡ä¸€å®šæ—¶é—´åæ‰èƒ½è¢«å–å‡ºã€‚</li>
</ol>
<p><em><strong>BlockingQueueå®ç°åŸç†ï¼šReentrantLock + Condition</strong></em></p>
<p><code>ArrayBlockingQueue</code>å’Œ<code>LinkedBlockingQueue</code>åŒºåˆ«ï¼š<br>    - <code>ArrayBlockingQueue</code>ä½¿ç”¨æ•°ç»„ä½œç¼“å†²åŒºï¼Œæœ‰ç•Œï¼Œç”Ÿäº§è€…æ¶ˆè´¹è€…ä¹‹é—´ä½¿ç”¨<strong>ç‹¬å é”</strong>ï¼Œå³ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…å…±ç”¨ä¸€æŠŠç¼“å†²åŒºçš„é”ï¼Œå‡ºé˜Ÿå’Œå…¥é˜Ÿä¸èƒ½åŒæ—¶è¿›è¡Œ<br>    - <code>LinkedBlockingQueue</code>ä½¿ç”¨é“¾è¡¨ä½œç¼“å†²åŒºï¼Œæ— ç•Œï¼Œç”Ÿäº§è€…æ¶ˆè´¹è€…ä¹‹é—´ä½¿ç”¨<strong>åˆ†ç¦»é”</strong>ï¼Œå³ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…åˆ†åˆ«ç”¨ä¸€æŠŠç¼“å†²åŒºçš„é”ï¼Œå‡ºé˜Ÿå’Œå…¥é˜Ÿå¯ä»¥åŒæ—¶è¿›è¡Œ</p>
<h3 id="æ‹’ç»ç­–ç•¥"><a href="#æ‹’ç»ç­–ç•¥" class="headerlink" title="æ‹’ç»ç­–ç•¥"></a>æ‹’ç»ç­–ç•¥</h3><p>  å¦‚ä¸Šé¢ä»‹ç»ï¼Œæ‹’ç»ç­–ç•¥éœ€è¦å®ç°<code>RejectedExecutionHandler</code>æ¥å£ï¼Œ<code>Executors</code>ä¸ºæˆ‘ä»¬æä¾›äº†4ç§æ‹’ç»ç­–ç•¥ï¼š</p>
<ul>
<li><code>AbortPolicy</code>ï¼ˆé»˜è®¤ï¼‰ï¼šä¸¢å¼ƒä»»åŠ¡å¹¶æŠ›å‡º<code>RejectedExecutionException</code>å¼‚å¸¸</li>
<li><code>CallerRunsPolicy</code>ï¼šç›´æ¥è¿è¡Œè¿™ä¸ªä»»åŠ¡çš„runæ–¹æ³•ï¼Œä½†å¹¶éæ˜¯ç”±çº¿ç¨‹æ± å¤„ç†ï¼Œè€Œæ˜¯äº¤ç”±ä»»åŠ¡çš„è°ƒç”¨çº¿ç¨‹å¤„ç†</li>
<li><code>DiscardPolicy</code>ï¼šç›´æ¥ä¸¢å¼ƒä»»åŠ¡ï¼Œä¸æŠ›å‡ºä»»ä½•å¼‚å¸¸</li>
<li><code>DiscardOldestPolicy</code>ï¼šå°†å½“å‰å¤„äºç­‰å¾…é˜Ÿåˆ—åˆ—å¤´çš„ç­‰å¾…ä»»åŠ¡å¼ºè¡Œå–å‡ºï¼Œç„¶åå†è¯•å›¾å°†å½“å‰è¢«æ‹’ç»çš„ä»»åŠ¡æäº¤</li>
</ul>
<h2 id="å¸¸è§çº¿ç¨‹æ± ç§ç±»"><a href="#å¸¸è§çº¿ç¨‹æ± ç§ç±»" class="headerlink" title="å¸¸è§çº¿ç¨‹æ± ç§ç±»"></a>å¸¸è§çº¿ç¨‹æ± ç§ç±»</h2><p>å››ç§çº¿ç¨‹æ± çš„ç‰¹ç‚¹ï¼š</p>
<ul>
<li><code>SingleThreadExecutor</code>å•çº¿ç¨‹çº¿ç¨‹æ± <ul>
<li>ç‰¹ç‚¹ï¼šçº¿ç¨‹æ± åªæœ‰ä¸€ä¸ªçº¿ç¨‹</li>
<li>ä½¿ç”¨ä¸€ä¸ª<code>LinkedBlockingQueue</code>ä½œä¸ºå·¥ä½œé˜Ÿåˆ—ï¼ŒæœªæŒ‡å®šå®¹é‡ï¼ˆé»˜è®¤å€¼<code>Integer.MAX_VALUE</code>ï¼‰</li>
</ul>
</li>
<li><code>FixedThreadPool</code>å›ºå®šçº¿ç¨‹æ± <ul>
<li>ç‰¹ç‚¹ï¼šæœ€å¤§çº¿ç¨‹æ•°å°±æ˜¯æ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œ<strong>å³åªæœ‰æ ¸å¿ƒçº¿ç¨‹</strong></li>
<li><code>keepAliveTime=0</code>ï¼Œä½†æ ¸å¿ƒçº¿ç¨‹ä¸ä¼šè¢«å›æ”¶æˆ–è€…é”€æ¯</li>
<li>æ— ç•Œé˜Ÿåˆ—ï¼šä½¿ç”¨<code>LinkedBlockingQueue</code>ä½œä¸ºå·¥ä½œé˜Ÿåˆ—ï¼ŒæœªæŒ‡å®šå®¹é‡ï¼ˆé»˜è®¤å€¼<code>Integer.MAX_VALUE</code>ï¼‰</li>
<li>é€‚ç”¨äºéœ€è¦æœ‰ä¸€å®šæŒç»­å¹¶å‘é‡çš„åœºæ™¯</li>
</ul>
</li>
<li><code>CachedThreadPool</code>ç¼“å­˜çº¿ç¨‹æ± <ul>
<li><strong>æ²¡æœ‰æ ¸å¿ƒçº¿ç¨‹ï¼Œæ™®é€šçº¿ç¨‹æ•°é‡æ— é™</strong></li>
<li><code>keepAliveTime=60</code>ï¼Œçº¿ç¨‹é—²ç½®60såå›æ”¶</li>
<li>ä½¿ç”¨<code>SynchronousQueue</code>ä½œä¸ºå·¥ä½œé˜Ÿåˆ—ï¼Œå®ƒä¸ä¼šä¿å­˜ä»»åŠ¡ï¼Œè€Œæ˜¯ç›´æ¥å°†ä»»åŠ¡äº¤ç»™ç©ºé—²çº¿ç¨‹æ‰§è¡Œ</li>
<li>å¤„ç†å¤§é‡çŸ­æ—¶é—´å·¥ä½œä»»åŠ¡çš„çº¿ç¨‹æ± ï¼Œé€‚ç”¨äºé¡¹ç›®ä¸­å¤šçº¿ç¨‹çš„åœºæ™¯ä¸å¤šæˆ–è€…æ˜¯éœ€è¦å¿«é€Ÿå“åº”çš„åœºæ™¯ï¼Œå³æ¥å³å¤„ç†ï¼Œä¸”ç”¨å®Œé‡Šæ”¾ï¼Œä¸å ç”¨è¿‡å¤šèµ„æº</li>
</ul>
</li>
<li><code>ScheduledThreadPool</code>å®šæ—¶çº¿ç¨‹æ± <ul>
<li><strong>æŒ‡å®šæ ¸å¿ƒçº¿ç¨‹æ•°é‡ï¼Œæ™®é€šçº¿ç¨‹æ•°é‡æ— é™</strong></li>
<li>ä»»åŠ¡é˜Ÿåˆ—ä¸ºå»¶æ—¶é˜»å¡é˜Ÿåˆ—<code>DelayQueue</code></li>
<li>é€‚ç”¨ç”¨äºæ‰§è¡Œå®šæ—¶æˆ–å‘¨æœŸæ€§çš„ä»»åŠ¡</li>
</ul>
</li>
</ul>
<h2 id="çº¿ç¨‹æ± è°ƒä¼˜"><a href="#çº¿ç¨‹æ± è°ƒä¼˜" class="headerlink" title="çº¿ç¨‹æ± è°ƒä¼˜"></a>çº¿ç¨‹æ± è°ƒä¼˜</h2><p>åœ¨è®¾ç½®çº¿ç¨‹æ± å¤§å°æ—¶ï¼Œå¯ä»¥è€ƒè™‘ä»»åŠ¡ç±»å‹å’Œç³»ç»Ÿèµ„æºçš„ç‰¹ç‚¹ï¼Œä»¥ç¡®å®šé€‚å½“çš„çº¿ç¨‹æ± å¤§å°ã€‚å…·ä½“è€Œè¨€ï¼Œå¯¹äº CPU å¯†é›†å‹ä»»åŠ¡å’Œ I/O å¯†é›†å‹ä»»åŠ¡ï¼Œå¯ä»¥é‡‡å–ä»¥ä¸‹å»ºè®®ï¼š</p>
<ul>
<li><strong>CPU å¯†é›†å‹ä»»åŠ¡</strong><ul>
<li>å¯¹äº CPU å¯†é›†å‹ä»»åŠ¡ï¼Œçº¿ç¨‹æ•°åº”ä¸ CPU æ ¸å¿ƒæ•°ç›¸è¿‘æˆ–ç¨å¤šä¸€äº›ï¼Œä»¥å……åˆ†åˆ©ç”¨ CPU èµ„æºï¼Œå¹¶é¿å…è¿‡å¤šçš„çº¿ç¨‹ç«äº‰å’Œä¸Šä¸‹æ–‡åˆ‡æ¢å¼€é”€ã€‚</li>
<li>å¯ä»¥é€šè¿‡ <code>Runtime.getRuntime().availableProcessors()</code> è·å–å½“å‰ç³»ç»Ÿçš„ CPU æ ¸å¿ƒæ•°ï¼Œä½œä¸ºçº¿ç¨‹æ± çš„æ ¸å¿ƒçº¿ç¨‹æ•°ã€‚</li>
<li>ç”±äº CPU å¯†é›†å‹ä»»åŠ¡ä¸æ¶‰åŠé˜»å¡ç­‰å¾…ï¼Œå¯ä»¥é€‰æ‹©è¾ƒå°çš„å·¥ä½œé˜Ÿåˆ—å®¹é‡æˆ–ä½¿ç”¨ <code>SynchronousQueue</code>ï¼Œä½¿å¾—ä»»åŠ¡æäº¤åç«‹å³æ‰§è¡Œã€‚</li>
</ul>
</li>
<li><strong>I/O å¯†é›†å‹ä»»åŠ¡</strong><ul>
<li>å¯¹äº I/O å¯†é›†å‹ä»»åŠ¡ï¼Œä¸€èˆ¬å»ºè®®å°†çº¿ç¨‹æ•°è®¾ç½®ä¸º CPU æ ¸å¿ƒæ•°çš„å‡ å€ï¼Œä¾‹å¦‚ 2 å€æˆ– 4 å€ï¼Œä»¥å……åˆ†åˆ©ç”¨ I/O æ“ä½œçš„ç­‰å¾…æ—¶é—´ï¼Œæé«˜ç³»ç»Ÿçš„ååé‡ã€‚</li>
<li>ç”±äº I/O æ“ä½œä¼šæ¶‰åŠåˆ°é˜»å¡ç­‰å¾…ï¼Œå¯ä»¥è®¾ç½®è¾ƒå¤§çš„å·¥ä½œé˜Ÿåˆ—å®¹é‡ï¼Œä»¥å¤„ç†å¯èƒ½çš„ä»»åŠ¡ç§¯å‹ã€‚</li>
</ul>
</li>
</ul>
<p>å®é™…çº¿ç¨‹æ± å¤§å°çš„é€‰æ‹©è¿˜å–å†³äºä»»åŠ¡çš„å…·ä½“ç‰¹ç‚¹å’Œç³»ç»Ÿèµ„æºçš„é™åˆ¶ã€‚åœ¨å®é™…åº”ç”¨ä¸­ï¼Œå¯ä»¥é€šè¿‡æµ‹è¯•å’Œæ€§èƒ½è°ƒä¼˜æ¥ç¡®å®šæœ€ä½³çš„çº¿ç¨‹æ± å¤§å°ï¼Œç¡®ä¿ä»»åŠ¡èƒ½å¤Ÿé«˜æ•ˆæ‰§è¡Œå¹¶å……åˆ†åˆ©ç”¨ç³»ç»Ÿèµ„æºã€‚</p>
<p><a href="/2024/02/03/%E7%BA%BF%E7%A8%8B%E6%B1%A0%E5%9C%A8%E4%B8%9A%E5%8A%A1%E4%B8%AD%E7%9A%84%E5%AE%9E%E8%B7%B5%E4%BB%A5%E5%8F%8A%E5%AF%B9%E5%BA%94%E5%8F%82%E6%95%B0%E5%A6%82%E4%BD%95%E8%AE%BE%E8%AE%A1/">çº¿ç¨‹æ± åœ¨ä¸šåŠ¡ä¸­çš„å®è·µä»¥åŠå¯¹åº”å‚æ•°å¦‚ä½•è®¾è®¡</a></p>
]]></content>
      <categories>
        <category>å¹¶å‘ç¼–ç¨‹</category>
      </categories>
      <tags>
        <tag>çº¿ç¨‹æ± </tag>
      </tags>
  </entry>
  <entry>
    <title>LangChainå…¥é—¨ç¬”è®°</title>
    <url>/2024/04/27/LangChain%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/</url>
    <content><![CDATA[<h1 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h1><blockquote>
<p>LangChainæ˜¯ä¸€ä¸ªç”¨äºå¼€å‘ç”±è¯­è¨€æ¨¡å‹é©±åŠ¨çš„åº”ç”¨ç¨‹åºçš„æ¡†æ¶ã€‚</p>
<p>ä¸»è¦åŠŸèƒ½ï¼š</p>
<ul>
<li><p>è°ƒç”¨è¯­è¨€æ¨¡å‹</p>
</li>
<li><p>å°†ä¸åŒæ•°æ®æºæ¥å…¥åˆ°è¯­è¨€æ¨¡å‹çš„äº¤äº’ä¸­</p>
</li>
<li><p>å…è®¸è¯­è¨€æ¨¡å‹ä¸è¿è¡Œç¯å¢ƒäº¤äº’</p>
</li>
</ul>
</blockquote>
<p><strong>åŸºæœ¬æ¶æ„</strong></p>
<p><img src="/../images/LangChain%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/langchain_stack_dark_0TT7SLpV72.svg"></p>
<p><strong>LangChainä¸­æä¾›çš„æ¨¡å—</strong></p>
<ul>
<li><p>Modulesï¼šæ”¯æŒçš„æ¨¡å‹ç±»å‹å’Œé›†æˆã€‚</p>
</li>
<li><p>Promptï¼šæç¤ºè¯ç®¡ç†ã€ä¼˜åŒ–å’Œåºåˆ—åŒ–ã€‚</p>
</li>
<li><p>Memoryï¼šå†…å­˜æ˜¯æŒ‡åœ¨é“¾/ä»£ç†è°ƒç”¨ä¹‹é—´æŒç»­å­˜åœ¨çš„çŠ¶æ€ã€‚</p>
</li>
<li><p>Indexesï¼šå½“è¯­è¨€æ¨¡å‹ä¸ç‰¹å®šäºåº”ç”¨ç¨‹åºçš„æ•°æ®ç›¸ç»“åˆæ—¶ï¼Œä¼šå˜å¾—æ›´åŠ å¼ºå¤§-æ­¤æ¨¡å—åŒ…å«ç”¨äºåŠ è½½ã€æŸ¥è¯¢å’Œæ›´æ–°å¤–éƒ¨æ•°æ®çš„æ¥å£å’Œé›†æˆã€‚</p>
</li>
<li><p>Chainï¼šé“¾æ˜¯ç»“æ„åŒ–çš„è°ƒç”¨åºåˆ—ï¼ˆå¯¹LLMæˆ–å…¶ä»–å®ç”¨ç¨‹åºï¼‰ã€‚</p>
</li>
<li><p>Agentsï¼šä»£ç†æ˜¯ä¸€ä¸ªé“¾ï¼Œå…¶ä¸­LLMåœ¨ç»™å®šé«˜çº§æŒ‡ä»¤å’Œä¸€ç»„å·¥å…·çš„æƒ…å†µä¸‹ï¼Œåå¤å†³å®šæ“ä½œï¼Œæ‰§è¡Œæ“ä½œå¹¶è§‚å¯Ÿç»“æœï¼Œç›´åˆ°é«˜çº§æŒ‡ä»¤å®Œæˆã€‚</p>
</li>
<li><p>Callbacksï¼šå›è°ƒå…è®¸æ‚¨è®°å½•å’Œæµå¼ä¼ è¾“ä»»ä½•é“¾çš„ä¸­é—´æ­¥éª¤ï¼Œä»è€Œè½»æ¾è§‚å¯Ÿã€è°ƒè¯•å’Œè¯„ä¼°åº”ç”¨<br>ç¨‹åºçš„å†…éƒ¨ã€‚</p>
</li>
</ul>
<p><strong>åº”ç”¨åœºæ™¯</strong></p>
<ul>
<li>æ–‡æ¡£é—®ç­”</li>
<li>æŸ¥è¯¢æ•°æ®è¡¨æ ¼ï¼ˆCSVã€SQLã€DataFrameç­‰ï¼‰</li>
<li>APIäº¤äº’ã€ä¿¡æ¯æå–ã€æ–‡æ¡£æ€»ç»“ç­‰</li>
</ul>
<h1 id="Model-I-O"><a href="#Model-I-O" class="headerlink" title="Model I/O"></a>Model I/O</h1><p>å››ä¸ªæ ¸å¿ƒç»„ä»¶ï¼š</p>
<ul>
<li>Prompts æç¤ºè¯</li>
<li>Chat Models èŠå¤©æ¨¡å‹<ul>
<li>æ“…é•¿å¯¹è¯</li>
</ul>
</li>
<li>LLMs çº¯æ–‡æœ¬æ¨¡å‹<ul>
<li>æ“…é•¿ç†è§£å’Œåˆæˆæ–‡æœ¬æ–¹é¢ï¼Œä¾‹å¦‚æ€»ç»“æ–‡æ¡£ã€PDFã€æ¦‚å¿µé¡µé¢ç­‰</li>
</ul>
</li>
<li>Output parsers è¾“å‡ºè½¬æ¢å™¨</li>
</ul>
<blockquote>
<p>ğŸ“ŒChat Models å’Œ LLMs çš„åŒºåˆ«ï¼š</p>
<p>Chat modelså’ŒLLMséƒ½æ˜¯LangChainä¸­çš„è¯­è¨€æ¨¡å‹æŠ½è±¡ï¼Œä½†æ˜¯LLMsæ˜¯çº¯è¯­è¨€æ¨¡å‹ï¼ŒChat modelsæ˜¯é’ˆå¯¹å¯¹è¯åšäº†ä¼˜åŒ–çš„èŠå¤©æ¨¡å‹</p>
</blockquote>
<h1 id="Agents"><a href="#Agents" class="headerlink" title="Agents"></a>Agents</h1><blockquote>
<p>å¤§å‹è¯­è¨€æ¨¡å‹ï¼ˆLLMsï¼‰éå¸¸å¼ºå¤§ï¼Œä½†å®ƒä»¬ç¼ºä¹â€œæœ€ç¬¨â€çš„è®¡ç®—æœºç¨‹åºå¯ä»¥è½»æ¾å¤„ç†çš„ç‰¹å®šèƒ½åŠ›ã€‚LLM å¯¹é€»è¾‘æ¨ç†ã€è®¡ç®—å’Œæ£€ç´¢å¤–éƒ¨ä¿¡æ¯çš„èƒ½åŠ›è¾ƒå¼±ï¼Œè¿™ä¸æœ€ç®€å•çš„è®¡ç®—æœºç¨‹åºå½¢æˆå¯¹æ¯”ã€‚ä¾‹å¦‚ï¼Œè¯­è¨€æ¨¡å‹æ— æ³•å‡†ç¡®å›ç­”ç®€å•çš„è®¡ç®—é—®é¢˜ï¼Œè¿˜æœ‰å½“è¯¢é—®æœ€è¿‘å‘ç”Ÿçš„äº‹ä»¶æ—¶ï¼Œå…¶å›ç­”ä¹Ÿå¯èƒ½è¿‡æ—¶æˆ–é”™è¯¯ï¼Œå› ä¸ºæ— æ³•ä¸»åŠ¨è·å–<br>æœ€æ–°ä¿¡æ¯ã€‚è¿™æ˜¯ç”±äºå½“å‰è¯­è¨€æ¨¡å‹ä»…ä¾èµ–é¢„è®­ç»ƒæ•°æ®ï¼Œä¸å¤–ç•Œâ€œæ–­å¼€â€ã€‚è¦å…‹æœè¿™ä¸€ç¼ºé™·ï¼Œ LangChain æ¡†<br>æ¶æå‡ºäº† â€œä»£ç†â€(Agent) çš„è§£å†³æ–¹æ¡ˆã€‚</p>
</blockquote>
<p>Agentä½œä¸ºè¯­è¨€æ¨¡å‹çš„å¤–éƒ¨æ¨¡å—ï¼Œå¯æä¾›è®¡ç®—ã€é€»è¾‘ã€æ£€ç´¢ç­‰åŠŸèƒ½çš„æ”¯æŒï¼Œä½¿è¯­è¨€æ¨¡å‹è·å¾—å¼‚å¸¸å¼ºå¤§çš„æ¨ç†å’Œè·å–ä¿¡æ¯çš„è¶…èƒ½åŠ›ã€‚</p>
<hr>
<p>Agentsçš„æ ¸å¿ƒæ€æƒ³æ˜¯ä½¿ç”¨è¯­è¨€æ¨¡å‹æ¥é€‰æ‹©è¦é‡‡å–çš„ä¸€ç³»åˆ—Action</p>
<p>åœ¨langchainä¸­ï¼Œä¸€ç³»åˆ—Actionè¢«ç¡¬ç¼–ç ï¼ˆåœ¨ä»£ç ä¸­ï¼‰ã€‚</p>
<p>åœ¨Agentsä¸­ï¼Œè¯­è¨€æ¨¡å‹è¢«ç”¨ä½œæ¨ç†å¼•æ“æ¥ç¡®å®šè¦é‡‡å–å“ªäº›æ“ä½œä»¥åŠæŒ‰ä»€ä¹ˆé¡ºåºã€‚</p>
<p>ä¸åŒAgentsçš„åŒºåˆ«ï¼šä¸åŒçš„æ¨ç†æç¤ºé£æ ¼ã€ä¸åŒçš„ç¼–ç è¾“å…¥æ–¹å¼ä»¥åŠä¸åŒçš„è§£æè¾“å‡ºæ–¹å¼ã€‚</p>
<h2 id="åŸºæœ¬æ¦‚å¿µ"><a href="#åŸºæœ¬æ¦‚å¿µ" class="headerlink" title="åŸºæœ¬æ¦‚å¿µ"></a>åŸºæœ¬æ¦‚å¿µ</h2><h3 id="Schema"><a href="#Schema" class="headerlink" title="Schema"></a>Schema</h3><p>æ„å»ºä»£ç†çš„æ ¸å¿ƒç»„ä»¶</p>
<ul>
<li><code>AgentAction</code> å³Actionï¼Œè¡¨ç¤ºä»£ç†æ‰§è¡Œçš„æ“ä½œï¼Œé€šå¸¸è¡¨ç¤ºè°ƒç”¨tools<ul>
<li>æˆ‘ä»¬å°†æƒ³è®©å¯¹Agentsçš„æ“ä½œå°è£…æˆActionï¼ˆtoolsï¼‰ï¼Œå†è®©Agentsåœ¨è¢«è°ƒç”¨æ—¶é€‰æ‹©åº”è¯¥ä½¿ç”¨å“ªäº›tools</li>
<li>åœ¨<code>AgentAction</code>ä¸­æœ‰ä¸¤ä¸ªå±æ€§ï¼š<code>tool</code>å’Œ<code>tool_input</code>ï¼Œåˆ†åˆ«ä»£è¡¨å·¥å…·çš„åå­—å’Œå·¥å…·è¾“å…¥</li>
</ul>
</li>
<li><code>AgentFinish</code>  Agentsè¿”å›çš„æœ€ç»ˆç»“æœ</li>
<li><code>Intermediate Steps</code> ä¸­é—´æ­¥éª¤ã€‚ä»£è¡¨<code>AgentAction</code>ä»¥åŠå½“å‰Agentsè¿è¡Œçš„ç›¸åº”è¾“å‡º</li>
</ul>
<h3 id="Agent"><a href="#Agent" class="headerlink" title="Agent"></a>Agent</h3><ul>
<li><code>Agent Inputs</code> Agentsçš„è¾“å…¥ï¼Œé”®å€¼å¯¹ç±»å‹<ul>
<li>requiredï¼š<code>intermediate_steps</code></li>
</ul>
</li>
<li><code>Agent Outputs</code> Agentsçš„å“åº”ï¼Œåˆ†ä¸º<code>Union[AgentAction, List[AgentAction], AgentFinish]</code><ul>
<li>è¾“å‡ºè§£æå™¨è´Ÿè´£è·å–åŸå§‹ LLM è¾“å‡ºå¹¶å°†å…¶è½¬æ¢ä¸ºè¿™ä¸‰ç§ç±»å‹ä¹‹ä¸€</li>
</ul>
</li>
</ul>
<p>demoï¼š</p>
<figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line">agent = (</span><br><span class="line">    {</span><br><span class="line">        <span class="string">"input"</span>: <span class="keyword">lambda</span> x: x[<span class="string">"input"</span>],</span><br><span class="line">        <span class="string">"agent_scratchpad"</span>: <span class="keyword">lambda</span> x: format_to_openai_tool_messages(</span><br><span class="line">            x[<span class="string">"intermediate_steps"</span>]</span><br><span class="line">        ),</span><br><span class="line">    }</span><br><span class="line">    | prompt</span><br><span class="line">    | llm_with_tools</span><br><span class="line">    | OpenAIToolsAgentOutputParser()</span><br><span class="line">)</span><br></pre></td></tr></tbody></table></figure>

<h4 id="Agents-API"><a href="#Agents-API" class="headerlink" title="Agents API"></a>Agents API</h4><ul>
<li><code>AgentExecutor</code> é‡å¤è°ƒç”¨Agentså¹¶æ‰§è¡Œå·¥å…·<ul>
<li>å°è£…äº†å„ç§é”™è¯¯å¤„ç†ã€æ—¥å¿—ç­‰</li>
</ul>
</li>
</ul>
<h3 id="Tools"><a href="#Tools" class="headerlink" title="Tools"></a>Tools</h3><p>å·¥å…·æ˜¯ä»£ç†å¯ä»¥è°ƒç”¨â€‹â€‹çš„åŠŸèƒ½ã€‚ <code>Tool</code> æŠ½è±¡ç”±ä¸¤ä¸ªç»„ä»¶ç»„æˆï¼š</p>
<p>å·¥å…· API çš„ç›®æ ‡æ˜¯æ¯”ä½¿ç”¨é€šç”¨æ–‡æœ¬å®Œæˆæˆ–èŠå¤© API æ›´å¯é åœ°è¿”å›æœ‰æ•ˆä¸”æœ‰ç”¨çš„å·¥å…·è°ƒç”¨ã€‚</p>
<ul>
<li>schema</li>
<li>function</li>
</ul>
<p>è®¾è®¡Agentsçš„å…³é”®ï¼š</p>
<ul>
<li>è®©Agentsæ­£ç¡®çš„ä½¿ç”¨tools</li>
<li>ä»¥å¯¹ä»£ç†æœ€æœ‰å¸®åŠ©çš„æ–¹å¼æè¿°å·¥å…·</li>
</ul>
<h2 id="Agent-Type"><a href="#Agent-Type" class="headerlink" title="Agent Type"></a>Agent Type</h2><p>ä»‹ç»å‡ ä¸ªå¸¸ç”¨çš„Agent Type</p>
<p>ReActï¼šLLM å¯ä»¥å¾ªç¯è¿›è¡Œ Reasoning å’Œ Action æ­¥éª¤çš„è¿‡ç¨‹ã€‚å®ƒå¯ç”¨äº†ä¸€ä¸ªå¤šæ­¥éª¤çš„è¿‡ç¨‹æ¥è¯†åˆ«ç­”æ¡ˆã€‚</p>
<h1 id="Prompt"><a href="#Prompt" class="headerlink" title="Prompt"></a>Prompt</h1><p>æç¤ºè¯å·¥ç¨‹å’Œæ¨¡å‹å¾®è°ƒçš„åŒºåˆ«ï¼š</p>
<ul>
<li><p>å¾®è°ƒ</p>
<ul>
<li>å®šä¹‰ï¼šé’ˆå¯¹é¢„å…ˆè®­ç»ƒçš„è¯­è¨€æ¨¡å‹ï¼Œåœ¨ç‰¹å®šä»»åŠ¡çš„å°‘é‡æ•°æ®é›†ä¸Šå¯¹å…¶è¿›è¡Œè¿›ä¸€æ­¥è®­ç»ƒ</li>
<li>é€‚ç”¨åœºæ™¯ï¼šå½“ä»»åŠ¡æˆ–åŸŸå®šä¹‰æ˜ç¡®ï¼Œå¹¶ä¸”æœ‰è¶³å¤Ÿçš„æ ‡è®°æ•°æ®å¯ä¾›è®­ç»ƒæ—¶ï¼Œé€šå¸¸ä½¿ç”¨å¾®è°ƒè¿‡ç¨‹</li>
</ul>
</li>
<li><p>æç¤ºè¯å·¥ç¨‹</p>
<ul>
<li>æ¶‰åŠè®¾è®¡è‡ªç„¶è¯­è¨€æç¤ºæˆ–æŒ‡ä»¤ï¼Œå¯ä»¥æŒ‡å¯¼è¯­è¨€æ¨¡å‹æ‰§è¡Œç‰¹å®šä»»åŠ¡</li>
<li>æœ€é€‚åˆéœ€è¦é«˜ç²¾åº¦å’Œæ˜ç¡®è¾“å‡ºçš„ä»»åŠ¡ã€‚æç¤ºå·¥ç¨‹å¯ç”¨äºåˆ¶ä½œå¼•å‘æ‰€éœ€è¾“å‡ºçš„æŸ¥è¯¢</li>
</ul>
</li>
</ul>
<h1 id="Memory"><a href="#Memory" class="headerlink" title="Memory"></a>Memory</h1><p><img src="/../images/LangChain%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/memory_diagram-0627c68230aa438f9b5419064d63cbbc_TH.png"></p>
<p>å››ç§ä¸»è¦å‚¨å­˜æ¨¡å—ï¼š</p>
<ul>
<li><code>ConversationBufferMemory</code>å¯¹è¯ç¼“å­˜</li>
<li><code>ConversationTokenBufferMemory</code>æŒ‰çª—å£ç¼“å­˜</li>
<li><code>ConversationTokenBufferMemory</code>æŒ‰ä»¤ç‰Œç¼“å­˜</li>
<li><code>ConversationSummaryBufferMemory</code>æŒ‰æ‘˜è¦ç¼“å­˜</li>
</ul>
<p>æœ€å¸¸è§çš„å†…å­˜ç±»å‹ä¹‹ä¸€æ¶‰åŠè¿”å›èŠå¤©æ¶ˆæ¯åˆ—è¡¨ã€‚è¿™äº›å¯ä»¥ä½œä¸ºå•ä¸ªå­—ç¬¦ä¸²è¿”å›ï¼Œå…¨éƒ¨è¿æ¥åœ¨ä¸€èµ·ï¼ˆå½“å®ƒä»¬è¢«ä¼ é€’åˆ° LLMs æ—¶æœ‰ç”¨ï¼‰æˆ– ChatMessages åˆ—è¡¨ï¼ˆå½“ä¼ é€’åˆ° ChatModels æ—¶æœ‰ç”¨ï¼‰ã€‚</p>
<p>é»˜è®¤æƒ…å†µä¸‹ï¼Œå®ƒä»¬ä½œä¸ºå•ä¸ªå­—ç¬¦ä¸²è¿”å›ã€‚ä¸ºäº†ä½œä¸ºæ¶ˆæ¯åˆ—è¡¨è¿”å›ï¼Œæ‚¨å¯ä»¥è®¾ç½® <code>return_messages=True</code></p>
<p><img src="/../images/LangChain%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/image_6DBZDWLskV.png"></p>
<h1 id="Chains"><a href="#Chains" class="headerlink" title="Chains"></a>Chains</h1><p>é“¾æ˜¯æŒ‡è°ƒç”¨åºåˆ— - å³ LLMã€Toolsè¿˜æ˜¯æ•°æ®é¢„å¤„ç†æ­¥éª¤çš„å…ˆåé¡ºåºã€‚ä¸»è¦æ”¯æŒçš„æ–¹æ³•æ˜¯ä½¿ç”¨ LCELã€‚</p>
<h2 id="LCEL-Chains"><a href="#LCEL-Chains" class="headerlink" title="LCEL Chains"></a>LCEL Chains</h2><p>LangChain Expression Languageï¼ˆLCELï¼‰å¯ä»¥è½»æ¾åœ°ä»åŸºæœ¬ç»„ä»¶æ„å»ºå¤æ‚çš„é“¾ï¼Œå¹¶æ”¯æŒå¼€ç®±å³ç”¨çš„åŠŸèƒ½ï¼Œä¾‹å¦‚æµå¼ä¼ è¾“ã€å¹¶è¡Œæ€§å’Œæ—¥å¿—è®°å½•ï¼Œæœ€åŸºæœ¬å’Œå¸¸è§çš„ç”¨ä¾‹æ˜¯å°†Promptå’ŒLLMé“¾æ¥åœ¨ä¸€èµ·ã€‚</p>
<figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line">chain = prompt | model | output_parser</span><br></pre></td></tr></tbody></table></figure>

<p><a href="https://python.langchain.com/v0.1/docs/expression_language/get_started/" title="https://python.langchain.com/v0.1/docs/expression_language/get_started/">https://python.langchain.com/v0.1/docs/expression_language/get_started/</a></p>
<p>æ„ä¹‰ï¼šç»„åˆå¤§æ¨¡å‹è°ƒç”¨ä¸­ä¸ç›¸å…³çš„éƒ¨åˆ†ï¼Œè®©å¼€å‘è€…çœå»èƒ¶æ°´ä»£ç </p>
<p>ä¸‹é¢ä¸¾ä¸€äº›ç®€å•çš„æ —å­ï¼š</p>
<p>æ¨¡å‹è°ƒç”¨ï¼š</p>
<p><img src="/../images/LangChain%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/image_I16oGnpYi7.png"></p>
<p>Streamæµï¼š</p>
<p><img src="/../images/LangChain%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/image_8inhVIpa63.png"></p>
<p>Batchæ‰¹å¤„ç†ï¼š</p>
<p><img src="/../images/LangChain%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/image_HKv1CygTUu.png"></p>
<p>å¼‚æ­¥è°ƒç”¨ï¼š</p>
<p><img src="/../images/LangChain%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/image_wKdMBtlRZQ.png"></p>
<h1 id="RAG"><a href="#RAG" class="headerlink" title="RAG"></a>RAG</h1><p>å…¨ç§°Retrieval Augmented Generation (RAG)</p>
<p><img src="/../images/LangChain%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/data_connection-95ff2033a8faa5f3ba41376c0f6dd32a_6.jpg"></p>
<p>æ ¸å¿ƒç»„ä»¶ï¼š</p>
<ul>
<li><strong>Document loaders</strong>æ–‡æ¡£åŠ è½½å™¨</li>
<li>Text Splittingæ–‡æœ¬åˆ†å‰²å™¨ï¼Œå°†å¤§æ–‡æ¡£åˆ†å‰²ï¼ˆæˆ–åˆ†å—ï¼‰ä¸ºæ›´å°çš„å—ã€‚</li>
<li>Text Embedding modelsåµŒå…¥æ¨¡å‹ï¼Œç”¨äºå°†æ–‡æ¡£åµŒå…¥åˆ°Vector storesä¸­ï¼Œä¸»è¦æœ‰ä¸¤ç§å¸¸ç”¨æ–¹å¼ï¼š<ul>
<li>text2vector</li>
<li>llm</li>
</ul>
</li>
<li>Retrieversæ£€ç´¢å™¨ï¼Œç”¨äºåœ¨æ•°æ®æºä¸­æ£€ç´¢ç›¸å…³ä¿¡æ¯</li>
<li>Indexingæ•°æ®åº“ç´¢å¼•ï¼Œç”¨äºæ£€ç´¢</li>
</ul>
<h2 id="Retrieversæ£€ç´¢"><a href="#Retrieversæ£€ç´¢" class="headerlink" title="Retrieversæ£€ç´¢"></a>Retrieversæ£€ç´¢</h2><p>ç›¸å…³ç®—æ³•ï¼š</p>
<ul>
<li><p>åŸºæœ¬è¯­ä¹‰ç›¸ä¼¼åº¦ï¼ˆBasicsemanticsimilarity)</p>
</li>
<li><p>æœ€å¤§è¾¹é™…ç›¸å…³æ€§ï¼ˆMaximummarginalrelevanceï¼ŒMMR)</p>
</li>
<li><p>è¿‡æ»¤å…ƒæ•°æ®</p>
</li>
<li><p>LLMè¾…åŠ©æ£€ç´¢ SelfQueryRetriever</p>
</li>
<li><p>å‹ç¼© ContextualCompressionRetriever</p>
<ul>
<li>å·¥ä½œåŸç†ï¼šå…ˆä½¿ç”¨æ ‡å‡†å‘é‡æ£€ç´¢è·å¾—å€™é€‰æ–‡æ¡£ï¼Œç„¶ååŸºäºæŸ¥è¯¢è¯­å¥çš„è¯­ä¹‰ï¼Œä½¿ç”¨è¯­è¨€æ¨¡å‹å‹ç¼©è¿™äº›æ–‡æ¡£,åªä¿ç•™ä¸é—®é¢˜ç›¸å…³çš„éƒ¨åˆ†<br><img src="/../images/LangChain%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/image_vwodDD-H4n.png"></li>
</ul>
</li>
</ul>
<p>å…¶ä»–ç±»å‹çš„æ£€ç´¢ï¼š</p>
<p>vetordb å¹¶ä¸æ˜¯å”¯ä¸€ä¸€ç§æ£€ç´¢æ–‡æ¡£çš„å·¥å…·ã€‚ LangChain è¿˜æä¾›äº†å…¶ä»–æ£€ç´¢æ–‡æ¡£çš„æ–¹å¼ï¼Œä¾‹å¦‚ï¼š TF-IDF æˆ– SVM ã€‚</p>
<h2 id="å¯¹è¯æ£€ç´¢é“¾"><a href="#å¯¹è¯æ£€ç´¢é“¾" class="headerlink" title="å¯¹è¯æ£€ç´¢é“¾"></a>å¯¹è¯æ£€ç´¢é“¾</h2><h3 id="æ£€ç´¢é“¾ç±»å‹"><a href="#æ£€ç´¢é“¾ç±»å‹" class="headerlink" title="æ£€ç´¢é“¾ç±»å‹"></a>æ£€ç´¢é“¾ç±»å‹</h3><p>é€šè¿‡LangChainåˆ›å»ºä¸€ä¸ªæ£€ç´¢é—®ç­”é“¾ï¼Œå¯¹æ£€ç´¢åˆ°çš„æ–‡æ¡£è¿›è¡Œé—®é¢˜å›ç­”ã€‚æ£€ç´¢é—®ç­”é“¾çš„è¾“å…¥åŒ…å«ä»¥ä¸‹</p>
<ul>
<li>llmå¤§è¯­è¨€æ¨¡å‹</li>
<li><code>chain_type</code>æŒ‡å®šä¼ å…¥é“¾ï¼ˆç”¨äºå°†æ–‡æ¡£ä¼ é€’åˆ° LLM çš„ä¸Šä¸‹æ–‡çª—å£ä¸­ï¼‰ç±»å‹<ul>
<li><strong>Stuff</strong>ï¼šåªéœ€å°†æ‰€æœ‰æ–‡æ¡£â€œå¡â€åˆ°ä¸€ä¸ªæç¤ºä¸­å³å¯ï¼Œè¿™æ˜¯æœ€ç®€å•çš„æ–¹æ³•<ul>
<li>APIï¼šcreate_stuff_documents_chain</li>
</ul>
</li>
<li><strong>Map-reduce</strong>ï¼šå°†æ‰€æœ‰å—ä¸é—®é¢˜ä¸€èµ·ä¼ é€’ç»™è¯­è¨€æ¨¡å‹ï¼Œè·å–å›å¤ï¼Œä½¿ç”¨å¦ä¸€ä¸ªè¯­è¨€æ¨¡å‹è°ƒç”¨å°†æ‰€æœ‰å•ç‹¬çš„å›å¤æ€»ç»“æˆæœ€ç»ˆç­”æ¡ˆï¼Œå®ƒå¯ä»¥åœ¨ä»»æ„æ•°é‡çš„æ–‡æ¡£ä¸Šè¿è¡Œã€‚å¯ä»¥å¹¶è¡Œå¤„ç†å•ä¸ªé—®é¢˜ï¼ŒåŒæ—¶ä¹Ÿéœ€è¦æ›´å¤šçš„è°ƒç”¨ã€‚å®ƒå°†æ‰€æœ‰æ–‡æ¡£è§†ä¸ºç‹¬ç«‹çš„<ul>
<li>MapReduceDocumentsChain</li>
</ul>
</li>
<li><strong>Refine</strong><ul>
<li>å¾ªç¯è®¸å¤šæ–‡æ¡£ï¼Œå®é™…ä¸Šæ˜¯è¿­ä»£çš„ï¼Œå»ºç«‹åœ¨å…ˆå‰æ–‡æ¡£çš„ç­”æ¡ˆä¹‹ä¸Šï¼Œéå¸¸é€‚åˆå‰åå› æœä¿¡æ¯å¹¶éšæ—¶é—´é€æ­¥æ„å»ºç­”æ¡ˆï¼Œä¾èµ–äºå…ˆå‰è°ƒç”¨çš„ç»“æœã€‚</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><img src="/../images/LangChain%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/summarization_use_case_2-f2a4d5d60980a79140085fb7f.png" alt="Stuffå’ŒMapReduceåŒºåˆ«" title="Stuffå’ŒMapReduceåŒºåˆ«"></p>
<p><img src="/../images/LangChain%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/image_5N5XBgZFMJ.png"></p>
<h3 id="ç¤ºä¾‹"><a href="#ç¤ºä¾‹" class="headerlink" title="ç¤ºä¾‹"></a>ç¤ºä¾‹</h3><figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain.chains.combine_documents.stuff <span class="keyword">import</span> StuffDocumentsChain</span><br><span class="line"><span class="keyword">from</span> langchain.chains.llm <span class="keyword">import</span> LLMChain</span><br><span class="line"><span class="keyword">from</span> langchain_core.prompts <span class="keyword">import</span> PromptTemplate</span><br><span class="line"></span><br><span class="line"><span class="comment"># Define prompt</span></span><br><span class="line">prompt_template = <span class="string">"""Write a concise summary of the following:</span></span><br><span class="line"><span class="string">"{text}"</span></span><br><span class="line"><span class="string">CONCISE SUMMARY:"""</span></span><br><span class="line">prompt = PromptTemplate.from_template(prompt_template)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Define LLM chain</span></span><br><span class="line">llm = ChatOpenAI(temperature=<span class="number">0</span>, model_name=<span class="string">"gpt-3.5-turbo-16k"</span>)</span><br><span class="line">llm_chain = LLMChain(llm=llm, prompt=prompt)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Define StuffDocumentsChain</span></span><br><span class="line">stuff_chain = StuffDocumentsChain(llm_chain=llm_chain, document_variable_name=<span class="string">"text"</span>)</span><br><span class="line"></span><br><span class="line">docs = loader.load()</span><br><span class="line"><span class="built_in">print</span>(stuff_chain.run(docs))</span><br></pre></td></tr></tbody></table></figure>
]]></content>
      <categories>
        <category>AI</category>
      </categories>
      <tags>
        <tag>langchain</tag>
        <tag>LLM</tag>
      </tags>
  </entry>
  <entry>
    <title>ğŸ›å¼€æºç»å†ï¼šLangChain4j-Spring Bugä¿®å¤è®°å½•</title>
    <url>/2024/08/25/LangChain4j-Spring-Bug/</url>
    <content><![CDATA[<h3 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h3><p>åœ¨ä½¿ç”¨Langchain4jçš„è¿‡ç¨‹ä¸­å‘ç°ï¼Œå¦‚æœåœ¨å¯åŠ¨ç±»æ‰€åœ¨çš„classPathä»¥å¤–çš„ç›®å½•ä¸­å®šä¹‰äº†<code>AiService</code>ï¼Œé‚£ä¹ˆè¯¥ç±»å°†ä¸ä¼šè¢«Langchain4jæ‰«æå¹¶ä»£ç†åˆ°ï¼Œå³ä½¿ä½ ä½¿ç”¨<code>@ComponentScan</code>æˆ–è€…å…¶ä»–æ–¹å¼æŒ‡å®šäº†æ–‡ä»¶æ‰«æè·¯å¾„</p>
<p>æŸ¥çœ‹æºç åå‘ç°ï¼ŒLangchain4jä¸­ <code>AiService</code> åªä¼šæ‰«æå¯åŠ¨ç±»æ‰€åœ¨çš„classPathï¼Œè€Œå¯¹äºå…¶ä»–æ–¹å¼é…ç½®çš„æ‰«æè·¯å¾„éƒ½æ²¡æœ‰è¿›è¡Œå¤„ç†ï¼Œä¹Ÿæ²¡æœ‰å®ç°å…¶ä»–é…ç½®æ‰‹æ®µèƒ½å¤Ÿè®©ç”¨æˆ·æŒ‡å®šæ‰«æè·¯å¾„ï¼Œæœ€åå°±å¯¼è‡´äº† <code>AiService</code> ä¸å­˜åœ¨çš„Bug _(:Ğ·ã€âˆ )_</p>
<p><strong>ç›¸å…³issue</strong></p>
<ul>
<li><a href="https://github.com/langchain4j/langchain4j/issues/1606">https://github.com/langchain4j/langchain4j/issues/1606</a></li>
<li><a href="https://github.com/langchain4j/langchain4j-spring/pull/35">https://github.com/langchain4j/langchain4j-spring/pull/35</a></li>
<li><a href="https://github.com/langchain4j/langchain4j-spring/pull/48">https://github.com/langchain4j/langchain4j-spring/pull/48</a></li>
</ul>
<blockquote>
<p><em>Tipsï¼š</em>è¿™ä¹Ÿæ˜¯æˆ‘ç¬¬ä¸€æ¬¡å‚åŠ å¼€æºï¼Œè™½ç„¶åªæ˜¯åšäº†ä¸€ä¸ªå¾®ä¸è¶³é“çš„è´¡çŒ®ï¼Œä½†æ˜¯è¿˜æ˜¯æ„Ÿè§‰æ”¶è·å¾ˆå¤šå§â€¦ä¸€ç›´åœ¨æ‹…å¿ƒè‡ªå·±çš„æ°´å¹³ä¸å¤Ÿæ‰€ä»¥åå¤ç†è§£åå¤æŸ¥èµ„æ–™ï¼Œä½†æ˜¯ä½œè€…å¾ˆçƒ­å¿ƒå¸®æˆ‘ä¿®æ”¹äº†ä»£ç å¹¶ä¸”å¾ˆå¿«å°±è¢«å¤„ç†æ¥å—äº†ğŸ˜ƒ</p>
</blockquote>
<h2 id="é—®é¢˜åˆ†æ"><a href="#é—®é¢˜åˆ†æ" class="headerlink" title="é—®é¢˜åˆ†æ"></a>é—®é¢˜åˆ†æ</h2><p>é¡¹ç›®ä¸­ç›¸å…³ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> Set&lt;Class&lt;?&gt;&gt; findAiServices(ConfigurableListableBeanFactory beanFactory) {</span><br><span class="line">  String[] applicationBean = beanFactory.getBeanNamesForAnnotation(SpringBootApplication.class);</span><br><span class="line">  <span class="type">BeanDefinition</span> <span class="variable">applicationBeanDefinition</span> <span class="operator">=</span> beanFactory.getBeanDefinition(applicationBean[<span class="number">0</span>]);</span><br><span class="line">  <span class="type">String</span> <span class="variable">basePackage</span> <span class="operator">=</span> applicationBeanDefinition.getResolvableType().resolve().getPackage().getName();</span><br><span class="line">  <span class="type">Reflections</span> <span class="variable">reflections</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Reflections</span>((<span class="keyword">new</span> <span class="title class_">ConfigurationBuilder</span>()).forPackage(basePackage));</span><br><span class="line">  Set&lt;Class&lt;?&gt;&gt; classes = reflections.getTypesAnnotatedWith(AiService.class);</span><br><span class="line">  classes.removeIf(clazz -&gt; !clazz.getName().startsWith(basePackage));</span><br><span class="line">  <span class="keyword">return</span> classes;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>å¤§è‡´é€»è¾‘å°±æ˜¯ï¼Œè·å–å¯åŠ¨ç±»æ‰€åœ¨çš„è·¯å¾„ï¼Œç„¶åä½¿ç”¨åå°„æ‰¾åˆ°è¯¥è·¯å¾„ä¸‹æ‰€æœ‰å¸¦æœ‰AiServiceçš„classã€‚</p>
<p>ç›®å‰æœ‰ä¸¤ä¸ªé—®é¢˜ï¼š</p>
<ol>
<li>æ‰«æè·¯å¾„çš„è·å–ã€‚åœ¨ä¸å¢åŠ é¢å¤–çš„ç”¨æˆ·é…ç½®çš„æƒ…å†µä¸‹ï¼Œå¦‚ä½•çŸ¥é“åº”è¯¥æ‰«æå…¨éƒ¨çš„è·¯å¾„å‘¢ï¼Ÿç”¨æˆ·æŒ‡å®šæ‰«æè·¯å¾„çš„æ–¹å¼æœ‰å¾ˆå¤šç§ï¼Œå…¶ä¸­æœ€å¸¸ç”¨çš„å°±æ˜¯é€šè¿‡<code>@ComponentScan</code>æŒ‡å®šï¼Œäºæ˜¯æƒ³åˆ°æˆ‘ä»¬å¯ä»¥è§£æé¡¹ç›®ä¸­æ‰€æœ‰<code>@ComponentScan</code>æ³¨è§£ï¼Œä»¥æ­¤ä½œä¸ºæ‰«æè·¯å¾„</li>
<li>æ‰«æçš„æ–¹å¼æ˜¯é€šè¿‡Reflectionsï¼Œè€Œä¸æ˜¯é€šè¿‡Springè‡ªå¸¦çš„æ–¹æ³•ã€‚ä½œè€…ä½¿ç”¨Reflectionsæ˜¯å› ä¸º<strong>Springé»˜è®¤æ˜¯ä¸ä¼šæ‰«ææ¥å£</strong>çš„ï¼Œå› ä¸ºæ¥å£æ²¡æœ‰åŠæ³•å®ä¾‹åŒ–ï¼Œå› æ­¤é€šè¿‡Springè‡ªå¸¦çš„æ–¹æ³•è‡ªç„¶ä¹Ÿæ— æ³•è·å–åˆ°Beanã€‚ä½†æ˜¯è¿™ä¹ˆåšå±å®æœ‰ç‚¹ä¸åˆç†ï¼Œæœ‰æ²¡æœ‰æ›´åŠ ä¼˜é›…çš„è§£å†³åŠæ³•å‘¢ï¼Ÿ</li>
</ol>
<h2 id="è·å–æ‰«æè·¯å¾„"><a href="#è·å–æ‰«æè·¯å¾„" class="headerlink" title="è·å–æ‰«æè·¯å¾„"></a>è·å–æ‰«æè·¯å¾„</h2><p>ç”¨æˆ·æŒ‡å®šæ‰«æè·¯å¾„çš„æ–¹å¼æœ‰å¾ˆå¤šç§ï¼Œå…¶ä¸­æœ€å¸¸ç”¨çš„å°±æ˜¯é€šè¿‡<code>@ComponentScan</code>æŒ‡å®šï¼Œäºæ˜¯æƒ³åˆ°æˆ‘ä»¬å¯ä»¥è§£æé¡¹ç›®ä¸­æ‰€æœ‰<code>@ComponentScan</code>æ³¨è§£ï¼Œä»¥æ­¤ä½œä¸ºæ‰«æè·¯å¾„</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> Set&lt;String&gt; <span class="title function_">getBasePackages</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> {</span><br><span class="line">  Set&lt;String&gt; collectedBasePackages = <span class="keyword">new</span> <span class="title class_">LinkedHashSet</span>&lt;&gt;(); </span><br><span class="line">  beanFactory.getBeansWithAnnotation(ComponentScan.class).forEach((beanName, instance) -&gt; {</span><br><span class="line">      Set&lt;ComponentScan&gt; componentScans = AnnotatedElementUtils.getMergedRepeatableAnnotations(instance.getClass(), ComponentScan.class);</span><br><span class="line">      <span class="keyword">for</span> (ComponentScan componentScan : componentScans) {</span><br><span class="line">          Set&lt;String&gt; basePackages = <span class="keyword">new</span> <span class="title class_">LinkedHashSet</span>&lt;&gt;();</span><br><span class="line">          String[] basePackagesArray = componentScan.basePackages();</span><br><span class="line">          <span class="keyword">for</span> (String pkg : basePackagesArray) {</span><br><span class="line">              String[] tokenized = StringUtils.tokenizeToStringArray(<span class="built_in">this</span>.environment.resolvePlaceholders(pkg),</span><br><span class="line">                      ConfigurableApplicationContext.CONFIG_LOCATION_DELIMITERS);</span><br><span class="line">              Collections.addAll(basePackages, tokenized);</span><br><span class="line">          }</span><br><span class="line">          <span class="keyword">for</span> (Class&lt;?&gt; clazz : componentScan.basePackageClasses()) {</span><br><span class="line">              basePackages.add(ClassUtils.getPackageName(clazz));</span><br><span class="line">          }</span><br><span class="line">          <span class="keyword">if</span> (basePackages.isEmpty()) {</span><br><span class="line">              basePackages.add(ClassUtils.getPackageName(instance.getClass()));</span><br><span class="line">          }</span><br><span class="line">          collectedBasePackages.addAll(basePackages);</span><br><span class="line">      }</span><br><span class="line">  });</span><br><span class="line">  <span class="keyword">return</span> collectedBasePackages;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<blockquote>
<p><em>Tipsï¼š</em> è¿™é‡Œæˆ‘åªå¤„ç†äº†<code>@ComponentScan</code>çš„basePackagesç­‰ç›¸å…³çš„è·¯å¾„æ‰«æå±æ€§ã€åˆ«åé—®é¢˜ï¼Œè¿‡æ»¤å™¨ä¹‹ç±»çš„å±æ€§ç›®å‰è¿˜æ²¡æœ‰è§£å†³ï¼ˆSpringå¤ªå¤æ‚äº†ğŸ¥²ï¼‰</p>
</blockquote>
<h2 id="è‡ªå®šä¹‰ç±»æ‰«æå™¨"><a href="#è‡ªå®šä¹‰ç±»æ‰«æå™¨" class="headerlink" title="è‡ªå®šä¹‰ç±»æ‰«æå™¨"></a>è‡ªå®šä¹‰ç±»æ‰«æå™¨</h2><p>å¦‚æœæ˜¯è¦ä¸Springé›†æˆçš„è¯è‚¯å®šæ˜¯ä½¿ç”¨Springçš„æ–¹å¼æ‰«æBeanæ›´å¥½ï¼Œä½†æ˜¯Springè‡ªå¸¦çš„ç±»æ‰«æå™¨ä¼šç›´æ¥è¿‡æ»¤æ¥å£ï¼Œè¿™æ€ä¹ˆåŠï¼Ÿæˆ‘æƒ³åˆ°ä¸€ä¸ªæ¯”è¾ƒç†Ÿæ‚‰çš„åœºæ™¯ï¼šMyBatisçš„Mapperä¹Ÿæ˜¯æ¥å£ï¼Œä½†æ˜¯ä»–æ˜¯æ€ä¹ˆè¢«æ‰«æå¹¶ä¸”æ³¨å†Œåˆ°Springä¸­çš„å‘¢ï¼Ÿ</p>
<p>äºæ˜¯æˆ‘å»ç¿»äº†MyBatisç›¸å…³çš„æºä»£ç ï¼Œå‘ç°å…¶åŸç†æ˜¯è‡ªå®šä¹‰äº†ä¸€ä¸ªç±»æ‰«æ<code>ClassPathMapperScanner</code>ï¼Œå¹¶é‡å†™äº†ä»–çš„<code>isCandidateComponent()</code>æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">isCandidateComponent</span><span class="params">(AnnotatedBeanDefinition beanDefinition)</span> {</span><br><span class="line">  <span class="keyword">return</span> beanDefinition.getMetadata().isInterface() &amp;&amp; beanDefinition.getMetadata().isIndependent();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>åœ¨Springè‡ªå¸¦çš„ç±»æ‰«æå™¨ä¸­ï¼Œä»–ä»¬çš„<code>isCandidateComponent()</code>æ–¹æ³•æ˜¯è¿™æ ·çš„ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">isCandidateComponent</span><span class="params">(AnnotatedBeanDefinition beanDefinition)</span> {</span><br><span class="line">  <span class="type">AnnotationMetadata</span> <span class="variable">metadata</span> <span class="operator">=</span> beanDefinition.getMetadata();</span><br><span class="line">  <span class="keyword">return</span> (metadata.isIndependent() &amp;&amp; (metadata.isConcrete() ||</span><br><span class="line">      (metadata.isAbstract() &amp;&amp; metadata.hasAnnotatedMethods(Lookup.class.getName()))));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><code>isConcrete()</code>è¿”å›åŸºç¡€ç±»æ˜¯å¦è¡¨ç¤ºå…·ä½“ç±»ï¼Œå³æ—¢ä¸æ˜¯æ¥å£ä¹Ÿä¸æ˜¯æŠ½è±¡ç±»ã€‚è¿™é‡Œæˆ‘ä»¬ä¹Ÿå¯ä»¥çŸ¥é“Springä¸æ‰«ææ¥å£çš„åŸå› äº†ï¼Œåœ¨è¿™ä¸€æ­¥å°±è¢«passæ‰äº†</p>
<p>å…³äºMyBatisä»£ç†çš„è¯¦ç»†è¿‡ç¨‹å¯ä»¥å‚è€ƒMyBatisåˆ›å»ºä»£ç†å…¨è¿‡ç¨‹</p>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬å°±å¯ä»¥å‚è€ƒMyBatisè‡ªå®šä¹‰ç±»æ‰«æå™¨äº†ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ClassPathAiServiceScanner</span> <span class="keyword">extends</span> <span class="title class_">ClassPathBeanDefinitionScanner</span> {</span><br><span class="line">    ClassPathAiServiceScanner(BeanDefinitionRegistry registry, <span class="type">boolean</span> useDefaultFilters) {</span><br><span class="line">        <span class="built_in">super</span>(registry, useDefaultFilters);</span><br><span class="line">        addIncludeFilter(<span class="keyword">new</span> <span class="title class_">AnnotationTypeFilter</span>(AiService.class));</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">isCandidateComponent</span><span class="params">(AnnotatedBeanDefinition beanDefinition)</span> {</span><br><span class="line">        <span class="type">AnnotationMetadata</span> <span class="variable">annotationMetadata</span> <span class="operator">=</span> beanDefinition.getMetadata();</span><br><span class="line">        <span class="keyword">return</span> annotationMetadata.isInterface() &amp;&amp; annotationMetadata.isIndependent();</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<p>æŒ‰ç…§Mybatisçš„æ–¹å¼ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è‡ªå®šä¹‰ç±»æ‰«æå™¨çš„æ–¹å¼å®ç°è®©Springæ‰«ææ¥å£ï¼Œé‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œå¦‚ä½•è®©Springä½¿ç”¨æˆ‘ä»¬è‡ªå®šä¹‰çš„ç±»æ‰«æå™¨å‘¢ï¼Ÿ</p>
<p>æˆ‘ä»¬å¯ä»¥åœ¨Springçš„BeanDefinitionæ‰«ææµç¨‹ç»“æŸåï¼Œå†æ‰«æä¸€éä¸å°±å¥½äº†å—ï¼Ÿè¿™æ—¶å€™åç½®å¤„ç†å™¨å°±å¯ä»¥æ´¾ä¸Šç”¨åœºäº†ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AiServiceScannerProcessor</span> <span class="keyword">implements</span> <span class="title class_">BeanDefinitionRegistryPostProcessor</span> {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">postProcessBeanDefinitionRegistry</span><span class="params">(BeanDefinitionRegistry registry)</span> <span class="keyword">throws</span> BeansException {</span><br><span class="line">        <span class="type">ClassPathAiServiceScanner</span> <span class="variable">classPathAiServiceScanner</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathAiServiceScanner</span>(registry, <span class="literal">false</span>);</span><br><span class="line">        classPathAiServiceScanner.addIncludeFilter(<span class="keyword">new</span> <span class="title class_">AnnotationTypeFilter</span>(AiService.class));</span><br><span class="line">        Set&lt;String&gt; basePackages = getBasePackages((ConfigurableListableBeanFactory) registry);</span><br><span class="line">        classPathAiServiceScanner.scan(StringUtils.toStringArray(basePackages));</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>è‡³æ­¤è¿™ä¸ªé—®é¢˜å°±å¤§è‡´è§£å†³äº†ï¼Œä½†æ˜¯ä¸€äº›ç»†èŠ‚è‚¯å®šæ²¡æœ‰å¤„ç†å¥½ï¼Œè¿™ä¸ªé¡¹ç›®ç›®å‰ä¹Ÿæ˜¯åˆšèµ·æ­¥çš„é˜¶æ®µï¼ŒæœŸå¾…æœ‰å¤§ä½¬ç»™å‡ºæ›´å¥½çš„è§£å†³æ–¹æ¡ˆğŸ¥³</p>
<hr>
<p>é™„ä¸€ä¸ªè´´å›¾ï¼Œçºªå¿µä¸€ä¸‹ï¼š</p>
<p><img src="/../images/%E5%BC%80%E6%BA%90%E7%BB%8F%E5%8E%86-LangChain4j-Spring-Bug%E4%BF%AE%E5%A4%8D%E8%AE%B0%E5%BD%95/pr.png"></p>
]]></content>
      <categories>
        <category>æ—¥å¸¸å°è®°</category>
      </categories>
      <tags>
        <tag>langchain</tag>
        <tag>å¼€æº</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQLä¸­çš„å­—ç¬¦ä¸²ç±»å‹</title>
    <url>/2023/09/14/MySQL%E4%B8%AD%E7%9A%84%E5%AD%97%E7%AC%A6%E4%B8%B2%E7%B1%BB%E5%9E%8B/</url>
    <content><![CDATA[<table>
<thead>
<tr>
<th>å˜é‡åç§°</th>
<th>å«ä¹‰</th>
<th>å¤§å°</th>
</tr>
</thead>
<tbody><tr>
<td>char</td>
<td>å›ºå®šå¤§å°çš„å­—ç¬¦</td>
<td>0-255<strong>ä¸ªå­—ç¬¦</strong></td>
</tr>
<tr>
<td>varchar</td>
<td>å¯å˜é•¿åº¦å­—ç¬¦ä¸²,ç›¸å½“äº<code>String</code></td>
<td>0 - 65536<strong>ä¸ªå­—ç¬¦</strong></td>
</tr>
<tr>
<td>Text</td>
<td>æ–‡æœ¬ä¸²,ä¿å­˜å¤§æ–‡æœ¬</td>
<td>4G</td>
</tr>
<tr>
<td>Blob</td>
<td>äºŒè¿›åˆ¶å¤§å¯¹è±¡ï¼Œä¸“é—¨ç”¨æ¥å‚¨å­˜å›¾ç‰‡ï¼Œå£°éŸ³ï¼Œè§†é¢‘ç­‰æµåª’ä½“æ•°æ®ã€‚æ’å…¥æ•°æ®çš„æ—¶å€™ï¼Œéœ€è¦ä½¿ç”¨IOæµã€‚</td>
<td>4G</td>
</tr>
</tbody></table>
<span id="more"></span>


<h2 id="CHAR-å’Œ-VARCHAR-çš„å®šä¹‰"><a href="#CHAR-å’Œ-VARCHAR-çš„å®šä¹‰" class="headerlink" title="CHAR å’Œ VARCHAR çš„å®šä¹‰"></a>CHAR å’Œ VARCHAR çš„å®šä¹‰</h2><p><code>CHAR(N)</code> ç”¨æ¥ä¿å­˜å›ºå®šé•¿åº¦çš„å­—ç¬¦ï¼ŒN çš„èŒƒå›´æ˜¯ 0 ~ 255ï¼Œ<strong>è¯·ç‰¢è®°ï¼ŒN è¡¨ç¤ºçš„æ˜¯å­—ç¬¦ï¼Œè€Œä¸æ˜¯å­—èŠ‚</strong>ã€‚<code>VARCHAR(N)</code> ç”¨æ¥ä¿å­˜å˜é•¿å­—ç¬¦ï¼ŒN çš„èŒƒå›´ä¸º 0 ~ 65536ï¼Œ <strong>N è¡¨ç¤ºå­—ç¬¦</strong>ã€‚</p>
<p>åœ¨è¶…å‡º 65536 ä¸ªå­—ç¬¦çš„æƒ…å†µä¸‹ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨æ›´å¤§çš„å­—ç¬¦ç±»å‹ TEXT æˆ– BLOBï¼Œä¸¤è€…æœ€å¤§å­˜å‚¨é•¿åº¦ä¸º 4Gï¼Œå…¶åŒºåˆ«æ˜¯ BLOB æ²¡æœ‰å­—ç¬¦é›†å±æ€§ï¼Œçº¯å±äºŒè¿›åˆ¶å­˜å‚¨ã€‚</p>
<p>MySQL æ•°æ®åº“çš„ VARCHAR å­—ç¬¦ç±»å‹ï¼Œæœ€å¤§èƒ½å¤Ÿå­˜å‚¨ 65536 ä¸ªå­—ç¬¦ï¼Œæ‰€ä»¥åœ¨ MySQL æ•°æ®åº“ä¸‹ï¼Œç»å¤§éƒ¨åˆ†åœºæ™¯ä½¿ç”¨ç±»å‹ VARCHAR å°±è¶³å¤Ÿäº†ã€‚</p>
<p>å¯¹äºé•¿æ–‡æœ¬ï¼Œæ¯”å¦‚å­˜å‚¨åšå®¢è¿™æ ·çš„åœºæ™¯ï¼Œå¯ä»¥ä½¿ç”¨<code>Text</code></p>
<p><strong>å­—ç¬¦é›†</strong></p>
<p>åœ¨è¡¨ç»“æ„è®¾è®¡ä¸­ï¼Œé™¤äº†å°†åˆ—å®šä¹‰ä¸º CHAR å’Œ VARCHAR ç”¨ä»¥å­˜å‚¨å­—ç¬¦ä»¥å¤–ï¼Œè¿˜éœ€è¦é¢å¤–å®šä¹‰å­—ç¬¦å¯¹åº”çš„å­—ç¬¦é›†ï¼Œå› ä¸ºæ¯ç§å­—ç¬¦åœ¨ä¸åŒå­—ç¬¦é›†ç¼–ç ä¸‹ï¼Œå¯¹åº”ç€ä¸åŒçš„äºŒè¿›åˆ¶å€¼ã€‚å¸¸è§çš„å­—ç¬¦é›†æœ‰ GBKã€UTF8ï¼Œé€šå¸¸é»˜è®¤æŠŠå­—ç¬¦é›†è®¾ç½®ä¸º UTF8ã€‚</p>
<p><strong>æ¨èæŠŠ MySQL çš„é»˜è®¤å­—ç¬¦é›†è®¾ç½®ä¸º UTF8MB4</strong>ï¼Œå¯ä»¥å­˜å‚¨emoji è¡¨æƒ…</p>
<h2 id="varchar-100-å¯ä»¥å­˜å¤šå°‘ä¸­æ–‡å­—ç¬¦"><a href="#varchar-100-å¯ä»¥å­˜å¤šå°‘ä¸­æ–‡å­—ç¬¦" class="headerlink" title="varchar(100)å¯ä»¥å­˜å¤šå°‘ä¸­æ–‡å­—ç¬¦"></a>varchar(100)å¯ä»¥å­˜å¤šå°‘ä¸­æ–‡å­—ç¬¦</h2><p>ä¸åŒçš„å­—ç¬¦é›†ï¼Œ<code>CHAR(N)</code>ã€<code>VARCHAR(N)</code>å¯¹åº”æœ€é•¿çš„å­—èŠ‚ä¹Ÿä¸ç›¸åŒã€‚</p>
<p>æ¯”å¦‚ <em><strong>GBK å­—ç¬¦é›†ï¼Œ1 ä¸ªå­—ç¬¦æœ€å¤§å­˜å‚¨ 2 ä¸ªå­—èŠ‚ï¼ŒUTF-8å­—ç¬¦é›†æ”¯æŒæ¯ä¸ªå­—ç¬¦æœ€å¤§ä¸‰3å­—èŠ‚ï¼ŒUTF8MB4 å­—ç¬¦é›† 1 ä¸ªå­—ç¬¦æœ€å¤§å­˜å‚¨ 4 ä¸ªå­—èŠ‚ã€‚</strong></em></p>
<blockquote>
<p>æ³¨æ„MySQLä¸­çš„UTF-8è·Ÿå¹³æ—¶ç”¨çš„UTF-8æœ‰åŒºåˆ«ï¼ŒçœŸæ­£çš„ UTF-8 æ˜¯æ¯ä¸ªå­—ç¬¦æœ€å¤šå››ä¸ªå­—èŠ‚ã€‚</p>
</blockquote>
<p>é‚£ä¹ˆåœ¨UTF-8å­—ç¬¦é›†çš„æƒ…å†µä¸‹ï¼Œä¸€ä¸ªæ±‰å­—3ä¸ªå­—èŠ‚ï¼Œ<code>varchar(100)</code>å¯ä»¥å­˜æ”¾100ä¸ªä¸­æ–‡å­—ç¬¦</p>
<h2 id="è¡¥å……ï¼šUnicode-ASCII-UTF-8-GBK-ç¼–ç çš„åŒºåˆ«"><a href="#è¡¥å……ï¼šUnicode-ASCII-UTF-8-GBK-ç¼–ç çš„åŒºåˆ«" class="headerlink" title="è¡¥å……ï¼šUnicode ASCII UTF-8 GBK ç¼–ç çš„åŒºåˆ«"></a>è¡¥å……ï¼šUnicode ASCII UTF-8 GBK ç¼–ç çš„åŒºåˆ«</h2><h3 id="ASCIIç¼–ç "><a href="#ASCIIç¼–ç " class="headerlink" title="ASCIIç¼–ç "></a>ASCIIç¼–ç </h3><p>ASCII ç ä½¿ç”¨æŒ‡å®šçš„7 ä½æˆ–8 ä½äºŒè¿›åˆ¶æ•°ç»„åˆæ¥è¡¨ç¤º128 æˆ–256 ç§å¯èƒ½çš„å­—ç¬¦ã€‚</p>
<p><em><strong>é•¿åº¦ï¼š1ä¸ªå­—èŠ‚</strong></em></p>
<h3 id="Unicode"><a href="#Unicode" class="headerlink" title="Unicode"></a>Unicode</h3><p>UnicodeæŠŠæ‰€æœ‰è¯­è¨€éƒ½ç»Ÿä¸€åˆ°ä¸€å¥—ç¼–ç é‡Œï¼Œè¿™æ ·å°±ä¸ä¼šå†æœ‰ä¹±ç é—®é¢˜äº†ã€‚</p>
<p>Unicodeæœ€å¸¸ç”¨çš„æ˜¯ç”¨<strong>ä¸¤ä¸ªå­—èŠ‚è¡¨ç¤ºä¸€ä¸ªå­—ç¬¦</strong>ã€‚ç°ä»£æ“ä½œç³»ç»Ÿå’Œå¤§å¤šæ•°ç¼–ç¨‹è¯­è¨€éƒ½ç›´æ¥æ”¯æŒUnicodeã€‚</p>
<p>æ–°çš„é—®é¢˜ï¼šå¦‚æœç»Ÿä¸€æˆUnicodeç¼–ç ï¼Œä¹±ç é—®é¢˜ä»æ­¤æ¶ˆå¤±äº†ã€‚ä½†æ˜¯ï¼Œå¦‚æœä½ å†™çš„æ–‡æœ¬åŸºæœ¬ä¸Šå…¨éƒ¨æ˜¯è‹±æ–‡çš„è¯ï¼Œç”¨Unicodeç¼–ç æ¯”ASCIIç¼–ç éœ€è¦å¤šä¸€å€çš„å­˜å‚¨ç©ºé—´ï¼Œåœ¨å­˜å‚¨å’Œä¼ è¾“ä¸Šå°±ååˆ†ä¸åˆ’ç®—ã€‚</p>
<p><em><strong>é•¿åº¦ï¼š2ä¸ªå­—èŠ‚</strong></em></p>
<h3 id="UTF8"><a href="#UTF8" class="headerlink" title="UTF8"></a>UTF8</h3><p>æ‰€ä»¥ï¼Œæœ¬ç€èŠ‚çº¦çš„ç²¾ç¥ï¼Œå‡ºç°äº†â€œå¯å˜é•¿ç¼–ç â€çš„UTF-8ç¼–ç </p>
<p>UTF-8ç¼–ç æŠŠä¸€ä¸ªUnicodeå­—ç¬¦æ ¹æ®ä¸åŒçš„æ•°å­—å¤§å°ç¼–ç æˆ1-6ä¸ªå­—èŠ‚ï¼Œ<em><strong>å¸¸ç”¨çš„è‹±æ–‡å­—æ¯è¢«ç¼–ç æˆ1ä¸ªå­—èŠ‚ï¼Œæ±‰å­—é€šå¸¸æ˜¯3ä¸ªå­—èŠ‚ï¼Œåªæœ‰å¾ˆç”Ÿåƒ»çš„å­—ç¬¦æ‰ä¼šè¢«ç¼–ç æˆ4-6ä¸ªå­—èŠ‚</strong></em>ã€‚å¦‚æœä½ è¦ä¼ è¾“çš„æ–‡æœ¬åŒ…å«å¤§é‡è‹±æ–‡å­—ç¬¦ï¼Œç”¨UTF-8ç¼–ç å°±èƒ½èŠ‚çœç©ºé—´ã€‚</p>
<p><em><strong>é•¿åº¦ï¼š1-6ä¸ªå­—èŠ‚ï¼Œæ±‰å­—ä¸€èˆ¬æ˜¯3ä¸ªå­—èŠ‚</strong></em></p>
<h3 id="GBK-ç¼–ç "><a href="#GBK-ç¼–ç " class="headerlink" title="GBK ç¼–ç "></a><strong>GBK ç¼–ç </strong></h3><p>GBK ç¼–ç ä¸“é—¨ç”¨äºè¡¨ç¤ºæ±‰å­—</p>
<p><em><strong>é•¿åº¦ï¼š</strong></em><em><strong>2ä¸ªå­—èŠ‚</strong></em></p>
]]></content>
      <categories>
        <category>æ—¥å¸¸å°è®°</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title>SPIæœºåˆ¶è¯¦è§£</title>
    <url>/2024/06/01/SPI%E6%9C%BA%E5%88%B6%E8%AF%A6%E8%A7%A3/</url>
    <content><![CDATA[<blockquote>
<p>ä»€ä¹ˆæ˜¯SPIæœºåˆ¶ï¼Ÿ</p>
<p><em><strong>SPIï¼ˆService Provider Interfaceï¼‰</strong></em>ï¼Œæ˜¯ JDK å†…ç½®çš„ä¸€ç§æœåŠ¡æä¾›å‘ç°æœºåˆ¶ï¼Œå…·ä½“è¡¨ç°ä¸ºæŒ‰ç…§çº¦å®šèƒ½å¤Ÿä¸ºåŒä¸€æ¥å£æä¾›å¤šç§ä¸åŒçš„å®ç°ï¼Œå¸¸ç”¨æ¥å¯ç”¨æ¡†æ¶æ‰©å±•å’Œæ›¿æ¢ç»„ä»¶</p>
<p><img src="/../images/SPI%E6%9C%BA%E5%88%B6%E8%AF%A6%E8%A7%A3/image_ieFj3Q2IEV.png"></p>
<p>Java ä¸­ SPI æœºåˆ¶ä¸»è¦æ€æƒ³æ˜¯å°†è£…é…çš„æ§åˆ¶æƒç§»åˆ°ç¨‹åºä¹‹å¤–ï¼Œåœ¨æ¨¡å—åŒ–è®¾è®¡ä¸­è¿™ä¸ªæœºåˆ¶å°¤å…¶é‡è¦ï¼Œå…¶æ ¸å¿ƒæ€æƒ³å°±æ˜¯ <strong>è§£è€¦</strong>ã€‚</p>
</blockquote>
<p>æœ¬æ–‡æ¢è®¨SPIåœ¨Javaå’ŒSpringBootä¸­çš„å®ç°ä»¥åŠå…·ä½“çš„ä½¿ç”¨å§¿åŠ¿</p>
<h1 id="Java-SPI"><a href="#Java-SPI" class="headerlink" title="Java SPI"></a>Java SPI</h1><p>Java SPI ä¸­æœ‰å››ä¸ªé‡è¦çš„ç»„ä»¶ï¼š</p>
<ol>
<li><strong>æœåŠ¡æ¥å£</strong>ï¼šä¸€ä¸ªå®šä¹‰äº†æœåŠ¡æä¾›è€…å®ç°ç±»å¥‘çº¦æ–¹æ³•çš„æ¥å£æˆ–è€…æŠ½è±¡ç±»ã€‚</li>
<li><strong>æœåŠ¡å®ç°</strong>ï¼šå®é™…æä¾›æœåŠ¡çš„å®ç°ç±»ã€‚</li>
<li><strong>SPI é…ç½®æ–‡ä»¶</strong>ï¼šæ–‡ä»¶åå¿…é¡»å­˜åœ¨äº <code>META-INF/services</code> ç›®å½•ä¸­ã€‚æ–‡ä»¶ååº”ä¸æœåŠ¡æä¾›å•†æ¥å£å®Œå…¨é™å®šåå®Œå…¨ç›¸åŒã€‚æ–‡ä»¶ä¸­çš„æ¯ä¸€è¡Œéƒ½æœ‰ä¸€ä¸ªå®ç°æœåŠ¡ç±»è¯¦ç»†ä¿¡æ¯ï¼Œå³æœåŠ¡æä¾›è€…ç±»çš„å®Œå…¨é™å®šåã€‚</li>
<li><strong>ServiceLoader</strong>ï¼š Java SPI å…³é”®ç±»ï¼Œç”¨äºåŠ è½½æœåŠ¡æä¾›è€…æ¥å£çš„æœåŠ¡ã€‚</li>
</ol>
<p>ç®€å•çœ‹ä¸€ä¸ªdemoï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// æ ‡å‡†æœåŠ¡æ¥å£</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Compresser</span> {</span><br><span class="line">    <span class="type">byte</span>[] compress(<span class="type">byte</span>[] bytes);</span><br><span class="line">    <span class="type">byte</span>[] decompress(<span class="type">byte</span>[] bytes);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// å®é™…æœåŠ¡æä¾›è€…1</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GzipCompresser</span> <span class="keyword">implements</span> <span class="title class_">Compresser</span>{</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">byte</span>[] compress(<span class="type">byte</span>[] bytes) {</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"compress by Gzip"</span>.getBytes(StandardCharsets.UTF_8);</span><br><span class="line">    }</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">byte</span>[] decompress(<span class="type">byte</span>[] bytes) {</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"decompress by Gzip"</span>.getBytes(StandardCharsets.UTF_8);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// å®é™…æœåŠ¡æä¾›è€…2</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ZipCompresser</span> <span class="keyword">implements</span> <span class="title class_">Compresser</span> {</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">byte</span>[] compress(<span class="type">byte</span>[] bytes) {</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"compress by Zip"</span>.getBytes(StandardCharsets.UTF_8);</span><br><span class="line">    }</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">byte</span>[] decompress(<span class="type">byte</span>[] bytes) {</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"decompress by Zip"</span>.getBytes(StandardCharsets.UTF_8);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<p>ç¼–å†™SPI é…ç½®æ–‡ä»¶ï¼š</p>
<p>åœ¨<code>META-INF/services</code>ä¸­åˆ›å»º<code>cn.ppphuang.demoserver.serviceproviders.Compresser</code>æ–‡ä»¶ï¼Œæ³¨æ„æ–‡ä»¶åæ˜¯æ ‡å‡†æœåŠ¡æ¥å£ç±»çš„<strong>å…¨é™å®šç±»å</strong></p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">cn.ppphuang.demoserver.serviceproviders.GzipCompresser</span><br><span class="line">cn.ppphuang.demoserver.serviceproviders.ZipCompresser cn.ppphuang.demoserver.serviceproviders.Compresser</span><br></pre></td></tr></tbody></table></figure>

<p>æ¥ä¸‹æ¥é€šè¿‡ ServiceLoader åŠ è½½æœåŠ¡ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">  ServiceLoader&lt;Compresser&gt; serviceLoader = ServiceLoader.load(Compresser.class);</span><br><span class="line">  <span class="keyword">for</span> (Compresser service : serviceLoader) {</span><br><span class="line">    System.out.println(service.getClass().getClassLoader());</span><br><span class="line">    <span class="type">byte</span>[] compress = service.compress(<span class="string">"Hello"</span>.getBytes(StandardCharsets.UTF_8));</span><br><span class="line">    System.out.println(<span class="keyword">new</span> <span class="title class_">String</span>(compress));</span><br><span class="line">    <span class="type">byte</span>[] decompress = service.decompress(<span class="string">"Hello"</span>.getBytes(StandardCharsets.UTF_8));</span><br><span class="line">    System.out.println(<span class="keyword">new</span> <span class="title class_">String</span>(decompress));</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">-------------</span><br><span class="line">sun.misc.Launcher$AppClassLoader@18b4aac2</span><br><span class="line">compress by Gzip</span><br><span class="line">decompress by Gzip</span><br><span class="line">sun.misc.Launcher$AppClassLoader@18b4aac2</span><br><span class="line">compress by Zip</span><br><span class="line">decompress by Zip</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<h2 id="å¸¸è§SPIæ¡ˆä¾‹"><a href="#å¸¸è§SPIæ¡ˆä¾‹" class="headerlink" title="å¸¸è§SPIæ¡ˆä¾‹"></a>å¸¸è§SPIæ¡ˆä¾‹</h2><ul>
<li><p>JDBC SPI</p>
<p>SPIçš„ä½¿ç”¨éå¸¸å¹¿æ³›ï¼Œä¸€ä¸ªæ¯”è¾ƒå‡ºåçš„å®ç°å°±æ˜¯JDBC</p>
<p>åœ¨JDBCä¸­ï¼Œæˆ‘ä»¬ä¸€èˆ¬ä¼šé€šè¿‡<code>DriverManager</code>å»åˆ›å»ºä¸æ•°æ®åº“çš„è¿æ¥ï¼›è€Œ<code>DriverManager</code>ä¼šæŸ¥æ‰¾å¹¶åŠ è½½classPathä¸­ä¸åŒçš„<code>Driver</code>çš„å®ç°</p>
</li>
<li><p>Common-Loggingï¼ˆJCLï¼‰</p>
<p>Common-Logging apacheæ˜¯å¸¸ç”¨çš„æ—¥å¿—åº“é—¨é¢ã€‚åªæœ‰æ¥å£ï¼ˆ<code>LogFactory</code>ï¼‰ï¼Œæ²¡æœ‰å®ç°ã€‚å…·ä½“æ–¹æ¡ˆç”±å„æä¾›å•†å®ç°</p>
</li>
</ul>
<h2 id="Java-SPIå­˜åœ¨çš„é—®é¢˜"><a href="#Java-SPIå­˜åœ¨çš„é—®é¢˜" class="headerlink" title="Java SPIå­˜åœ¨çš„é—®é¢˜"></a>Java SPIå­˜åœ¨çš„é—®é¢˜</h2><p>ä½¿ç”¨ Java SPI èƒ½æ–¹ä¾¿å¾—è§£è€¦æ¨¡å—ï¼Œä½¿å¾—æ¥å£çš„å®šä¹‰ä¸å…·ä½“ä¸šåŠ¡å®ç°åˆ†ç¦»ã€‚åº”ç”¨ç¨‹åºå¯ä»¥æ ¹æ®å®é™…ä¸šåŠ¡æƒ…å†µå¯ç”¨æˆ–æ›¿æ¢å…·ä½“ç»„ä»¶ã€‚ä½†æ˜¯ä¹Ÿæœ‰ä¸€äº›ç¼ºç‚¹ï¼š</p>
<ul>
<li><strong>ä¸èƒ½æŒ‰éœ€åŠ è½½</strong>ã€‚è™½ç„¶ ServiceLoader åšäº†å»¶è¿Ÿè½½å…¥ï¼Œä½†æ˜¯åŸºæœ¬åªèƒ½é€šè¿‡éå†å…¨éƒ¨è·å–ï¼Œä¹Ÿå°±æ˜¯æ¥å£çš„å®ç°ç±»å¾—å…¨éƒ¨è½½å…¥å¹¶å®ä¾‹åŒ–ã€‚å¦‚æœä½ å¹¶ä¸æƒ³ç”¨æŸäº›å®ç°ç±»ï¼Œæˆ–è€…æŸäº›ç±»å®ä¾‹åŒ–å¾ˆè€—æ—¶ï¼Œå®ƒä¹Ÿè¢«è½½å…¥å¹¶å®ä¾‹åŒ–äº†ï¼Œè¿™å°±é€ æˆäº†æµªè´¹ã€‚</li>
<li><strong>è·å–æŸä¸ªå®ç°ç±»çš„æ–¹å¼ä¸å¤Ÿçµæ´»</strong>ã€‚åªèƒ½é€šè¿‡ Iterator å½¢å¼è·å–ï¼Œä¸èƒ½æ ¹æ®æŸä¸ªå‚æ•°æ¥è·å–å¯¹åº”çš„å®ç°ç±»ã€‚</li>
<li>å¤šä¸ªå¹¶å‘å¤šçº¿ç¨‹ä½¿ç”¨ ServiceLoader ç±»çš„å®ä¾‹æ˜¯ä¸å®‰å…¨çš„ã€‚</li>
</ul>
<h1 id="Spring-SPI"><a href="#Spring-SPI" class="headerlink" title="Spring SPI"></a>Spring SPI</h1><p>Springçš„SPIæœºåˆ¶å…¶å®å°±æ˜¯SpringBootè‡ªåŠ¨è£…é…çš„åŸç†ã€‚åœ¨SpringBootçš„è‡ªåŠ¨è£…é…è¿‡ç¨‹ä¸­ï¼Œæœ€ç»ˆä¼šåŠ è½½<code>META-INF/spring.factories</code>æ–‡ä»¶ï¼Œè€ŒåŠ è½½çš„è¿‡ç¨‹æ˜¯ç”±<code>SpringFactoriesLoader</code>åŠ è½½çš„ã€‚</p>
<p><code>@SpringBootApplication</code> â†’ <code>@EnableAutoConfinguration</code>  â†’ <code>@Import(AutoConfigurationImportSelector.class)</code></p>
<p>æ ¸å¿ƒç±»<code>AutoConfigurationImportSelector</code>ï¼Œè¿™ä¸ªç±»æ˜¯è‡ªåŠ¨è£…é…çš„å…³é”®ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AutoConfigurationImportSelector</span> <span class="keyword">implements</span> <span class="title class_">DeferredImportSelector</span>, BeanClassLoaderAware,</span><br><span class="line">    ResourceLoaderAware, BeanFactoryAware, EnvironmentAware, Ordered {</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> String[] selectImports(AnnotationMetadata annotationMetadata) {</span><br><span class="line">    <span class="keyword">if</span> (!isEnabled(annotationMetadata)) {</span><br><span class="line">      <span class="keyword">return</span> NO_IMPORTS;</span><br><span class="line">    }</span><br><span class="line">    <span class="type">AutoConfigurationEntry</span> <span class="variable">autoConfigurationEntry</span> <span class="operator">=</span> getAutoConfigurationEntry(annotationMetadata);</span><br><span class="line">    <span class="keyword">return</span> StringUtils.toStringArray(autoConfigurationEntry.getConfigurations());</span><br><span class="line">  }</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">protected</span> AutoConfigurationEntry <span class="title function_">getAutoConfigurationEntry</span><span class="params">(AnnotationMetadata annotationMetadata)</span> {</span><br><span class="line">    <span class="keyword">if</span> (!isEnabled(annotationMetadata)) {</span><br><span class="line">      <span class="keyword">return</span> EMPTY_ENTRY;</span><br><span class="line">    }</span><br><span class="line">    <span class="type">AnnotationAttributes</span> <span class="variable">attributes</span> <span class="operator">=</span> getAttributes(annotationMetadata);</span><br><span class="line">    List&lt;String&gt; configurations = getCandidateConfigurations(annotationMetadata, attributes);</span><br><span class="line">    configurations = removeDuplicates(configurations);</span><br><span class="line">    Set&lt;String&gt; exclusions = getExclusions(annotationMetadata, attributes);</span><br><span class="line">    checkExcludedClasses(configurations, exclusions);</span><br><span class="line">    configurations.removeAll(exclusions);</span><br><span class="line">    configurations = getConfigurationClassFilter().filter(configurations);</span><br><span class="line">    fireAutoConfigurationImportEvents(configurations, exclusions);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">AutoConfigurationEntry</span>(configurations, exclusions);</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> List&lt;String&gt; <span class="title function_">getCandidateConfigurations</span><span class="params">(AnnotationMetadata metadata, AnnotationAttributes attributes)</span> {</span><br><span class="line">  List&lt;String&gt; configurations = ImportCandidates.load(AutoConfiguration.class, getBeanClassLoader())</span><br><span class="line">    .getCandidates();</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">return</span> configurations;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">LOCATION</span> <span class="operator">=</span> <span class="string">"META-INF/spring/%s.imports"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¯»å–èµ„æºæ–‡ä»¶å¹¶è·å–Beançš„URL</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> ImportCandidates <span class="title function_">load</span><span class="params">(Class&lt;?&gt; annotation, ClassLoader classLoader)</span> {</span><br><span class="line">  Assert.notNull(annotation, <span class="string">"'annotation' must not be null"</span>);</span><br><span class="line">  <span class="type">ClassLoader</span> <span class="variable">classLoaderToUse</span> <span class="operator">=</span> decideClassloader(classLoader);</span><br><span class="line">  <span class="type">String</span> <span class="variable">location</span> <span class="operator">=</span> String.format(LOCATION, annotation.getName());</span><br><span class="line">  Enumeration&lt;URL&gt; urls = findUrlsInClasspath(classLoaderToUse, location);</span><br><span class="line">  List&lt;String&gt; importCandidates = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">  <span class="keyword">while</span> (urls.hasMoreElements()) {</span><br><span class="line">    <span class="type">URL</span> <span class="variable">url</span> <span class="operator">=</span> urls.nextElement();</span><br><span class="line">    importCandidates.addAll(readCandidateConfigurations(url));</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ImportCandidates</span>(importCandidates);</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
<p>æˆ‘ä»¬å¯ä»¥çœ‹ä¸€ä¸‹æœ€åè·å–åˆ°çš„éœ€è¦æ³¨å…¥çš„Beanä¿¡æ¯ï¼š</p>
<p><img src="/../images/SPI%E6%9C%BA%E5%88%B6%E8%AF%A6%E8%A7%A3/image_aJce8e-8zN.png"></p>
<h1 id="Dubbo-SPI"><a href="#Dubbo-SPI" class="headerlink" title="Dubbo SPI"></a>Dubbo SPI</h1><p>è¡¥å……ä¸€ä¸‹Dubbo SPI æ‰©å±•èƒ½åŠ›çš„ç‰¹æ€§ï¼š</p>
<ul>
<li>æŒ‰éœ€åŠ è½½ã€‚Dubbo çš„æ‰©å±•èƒ½åŠ›ä¸ä¼šä¸€æ¬¡æ€§å®ä¾‹åŒ–æ‰€æœ‰å®ç°ï¼Œå¯ä»¥æ ¹æ®åˆ«åå®ä¾‹åŒ–æŒ‡å®šçš„æ‰©å±•ç±»</li>
<li>å¢åŠ æ‰©å±•ç±»çš„ IOC èƒ½åŠ›ã€‚Dubbo çš„æ‰©å±•èƒ½åŠ›å¹¶ä¸ä»…ä»…åªæ˜¯å‘ç°æ‰©å±•æœåŠ¡å®ç°ç±»ï¼Œè€Œæ˜¯åœ¨æ­¤åŸºç¡€ä¸Šæ›´è¿›ä¸€æ­¥ï¼Œå¦‚æœè¯¥æ‰©å±•ç±»çš„å±æ€§ä¾èµ–å…¶ä»–å¯¹è±¡ï¼Œåˆ™ Dubbo ä¼šè‡ªåŠ¨çš„å®Œæˆè¯¥ä¾èµ–å¯¹è±¡çš„æ³¨å…¥åŠŸèƒ½ã€‚</li>
<li>å¢åŠ æ‰©å±•ç±»çš„ AOP èƒ½åŠ›ã€‚Dubbo æ‰©å±•èƒ½åŠ›ä¼šè‡ªåŠ¨çš„å‘ç°æ‰©å±•ç±»çš„åŒ…è£…ç±»ï¼Œå®ŒæˆåŒ…è£…ç±»çš„æ„é€ ï¼Œå¢å¼ºæ‰©å±•ç±»çš„åŠŸèƒ½ã€‚</li>
<li>å…·å¤‡åŠ¨æ€é€‰æ‹©æ‰©å±•å®ç°çš„èƒ½åŠ›ã€‚Dubbo æ‰©å±•ä¼šåŸºäºå‚æ•°ï¼Œåœ¨è¿è¡Œæ—¶åŠ¨æ€é€‰æ‹©å¯¹åº”çš„æ‰©å±•ç±»ï¼Œæé«˜äº† Dubbo çš„æ‰©å±•èƒ½åŠ›ã€‚</li>
<li>å¯ä»¥å¯¹æ‰©å±•å®ç°è¿›è¡Œæ’åºã€‚èƒ½å¤ŸåŸºäºç”¨æˆ·éœ€æ±‚ï¼ŒæŒ‡å®šæ‰©å±•å®ç°çš„æ‰§è¡Œé¡ºåºã€‚</li>
<li>æä¾›æ‰©å±•ç‚¹çš„ Adaptive èƒ½åŠ›ã€‚è¯¥èƒ½åŠ›å¯ä»¥ä½¿çš„ä¸€äº›æ‰©å±•ç±»åœ¨ consumer ç«¯ç”Ÿæ•ˆï¼Œä¸€äº›æ‰©å±•ç±»åœ¨ provider ç«¯ç”Ÿæ•ˆã€‚</li>
</ul>
<p>Dubbo SPI åŠ è½½æ‰©å±•çš„å·¥ä½œæµç¨‹ï¼š</p>
<p><img src="/../images/SPI%E6%9C%BA%E5%88%B6%E8%AF%A6%E8%A7%A3/image_3P8oDOj5xz.png"></p>
<hr>
<p>å‚è€ƒï¼š</p>
<ul>
<li><a href="https://cloud.tencent.com/developer/article/1985623" title="å¦‚ä½•åœ¨é¡¹ç›®ä¸­å¼•å…¥SPI">å¦‚ä½•åœ¨é¡¹ç›®ä¸­å¼•å…¥SPI</a></li>
<li><a href="https://blog.csdn.net/weixin_41564440/article/details/108705534" title="Spring SPIæœºåˆ¶å®ç°è‡ªåŠ¨è£…é… å®ç°è‡ªå®šä¹‰Starterç»„ä»¶">Spring SPIæœºåˆ¶å®ç°è‡ªåŠ¨è£…é… å®ç°è‡ªå®šä¹‰Starterç»„ä»¶</a></li>
</ul>
]]></content>
      <categories>
        <category>æ—¥å¸¸å°è®°</category>
      </categories>
      <tags>
        <tag>SPI</tag>
      </tags>
  </entry>
  <entry>
    <title>RabbitMQå­¦ä¹ ç¬”è®°</title>
    <url>/2022/09/08/RabbitMQ%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/</url>
    <content><![CDATA[<h2 id="1-AMQPåè®®ä¸­çš„å…³é”®æ¦‚å¿µ"><a href="#1-AMQPåè®®ä¸­çš„å…³é”®æ¦‚å¿µ" class="headerlink" title="1 AMQPåè®®ä¸­çš„å…³é”®æ¦‚å¿µ"></a>1 AMQPåè®®ä¸­çš„å…³é”®æ¦‚å¿µ</h2><ul>
<li><code>Connection</code>socketè¿æ¥ï¼Œå®ƒå°è£…äº†socketåè®®ç›¸å…³éƒ¨åˆ†é€»è¾‘ã€‚ä½ å¯ä»¥è®¤ä¸ºä¸€ä¸ªConnectionå°±æ˜¯ä¸€ä¸ªTcpè¿æ¥ã€‚</li>
<li><code>Channel</code>ç”Ÿäº§è€…ä¸Brokeré€šä¿¡çš„é€šé“ï¼Œå¯ä»¥æŠŠé€šé“ç†è§£æˆå…±äº«ä¸€ä¸ª TCP è¿æ¥çš„å¤šä¸ªè½»é‡åŒ–è¿æ¥ï¼ˆé€šå¸¸æ¯ä¸ªthreadåˆ›å»ºå•ç‹¬çš„channelè¿›è¡Œé€šè®¯ï¼‰ã€‚</li>
</ul>
<blockquote>
<p><code>Connection</code>å°±æ˜¯ä¸€ä¸ªTCPè¿æ¥å¯¹è±¡ï¼Œè€Œ<code>Channel</code>ç›¸å½“äºè¿æ¥æ± </p>
</blockquote>
<ul>
<li><code>Exchange</code>äº¤æ¢å™¨ï¼Œæ¥æ”¶æ¶ˆæ¯ï¼ŒæŒ‰ç…§è·¯ç”±è§„åˆ™å°†æ¶ˆæ¯è·¯ç”±åˆ°ä¸€ä¸ªæˆ–è€…å¤šä¸ªé˜Ÿåˆ—</li>
<li><code>Queue</code>æ¶ˆæ¯é˜Ÿåˆ—ï¼Œç”¨æ¥ä¿å­˜æ¶ˆæ¯ï¼Œä¾›æ¶ˆè´¹è€…æ¶ˆè´¹</li>
<li><code>Produce/Consumer</code>æ¶ˆæ¯ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…</li>
<li><code>Binding</code>ç»‘å®šï¼Œäº¤æ¢å™¨å’Œæ¶ˆæ¯é˜Ÿåˆ—ä¹‹é—´çš„è™šæ‹Ÿè¿æ¥ï¼Œç»‘å®šä¸­å¯ä»¥åŒ…å«ä¸€ä¸ªæˆ–è€…å¤šä¸ª RoutingKeyã€‚</li>
<li><code>RoutingKey</code>è·¯ç”±é”®ï¼Œç”Ÿäº§è€…å°†æ¶ˆæ¯å‘é€ç»™äº¤æ¢å™¨çš„æ—¶å€™ï¼Œä¼šæŒ‡å®šä¸€ä¸ª RoutingKeyï¼Œç”¨æ¥æŒ‡å®šè·¯ç”±è§„åˆ™ï¼Œäº¤æ¢å™¨æ ¹æ®è·¯ç”±é”®æŠŠæ¶ˆæ¯å‘é€åˆ°æŒ‡å®šé˜Ÿåˆ—</li>
</ul>
<span id="more"></span>

<h2 id="2-æ¶ˆæ¯é˜Ÿåˆ—æ¨¡å¼"><a href="#2-æ¶ˆæ¯é˜Ÿåˆ—æ¨¡å¼" class="headerlink" title="2 æ¶ˆæ¯é˜Ÿåˆ—æ¨¡å¼"></a>2 æ¶ˆæ¯é˜Ÿåˆ—æ¨¡å¼</h2><h3 id="2-1-ç‚¹å¯¹ç‚¹æ¨¡å¼"><a href="#2-1-ç‚¹å¯¹ç‚¹æ¨¡å¼" class="headerlink" title="2.1 ç‚¹å¯¹ç‚¹æ¨¡å¼"></a>2.1 ç‚¹å¯¹ç‚¹æ¨¡å¼</h3><p><img src="/../images/RabbitMQ%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/e6053e18-99d6-4914-b06a-4dc65d258a30_1koS-yViN2.png"></p>
<p>ç‚¹å¯¹ç‚¹æ¨¡å¼ç‰¹ç‚¹ï¼š<strong>ä¸€ä¸ªå…·ä½“çš„æ¶ˆæ¯åªèƒ½ç”±ä¸€ä¸ªæ¶ˆè´¹è€…æ¶ˆè´¹</strong>ï¼Œå¤šä¸ªç”Ÿäº§è€…å¯ä»¥å‘åŒä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—å‘é€æ¶ˆæ¯ï¼Œä½†æ˜¯ä¸€ä¸ªæ¶ˆæ¯åœ¨è¢«ä¸€ä¸ªæ¶ˆæ¯è€…å¤„ç†çš„æ—¶å€™ï¼Œè¿™ä¸ªæ¶ˆæ¯åœ¨é˜Ÿåˆ—ä¸Šä¼šè¢«é”ä½æˆ–è€…è¢«ç§»é™¤å¹¶ä¸”å…¶ä»–æ¶ˆè´¹è€…æ— æ³•å¤„ç†è¯¥æ¶ˆæ¯ã€‚</p>
<h3 id="2-2-å‘å¸ƒ-è®¢é˜…æ¨¡å¼"><a href="#2-2-å‘å¸ƒ-è®¢é˜…æ¨¡å¼" class="headerlink" title="2.2 å‘å¸ƒ/è®¢é˜…æ¨¡å¼"></a>2.2 å‘å¸ƒ/è®¢é˜…æ¨¡å¼</h3><p><strong>å•ä¸ªæ¶ˆæ¯å¯ä»¥è¢«å¤šä¸ªè®¢é˜…è€…å¹¶å‘çš„è·å–å’Œå¤„ç†</strong>ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œè®¢é˜…æœ‰ä¸¤ç§ç±»å‹ï¼š</p>
<ul>
<li>ä¸´æ—¶è®¢é˜…ï¼šè¿™ç§è®¢é˜…åªæœ‰åœ¨æ¶ˆè´¹è€…å¯åŠ¨å¹¶ä¸”è¿è¡Œçš„æ—¶å€™æ‰å­˜åœ¨ã€‚ä¸€æ—¦æ¶ˆè´¹è€…é€€å‡ºï¼Œç›¸åº”çš„è®¢é˜…ä»¥åŠå°šæœªå¤„ç†çš„æ¶ˆæ¯å°±ä¼šä¸¢å¤±ã€‚</li>
<li>æŒä¹…è®¢é˜…ï¼šè¿™ç§è®¢é˜…ä¼šä¸€ç›´å­˜åœ¨ï¼Œé™¤éä¸»åŠ¨å»åˆ é™¤ã€‚æ¶ˆè´¹è€…é€€å‡ºåï¼Œæ¶ˆæ¯ç³»ç»Ÿä¼šç»§ç»­ç»´æŠ¤è¯¥è®¢é˜…ï¼Œå¹¶ä¸”åç»­æ¶ˆæ¯å¯ä»¥è¢«ç»§ç»­å¤„ç†ã€‚</li>
</ul>
<p><img src="/../images/RabbitMQ%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image_TSARw_VzVJ.png"></p>
<h2 id="3-RabbitMQåŸç†"><a href="#3-RabbitMQåŸç†" class="headerlink" title="3 RabbitMQåŸç†"></a>3 RabbitMQåŸç†</h2><p>RabbbitMQä½¿ç”¨Erlangè¯­è¨€å¼€å‘ï¼ŒåŸºäºAMQPåè®®å®ç°ã€‚AMQPåè®®ç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼Œåˆ†åˆ«æ˜¯æ¶ˆè´¹è€…ï¼Œç”Ÿäº§è€…å’ŒæœåŠ¡ç«¯ã€‚æ‰§è¡Œæµç¨‹å¦‚ä¸‹ï¼š</p>
<ol>
<li><p>ç”Ÿäº§è€…è¿æ¥åˆ°Serverï¼Œå»ºç«‹ä¸€ä¸ªè¿æ¥ï¼Œå¼€å¯ä¸€ä¸ªé€šé“ã€‚</p>
</li>
<li><p>ç”Ÿäº§è€…å£°æ˜äº¤æ¢å™¨å’Œé˜Ÿåˆ—ï¼Œè®¾ç½®ç›¸å…³å±æ€§ï¼Œå¹¶é€šè¿‡è·¯ç”±é”®å°†äº¤æ¢å™¨å’Œé˜Ÿåˆ—è¿›è¡Œç»‘å®šã€‚</p>
</li>
<li><p>æ¶ˆè´¹è€…ä¹Ÿéœ€è¦è¿›è¡Œå»ºç«‹è¿æ¥ï¼Œå¼€å¯ä¿¡é“ç­‰æ“ä½œï¼Œä¾¿äºæ¥æ”¶æ¶ˆæ¯ã€‚</p>
</li>
<li><p>ç”Ÿäº§è€…å‘é€æ¶ˆæ¯ï¼Œå‘é€åˆ°æœåŠ¡ç«¯ä¸­çš„è™šæ‹Ÿä¸»æœºã€‚</p>
</li>
<li><p>è™šæ‹Ÿä¸»æœºä¸­çš„äº¤æ¢å™¨æ ¹æ®è·¯ç”±é”®é€‰æ‹©è·¯ç”±è§„åˆ™ï¼Œå‘é€åˆ°ä¸åŒçš„æ¶ˆæ¯é˜Ÿåˆ—ä¸­ã€‚</p>
</li>
<li><p>è®¢é˜…äº†æ¶ˆæ¯é˜Ÿåˆ—çš„æ¶ˆè´¹è€…å°±å¯ä»¥è·å–åˆ°æ¶ˆæ¯ï¼Œè¿›è¡Œæ¶ˆè´¹ã€‚</p>
</li>
</ol>
<p><img src="/../images/RabbitMQ%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/82ff9d01-1ac7-4463-9733-a7372c642d35_wBUrxx8cW8.png"></p>
<blockquote>
<p>ğŸ“ŒRabbitMQ æ¶ˆæ¯ä¼ é€’æ¨¡å‹çš„æ ¸å¿ƒæ€æƒ³æ˜¯ç”Ÿäº§è€…ä»ä¸ç›´æ¥å‘é˜Ÿåˆ—å‘é€ä»»ä½•æ¶ˆæ¯ã€‚å®é™…ä¸Šï¼Œç”Ÿäº§è€…é€šå¸¸æ ¹æœ¬ä¸çŸ¥é“æ¶ˆæ¯æ˜¯å¦ä¼šè¢«ä¼ é€’åˆ°ä»»ä½•é˜Ÿåˆ—ã€‚</p>
<p>ç›¸åï¼Œç”Ÿäº§è€…åªèƒ½å°†æ¶ˆæ¯å‘é€åˆ°äº¤æ¢å™¨ã€‚äº¤æ¢æ˜¯ä¸€ä»¶éå¸¸ç®€å•çš„äº‹æƒ…ã€‚ä¸€æ–¹é¢ï¼Œå®ƒæ¥æ”¶æ¥è‡ªç”Ÿäº§è€…çš„æ¶ˆæ¯ï¼Œå¦ä¸€æ–¹é¢ï¼Œå®ƒå°†æ¶ˆæ¯æ¨é€åˆ°é˜Ÿåˆ—ã€‚</p>
<p>äº¤æ¢æœºç»‘å®šå¤šä¸ªé˜Ÿåˆ—ï¼Œä¸€ä¸ªé˜Ÿåˆ—ç»‘å®šä¸€ä¸ªé”®</p>
</blockquote>
<h3 id="3-1-äº¤æ¢æœº"><a href="#3-1-äº¤æ¢æœº" class="headerlink" title="3.1 äº¤æ¢æœº"></a>3.1 äº¤æ¢æœº</h3><p>Rabbitmqé˜Ÿåˆ—å’Œäº¤æ¢æœºæ˜¯ç»‘å®šçš„ï¼Œæ¯ä¸ªé˜Ÿåˆ—éƒ½æœ‰ä¸€ä¸ª***<code>routingKey</code><em><strong>ï¼Œå‘å¸ƒè€…æ¯æ¬¡å‘å¸ƒçš„æ¶ˆæ¯ä¹Ÿæœ‰ä¸€ä¸ª</strong></em><code>routingKey</code>***ï¼Œäº¤æ¢æœºä¼šæ ¹æ®ä¸åŒçš„åŒ¹é…è§„åˆ™å°†æ¶ˆæ¯åŒ¹é…åˆ°ä¸è‡ªå·±ç»‘å®šçš„é˜Ÿåˆ—ä¸­</p>
<p>RabbitMQå¸¸ç”¨äº¤æ¢æœºæœ‰å››ç§ï¼š</p>
<h4 id="3-1-1-Direct"><a href="#3-1-1-Direct" class="headerlink" title="3.1.1 Direct"></a>3.1.1 Direct</h4><p>Direct exchangeèƒŒåçš„è·¯ç”±ç®—æ³•å¾ˆç®€å• - æ¶ˆæ¯è¿›å…¥å…¶ç»‘å®šé”®ä¸æ¶ˆæ¯çš„è·¯ç”±é”®å®Œå…¨åŒ¹é…çš„é˜Ÿåˆ—ã€‚</p>
<p><img src="/../images/RabbitMQ%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image_gOLw0gI3JR.png"></p>
<blockquote>
<p>å¤šé‡ç»‘å®š</p>
<p>ä½¿ç”¨ç›¸åŒçš„ç»‘å®šé”®ç»‘å®šå¤šä¸ªé˜Ÿåˆ—æ˜¯å®Œå…¨åˆæ³•çš„ã€‚åœ¨æˆ‘ä»¬çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ç»‘å®šé”®blackåœ¨Xå’ŒQ1ä¹‹é—´æ·»åŠ ç»‘å®šã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œç›´æ¥äº¤æ¢çš„è¡Œä¸ºå°†ç±»ä¼¼äºæ‰‡å‡ºï¼Œå¹¶å°†æ¶ˆæ¯å¹¿æ’­åˆ°æ‰€æœ‰åŒ¹é…çš„é˜Ÿåˆ—ã€‚</p>
<p><img src="/../images/RabbitMQ%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image_ILV-y7PI8A.png"></p>
</blockquote>
<h4 id="3-1-2-Topic-exchange"><a href="#3-1-2-Topic-exchange" class="headerlink" title="3.1.2 Topic exchange"></a>3.1.2 Topic exchange</h4><p>**<code>topic</code>**ï¼šå°†è·¯ç”±é”®å’ŒæŸæ¨¡å¼è¿›è¡ŒåŒ¹é…ã€‚æ­¤æ—¶é˜Ÿåˆ—éœ€è¦ç»‘å®šè¦ä¸€ä¸ªæ¨¡å¼ä¸Šã€‚ç¬¦å·â€œ#â€åŒ¹é…ä¸€ä¸ªæˆ–å¤šä¸ªè¯ï¼Œç¬¦å·â€œ*â€åªèƒ½åŒ¹é…ä¸€ä¸ªè¯</p>
<p>å‘é€åˆ°Topic exchangeçš„ <code>routing_key</code>å®ƒå¿…é¡»æ˜¯ä¸€ä¸ªç”±ç‚¹åˆ†éš”çš„å•è¯åˆ—è¡¨ã€‚è¿™äº›å•è¯å¯ä»¥æ˜¯ä»»ä½•å†…å®¹ï¼Œä½†é€šå¸¸å®ƒä»¬æŒ‡å®šä¸æ¶ˆæ¯ç›¸å…³çš„ä¸€äº›åŠŸèƒ½ã€‚ä¸€äº›æœ‰æ•ˆçš„è·¯ç”±é”®ç¤ºä¾‹ï¼š <code>stock.usd.nyse</code> ã€ <code>nyse.vmw</code> ã€<code>quick.orange.rabbit</code> ã€‚è·¯ç”±å¯†é’¥ä¸­å¯ä»¥æœ‰ä»»æ„å¤šä¸ªå•è¯ï¼Œæœ€å¤š 255 ä¸ªå­—èŠ‚ã€‚</p>
<p><img src="/../images/RabbitMQ%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image_WeBDd2GgZO.png"></p>
<ul>
<li><code>*</code>å¯ä»¥æ°å¥½æ›¿ä»£ä¸€ä¸ªå•è¯ã€‚</li>
<li><code>#</code>å¯ä»¥æ›¿ä»£é›¶ä¸ªæˆ–å¤šä¸ªå•è¯ã€‚</li>
</ul>
<p>å½“é˜Ÿåˆ—ä¸<code>#</code>ç»‘å®šé”®ç»‘å®šæ—¶ - å®ƒå°†æ¥æ”¶æ‰€æœ‰æ¶ˆæ¯ï¼Œæ— è®ºè·¯ç”±é”®å¦‚ä½• - å°±åƒåœ¨æ‰‡åŒºäº¤æ¢å™¨ä¸­ä¸€æ ·ã€‚</p>
<h4 id="3-1-3-Fanout"><a href="#3-1-3-Fanout" class="headerlink" title="3.1.3 Fanout"></a>3.1.3 Fanout</h4><p>Fanout ä¸å¤„ç†è·¯ç”±é”®ï¼Œè€Œæ˜¯å¹¿æ’­ã€‚ä½ åªéœ€è¦ç®€å•çš„å°†é˜Ÿåˆ—ç»‘å®šåˆ°äº¤æ¢æœºä¸Šã€‚ä¸€ä¸ªå‘é€åˆ°è¯¥ç±»å‹äº¤æ¢æœºçš„æ¶ˆæ¯éƒ½ä¼šè¢«å¹¿æ’­åˆ°ä¸è¯¥äº¤æ¢æœºç»‘å®šçš„æ‰€æœ‰é˜Ÿåˆ—ä¸Š</p>
<h4 id="Headers"><a href="#Headers" class="headerlink" title="Headers"></a><strong>Headers</strong></h4><p>ä¸å¤„ç†è·¯ç”±é”®ï¼Œè€Œæ˜¯æ ¹æ®å‘é€çš„æ¶ˆæ¯å†…å®¹ä¸­çš„headerså±æ€§è¿›è¡ŒåŒ¹é…ã€‚</p>
<h3 id="3-2-é˜Ÿåˆ—"><a href="#3-2-é˜Ÿåˆ—" class="headerlink" title="3.2 é˜Ÿåˆ—"></a>3.2 é˜Ÿåˆ—</h3><h4 id="3-2-1-æ­»ä¿¡é˜Ÿåˆ—"><a href="#3-2-1-æ­»ä¿¡é˜Ÿåˆ—" class="headerlink" title="3.2.1 æ­»ä¿¡é˜Ÿåˆ—"></a>3.2.1 æ­»ä¿¡é˜Ÿåˆ—</h4><p>æ¥è‡ªé˜Ÿåˆ—çš„æ¶ˆæ¯å¯èƒ½æ˜¯â€œ<strong>æ­»ä¿¡çš„</strong>â€ï¼›ä¹Ÿå°±æ˜¯è¯´ï¼Œå½“å‘ç”Ÿä»¥ä¸‹ä»»ä½•äº‹ä»¶æ—¶ï¼Œé‡æ–°å‘å¸ƒåˆ°äº¤æ¢æœºï¼š</p>
<ul>
<li>æ¶ˆè´¹è€…ä½¿ç”¨<code>basic.reject</code>æˆ– <code>basic.nack</code>å¦å®šç¡®è®¤æ¶ˆæ¯ï¼Œå¹¶å°†requeueå‚æ•°è®¾ç½®ä¸ºfalseã€‚</li>
<li>ç”±äºæ¯æ¡æ¶ˆæ¯ TTLï¼ˆæœ€å¤§å­˜æ´»æ—¶é—´ï¼‰ çš„åŸå› ï¼Œè¯¥æ¶ˆæ¯è¿‡æœŸï¼›</li>
<li>ç”±äºé˜Ÿåˆ—è¶…å‡ºé•¿åº¦é™åˆ¶ï¼Œæ¶ˆæ¯è¢«ä¸¢å¼ƒ</li>
</ul>
<blockquote>
<p>åº”ç”¨åœºæ™¯</p>
</blockquote>
<p>ä¸€èˆ¬ç”¨åœ¨è¾ƒä¸ºé‡è¦çš„ä¸šåŠ¡é˜Ÿåˆ—ä¸­ï¼Œä¸ºäº†ç¡®ä¿æœªè¢«æ­£ç¡®æ¶ˆè´¹çš„æ¶ˆæ¯ä¸è¢«ä¸¢å¼ƒï¼Œå½“å‘ç”Ÿå¼‚å¸¸æ—¶ï¼Œé€šè¿‡æ­»ä¿¡é˜Ÿåˆ—ï¼Œå¯ä»¥è®©æœªæ­£ç¡®å¤„ç†çš„æ¶ˆæ¯æš‚å­˜åˆ°å¦ä¸€ä¸ªé˜Ÿåˆ—ä¸­ã€‚å¾…åç»­æ’æŸ¥æ¸…æ¥šé—®é¢˜åï¼Œç¼–å†™ç›¸åº”çš„å¤„ç†ä»£ç æ¥å¤„ç†æ­»ä¿¡æ¶ˆæ¯ï¼Œè¿™æ ·æ¯”æ‰‹å·¥æ¢å¤æ•°æ®è¦å¥½å¤ªå¤šäº† ã€‚</p>
<h4 id="3-2-2-å»¶æ—¶é˜Ÿåˆ—"><a href="#3-2-2-å»¶æ—¶é˜Ÿåˆ—" class="headerlink" title="3.2.2 å»¶æ—¶é˜Ÿåˆ—"></a>3.2.2 å»¶æ—¶é˜Ÿåˆ—</h4><p>â€‹ å»¶è¿Ÿé˜Ÿåˆ—å­˜å‚¨çš„å¯¹è±¡è‚¯å®šæ˜¯å¯¹åº”çš„å»¶æ—¶æ¶ˆæ¯ï¼Œæ‰€è°“â€å»¶æ—¶æ¶ˆæ¯â€æ˜¯æŒ‡å½“æ¶ˆæ¯è¢«å‘é€ä»¥åï¼Œå¹¶ä¸æƒ³è®©æ¶ˆè´¹è€…ç«‹å³æ‹¿åˆ°æ¶ˆæ¯ï¼Œè€Œæ˜¯ç­‰å¾…æŒ‡å®šæ—¶é—´åï¼Œæ¶ˆè´¹è€…æ‰æ‹¿åˆ°è¿™ä¸ªæ¶ˆæ¯è¿›è¡Œæ¶ˆè´¹ã€‚</p>
<h3 id="3-3-ACKæœºåˆ¶"><a href="#3-3-ACKæœºåˆ¶" class="headerlink" title="3.3 ACKæœºåˆ¶"></a>3.3 ACKæœºåˆ¶</h3><p>ACKæœºåˆ¶æ˜¯æ¶ˆè´¹è€…ä»RabbitMQæ”¶åˆ°æ¶ˆæ¯å¹¶å¤„ç†å®Œæˆåï¼Œåé¦ˆç»™RabbitMQï¼ŒRabbitMQæ”¶åˆ°åé¦ˆåæ‰å°†æ¬¡æ¶ˆæ¯ä»é˜Ÿåˆ—ä¸­åˆ é™¤ã€‚å¦‚æœæ¶ˆè´¹è€…å¤„ç†æ¶ˆæ¯æ—¶å‡ºç°å¼‚å¸¸ï¼ŒRabbitMQä¼šè®¤ä¸ºæ¶ˆæ¯æœªè¢«æ­£å¸¸æ¶ˆè´¹ï¼Œå°†æ¶ˆæ¯é‡æ–°æ”¾å…¥é˜Ÿåˆ—ä¸­ã€‚å¯ä»¥åœ¨æ¶ˆè´¹æ¶ˆæ¯ä¸­try-catchæˆ–åœ¨Consumerçš„é…ç½®æ–‡ä»¶ä¸­é…ç½®é‡è¯•æœºåˆ¶æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p>
<h3 id="3-4-é‡è¯•æœºåˆ¶"><a href="#3-4-é‡è¯•æœºåˆ¶" class="headerlink" title="3.4 é‡è¯•æœºåˆ¶"></a>3.4 é‡è¯•æœºåˆ¶</h3><p>åœ¨æ¶ˆæ¯<strong>æ¶ˆè´¹å¤±è´¥</strong>çš„æ—¶å€™ï¼ŒSpring-AMQP ä¼šé€šè¿‡<strong>æ¶ˆè´¹é‡è¯•</strong>æœºåˆ¶ï¼Œé‡æ–°æŠ•é€’è¯¥æ¶ˆæ¯ç»™ Consumer ï¼Œè®© Consumer æœ‰æœºä¼šé‡æ–°æ¶ˆè´¹æ¶ˆæ¯ï¼Œå®ç°æ¶ˆè´¹æˆåŠŸã€‚</p>
<p>å½“ç„¶ï¼ŒSpring-AMQP å¹¶ä¸ä¼šæ— é™é‡æ–°æŠ•é€’æ¶ˆæ¯ç»™ Consumer é‡æ–°æ¶ˆè´¹ï¼Œè€Œæ˜¯åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œè¾¾åˆ° N æ¬¡é‡è¯•æ¬¡æ•°æ—¶ï¼ŒConsumer è¿˜æ˜¯æ¶ˆè´¹å¤±è´¥æ—¶ï¼Œè¯¥æ¶ˆæ¯å°±ä¼šè¿›å…¥åˆ°<strong>æ­»ä¿¡é˜Ÿåˆ—</strong>ã€‚åç»­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å¯¹æ­»ä¿¡é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯è¿›è¡Œé‡å‘ï¼Œæ¥ä½¿å¾—æ¶ˆè´¹è€…å®ä¾‹å†æ¬¡è¿›è¡Œæ¶ˆè´¹ã€‚</p>
<p>ä¸ºäº†æ•ˆç‡å’ŒèŠ‚çœèµ„æºï¼Œæˆ‘ä»¬ä¸€èˆ¬ä¼šé€‰æ‹©<code>CONNECTION</code>æ¨¡å¼</p>
<h2 id="4-è¡¡é‡æ ‡å‡†"><a href="#4-è¡¡é‡æ ‡å‡†" class="headerlink" title="4 è¡¡é‡æ ‡å‡†"></a>4 è¡¡é‡æ ‡å‡†</h2><ul>
<li><strong>æ¶ˆæ¯é¡ºåº</strong>ï¼šå‘é€åˆ°é˜Ÿåˆ—çš„æ¶ˆæ¯ï¼Œæ¶ˆè´¹æ—¶æ˜¯å¦å¯ä»¥ä¿è¯æ¶ˆè´¹çš„é¡ºåºï¼Œæ¯”å¦‚ A å…ˆä¸‹å•ï¼ŒB åä¸‹å•ï¼Œåº”è¯¥æ˜¯ A å…ˆå»æ‰£åº“å­˜ï¼ŒB å†å»æ‰£ï¼Œé¡ºåºä¸èƒ½åã€‚</li>
<li><strong>æ¶ˆæ¯è·¯ç”±</strong>ï¼šæ ¹æ®è·¯ç”±è§„åˆ™ï¼Œåªè®¢é˜…åŒ¹é…è·¯ç”±è§„åˆ™çš„æ¶ˆæ¯ï¼Œæ¯”å¦‚æœ‰ A/B ä¸¤è€…è§„åˆ™çš„æ¶ˆæ¯ï¼Œæ¶ˆè´¹è€…å¯ä»¥åªè®¢é˜… A æ¶ˆæ¯ï¼ŒB æ¶ˆæ¯ä¸ä¼šæ¶ˆè´¹ã€‚</li>
<li>æ¶ˆæ¯å¯é æ€§ï¼šæ˜¯å¦ä¼šå­˜åœ¨ä¸¢æ¶ˆæ¯çš„æƒ…å†µï¼Œæ¯”å¦‚æœ‰ A/B ä¸¤ä¸ªæ¶ˆæ¯ï¼Œæœ€ååªæœ‰ B æ¶ˆæ¯èƒ½æ¶ˆè´¹ï¼ŒA æ¶ˆæ¯ä¸¢å¤±ã€‚</li>
<li><strong>æ¶ˆæ¯æ—¶åº</strong>ï¼šä¸»è¦åŒ…æ‹¬ â€œæ¶ˆæ¯å­˜æ´»æ—¶é—´â€ å’Œâ€œå»¶è¿Ÿ / é¢„å®šçš„æ¶ˆæ¯â€ï¼Œâ€œæ¶ˆæ¯å­˜æ´»æ—¶é—´â€è¡¨ç¤ºç”Ÿäº§è€…å¯ä»¥å¯¹æ¶ˆæ¯è®¾ç½® TTLï¼Œå¦‚æœè¶…è¿‡è¯¥ TTLï¼Œæ¶ˆæ¯ä¼šè‡ªåŠ¨æ¶ˆå¤±ï¼›â€œå»¶è¿Ÿ / é¢„å®šçš„æ¶ˆæ¯â€æŒ‡çš„æ˜¯å¯ä»¥å»¶è¿Ÿæˆ–è€…é¢„è®¢æ¶ˆè´¹æ¶ˆæ¯ï¼Œæ¯”å¦‚å»¶æ—¶ 5 åˆ†é’Ÿï¼Œé‚£ä¹ˆæ¶ˆæ¯ä¼š 5 åˆ†é’Ÿåæ‰èƒ½è®©æ¶ˆè´¹è€…æ¶ˆè´¹ï¼Œæ—¶é—´æœªåˆ°çš„è¯ï¼Œæ˜¯ä¸èƒ½æ¶ˆè´¹çš„ã€‚</li>
<li><strong>æ¶ˆæ¯ç•™å­˜</strong>ï¼šæ¶ˆæ¯æ¶ˆè´¹æˆåŠŸåï¼Œæ˜¯å¦è¿˜ä¼šç»§ç»­ä¿ç•™åœ¨æ¶ˆæ¯é˜Ÿåˆ—ã€‚</li>
<li><strong>å®¹é”™æ€§</strong>ï¼šå½“ä¸€æ¡æ¶ˆæ¯æ¶ˆè´¹å¤±è´¥åï¼Œæ˜¯å¦æœ‰ä¸€äº›æœºåˆ¶ï¼Œä¿è¯è¿™æ¡æ¶ˆæ¯æ˜¯ä¸€ç§èƒ½æˆåŠŸï¼Œæ¯”å¦‚å¼‚æ­¥ç¬¬ä¸‰æ–¹é€€æ¬¾æ¶ˆæ¯ï¼Œéœ€è¦ä¿è¯è¿™æ¡æ¶ˆæ¯æ¶ˆè´¹æ‰ï¼Œæ‰èƒ½ç¡®å®šç»™ç”¨æˆ·é€€æ¬¾æˆåŠŸï¼Œæ‰€ä»¥å¿…é¡»ä¿è¯è¿™æ¡æ¶ˆæ¯æ¶ˆè´¹æˆåŠŸçš„å‡†ç¡®æ€§ã€‚</li>
<li><strong>ä¼¸ç¼©</strong>ï¼šå½“æ¶ˆæ¯é˜Ÿåˆ—æ€§èƒ½æœ‰é—®é¢˜ï¼Œæ¯”å¦‚æ¶ˆè´¹å¤ªæ…¢ï¼Œæ˜¯å¦å¯ä»¥å¿«é€Ÿæ”¯æŒåº“å®¹ï¼›å½“æ¶ˆè´¹é˜Ÿåˆ—è¿‡å¤šï¼Œæµªè´¹ç³»ç»Ÿèµ„æºï¼Œæ˜¯å¦å¯ä»¥æ”¯æŒç¼©å®¹ã€‚</li>
<li><strong>ååé‡</strong>ï¼šæ”¯æŒçš„æœ€é«˜å¹¶å‘æ•°ã€‚</li>
</ul>
]]></content>
      <categories>
        <category>å­¦ä¹ ç¬”è®°</category>
      </categories>
      <tags>
        <tag>ä¸­é—´ä»¶</tag>
        <tag>æ¶ˆæ¯é˜Ÿåˆ—</tag>
      </tags>
  </entry>
  <entry>
    <title>Spring Eventæœºåˆ¶è¯¦è§£</title>
    <url>/2024/08/11/Spring-%E4%BA%8B%E4%BB%B6%E6%9C%BA%E5%88%B6/</url>
    <content><![CDATA[<p>Springçš„äº‹ä»¶æœºåˆ¶æä¾›äº†ä¸€ç§ä½è€¦åˆã€æ— ä¾µå…¥çš„è§£å†³æ–¹å¼ï¼Œå®ƒç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼š</p>
<ul>
<li><code>ApplicationEventPublisher</code>ï¼šå‘å¸ƒå™¨ï¼Œè®©å®¹å™¨æ‹¥æœ‰å‘å¸ƒåº”ç”¨ä¸Šä¸‹æ–‡äº‹ä»¶çš„åŠŸèƒ½ï¼ŒåŒ…æ‹¬å®¹å™¨å¯åŠ¨äº‹ä»¶ã€å…³é—­äº‹ä»¶ç­‰ã€‚</li>
<li><code>ApplicationListener</code>ï¼šç›‘å¬å™¨ ï¼Œå¯ä»¥æ¥æ”¶åˆ°å®¹å™¨äº‹ä»¶ ï¼Œ å¹¶å¯¹äº‹ä»¶è¿›è¡Œå“åº”å¤„ç† ã€‚</li>
<li><code>ApplicationEventMulticaster</code>ï¼šäº‹ä»¶å¤šæ’­å™¨ï¼Œå®ƒè´Ÿè´£ä¿å­˜æ‰€æœ‰ç›‘å¬å™¨ï¼Œä»¥ä¾¿åœ¨å®¹å™¨äº§ç”Ÿä¸Šä¸‹æ–‡äº‹ä»¶æ—¶é€šçŸ¥è¿™äº›äº‹ä»¶ç›‘å¬è€…ã€‚</li>
<li><code>ApplicationEvent</code>ï¼šå…·ä½“çš„äº‹ä»¶</li>
</ul>
<p><img src="/../images/Spring-%E4%BA%8B%E4%BB%B6%E6%9C%BA%E5%88%B6/image_k6VpJmK7hm.png"></p>
<blockquote>
<p>å›¾ç‰‡æ¥è‡ªï¼š<a href="https://juejin.cn/post/7140849555607650335#heading-10" title="https://juejin.cn/post/7140849555607650335#heading-10">https://juejin.cn/post/7140849555607650335#heading-10</a></p>
</blockquote>
<h2 id="1-Springä¸­çš„å†…ç½®äº‹ä»¶"><a href="#1-Springä¸­çš„å†…ç½®äº‹ä»¶" class="headerlink" title="1 Springä¸­çš„å†…ç½®äº‹ä»¶"></a>1 Springä¸­çš„å†…ç½®äº‹ä»¶</h2><p><img src="/../images/Spring-%E4%BA%8B%E4%BB%B6%E6%9C%BA%E5%88%B6/image_NIowE11gVH.png"></p>
<ul>
<li><code>ContextRefreshedEvent</code>ï¼šåœ¨<code>refresh()</code>æ‰§è¡Œå®Œæˆæ—¶è§¦å‘ï¼Œé€šçŸ¥å®¹å™¨åˆ·æ–°å®Œæˆã€‚<ul>
<li>å¾ˆé€‚åˆæˆ‘ä»¬åšä¸€äº›ç³»ç»Ÿå¯åŠ¨åçš„å‡†å¤‡å·¥ä½œï¼Œæ­¤æ—¶æˆ‘ä»¬å°±å¯ä»¥ç›‘å¬è¯¥äº‹ä»¶ï¼Œä½œä¸ºç³»ç»Ÿå¯åŠ¨ååˆå§‹é¢„çƒ­çš„å¥‘æœºã€‚</li>
</ul>
</li>
<li><code>ContextStartedEvent</code>ï¼š<code>ConfigurableApplicationContext</code>çš„<code>start()</code>æ‰§è¡Œå®Œæˆæ—¶è§¦å‘<ul>
<li>è¯¥äº‹ä»¶çš„è§¦å‘æ˜¯æ‰€æœ‰çš„å•ä¾‹beanåˆ›å»ºå®Œæˆåå‘å¸ƒï¼Œæ­¤æ—¶å®ç°äº†<code>Lifecycle</code>æ¥å£çš„beanè¿˜æ²¡æœ‰å›è°ƒ<code>start()</code>ï¼Œå½“è¿™äº›<code>start()</code>è¢«è°ƒç”¨åï¼Œæ‰ä¼šå‘å¸ƒ<code>ContextStartedEvent</code>äº‹ä»¶ã€‚</li>
</ul>
</li>
<li><code>ContextClosedEvent</code>ï¼š<code>ConfigurableApplicationContext</code>çš„<code>close()</code>æ‰§è¡Œå®Œæˆæ—¶è§¦å‘<ul>
<li>æ­¤æ—¶IOCå®¹å™¨å·²ç»å…³é—­ï¼Œä½†å°šæœªé”€æ¯æ‰€æœ‰çš„beanã€‚</li>
</ul>
</li>
<li><code>ContextStoppedEvent</code>ï¼š<code>ConfigurableApplicationContext</code>çš„<code>stop()</code>æ‰§è¡Œå®Œæˆæ—¶è§¦å‘</li>
</ul>
<h2 id="2-è‡ªå®šä¹‰äº‹ä»¶çš„ä½¿ç”¨"><a href="#2-è‡ªå®šä¹‰äº‹ä»¶çš„ä½¿ç”¨" class="headerlink" title="2 è‡ªå®šä¹‰äº‹ä»¶çš„ä½¿ç”¨"></a>2 è‡ªå®šä¹‰äº‹ä»¶çš„ä½¿ç”¨</h2><ul>
<li><p><strong>å®šä¹‰äº‹ä»¶</strong></p>
<p>è‡ªå®šä¹‰äº‹ä»¶åœ¨ä½¿ç”¨ä¸Šå¾ˆç®€å•ï¼Œç»§æ‰¿ ApplicationEvent å³å¯:</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyApplicationEvent</span> <span class="keyword">extends</span> <span class="title class_">ApplicationEvent</span> {</span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MyApplicationEvent</span><span class="params">(Long id)</span> {</span><br><span class="line">        <span class="built_in">super</span>(id);</span><br><span class="line">        <span class="built_in">this</span>.id = id;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Long <span class="title function_">getId</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure></li>
<li><p><strong>å‘å¸ƒè‡ªå®šä¹‰äº‹ä»¶</strong></p>
<p><code>ApplicationContext</code>ç»§æ‰¿äº†<code>ApplicationEventPublisher</code>ï¼Œå› æ­¤ä¹Ÿæ‹¥æœ‰æ¶ˆæ¯å‘å¸ƒçš„èƒ½åŠ›ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line">applicationContext.publishEvent(<span class="keyword">new</span> <span class="title class_">MyApplicationEvent</span>(<span class="number">1L</span>));</span><br></pre></td></tr></tbody></table></figure></li>
<li><p><strong>å®šä¹‰ç›‘å¬å™¨</strong></p>
<p>ç›‘å¬å™¨éœ€è¦å®ç°<code>ApplicationListener</code>æ¥å£ï¼Œ<code>onApplicationEvent()</code>è´Ÿè´£å¤„ç†å…·ä½“çš„äº‹ä»¶</p>
<p>æ³¨æ„ï¼šéœ€è¦é€šè¿‡æ³›å‹å‚æ•°æŒ‡å®šå¤„ç†çš„äº‹ä»¶ç±»å‹</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyEventListener</span> <span class="keyword">implements</span> <span class="title class_">ApplicationListener</span>&lt;MyApplicationEvent&gt; {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onApplicationEvent</span><span class="params">(MyApplicationEvent event)</span> {</span><br><span class="line">        System.out.println(event.getSource());</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure></li>
</ul>
<h2 id="3-ApplicationListeneræ³¨å†Œè¿‡ç¨‹"><a href="#3-ApplicationListeneræ³¨å†Œè¿‡ç¨‹" class="headerlink" title="3 ApplicationListeneræ³¨å†Œè¿‡ç¨‹"></a>3 ApplicationListeneræ³¨å†Œè¿‡ç¨‹</h2><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">refresh</span><span class="params">()</span> <span class="keyword">throws</span> BeansException, IllegalStateException {</span><br><span class="line">  <span class="keyword">try</span> {</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// åˆå§‹åŒ–å„ç§ç›‘å¬å™¨</span></span><br><span class="line">    <span class="built_in">this</span>.registerListeners();</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ³¨å†Œç›‘å¬å™¨</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">registerListeners</span><span class="params">()</span> {</span><br><span class="line">  <span class="comment">// 1: å¤„ç†context.addApplicationListener() æ–¹å¼æ³¨å†Œçš„ç›‘å¬å™¨ï¼Œå¹¶å°†ç›‘å¬å™¨æ³¨å†Œåˆ°å¹¿æ’­å™¨ä¸­ï¼Œ</span></span><br><span class="line">  <span class="keyword">for</span> (ApplicationListener&lt;?&gt; listener : <span class="built_in">this</span>.getApplicationListeners()) {</span><br><span class="line">    <span class="built_in">this</span>.getApplicationEventMulticaster().addApplicationListener(listener);</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 2: å»Springå®¹å™¨ä¸­è·å–ç›‘å¬å™¨ï¼ˆå¤„ç†æ‰«æçš„æˆ–è€…registeræ–¹å¼æ³¨å†Œçš„ï¼‰,åŒæ ·ä¹Ÿæ˜¯æ·»åŠ åˆ°å¹¿æ’­å™¨ä¸­</span></span><br><span class="line">  String[] listenerBeanNames = <span class="built_in">this</span>.getBeanNamesForType(ApplicationListener.class, <span class="literal">true</span>, <span class="literal">false</span>);</span><br><span class="line">  <span class="keyword">for</span> (String listenerBeanName : listenerBeanNames) {</span><br><span class="line">    <span class="built_in">this</span>.getApplicationEventMulticaster().addApplicationListenerBean(listenerBeanName);</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼ŒIoCå®¹å™¨ä¼šæ‰«æç»§æ‰¿äº†<code>ApplicationListener</code>çš„ç›‘å¬å™¨ä½œä¸ºBeanå¹¶æ³¨å†Œåˆ°å®¹å™¨ä¸­ï¼Œä½†é€šè¿‡<code>@EventListener</code>æ–¹å¼æ³¨å†Œçš„æ˜¯ä¸€ä¸ªæ–¹æ³•ï¼Œç›‘å¬è€…åº”è¯¥æ˜¯ä¸€ä¸ªå®ä¾‹å¯¹è±¡ï¼Œé‚£å®ƒæ˜¯æ€ä¹ˆè¢«è¯†åˆ«å¹¶æ³¨å†Œå‘¢ï¼Ÿ</p>
<h3 id="3-1-EventListeneræ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Ÿ"><a href="#3-1-EventListeneræ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Ÿ" class="headerlink" title="3.1 @EventListeneræ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Ÿ"></a>3.1 @EventListeneræ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Ÿ</h3><p>æ¯æ¬¡é¢å¯¹è¿™ç§ä¸åŒçš„æ³¨å†Œæ–¹å¼æ—¶ï¼Œé€‚é…å™¨æ¨¡å¼å°±è¦ç™»åœºäº†ã€‚<code>@EventListener</code>çš„æ‰«æå’Œæ³¨å†Œè¿‡ç¨‹æˆ‘è§‰å¾—ä¹Ÿå¾ˆæœ‰å‚è€ƒæ„ä¹‰ï¼Œåœ¨æ­¤è®°å½•ä¸€ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">refresh</span><span class="params">()</span> <span class="keyword">throws</span> BeansException, IllegalStateException {</span><br><span class="line">  <span class="keyword">try</span> {</span><br><span class="line">    ..</span><br><span class="line">    <span class="comment">// æ™®é€šå•ä¾‹Beançš„å®ä¾‹åŒ–</span></span><br><span class="line">    <span class="built_in">this</span>.finishBeanFactoryInitialization(beanFactory);</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">finishBeanFactoryInitialization</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> {</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// åˆå§‹åŒ–éå»¶è¿ŸåŠ è½½çš„å•ä¾‹bean</span></span><br><span class="line">    beanFactory.preInstantiateSingletons();</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">preInstantiateSingletons</span><span class="params">()</span> <span class="keyword">throws</span> BeansException {</span><br><span class="line">    List&lt;String&gt; beanNames = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(<span class="built_in">this</span>.beanDefinitionNames);</span><br><span class="line">    <span class="comment">// 1: å®Œæˆbeançš„å®ä¾‹åŒ–</span></span><br><span class="line">    <span class="keyword">for</span> (String beanName : beanNames) {</span><br><span class="line">        <span class="comment">// è°ƒç”¨BeanFactoryå°è¯•è·å–Beanï¼Œè·å–ä¸åˆ°ä¼šåˆ›å»ºBean</span></span><br><span class="line">        getBean(beanName);</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2: è°ƒç”¨beançš„åç½®å¤„ç†æ–¹æ³•</span></span><br><span class="line">    <span class="comment">// Trigger post-initialization callback for all applicable beans...</span></span><br><span class="line">    <span class="keyword">for</span> (String beanName : beanNames) {</span><br><span class="line">      <span class="comment">// singletonInstance instanceof SmartInitializingSingleton</span></span><br><span class="line">      smartSingleton.afterSingletonsInstantiated();</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<p>è¿™é‡Œçš„<code>smartSingleton.afterSingletonsInstantiated()</code>ä¼šè§¦å‘æ‰€æœ‰é€‚ç”¨ bean çš„å›è°ƒï¼š</p>
<p><img src="/../images/Spring-%E4%BA%8B%E4%BB%B6%E6%9C%BA%E5%88%B6/image_9NiB6Gnaat.png"></p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// EventListenerMethodProcessor.java</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterSingletonsInstantiated</span><span class="params">()</span> {</span><br><span class="line">    <span class="keyword">for</span> (String beanName : beanNames) {</span><br><span class="line">        processBean(beanName, type);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">processBean</span><span class="params">(<span class="keyword">final</span> String beanName, <span class="keyword">final</span> Class&lt;?&gt; targetType)</span> {</span><br><span class="line">    <span class="comment">// 1: è§£æbeanä¸ŠåŠ äº†@EventListenerçš„æ–¹æ³•</span></span><br><span class="line">    Map&lt;Method, EventListener&gt; annotatedMethods = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        annotatedMethods = MethodIntrospector.selectMethods(targetType,</span><br><span class="line">                        (MethodIntrospector.MetadataLookup&lt;EventListener&gt;) method -&gt;</span><br><span class="line">        AnnotatedElementUtils.findMergedAnnotation(method, EventListener.class));</span><br><span class="line">    }</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// 2: éå†åŠ äº†@EventListenerçš„æ–¹æ³•ï¼Œæ³¨å†Œä¸ºäº‹ä»¶ç›‘å¬å™¨</span></span><br><span class="line">    <span class="keyword">for</span> (Method method : annotatedMethods.keySet()) {</span><br><span class="line">        <span class="keyword">for</span> (EventListenerFactory factory : factories) {</span><br><span class="line">            <span class="keyword">if</span> (factory.supportsMethod(method)) {</span><br><span class="line">                <span class="type">Method</span> <span class="variable">methodToUse</span> <span class="operator">=</span> AopUtils.selectInvocableMethod(method, context.getType(beanName));</span><br><span class="line">                <span class="comment">// 2.1 é€šè¿‡EventListenerFactoryï¼Œå°†æ–¹æ³•åˆ›å»ºä¸ºç›‘å¬å™¨å®ä¾‹(ApplicationListenerMethodAdapter)</span></span><br><span class="line">                ApplicationListener&lt;?&gt; applicationListener = factory.createApplicationListener(beanName, targetType, methodToUse);</span><br><span class="line">                <span class="keyword">if</span> (applicationListener <span class="keyword">instanceof</span> ApplicationListenerMethodAdapter) {</span><br><span class="line">                        ((ApplicationListenerMethodAdapter) applicationListener).init(context, <span class="built_in">this</span>.evaluator);</span><br><span class="line">                }</span><br><span class="line">                <span class="comment">// 2.2 æ³¨å†Œä¸ºApplicationListener</span></span><br><span class="line">                context.addApplicationListener(applicationListener);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>æ€»ç»“ä¸€ä¸‹æµç¨‹ï¼šåœ¨å®¹å™¨ä¸­æ‰€æœ‰çš„beanå®ä¾‹åŒ–åï¼Œä¼šå†æ¬¡éå†æ‰€æœ‰beanï¼Œè°ƒç”¨<code>afterSingletonsInstantiated()</code>çš„æ–¹æ³•ï¼Œæ­¤æ—¶ç¬¦åˆæ¡ä»¶çš„<code>EventListenerMethodProcessor</code>å°±ä¼šè¢«è°ƒç”¨</p>
<p><img src="/../images/Spring-%E4%BA%8B%E4%BB%B6%E6%9C%BA%E5%88%B6/image_qNXImWUpet.png"></p>
<blockquote>
<p>å…³äº@EventListeneræ ‡æ³¨æ–¹æ³•çš„è§£ææ—¶æœºï¼Œç¬”è€…é¦–å…ˆæƒ³åˆ°çš„åº”è¯¥å’Œ<code>@Bean</code>çš„å¤„ç†æ—¶æœºä¸€è‡´ï¼Œåœ¨æ‰«æç±»çš„æ—¶å€™ï¼Œå°±è§£æå‡ºæ¥åŠ äº†<code>@EventListener</code>çš„æ–¹æ³•ï¼ŒæŠ½è±¡ä¸ºBeanDefinitionæ”¾åˆ°å®¹å™¨ä¸­ï¼Œåé¢å®ä¾‹åŒ–æ—¶å€™ï¼Œå’Œæ­£å¸¸æ‰«æå‡ºæ¥çš„beanæ˜¯ä¸€æ ·çš„å®ä¾‹åŒ–æµç¨‹ã€‚ä½†æ˜¯æŸ¥æ‰¾ä¸‹æ¥å‘ç°Springå¹¶æ²¡æœ‰è¿™æ ·å¤„ç†ï¼Œè€Œæ˜¯åœ¨beanåˆå§‹åŒ–åå›è°ƒé˜¶æ®µå¤„ç†çš„ã€‚ç©¶å…¶åŸå› ï¼Œå¤§æ¦‚æ˜¯@BeançœŸçš„æ˜¯éœ€è¦æ‰˜ä»˜ç»™Springç®¡ç†ï¼Œè€Œ<code>@EventListener</code>åªæ˜¯ä¸€ä¸ªæ ‡è¯†ï¼Œæ— éœ€æ”¾å…¥æ”¾å…¥å®¹å™¨ï¼Œé˜²æ­¢å¯¹å®Œæš´éœ²æ‰€è‡´å§ã€‚</p>
</blockquote>
<h2 id="4-Springå¦‚ä½•å¹¿æ’­æ¶ˆæ¯ï¼Ÿ"><a href="#4-Springå¦‚ä½•å¹¿æ’­æ¶ˆæ¯ï¼Ÿ" class="headerlink" title="4 Springå¦‚ä½•å¹¿æ’­æ¶ˆæ¯ï¼Ÿ"></a>4 Springå¦‚ä½•å¹¿æ’­æ¶ˆæ¯ï¼Ÿ</h2><p><code>ApplicationEventMulticaster</code>è´Ÿè´£äº‹ä»¶çš„åˆ†å‘ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹ä¸€ä¸‹å®ƒçš„å…·ä½“å®ç°ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// SimpleApplicationEventMulticaster.java</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">multicastEvent</span><span class="params">(<span class="keyword">final</span> ApplicationEvent event, <span class="meta">@Nullable</span> ResolvableType eventType)</span> {</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// getApplicationListeners è·å–ç¬¦åˆçš„ç›‘å¬å™¨</span></span><br><span class="line">    <span class="keyword">for</span> (ApplicationListener&lt;?&gt; listener : getApplicationListeners(event, type)) {</span><br><span class="line">        <span class="comment">// æ‰§è¡Œæ¯ä¸ªç›‘å¬å™¨çš„é€»è¾‘</span></span><br><span class="line">         <span class="comment">// æ³¨æ„ï¼Œè¿™é‡Œæ˜¯åŒæ­¥çš„ </span></span><br><span class="line">        invokeListener(listener, event);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// invokeListeneræœ€åè°ƒç”¨doInvokeListener</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">doInvokeListener</span><span class="params">(ApplicationListener listener, ApplicationEvent event)</span> {</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">      <span class="comment">// è°ƒç”¨ç›‘å¬å™¨çš„onApplicationEventæ–¹æ³•è¿›è¡Œå¤„ç†</span></span><br><span class="line">      listener.onApplicationEvent(event);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><code>getApplicationListeners()</code>æ‰¾åˆ°äº†æ‰€æœ‰åŒ¹é…çš„ç›‘å¬å™¨ï¼Œæˆ‘ä»¬ç»§ç»­è·Ÿè¸ªçœ‹ä¸€ä¸‹æ˜¯å¦‚ä½•è¿›è¡Œäº‹ä»¶åŒ¹é…çš„ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> Collection&lt;ApplicationListener&lt;?&gt;&gt; getApplicationListeners(</span><br><span class="line">      ApplicationEvent event, ResolvableType eventType) {</span><br><span class="line">   <span class="comment">// çœç•¥ç¼“å­˜ç›¸å…³ä»£ç </span></span><br><span class="line">   <span class="keyword">return</span> retrieveApplicationListeners(eventType, sourceType, newRetriever);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> Collection&lt;ApplicationListener&lt;?&gt;&gt; retrieveApplicationListeners(</span><br><span class="line">ResolvableType eventType, <span class="meta">@Nullable</span> Class&lt;?&gt; sourceType, <span class="meta">@Nullable</span> CachedListenerRetriever retriever) {</span><br><span class="line">    <span class="comment">// 1: è·å–æ‰€æœ‰çš„ApplicationListener</span></span><br><span class="line">    Set&lt;ApplicationListener&lt;?&gt;&gt; listeners;</span><br><span class="line">    Set&lt;String&gt; listenerBeans;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="built_in">this</span>.defaultRetriever) {</span><br><span class="line">        listeners = <span class="keyword">new</span> <span class="title class_">LinkedHashSet</span>&lt;&gt;(<span class="built_in">this</span>.defaultRetriever.applicationListeners);</span><br><span class="line">        listenerBeans = <span class="keyword">new</span> <span class="title class_">LinkedHashSet</span>&lt;&gt;(<span class="built_in">this</span>.defaultRetriever.applicationListenerBeans);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (ApplicationListener&lt;?&gt; listener : listeners) {</span><br><span class="line">        <span class="comment">// 2: éå†åˆ¤æ–­æ˜¯å¦åŒ¹é…</span></span><br><span class="line">        <span class="keyword">if</span> (supportsEvent(listener, eventType, sourceType)) {</span><br><span class="line">            <span class="keyword">if</span> (retriever != <span class="literal">null</span>) {</span><br><span class="line">                filteredListeners.add(listener);</span><br><span class="line">            }</span><br><span class="line">            allListeners.add(listener);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">supportsEvent</span><span class="params">(</span></span><br><span class="line"><span class="params">  ApplicationListener&lt;?&gt; listener, ResolvableType eventType, <span class="meta">@Nullable</span> Class&lt;?&gt; sourceType)</span> {</span><br><span class="line">  <span class="type">GenericApplicationListener</span> <span class="variable">smartListener</span> <span class="operator">=</span> (listener <span class="keyword">instanceof</span> GenericApplicationListener ?</span><br><span class="line">                                              (GenericApplicationListener) listener : <span class="keyword">new</span> <span class="title class_">GenericApplicationListenerAdapter</span>(listener));</span><br><span class="line">  <span class="comment">// supportsEventType æ ¹æ®ApplicationListenerçš„æ³›å‹, å’Œäº‹ä»¶ç±»å‹,çœ‹æ˜¯å¦åŒ¹é…</span></span><br><span class="line">  <span class="comment">// supportsSourceType æ ¹æ®äº‹ä»¶æºç±»å‹ï¼Œåˆ¤æ–­æ˜¯å¦åŒ¹é…</span></span><br><span class="line">  <span class="keyword">return</span> (smartListener.supportsEventType(eventType) &amp;&amp; smartListener.supportsSourceType(sourceType));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>ä»¥ä¸Šå°±æ˜¯<code>ApplicationEventMulticaster</code>åˆ†å‘äº‹ä»¶çš„å¤§è‡´é€»è¾‘ï¼Œæœ¬è´¨ä¸Šå°±æ˜¯é€šè¿‡æ³›å‹æŸ¥æ‰¾åˆ°æ‰€æœ‰åŒ¹é…çš„ç›‘å¬å™¨ï¼Œç„¶ååœ¨ä¸€ä¸ªforå¾ªç¯ä¸­è°ƒç”¨ç›‘å¬å™¨çš„äº‹ä»¶å¤„ç†æ–¹æ³•</p>
<p>ä½†æ˜¯è¿™é‡Œä¹Ÿæœ‰ä¸€ä¸ªé—®é¢˜ï¼Œè¿™ç§æ–¹å¼äº‹ä»¶çš„å¤„ç†æ˜¯åŒæ­¥çš„ï¼Œå¯èƒ½ä¼šå­˜åœ¨å‘å¸ƒé˜»å¡çš„é—®é¢˜ï¼Œå¹¶ä¸”æœ‰æ€§èƒ½é—®é¢˜ã€‚æœ‰æ²¡æœ‰åŠæ³•èƒ½å¤Ÿä½¿ç”¨å¼‚æ­¥æœºåˆ¶æ¥å¤„ç†æ¶ˆæ¯å‘¢ï¼Ÿ</p>
<h2 id="5-å¼‚æ­¥å¤„ç†äº‹ä»¶"><a href="#5-å¼‚æ­¥å¤„ç†äº‹ä»¶" class="headerlink" title="5 å¼‚æ­¥å¤„ç†äº‹ä»¶"></a>5 å¼‚æ­¥å¤„ç†äº‹ä»¶</h2><p>Springæä¾›äº†ä¸¤ç§å¼‚æ­¥å¤„ç†äº‹ä»¶çš„æ–¹å¼ï¼š</p>
<h3 id="5-1-ç»™ApplicationEventMulticasteræ·»åŠ çº¿ç¨‹æ± "><a href="#5-1-ç»™ApplicationEventMulticasteræ·»åŠ çº¿ç¨‹æ± " class="headerlink" title="5.1 ç»™ApplicationEventMulticasteræ·»åŠ çº¿ç¨‹æ± "></a>5.1 ç»™ApplicationEventMulticasteræ·»åŠ çº¿ç¨‹æ± </h3><p>é€šè¿‡<code>setTaskExecutor()</code>æ–¹æ³•å¯ä»¥ç»™<code>ApplicationEventMulticaster</code>è®¾ç½®çº¿ç¨‹æ± ï¼Œè¿™æ ·çš„åšæ³•æ˜¯å…¨å±€ç”Ÿæ•ˆçš„ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">multicastEvent</span><span class="params">(<span class="keyword">final</span> ApplicationEvent event, <span class="meta">@Nullable</span> ResolvableType eventType)</span> {</span><br><span class="line">    <span class="comment">// è·å–æ‰§è¡Œçº¿ç¨‹æ± </span></span><br><span class="line">    <span class="type">Executor</span> <span class="variable">executor</span> <span class="operator">=</span> getTaskExecutor();</span><br><span class="line">    <span class="keyword">for</span> (ApplicationListener&lt;?&gt; listener : getApplicationListeners(event, type)) {</span><br><span class="line">        <span class="comment">// å¦‚æœå­˜åœ¨çº¿ç¨‹æ± ï¼Œä½¿ç”¨çº¿ç¨‹æ± å¼‚æ­¥æ‰§è¡Œ</span></span><br><span class="line">        <span class="keyword">if</span> (executor != <span class="literal">null</span>) {</span><br><span class="line">            executor.execute(() -&gt; invokeListener(listener, event));</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">// å¦‚æœä¸å­˜åœ¨çº¿ç¨‹æ± ï¼ŒåŒæ­¥æ‰§è¡Œ</span></span><br><span class="line">        <span class="keyword">else</span> {</span><br><span class="line">            invokeListener(listener, event);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setTaskExecutor</span><span class="params">(<span class="meta">@Nullable</span> Executor taskExecutor)</span> {</span><br><span class="line">    <span class="built_in">this</span>.taskExecutor = taskExecutor;</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<h3 id="5-2-ä½¿ç”¨-Async"><a href="#5-2-ä½¿ç”¨-Async" class="headerlink" title="5.2 ä½¿ç”¨@Async"></a>5.2 ä½¿ç”¨<code>@Async</code></h3><p>è¿˜æœ‰ä¸€ç§æ–¹å¼æ˜¯é€šè¿‡ç»™ç›‘å¬è€…çš„<code>onApplicationEvent()</code>æ·»åŠ <code>@Async</code>æ³¨è§£ä½¿å…¶å˜æˆå¼‚æ­¥çš„ï¼Œè¿™ç§æ–¹å¼åªå¯¹å•ä¸ªæ–¹æ³•ç”Ÿæ•ˆï¼Œä½¿ç”¨æ–¹å¼å°±è·Ÿæˆ‘ä»¬å¹³æ—¶å®šä¹‰çš„å¼‚æ­¥æ–¹æ³•ä¸€æ ·ï¼Œè¿™é‡Œå°±ä¸å¤šèµ˜è¿°äº†</p>
<h2 id="6-å…¨å±€å¼‚å¸¸å¤„ç†"><a href="#6-å…¨å±€å¼‚å¸¸å¤„ç†" class="headerlink" title="6 å…¨å±€å¼‚å¸¸å¤„ç†"></a>6 å…¨å±€å¼‚å¸¸å¤„ç†</h2><p><code>ApplicationEventMulticaster</code>åˆ†å‘äº‹ä»¶çš„æ—¶å€™å‘ç”Ÿå¼‚å¸¸æ€ä¹ˆåŠï¼Œåé¢çš„ç›‘å¬å™¨è¿˜èƒ½æ‰§è¡Œå—ï¼Ÿ</p>
<p>Springäº‹ä»¶çš„å¤„ç†ï¼Œé»˜è®¤æ˜¯åŒæ­¥ä¾æ¬¡æ‰§è¡Œã€‚é‚£å¦‚æœå‰é¢çš„ç›‘å¬å™¨å‡ºç°äº†å¼‚å¸¸ï¼Œå¹¶ä¸”æ²¡æœ‰å¤„ç†å¼‚å¸¸ï¼Œä¼šå¯¹åç»­çš„ç›‘å¬å™¨è¿˜èƒ½é¡ºåˆ©æ¥æ”¶è¯¥äº‹ä»¶å—ï¼Ÿå…¶å®ä¸èƒ½çš„ï¼Œå› ä¸ºå¼‚å¸¸ä¸­æ–­äº†äº‹ä»¶çš„å‘é€äº†</p>
<p>å¦‚æœè®¾ç½®äº†å¼‚æ­¥æ‰§è¡Œï¼Œå› ä¸ºä¸æ˜¯ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œï¼Œæ˜¯ä¸ä¼šäº’ç›¸å½±å“çš„ã€‚</p>
<p>Springæä¾›äº†ErrorHandleræ¥æ–¹ä¾¿æˆ‘ä»¬å¯¹æ¶ˆæ¯å¤„ç†å¼‚å¸¸è¿›è¡Œç»Ÿä¸€å¤„ç†ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="type">ApplicationEventMulticaster</span> <span class="variable">multicaster</span> <span class="operator">=</span> context.getBean(AbstractApplicationContext.APPLICATION_EVENT_MULTICASTER_BEAN_NAME, ApplicationEventMulticaster.class);</span><br><span class="line">((SimpleApplicationEventMulticaster) multicaster).setErrorHandler(t -&gt; System.out.println(t));</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<h2 id="7-æ€»ç»“"><a href="#7-æ€»ç»“" class="headerlink" title="7 æ€»ç»“"></a>7 æ€»ç»“</h2><p><strong>Springäº‹ä»¶æœºåˆ¶å­˜åœ¨ä»€ä¹ˆé—®é¢˜ï¼Ÿ</strong></p>
<p>æˆ‘è®¤ä¸ºä¸»è¦çš„é—®é¢˜è¿˜æ˜¯å…¬å…±çº¿ç¨‹æ± é€ æˆçš„é—®é¢˜ï¼š</p>
<ol>
<li><p><strong>å‘å¸ƒé˜»å¡</strong></p>
<p> <strong>ç›‘å¬å™¨çš„æ‰§è¡Œé€Ÿåº¦ä¼šäº’ç›¸å½±å“ã€ç”šè‡³ä¼šå‘ç”Ÿé˜»å¡</strong>ã€‚å‡å¦‚æŸä¸€ä¸ªç›‘å¬å™¨æ‰§è¡Œçš„å¾ˆæ…¢ï¼ŒæŠŠçº¿ç¨‹æ± ä¸­çº¿ç¨‹éƒ½å ç”¨äº†ï¼Œæ­¤æ—¶å…¶ä»–çš„äº‹ä»¶è™½ç„¶å‘å¸ƒä½†æ²¡æœ‰èµ„æºæ‰§è¡Œï¼Œåªèƒ½åœ¨ç¼“å­˜é˜Ÿåˆ—ç­‰å¾…çº¿ç¨‹é‡Šæ”¾<br> å…¶å®è¿™é‡Œå¯ä»¥å‚è€ƒNettyçš„boss-workå·¥ä½œæ¨¡å‹ï¼Œå¹¿æ’­å™¨åªè´Ÿè´£åˆ†å‘äº‹ä»¶ï¼Œè°ƒåº¦æ‰§è¡Œç›‘å¬å™¨çš„é€»è¾‘äº¤ç»™ç”±å…·ä½“çš„workçº¿ç¨‹è´Ÿè´£ä¼šæ›´åˆé€‚ã€‚</p>
</li>
<li><p><strong>æ— æ³•å®šåˆ¶ç›‘å¬å™¨æ‰§è¡Œçº¿ç¨‹æ± </strong></p>
<p> ç”±äºæ¯ç§äº‹ä»¶äº§ç”Ÿçš„æ•°é‡ã€å¤„ç†é€»è¾‘ã€å¤„ç†é€Ÿåº¦å·®å¼‚åŒ–å¯èƒ½å¾ˆå¤§ï¼Œæ‰€ä»¥æ¯ä¸ªç›‘å¬å™¨éƒ½æœ‰é€‚åˆè‡ªå·±åœºæ™¯çš„çº¿ç¨‹æ•°ï¼Œä¸ºæ¯ä¸ªç›‘å¬å™¨é…ç½®å•ç‹¬çš„çº¿ç¨‹æ± å°¤ä¸ºé‡è¦ã€‚Springäº‹ä»¶æœºåˆ¶æ— æ³•å•ç‹¬ä¸ºç›‘å¬å™¨è®¾ç½®çº¿ç¨‹æ± ï¼Œåªèƒ½å…±ç”¨çº¿ç¨‹æ± ï¼Œæ— æ³•åšåˆ°ç²¾å‡†æ§åˆ¶ï¼Œçº¿ç¨‹æ‹¥å µæˆ–è€…çº¿ç¨‹æµªè´¹å‡ºç°çš„å‡ ç‡æå¤§</p>
<p> è™½ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨æ¥æ”¶åˆ°äº‹ä»¶åä½¿ç”¨è‡ªå®šä¹‰çš„çº¿ç¨‹æ± å¤„ç†ï¼Œä½†æ˜¯æˆ‘ä»¬æ›´å¸Œæœ›ç®€å•åŒ–é…ç½®å°±èƒ½æ”¯æŒ</p>
</li>
</ol>
<hr>
<p>å‚è€ƒï¼š</p>
<ul>
<li><a href="https://juejin.cn/post/7140849555607650335#heading-14">èŠé€Springäº‹ä»¶æœºåˆ¶</a></li>
</ul>
]]></content>
      <categories>
        <category>Springä½“ç³»ç»“æ„</category>
      </categories>
      <tags>
        <tag>Springæºç é˜…è¯»</tag>
      </tags>
  </entry>
  <entry>
    <title>SpingBoot3.0 å‡çº§è®°å½•</title>
    <url>/2024/06/04/Spingboot3.0%20%E5%8D%87%E7%BA%A7%E8%AE%B0%E5%BD%95/</url>
    <content><![CDATA[<blockquote>
<p><strong>èƒŒæ™¯</strong>ï¼šåœ¨åŸæ¥ä¸€ä¸ªåŸºäº SpringBoot 2.6.x çš„é¡¹ç›®ä¸­ï¼Œå¼•å…¥äº†ä¸€ä¸ªç¬¬ä¸‰æ–¹åº“åï¼Œå‘ç°æ— æ³•æ­£å¸¸åŠ è½½å…¶è‡ªåŠ¨è£…é…çš„Beanã€‚ç»è¿‡æ’æŸ¥ï¼Œå‘ç°ç¬¬ä¸‰æ–¹åº“åŸºäºSpring Boot 3.2.4 ç‰ˆæœ¬å¼€å‘ï¼Œå­˜åœ¨ä¾èµ–æ³¨å…¥æ–¹å¼ä¸Šçš„å·®å¼‚ã€‚ä¸ºäº†å…¼å®¹æ€§ï¼Œå†³å®šå°†åŸé¡¹ç›®å‡çº§è‡³ Spring Boot 3.xã€‚é‰´äº Spring Boot 3.0 çš„é‡å¤§å˜åŒ–ï¼Œæœ¬æ–‡è¯¦ç»†è®°å½•äº†è¿ç§»è¿‡ç¨‹ä¸­é‡åˆ°çš„å…³é”®æ”¹åŠ¨åŠè§£å†³æ–¹æ¡ˆã€‚</p>
</blockquote>
<h2 id="SpringBoot-3-0ä¸»è¦æ”¹åŠ¨"><a href="#SpringBoot-3-0ä¸»è¦æ”¹åŠ¨" class="headerlink" title="SpringBoot 3.0ä¸»è¦æ”¹åŠ¨"></a>SpringBoot 3.0ä¸»è¦æ”¹åŠ¨</h2><p>ä»¥ä¸‹æ˜¯SpringBoot 3.0 ä¸­æœ€é‡è¦çš„å˜åŠ¨ï¼š</p>
<ul>
<li><strong>æœ€ä½ Java ç‰ˆæœ¬è¦æ±‚</strong>ï¼šå‡çº§è‡³ Java 17ã€‚</li>
<li><strong>ç§»é™¤å†…ç½®é…ç½®</strong>ï¼šä¾‹å¦‚ï¼ŒMySQL é©±åŠ¨ç­‰é…ç½®è¢«ç§»é™¤ï¼Œå®˜æ–¹æä¾›è¿ç§»å·¥å…·ååŠ©å‡çº§ï¼š</li>
</ul>
<span id="more"></span>

<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-properties-migrator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><strong>Jakarta EE æ›¿ä»£ Java EE</strong>ï¼šæ‰€æœ‰ <code>javax</code> åŒ…è¢«æ›¿æ¢ä¸º <code>jakarta</code> åŒ…ï¼š</li>
</ul>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line">javax.persistence.*   -&gt; jakarta.persistence.*</span><br><span class="line">javax.validation.*    -&gt; jakarta.validation.*</span><br><span class="line">javax.servlet.*       -&gt; jakarta.servlet.*</span><br><span class="line">javax.annotation.*    -&gt; jakarta.annotation.*</span><br><span class="line">javax.transaction.*   -&gt; jakarta.transaction.*</span><br></pre></td></tr></tbody></table></figure>

<p>æ›´å¤šæ”¹åŠ¨è¯¦æƒ…ï¼Œå‚è€ƒå®˜æ–¹æ–‡æ¡£ï¼š<a href="https://github.com/spring-projects/spring-boot/wiki/Spring-Boot-3.0-Release-Notes">SpringBoot 3.0 å‘å¸ƒè¯´æ˜</a></p>
<h2 id="é¡¹ç›®è¿ç§»ä¸­å‘ç°çš„é—®é¢˜"><a href="#é¡¹ç›®è¿ç§»ä¸­å‘ç°çš„é—®é¢˜" class="headerlink" title="é¡¹ç›®è¿ç§»ä¸­å‘ç°çš„é—®é¢˜"></a>é¡¹ç›®è¿ç§»ä¸­å‘ç°çš„é—®é¢˜</h2><h3 id="è‡ªå®šä¹‰-Starter-ä¸å…¼å®¹"><a href="#è‡ªå®šä¹‰-Starter-ä¸å…¼å®¹" class="headerlink" title="è‡ªå®šä¹‰ Starter ä¸å…¼å®¹"></a>è‡ªå®šä¹‰ Starter ä¸å…¼å®¹</h3><p>åŸç‰ˆæœ¬ä¸­è‡ªå®šä¹‰Starterçš„æ–¹å¼ä¸ºï¼šåœ¨æ‰«æç±»ä¸Šä½¿ç”¨<code>@Configuration</code>æ³¨è§£ï¼Œå¹¶åœ¨<code>META-INF/spring.factories</code>æ–‡ä»¶ä¸­å£°æ˜è¯¥æ‰«æç±»ï¼š</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">org.springframework.boot.autoconfigure.EnableAutoConfiguration=\</span><br><span class="line">{{å¯åŠ¨ç±»è·¯å¾„}}</span><br></pre></td></tr></tbody></table></figure>

<p>è€Œåœ¨æ–°ç‰ˆä¸­ï¼Œè‡ªå®šä¹‰Starteråº”é‡‡ç”¨<code>@AutoConfiguration</code>æ³¨è§£ï¼Œ<br>å¹¶åœ¨ <code>META-INF/spring/org.springframework.boot.autoconfigure.AutoConfiguration.imports</code> æ–‡ä»¶ä¸­å£°æ˜æ‰«æç±»ï¼š</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">{{å¯åŠ¨ç±»è·¯å¾„}}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="Mybatis-å…¼å®¹æ€§é—®é¢˜"><a href="#Mybatis-å…¼å®¹æ€§é—®é¢˜" class="headerlink" title="Mybatis å…¼å®¹æ€§é—®é¢˜"></a>Mybatis å…¼å®¹æ€§é—®é¢˜</h3><p><img src="/../images/Spingboot3.0-%E5%8D%87%E7%BA%A7%E8%AE%B0%E5%BD%95/Secure2%20Image.png" alt="Secure2 Image"></p>
<p><strong>åŸå› </strong>ï¼šMybatis æ—§ç‰ˆæœ¬ä¸ SpringBoot 3.0 ä¸å…¼å®¹ï¼Œéœ€å‡çº§è‡³ Mybatis 3.x ç‰ˆæœ¬æˆ–æ›´é«˜ã€‚</p>
]]></content>
      <categories>
        <category>æ—¥å¸¸å°è®°</category>
      </categories>
  </entry>
  <entry>
    <title>Spring Lazy-init è¸©å‘è®°å½•</title>
    <url>/2023/11/01/Spring%20Lazy-init%20%E8%B8%A9%E5%9D%91%E8%AE%B0%E5%BD%95/</url>
    <content><![CDATA[<blockquote>
<p>èµ·å› ï¼šåœ¨å†™ä¸€ä¸ªSpringbooté¡¹ç›®æ—¶ï¼Œé˜Ÿå‹å°†é¡¹ç›®åŠ è½½æ–¹å¼æ”¹ä¸º<code>lazy-init</code>ï¼Œç†ç”±æ˜¯èƒ½åŠ å¿«é‡å¯çš„é€Ÿåº¦ï¼Œä½†æ˜¯å¯¼è‡´äº†Bug</p>
</blockquote>
<span id="more"></span>

<p><img src="/../images/289b54f1b37819da340708c7cfb9e261_rfYNVwE36_.png"></p>
<p><img src="/../images/1551908c7fb3dddbbc2d3b1e90a48cf1_gLwVbcWEG6.png"></p>
<p>Springåœ¨Beanåˆå§‹åŒ–é˜¶æ®µä¼šå¯¹æ‰€æœ‰ç»§æ‰¿äº†<code>ApplicationContextAware</code>æ¥å£çš„ç±»æ³¨å…¥<code>ApplicationContext</code></p>
<p>ä½†æ˜¯å¦‚æœè®¾ç½®äº†<code>lazy-init</code>ï¼ŒbeanåŠ è½½é¡ºåºå˜äº†ï¼Œ<code>setApplicationContext</code>å°±ä¸æ‰§è¡Œäº†</p>
]]></content>
      <categories>
        <category>æ—¥å¸¸å°è®°</category>
      </categories>
      <tags>
        <tag>Bug</tag>
      </tags>
  </entry>
  <entry>
    <title>Spring äº‹åŠ¡ä½“ç³»</title>
    <url>/2024/01/08/Spring-%E4%BA%8B%E5%8A%A1%E4%BD%93%E7%B3%BB/</url>
    <content><![CDATA[<p>æœ€è¿‘äº†è§£åˆ°ï¼ŒSpringä¸­çš„äº‹åŠ¡æ˜¯ç”±AOPå®ç°çš„ï¼ˆå½“ç„¶è¿™é‡Œè¯´çš„æ˜¯å£°æ˜å¼äº‹åŠ¡ï¼‰ï¼Œè‡³äºé‡Œé¢å…·ä½“çš„é€»è¾‘æ˜¯æ€ä¹ˆæ ·çš„ï¼Œä»Šå¤©èŠ±äº†ä¸€å¤©çš„æ—¶é—´çœ‹ä»£ç ï¼Œæ€»ç®—å¼„æ˜¯æ˜ç™½äº†å¤§æ¦‚æµç¨‹ğŸ˜ï¼Œè‡³äºé‡Œé¢å¾ˆå¤šæŠ€æœ¯ç»†èŠ‚è¿˜æ²¡å»æ·±æŒ–ï¼Œå…ˆè¿™æ ·å§â•®(â•¯_â•°)â•­</p>
<h2 id="Spring-äº‹åŠ¡ç›¸å…³çš„API"><a href="#Spring-äº‹åŠ¡ç›¸å…³çš„API" class="headerlink" title="Spring äº‹åŠ¡ç›¸å…³çš„API"></a>Spring äº‹åŠ¡ç›¸å…³çš„API</h2><p>å…ˆçœ‹çœ‹æ¦‚å¿µï¼š</p>
<p><strong>äº‹åŠ¡æ“ä½œç›¸å…³çš„API</strong></p>
<ul>
<li><code>@Transactional</code> - Springäº‹åŠ¡æ³¨è§£</li>
<li><code>@EnableTranSactionManagement</code> - Springäº‹åŠ¡æ¨¡å—é©±åŠ¨</li>
</ul>
<p><strong>äº‹åŠ¡æŠ½è±¡ç›¸å…³çš„API</strong></p>
<ul>
<li><strong><code>PlatformTransactionManager</code></strong> - Springå¹³å°äº‹åŠ¡ç®¡ç†å™¨ï¼Œè´Ÿè´£æ‰§è¡Œäº‹åŠ¡çš„å…³é”®ç±»</li>
<li><code>TransactionStatus</code> - Springäº‹åŠ¡çŠ¶æ€</li>
<li><code>TransactionDefinition</code> - Springäº‹åŠ¡å®šä¹‰</li>
<li><strong><code>ProxyTransactionManagementConfiguration</code></strong> - Springäº‹åŠ¡ä»£ç†é…ç½®ç±»</li>
</ul>
<p><strong>AOPç›¸å…³çš„API</strong></p>
<ul>
<li><strong><code>BeanFactoryTransactionAttrubuteSourceAdvisor</code></strong> - Springäº‹åŠ¡PointcutAdvisorå®ç°</li>
<li><strong><code>TransactionInterceptor</code></strong> - äº‹åŠ¡æ‰§è¡Œåˆ‡é¢ï¼Œè´Ÿè´£äº‹åŠ¡æ‰§è¡Œçš„æ ¸å¿ƒç±»</li>
<li><strong><code>TransactionAttributeSource</code></strong> - Springäº‹åŠ¡å±æ€§æº</li>
<li><strong><code>TransactionAnnotationParser</code></strong> - è§£æå™¨ï¼Œè´Ÿè´£æ‰«æå¹¶è§£ææ‰€æœ‰çš„å¸¦æœ‰@Transactionalçš„æ–¹æ³•æˆ–ç±»ï¼Œå¹¶å°†æ•°æ®å°è£…ä¸º<code>TransactionAttributeSource</code></li>
<li><code>TransactionSynchronizationAdapter</code> - äº‹åŠ¡åŒæ­¥å™¨ï¼Œæ„ŸçŸ¥äº‹åŠ¡æ˜¯æˆåŠŸè¿˜æ˜¯å¤±è´¥ï¼Œåœ¨äº‹åŠ¡æäº¤å‰åé€šçŸ¥ï¼Œè¿™ä¸ªåœ¨åšä¸€äº›éœ€è¦ç›‘å¬äº‹åŠ¡çŠ¶æ€çš„ä¸šåŠ¡éœ€æ±‚ä¼°è®¡ä¼šæ¯”è¾ƒæœ‰ç”¨å§ğŸ¤¨</li>
</ul>
<span id="more"></span>

<h2 id="å®ç°åŸç†"><a href="#å®ç°åŸç†" class="headerlink" title="å®ç°åŸç†"></a>å®ç°åŸç†</h2><p><code>ProxyTransactionManagementConfiguration</code>æ˜¯é€šè¿‡<code>@EnableTranSactionManagement</code>æ³¨å…¥çš„æ ¸å¿ƒé…ç½®ç±»ï¼Œå†…éƒ¨å®é™…æ³¨å†Œäº†ä¸‰ä¸ªBeanï¼Œè¿™ä¸‰ä¸ªBeanå…¶å®æ˜¯AOPçš„ä¸‰éƒ¨åˆ†ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line"><span class="meta">@Role(BeanDefinition.ROLE_INFRASTRUCTURE)</span></span><br><span class="line"><span class="meta">@ImportRuntimeHints(TransactionRuntimeHints.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProxyTransactionManagementConfiguration</span> <span class="keyword">extends</span> <span class="title class_">AbstractTransactionManagementConfiguration</span> {</span><br><span class="line"></span><br><span class="line">  <span class="comment">// AOPçš„PointcutAdvisor</span></span><br><span class="line">  <span class="comment">// PointcutAdvisor = PointCut + Advice</span></span><br><span class="line">  <span class="meta">@Bean(name = TransactionManagementConfigUtils.TRANSACTION_ADVISOR_BEAN_NAME)</span></span><br><span class="line">  <span class="meta">@Role(BeanDefinition.ROLE_INFRASTRUCTURE)</span></span><br><span class="line">  <span class="keyword">public</span> BeanFactoryTransactionAttributeSourceAdvisor <span class="title function_">transactionAdvisor</span><span class="params">(</span></span><br><span class="line"><span class="params">      TransactionAttributeSource transactionAttributeSource, TransactionInterceptor transactionInterceptor)</span> {</span><br><span class="line"></span><br><span class="line">    <span class="type">BeanFactoryTransactionAttributeSourceAdvisor</span> <span class="variable">advisor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BeanFactoryTransactionAttributeSourceAdvisor</span>();</span><br><span class="line">    advisor.setTransactionAttributeSource(transactionAttributeSource);</span><br><span class="line">    advisor.setAdvice(transactionInterceptor);</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.enableTx != <span class="literal">null</span>) {</span><br><span class="line">      advisor.setOrder(<span class="built_in">this</span>.enableTx.&lt;Integer&gt;getNumber(<span class="string">"order"</span>));</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> advisor;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="comment">// PointCut</span></span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="meta">@Role(BeanDefinition.ROLE_INFRASTRUCTURE)</span></span><br><span class="line">  <span class="keyword">public</span> TransactionAttributeSource <span class="title function_">transactionAttributeSource</span><span class="params">()</span> {</span><br><span class="line">    <span class="comment">// Accept protected @Transactional methods on CGLIB proxies, as of 6.0.</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">AnnotationTransactionAttributeSource</span>(<span class="literal">false</span>);</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Advice</span></span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="meta">@Role(BeanDefinition.ROLE_INFRASTRUCTURE)</span></span><br><span class="line">  <span class="keyword">public</span> TransactionInterceptor <span class="title function_">transactionInterceptor</span><span class="params">(TransactionAttributeSource transactionAttributeSource)</span> {</span><br><span class="line">    <span class="type">TransactionInterceptor</span> <span class="variable">interceptor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TransactionInterceptor</span>();</span><br><span class="line">    interceptor.setTransactionAttributeSource(transactionAttributeSource);</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.txManager != <span class="literal">null</span>) {</span><br><span class="line">      interceptor.setTransactionManager(<span class="built_in">this</span>.txManager);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> interceptor;</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>å…¶ä¸­<code>BeanFactoryTransactionAttributeSourceAdvisor</code>è´Ÿè´£å°†<code>PointCut</code>å’Œ<code>Advice</code>æ³¨å…¥åˆ°AOPä¸­ï¼Œæ²¡æœ‰ä»€ä¹ˆå¤æ‚çš„é€»è¾‘</p>
<p>ä¸‹é¢ä»‹ç»ä¸€ä¸‹<code>TransactionAttributeSource</code>å’Œ<code>TransactionInterceptor</code></p>
<h3 id="TransactionAttributeSource"><a href="#TransactionAttributeSource" class="headerlink" title="TransactionAttributeSource"></a>TransactionAttributeSource</h3><p>ä¸Šé¢æ³¨å…¥äº†ä¸€ä¸ª<code>AnnotationTransactionAttributeSource</code>ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹è¿™ä¸ªBeanåšäº†ä»€ä¹ˆ</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// æ·»åŠ è§£æå™¨</span></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">AnnotationTransactionAttributeSource</span><span class="params">(<span class="type">boolean</span> publicMethodsOnly)</span> {</span><br><span class="line">  <span class="built_in">this</span>.publicMethodsOnly = publicMethodsOnly;</span><br><span class="line">  <span class="keyword">if</span> (jta12Present || ejb3Present) {</span><br><span class="line">    <span class="built_in">this</span>.annotationParsers = <span class="keyword">new</span> <span class="title class_">LinkedHashSet</span>&lt;&gt;(<span class="number">4</span>);</span><br><span class="line">    <span class="built_in">this</span>.annotationParsers.add(<span class="keyword">new</span> <span class="title class_">SpringTransactionAnnotationParser</span>());</span><br><span class="line">    <span class="keyword">if</span> (jta12Present) {</span><br><span class="line">      <span class="built_in">this</span>.annotationParsers.add(<span class="keyword">new</span> <span class="title class_">JtaTransactionAnnotationParser</span>());</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">if</span> (ejb3Present) {</span><br><span class="line">      <span class="built_in">this</span>.annotationParsers.add(<span class="keyword">new</span> <span class="title class_">Ejb3TransactionAnnotationParser</span>());</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">else</span> {</span><br><span class="line">    <span class="built_in">this</span>.annotationParsers = Collections.singleton(<span class="keyword">new</span> <span class="title class_">SpringTransactionAnnotationParser</span>());</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// è§£ææ–¹æ³•</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="keyword">protected</span> TransactionAttribute <span class="title function_">findTransactionAttribute</span><span class="params">(Method method)</span> {</span><br><span class="line">  <span class="keyword">return</span> determineTransactionAttribute(method);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// è§£ææ–¹æ³•ä¸Šçš„Transactionalæ³¨è§£</span></span><br><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="keyword">protected</span> TransactionAttribute <span class="title function_">determineTransactionAttribute</span><span class="params">(AnnotatedElement element)</span> {</span><br><span class="line">  <span class="keyword">for</span> (TransactionAnnotationParser parser : <span class="built_in">this</span>.annotationParsers) {</span><br><span class="line">    <span class="type">TransactionAttribute</span> <span class="variable">attr</span> <span class="operator">=</span> parser.parseTransactionAnnotation(element);</span><br><span class="line">    <span class="keyword">if</span> (attr != <span class="literal">null</span>) {</span><br><span class="line">      <span class="keyword">return</span> attr;</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<p>æ‰€ä»¥è¿™ä¸ªç±»çš„ä½œç”¨å¤§æ¦‚å°±æ˜¯è§£ææ‰€æœ‰æ–¹æ³•ä¸Šçš„Transactionalæ³¨è§£ç„¶åå°è£…ä¸º<code>TransactionAttributeSource</code>ï¼Œæœ€åæ‹…ä»»<code>PointCut</code>è§’è‰²</p>
<h3 id="TransactionInterceptor"><a href="#TransactionInterceptor" class="headerlink" title="TransactionInterceptor"></a>TransactionInterceptor</h3><p>æ‰§è¡Œäº‹åŠ¡çš„æ ¸å¿ƒæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•å¾ˆé•¿å¾ˆå¤æ‚æ²¡æœ‰è€å¿ƒçœ‹äº†ğŸ¥²ï¼Œçœ‹äº†ç½‘ä¸Šçš„åšå®¢å¤§æ¦‚æ˜¯è¿™ä¹ˆè¯´çš„ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> Object <span class="title function_">invokeWithinTransaction</span><span class="params">(Method method, <span class="meta">@Nullable</span> Class&lt;?&gt; targetClass,</span></span><br><span class="line"><span class="params">    <span class="keyword">final</span> InvocationCallback invocation)</span> <span class="keyword">throws</span> Throwable {</span><br><span class="line"></span><br><span class="line">  <span class="type">TransactionAttributeSource</span> <span class="variable">tas</span> <span class="operator">=</span> getTransactionAttributeSource();</span><br><span class="line">  <span class="keyword">final</span> <span class="type">TransactionAttribute</span> <span class="variable">txAttr</span> <span class="operator">=</span> (tas != <span class="literal">null</span> ? tas.getTransactionAttribute(method, targetClass) : <span class="literal">null</span>);</span><br><span class="line">  <span class="keyword">final</span> <span class="type">PlatformTransactionManager</span> <span class="variable">tm</span> <span class="operator">=</span> determineTransactionManager(txAttr);</span><br><span class="line">  <span class="keyword">final</span> <span class="type">String</span> <span class="variable">joinpointIdentification</span> <span class="operator">=</span> methodIdentification(method, targetClass, txAttr);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//è·å–äº‹åŠ¡</span></span><br><span class="line">  <span class="type">TransactionInfo</span> <span class="variable">txInfo</span> <span class="operator">=</span> createTransactionIfNecessary(tm, txAttr, joinpointIdentification);</span><br><span class="line">  <span class="type">Object</span> <span class="variable">retVal</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">try</span> {</span><br><span class="line">    <span class="comment">//æ‰§è¡Œç›®æ ‡æ–¹æ³•crud</span></span><br><span class="line">    retVal = invocation.proceedWithInvocation();</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">catch</span> (Throwable ex) {</span><br><span class="line">    <span class="comment">// crudæ‰§è¡Œå¼‚å¸¸å›æ»šäº‹åŠ¡</span></span><br><span class="line">    completeTransactionAfterThrowing(txInfo, ex);</span><br><span class="line">    <span class="keyword">throw</span> ex;</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">finally</span> {</span><br><span class="line">    cleanupTransactionInfo(txInfo);</span><br><span class="line">  }</span><br><span class="line">  <span class="comment">//æäº¤äº‹åŠ¡</span></span><br><span class="line">  commitTransactionAfterReturning(txInfo);</span><br><span class="line">  <span class="keyword">return</span> retVal;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>å…¶ä¸­è°ƒç”¨äº†<code>PlatformTransactionManager</code>å»æ‰§è¡Œç‰©ç†äº‹åŠ¡ï¼Œæ˜¯è´Ÿè´£æ‰§è¡Œå¢å¼ºä»»åŠ¡çš„<code>Advice</code></p>
<h3 id="PlatformTransactionManager"><a href="#PlatformTransactionManager" class="headerlink" title="PlatformTransactionManager"></a>PlatformTransactionManager</h3><p>PlatformTransactionManageræ˜¯Springå¯¹äºäº‹åŠ¡æ¨¡å‹çš„æŠ½è±¡ï¼Œå®ƒä»£è¡¨äº‹åŠ¡çš„æ•´ä½“æ‰§è¡Œè¿‡ç¨‹ã€‚</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">PlatformTransactionManager</span> {</span><br><span class="line">    <span class="comment">// è·å–äº‹åŠ¡çš„æ‰§è¡ŒçŠ¶æ€</span></span><br><span class="line">    TransactionStatus <span class="title function_">getTransaction</span><span class="params">(<span class="meta">@Nullable</span> TransactionDefinition var1)</span> <span class="keyword">throws</span> TransactionException;</span><br><span class="line">    <span class="comment">// æäº¤äº‹åŠ¡</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">commit</span><span class="params">(TransactionStatus var1)</span> <span class="keyword">throws</span> TransactionException;</span><br><span class="line">    <span class="comment">// å›æ»šäº‹åŠ¡</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">rollback</span><span class="params">(TransactionStatus var1)</span> <span class="keyword">throws</span> TransactionException;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<hr>
<h2 id="å…¶ä»–çš„ä¸€äº›çŸ¥è¯†ç‚¹"><a href="#å…¶ä»–çš„ä¸€äº›çŸ¥è¯†ç‚¹" class="headerlink" title="å…¶ä»–çš„ä¸€äº›çŸ¥è¯†ç‚¹"></a>å…¶ä»–çš„ä¸€äº›çŸ¥è¯†ç‚¹</h2><h3 id="Springä¸­äº‹åŠ¡çš„ä¼ æ’­è¡Œä¸º"><a href="#Springä¸­äº‹åŠ¡çš„ä¼ æ’­è¡Œä¸º" class="headerlink" title="Springä¸­äº‹åŠ¡çš„ä¼ æ’­è¡Œä¸º"></a>Springä¸­äº‹åŠ¡çš„ä¼ æ’­è¡Œä¸º</h3><p>Springä¸­äº‹åŠ¡çš„ä¼ æ’­æ¨¡å¼æœ‰ä»¥ä¸‹å‡ ç§ï¼š</p>
<p><img src="/../images/Spring-%E4%BA%8B%E5%8A%A1%E4%BD%93%E7%B3%BB/%E4%BA%8B%E5%8A%A1%E4%BC%A0%E6%92%AD%E6%A8%A1%E5%BC%8F.png"></p>
<p>äº‹åŠ¡åˆ†ä¸ºé€»è¾‘äº‹åŠ¡å’Œç‰©ç†äº‹åŠ¡ï¼š</p>
<ul>
<li>é€»è¾‘äº‹åŠ¡æ˜¯æŒ‡ä»£ç ä¸­äº‹åŠ¡çš„æ“ä½œï¼Œå³è¡¨é¢çš„ä¸šåŠ¡é€»è¾‘</li>
<li>ç‰©ç†äº‹åŠ¡æ˜¯æ•°æ®åº“å±‚é¢çš„æ“ä½œï¼Œå³ä»è·å–æ•°æ®åº“è¿æ¥åˆ°æ•°æ®åº“æ‰§è¡Œäº‹åŠ¡å®Œæ¯•æ•´ä¸ªè¿‡ç¨‹</li>
</ul>
<h3 id="äº‹åŠ¡å¤±æ•ˆçš„å‡ ç§åœºæ™¯"><a href="#äº‹åŠ¡å¤±æ•ˆçš„å‡ ç§åœºæ™¯" class="headerlink" title="äº‹åŠ¡å¤±æ•ˆçš„å‡ ç§åœºæ™¯"></a>äº‹åŠ¡å¤±æ•ˆçš„å‡ ç§åœºæ™¯</h3><p>è¿™ä¸ªéƒ¨åˆ†æ˜¯æ ¹æ®ç½‘ä¸Šçš„åšå®¢æ€»ç»“å‡ºæ¥çš„ğŸ˜</p>
<ol>
<li>æ–¹æ³•ä¸º<code>private</code>ï¼šäº‹åŠ¡ä»£ç†ç±»è¦æ±‚è¢«ä»£ç†æ–¹æ³•å¿…é¡»æ˜¯<code>public</code>çš„ï¼Œå¦åˆ™ä¸è¿›è¡Œä»£ç†<ul>
<li>ä» Spring 6.0 å¼€å§‹ï¼Œ<code>protected</code>æ–¹æ³•å¯ä»¥è¢« CGLIB ä»£ç†</li>
</ul>
</li>
<li>æ–¹æ³•ç”¨<code>final</code>ä¿®é¥°ï¼šSpringäº‹åŠ¡åº•å±‚æ˜¯åŸºäºAOPçš„ï¼Œè¢«finalä¿®é¥°çš„æ–¹æ³•æ— æ³•è¢«ä»£ç†ç±»é‡å†™</li>
<li>æ–¹æ³•å†…éƒ¨è°ƒç”¨ï¼šåŒç†ï¼Œä»£ç†ç±»æ ¹æ®<code>@Transactional</code>ä»£ç†æ–¹æ³•ï¼Œæ–¹æ³•å†…éƒ¨è°ƒç”¨ä¼šç»•è¿‡ä»£ç†</li>
<li>å¤šçº¿ç¨‹è°ƒç”¨ã€å¼‚å¸¸æ•è·ä¸å¯¹ï¼ˆé»˜è®¤æ•è·<code>RunningTimeError</code>ï¼‰ã€æœªè¢«Springç®¡ç†ç­‰ç­‰</li>
</ol>
<hr>
<p>å‚è€ƒï¼š</p>
<ul>
<li><a href="https://juejin.cn/post/7106158883055353870">æ·±å…¥æµ…å‡ºSpringäº‹åŠ¡çš„å®ç°åŸç†</a></li>
<li><a href="https://juejin.cn/post/7003949263281455112?share_token=1c6f49e0-3d47-4380-af8d-de4d2b72a783">Springäº‹åŠ¡ä¸ç”Ÿæ•ˆçš„12ä¸­åœºæ™¯</a></li>
<li><a href="https://juejin.cn/post/7212142580708802615?from=search-suggest">å¥³æœ‹å‹ä¸æ‡‚Springäº‹åŠ¡åŸç†ï¼Œä»Šå¤©ç»™å¥¹è®²æ¸…æ¥šäº†ï¼</a></li>
<li><a href="https://cloud.tencent.com/developer/article/1808649">ä» AbstractPointcutAdvisor å¼€å§‹ï¼š Spring AOP ä¹‹ Advisorã€PointcutAdvisor ä»‹ç»</a></li>
</ul>
]]></content>
      <categories>
        <category>Springä½“ç³»ç»“æ„</category>
      </categories>
      <tags>
        <tag>Springæºç é˜…è¯»</tag>
      </tags>
  </entry>
  <entry>
    <title>Spring Securityæ¶æ„ä½“ç³»</title>
    <url>/2023/09/12/Spring-Security%E6%9E%B6%E6%9E%84/</url>
    <content><![CDATA[<p><em><strong>æœ¬æ–‡æš‚æœªå®Œå–„</strong></em></p>
<p>SpringSecurityçš„é€»è¾‘æ¶æ„ä¸»è¦åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼šè®¤è¯æ¶æ„å’Œæˆæƒæ¶æ„</p>
<h1 id="Servlet-è®¤è¯æ¶æ„"><a href="#Servlet-è®¤è¯æ¶æ„" class="headerlink" title="Servlet è®¤è¯æ¶æ„"></a>Servlet è®¤è¯æ¶æ„</h1><p>æ€»ä½“æ¶æ„ï¼š</p>
<p><img src="/../images/Spring-Security%E6%9E%B6%E6%9E%84/image_hWPD8lsRmI.png"></p>
<p>å…³é”®ç»„ä»¶ï¼š</p>
<p><code>AuthenticationFilter</code>ï¼šç”¨äºè·å–è¯·æ±‚ä¸­çš„ä¿¡æ¯ï¼Œå¹¶åˆ›å»º <code>Authentication</code>å¯¹è±¡</p>
<p><code>AuthenticationProvider</code>ï¼šç”¨äºéªŒè¯ç™»å½•é€»è¾‘ï¼Œå¯¹<code>Authentication</code>è¿›è¡Œè¿›ä¸€æ­¥çš„èº«ä»½è®¤è¯</p>
<span id="more"></span>

<p>ç”¨æˆ·æºå¸¦è®¤è¯tokenè¿›è¡Œè¯·æ±‚ï¼Œè¯·æ±‚ä¸­çš„ç”¨æˆ·èº«ä»½ä¿¡æ¯ä¼šè¢«AuthenTicationFilteræå–å‡ºæ¥å¹¶äº¤ç»™<code>AuthenticationManager</code>ï¼Œ<code>AuthenticationManager</code>è´Ÿè´£å¯¹ç”¨æˆ·çš„èº«ä»½ä¿¡æ¯è¿›è¡Œè®¤è¯</p>
<p><img src="/../images/Spring-Security%E6%9E%B6%E6%9E%84/image_67F-kIkJIp.png"></p>
<h2 id="é€»è¾‘å…³ç³»"><a href="#é€»è¾‘å…³ç³»" class="headerlink" title="é€»è¾‘å…³ç³»"></a>é€»è¾‘å…³ç³»</h2><p><img src="/../images/Spring-Security%E6%9E%B6%E6%9E%84/image_BnjQG1hUFj.png"></p>
<h2 id="ProviderManager"><a href="#ProviderManager" class="headerlink" title="ProviderManager"></a>ProviderManager</h2><p>ProviderManagerä¸­åŒ…å«äº†ä¸€ç³»åˆ—çš„Providerï¼Œè¿™äº›Providerè´Ÿè´£æ‰§è¡Œå®é™…çš„èº«ä»½éªŒè¯ã€‚ä¾‹å¦‚ï¼Œ<code>DaoAuthenticationProvider</code>æ”¯æŒåŸºäºç”¨æˆ·å/å¯†ç çš„èº«ä»½éªŒè¯ï¼ŒåŒæ—¶<code>JwtAuthenticationProvider</code>æ”¯æŒå¯¹ JWT ä»¤ç‰Œè¿›è¡Œèº«ä»½éªŒè¯ã€‚æ¯ä¸ª<code>AuthenticationProvider</code>æ‰§è¡Œç‰¹å®šç±»å‹çš„èº«ä»½éªŒè¯ã€‚</p>
<p><img src="/../images/Spring-Security%E6%9E%B6%E6%9E%84/image_3sJrWUgN3w.png"></p>
<p><img src="/../images/Spring-Security%E6%9E%B6%E6%9E%84/image_nA3iwqM0Zb.png"></p>
<h2 id="DaoAuthenticationProvider"><a href="#DaoAuthenticationProvider" class="headerlink" title="DaoAuthenticationProvider"></a>DaoAuthenticationProvider</h2><p>è¾“å…¥Usernameå’ŒPasswordï¼Œè¿”å›UserDetailså’ŒAuthorities</p>
<p>ä½œç”¨ï¼šæ˜¯ä¸€ä¸ª<code>AuthenticationProvider</code>ï¼Œç”¨äºæ ¡éªŒè´¦å·å¯†ç </p>
<p><img src="/../images/Spring-Security%E6%9E%B6%E6%9E%84/image_KiWYyJMnjI.png"></p>
<h1 id="SecurityContextHolder"><a href="#SecurityContextHolder" class="headerlink" title="SecurityContextHolder"></a>SecurityContextHolder</h1><p>Spring Security èº«ä»½éªŒè¯æ¨¡å‹çš„æ ¸å¿ƒæ˜¯<code>SecurityContextHolder</code>ï¼Œå®ƒå­˜åœ¨äºTreadLocalä¸­</p>
<p><img src="/../images/Spring-Security%E6%9E%B6%E6%9E%84/image_2QYvifZK3U.png"></p>
<h2 id="è®¾ç½®SecurityContextHolder"><a href="#è®¾ç½®SecurityContextHolder" class="headerlink" title="è®¾ç½®SecurityContextHolder"></a>è®¾ç½®SecurityContextHolder</h2><p>ä¸èƒ½ç›´æ¥é€šè¿‡<code>SecurityContextHolder.getContext().setAuthentication(authentication)</code>æ¥è®¾ç½®Holderä¸­çš„contextï¼Œå¦åˆ™å¤šçº¿ç¨‹æƒ…å†µä¸‹ä¼šå‡ºç°é—®é¢˜ã€‚åº”è¯¥ä¸ºæ¯ä¸ªçº¿ç¨‹åˆ›å»ºå•ç‹¬çš„å®ä¾‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="type">SecurityContext</span> <span class="variable">context</span> <span class="operator">=</span> SecurityContextHolder.createEmptyContext(); </span><br><span class="line"><span class="type">Authentication</span> <span class="variable">authentication</span> <span class="operator">=</span></span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">TestingAuthenticationToken</span>(<span class="string">"username"</span>, <span class="string">"password"</span>, <span class="string">"ROLE_USER"</span>); </span><br><span class="line">context.setAuthentication(authentication);</span><br><span class="line"></span><br><span class="line">SecurityContextHolder.setContext(context); </span><br></pre></td></tr></tbody></table></figure>

<h2 id="è®¿é—®å½“å‰ç»è¿‡èº«ä»½éªŒè¯çš„ç”¨æˆ·"><a href="#è®¿é—®å½“å‰ç»è¿‡èº«ä»½éªŒè¯çš„ç”¨æˆ·" class="headerlink" title="è®¿é—®å½“å‰ç»è¿‡èº«ä»½éªŒè¯çš„ç”¨æˆ·"></a>è®¿é—®å½“å‰ç»è¿‡èº«ä»½éªŒè¯çš„ç”¨æˆ·</h2><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="type">SecurityContext</span> <span class="variable">context</span> <span class="operator">=</span> SecurityContextHolder.getContext();</span><br><span class="line"><span class="type">Authentication</span> <span class="variable">authentication</span> <span class="operator">=</span> context.getAuthentication();</span><br><span class="line"><span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> authentication.getName();</span><br><span class="line"><span class="type">Object</span> <span class="variable">principal</span> <span class="operator">=</span> authentication.getPrincipal();</span><br><span class="line">Collection&lt;? <span class="keyword">extends</span> <span class="title class_">GrantedAuthority</span>&gt; authorities = authentication.getAuthorities();</span><br></pre></td></tr></tbody></table></figure>

<ul>
<li>é»˜è®¤æƒ…å†µä¸‹ï¼ŒSecurityContextHolderä½¿ç”¨ <code>ThreadLocal</code>æ¥å­˜å‚¨è¿™äº›è¯¦ç»†ä¿¡æ¯ã€‚</li>
<li>ThreadLocalå¦‚æœåœ¨å¤„ç†å½“å‰ä¸»ä½“çš„è¯·æ±‚åæ³¨æ„æ¸…é™¤çº¿ç¨‹ï¼ŒSpring Security çš„<code>FilterChainProxy</code>ç¡®ä¿SecurityContextå§‹ç»ˆæ¸…é™¤ã€‚</li>
<li>ä¸‰è€…åŒ…å«å…³ç³»ï¼šSecurityContextHolderâ†’ SecurityContext â†’ Authentication</li>
</ul>
<p><code>Authentication</code>ä¸­åŒ…å«ï¼š</p>
<ul>
<li><code>principal</code>ï¼šæ ‡è¯†ç”¨æˆ·ã€‚å½“ä½¿ç”¨ç”¨æˆ·å/å¯†ç è¿›è¡Œèº«ä»½éªŒè¯æ—¶ï¼Œè¿™é€šå¸¸æ˜¯<a href="https://docs.spring.io/spring-security/reference/servlet/authentication/passwords/user-details.html#servlet-authentication-userdetails" title="UserDetails">UserDetails</a>.</li>
<li><code>credentials</code>: é€šå¸¸æ˜¯å¯†ç ã€‚å¾ˆå¤šæƒ…å†µä¸‹ï¼Œè¿™ä¸ªæ˜¯åœ¨ç”¨æˆ·é€šè¿‡è®¤è¯åæ¸…é™¤çš„ï¼Œä»¥ä¿è¯ä¸è¢«æ³„éœ²ã€‚</li>
<li><code>Collection&lt;? extends GrantedAuthority&gt;</code>ï¼š<a href="https://docs.spring.io/spring-security/reference/servlet/authentication/architecture.html#servlet-authentication-granted-authority" title="GrantedAuthority">GrantedAuthority</a>å®ä¾‹æ˜¯æˆäºˆç”¨æˆ·çš„é«˜çº§æƒé™ã€‚</li>
</ul>
<blockquote>
<p><code>UserDetails</code>ã€<code>UserDetailsService</code>å…³ç³»ï¼š</p>
<p>UserDetailsç”±UserDetailsServiceè¿”å›ã€‚<code>DaoAuthenticationProvider</code>éªŒè¯UserDetailsï¼Œç„¶åè¿”å›ä¸€ä¸ªAuthenticationï¼Œè¯¥Authenticationçš„ä¸»ä½“æ˜¯é…ç½®çš„UserDetailsServiceè¿”å›çš„UserDetailsã€‚</p>
</blockquote>
<h1 id="Securityæˆæƒæµç¨‹"><a href="#Securityæˆæƒæµç¨‹" class="headerlink" title="Securityæˆæƒæµç¨‹"></a>Securityæˆæƒæµç¨‹</h1><p><img src="/../images/Spring-Security%E6%9E%B6%E6%9E%84/image_YR7XuKyby2.png"></p>
]]></content>
      <categories>
        <category>æ—¥å¸¸å°è®°</category>
      </categories>
      <tags>
        <tag>Spring Security</tag>
      </tags>
  </entry>
  <entry>
    <title>Spring IoCä¹‹ä½“ç³»ç»“æ„</title>
    <url>/2024/02/10/Spring-IoC%E4%B9%8B%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84/</url>
    <content><![CDATA[<p>Spring Bean çš„åˆ›å»ºæ˜¯å…¸å‹çš„å·¥å‚æ¨¡å¼ï¼Œåœ¨é¡¶å±‚çš„ç»“æ„è®¾è®¡ä¸»è¦å›´ç»•ç€ BeanFactory å’Œ xxxRegistry è¿›è¡Œï¼š</p>
<ul>
<li><strong>BeanFactoryï¼š å·¥å‚æ¨¡å¼å®šä¹‰äº† IOC å®¹å™¨çš„åŸºæœ¬åŠŸèƒ½</strong></li>
<li><strong>BeanRegistryï¼š æä¾›æ‰‹åŠ¨æ³¨å†Œ BeanDefinitionåˆ°å®¹å™¨ä¸­çš„æ–¹æ³•</strong></li>
</ul>
<p><img src="/../images/Spring-IoC%E4%B9%8B%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84/image_etoRGn8l6k.png"></p>
<span id="more"></span>

<h2 id="BeanFactory"><a href="#BeanFactory" class="headerlink" title="BeanFactory"></a>BeanFactory</h2><p><strong>BeanFactoryä½œä¸ºæœ€é¡¶å±‚çš„ä¸€ä¸ªæ¥å£ç±»ï¼Œå®ƒå®šä¹‰äº†IOCå®¹å™¨çš„åŸºæœ¬åŠŸèƒ½</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">BeanFactory</span> {    </span><br><span class="line">      </span><br><span class="line">    <span class="comment">//ç”¨äºå–æ¶ˆå¼•ç”¨å®ä¾‹å¹¶å°†å…¶ä¸FactoryBeanåˆ›å»ºçš„beanåŒºåˆ†å¼€æ¥ã€‚ä¾‹å¦‚ï¼Œå¦‚æœå‘½åçš„beanæ˜¯FactoryBeanï¼Œåˆ™è·å–å°†è¿”å›Factoryï¼Œè€Œä¸æ˜¯Factoryè¿”å›çš„å®ä¾‹ã€‚</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">FACTORY_BEAN_PREFIX</span> <span class="operator">=</span> <span class="string">"&amp;"</span>; </span><br><span class="line">        </span><br><span class="line">    <span class="comment">//æ ¹æ®beançš„åå­—å’ŒClassç±»å‹ç­‰æ¥å¾—åˆ°beanå®ä¾‹    </span></span><br><span class="line">    Object <span class="title function_">getBean</span><span class="params">(String name)</span> <span class="keyword">throws</span> BeansException;    </span><br><span class="line">    Object <span class="title function_">getBean</span><span class="params">(String name, Class requiredType)</span> <span class="keyword">throws</span> BeansException;    </span><br><span class="line">    Object <span class="title function_">getBean</span><span class="params">(String name, Object... args)</span> <span class="keyword">throws</span> BeansException;</span><br><span class="line">    &lt;T&gt; T <span class="title function_">getBean</span><span class="params">(Class&lt;T&gt; requiredType)</span> <span class="keyword">throws</span> BeansException;</span><br><span class="line">    &lt;T&gt; T <span class="title function_">getBean</span><span class="params">(Class&lt;T&gt; requiredType, Object... args)</span> <span class="keyword">throws</span> BeansException;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è¿”å›æŒ‡å®šbeançš„Provider</span></span><br><span class="line">    &lt;T&gt; ObjectProvider&lt;T&gt; <span class="title function_">getBeanProvider</span><span class="params">(Class&lt;T&gt; requiredType)</span>;</span><br><span class="line">    &lt;T&gt; ObjectProvider&lt;T&gt; <span class="title function_">getBeanProvider</span><span class="params">(ResolvableType requiredType)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//æ£€æŸ¥å·¥å‚ä¸­æ˜¯å¦åŒ…å«ç»™å®šnameçš„beanï¼Œæˆ–è€…å¤–éƒ¨æ³¨å†Œçš„bean</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">containsBean</span><span class="params">(String name)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//æ£€æŸ¥æ‰€ç»™å®šnameçš„beanæ˜¯å¦ä¸ºå•ä¾‹/åŸå‹</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">isSingleton</span><span class="params">(String name)</span> <span class="keyword">throws</span> NoSuchBeanDefinitionException;</span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">isPrototype</span><span class="params">(String name)</span> <span class="keyword">throws</span> NoSuchBeanDefinitionException;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//åˆ¤æ–­æ‰€ç»™nameçš„ç±»å‹ä¸typeæ˜¯å¦åŒ¹é…</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">isTypeMatch</span><span class="params">(String name, ResolvableType typeToMatch)</span> <span class="keyword">throws</span> NoSuchBeanDefinitionException;</span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">isTypeMatch</span><span class="params">(String name, Class&lt;?&gt; typeToMatch)</span> <span class="keyword">throws</span> NoSuchBeanDefinitionException;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è·å–ç»™å®šnameçš„beançš„ç±»å‹</span></span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    Class&lt;?&gt; getType(String name) <span class="keyword">throws</span> NoSuchBeanDefinitionException;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è¿”å›ç»™å®šnameçš„beançš„åˆ«å</span></span><br><span class="line">    String[] getAliases(String name);</span><br><span class="line">     </span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>BeanFactory æœ‰ä¸‰ä¸ªå­ç±»ï¼š<code>ListableBeanFactory</code>ã€<code>HierarchicalBeanFactory</code> å’Œ<code>AutowireCapableBeanFactory</code>ã€‚</p>
<ul>
<li>**<code>ListableBeanFactory</code>**ï¼šè¯¥æ¥å£å®šä¹‰äº†è®¿é—®å®¹å™¨ä¸­ Bean åŸºæœ¬ä¿¡æ¯çš„è‹¥å¹²æ–¹æ³•ï¼Œå¦‚æŸ¥çœ‹ Bean çš„ä¸ªæ•°ã€è·å–æŸä¸€ç±»å‹ Bean çš„é…ç½®åã€æŸ¥çœ‹å®¹å™¨ä¸­æ˜¯å¦åŒ…æ‹¬æŸä¸€ Bean ç­‰æ–¹æ³•ï¼›</li>
<li>**<code>HierarchicalBeanFactory</code>**ï¼šçˆ¶å­çº§è” IoC å®¹å™¨çš„æ¥å£ï¼Œå­å®¹å™¨å¯ä»¥é€šè¿‡æ¥å£æ–¹æ³•è®¿é—®çˆ¶å®¹å™¨ï¼› é€šè¿‡ HierarchicalBeanFactory æ¥å£ï¼Œ Spring çš„ IoC å®¹å™¨å¯ä»¥å»ºç«‹çˆ¶å­å±‚çº§å…³è”çš„å®¹å™¨ä½“ç³»ï¼Œå­å®¹å™¨å¯ä»¥è®¿é—®çˆ¶å®¹å™¨ä¸­çš„ Beanï¼Œä½†çˆ¶å®¹å™¨ä¸èƒ½è®¿é—®å­å®¹å™¨çš„ Beanã€‚Spring ä½¿ç”¨çˆ¶å­å®¹å™¨å®ç°äº†å¾ˆå¤šåŠŸèƒ½ï¼Œæ¯”å¦‚åœ¨ Spring MVC ä¸­ï¼Œå±•ç°å±‚ Bean ä½äºä¸€ä¸ªå­å®¹å™¨ä¸­ï¼Œè€Œä¸šåŠ¡å±‚å’ŒæŒä¹…å±‚çš„ Bean ä½äºçˆ¶å®¹å™¨ä¸­ã€‚è¿™æ ·ï¼Œå±•ç°å±‚ Bean å°±å¯ä»¥å¼•ç”¨ä¸šåŠ¡å±‚å’ŒæŒä¹…å±‚çš„ Beanï¼Œè€Œä¸šåŠ¡å±‚å’ŒæŒä¹…å±‚çš„ Bean åˆ™çœ‹ä¸åˆ°å±•ç°å±‚çš„ Beanã€‚</li>
<li>**<code>ConfigurableBeanFactory</code>**ï¼šæ˜¯ä¸€ä¸ªé‡è¦çš„æ¥å£ï¼Œå¢å¼ºäº† IoC å®¹å™¨çš„å¯å®šåˆ¶æ€§ï¼Œå®ƒå®šä¹‰äº†è®¾ç½®ç±»è£…è½½å™¨ã€å±æ€§ç¼–è¾‘å™¨ã€å®¹å™¨åˆå§‹åŒ–åç½®å¤„ç†å™¨ç­‰æ–¹æ³•ï¼›</li>
<li><strong><code>ConfigurableListableBeanFactory</code></strong>: ListableBeanFactory å’Œ ConfigurableBeanFactory çš„èåˆï¼›</li>
<li>**<code>AutowireCapableBeanFactory</code>**ï¼šå®šä¹‰äº†å°†å®¹å™¨ä¸­çš„ Bean æŒ‰æŸç§è§„åˆ™ï¼ˆå¦‚æŒ‰åå­—åŒ¹é…ã€æŒ‰ç±»å‹åŒ¹é…ç­‰ï¼‰è¿›è¡Œè‡ªåŠ¨è£…é…çš„æ–¹æ³•</li>
</ul>
<h2 id="BeanRegistry"><a href="#BeanRegistry" class="headerlink" title="BeanRegistry"></a>BeanRegistry</h2><p> BeanDefinitionRegistry æ¥å£æä¾›äº†å‘å®¹å™¨æ‰‹å·¥æ³¨å†Œ BeanDefinition å¯¹è±¡çš„æ–¹æ³•</p>
<h2 id="BeanDefinition"><a href="#BeanDefinition" class="headerlink" title="BeanDefinition"></a>BeanDefinition</h2><p>Bean å¯¹è±¡å­˜åœ¨ä¾èµ–åµŒå¥—ç­‰å…³ç³»ï¼Œæ‰€ä»¥è®¾è®¡è€…è®¾è®¡äº† BeanDefinitionï¼Œå®ƒç”¨æ¥å¯¹ Bean å¯¹è±¡åŠå…³ç³»å®šä¹‰ï¼›æˆ‘ä»¬åœ¨ç†è§£æ—¶åªéœ€è¦æŠ“ä½å¦‚ä¸‹ä¸‰ä¸ªè¦ç‚¹ï¼š</p>
<ul>
<li><code>BeanDefinition</code> å®šä¹‰äº†å„ç§ Bean å¯¹è±¡åŠå…¶ç›¸äº’çš„å…³ç³»</li>
<li><code>BeanDefinitionReader</code> è¿™æ˜¯ BeanDefinition çš„è§£æå™¨</li>
<li><code>BeanDefinitionHolder</code> è¿™æ˜¯ BeanDefination çš„åŒ…è£…ç±»ï¼Œç”¨æ¥å­˜å‚¨ BeanDefinitionï¼Œname ä»¥åŠ aliases ç­‰ã€‚</li>
</ul>
<p><img src="/../images/Spring-IoC%E4%B9%8B%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84/image_bZorDDTlue.png"></p>
<h2 id="ApplicationContext"><a href="#ApplicationContext" class="headerlink" title="ApplicationContext"></a>ApplicationContext</h2><p>ApplicationContextæ˜¯IoCå®¹å™¨çš„æ¥å£ï¼Œé™¤äº†ç»§æ‰¿äº†BeanFactoryçš„èƒ½åŠ›ï¼Œè¿˜æ‹“å±•äº†é…ç½®èµ„æºçš„åŠ è½½ã€åº”ç”¨äº‹ä»¶ã€å›½é™…åŒ–ç­‰åŠŸèƒ½</p>
<p><img src="/../images/Spring-IoC%E4%B9%8B%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84/image_LT5sne3EVd.png"></p>
<ul>
<li><strong>ApplicationEventPublisher</strong>ï¼šè®©å®¹å™¨æ‹¥æœ‰å‘å¸ƒåº”ç”¨ä¸Šä¸‹æ–‡äº‹ä»¶çš„åŠŸèƒ½ï¼ŒåŒ…æ‹¬å®¹å™¨å¯åŠ¨äº‹ä»¶ã€å…³é—­äº‹ä»¶ç­‰ã€‚</li>
<li><strong>MessageSource</strong>ï¼šä¸ºåº”ç”¨æä¾› i18n å›½é™…åŒ–æ¶ˆæ¯è®¿é—®çš„åŠŸèƒ½ï¼›</li>
<li><strong>ResourcePatternResolver</strong> ï¼šèµ„æºæ¨¡å¼è§£ææ¥å£ï¼Œå¯ä»¥é€šè¿‡å¸¦å‰ç¼€çš„ Ant é£æ ¼çš„èµ„æºæ–‡ä»¶è·¯å¾„è£…è½½ Spring çš„é…ç½®æ–‡ä»¶ã€‚</li>
<li><strong>LifeCycle</strong>ï¼šæä¾›äº† <code>start()</code> å’Œ <code>stop()</code> ä¸¤ä¸ªæ–¹æ³•ï¼Œä¸»è¦ç”¨äºæ§åˆ¶å¼‚æ­¥å¤„ç†è¿‡ç¨‹ã€‚åœ¨å…·ä½“ä½¿ç”¨æ—¶ï¼Œè¯¥æ¥å£åŒæ—¶è¢« ApplicationContext å®ç°åŠå…·ä½“ Bean å®ç°ï¼Œ ApplicationContext ä¼šå°† start/stop çš„ä¿¡æ¯ä¼ é€’ç»™å®¹å™¨ä¸­æ‰€æœ‰å®ç°äº†è¯¥æ¥å£çš„ Beanï¼Œä»¥è¾¾åˆ°ç®¡ç†å’Œæ§åˆ¶ JMXã€ä»»åŠ¡è°ƒåº¦ç­‰ç›®çš„ã€‚</li>
</ul>
<h3 id="ApplicationContextä½“ç³»"><a href="#ApplicationContextä½“ç³»" class="headerlink" title="ApplicationContextä½“ç³»"></a>ApplicationContextä½“ç³»</h3><p><img src="/../images/Spring-IoC%E4%B9%8B%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84/image_-3W-afYUAj.png"></p>
<blockquote>
<p>ä¸ºä»€ä¹ˆè®¾è®¡è¿™ä¹ˆå¤šApplicationContextï¼Ÿ</p>
<p><strong>ç¬¬ä¸€ï¼Œä»ç±»ç»“æ„è®¾è®¡ä¸Šçœ‹ï¼Œ å›´ç»•ç€æ˜¯å¦éœ€è¦ Refresh å®¹å™¨è¡ç”Ÿå‡ºä¸¤ä¸ªæŠ½è±¡ç±»</strong>ï¼š</p>
<ul>
<li><code>GenericApplicationContext</code>ï¼š æ˜¯åˆå§‹åŒ–çš„æ—¶å€™å°±åˆ›å»ºå®¹å™¨ï¼Œå¾€åçš„æ¯æ¬¡ refresh éƒ½ä¸ä¼šæ›´æ”¹</li>
<li><code>AbstractRefreshableApplicationContext</code>ï¼š <code>AbstractRefreshableApplicationContext</code> åŠå­ç±»çš„æ¯æ¬¡ refresh éƒ½æ˜¯å…ˆæ¸…é™¤å·²æœ‰ (å¦‚æœä¸å­˜åœ¨å°±åˆ›å»º) çš„å®¹å™¨ï¼Œç„¶åå†é‡æ–°åˆ›å»ºï¼Œå› æ­¤æ— æ³•åšåˆ°åƒ <code>GenericApplicationContext</code> <strong>æ··åˆæ­é…ä»ä¸åŒæºå¤´è·å– bean çš„å®šä¹‰ä¿¡æ¯</strong></li>
</ul>
<p><strong>ç¬¬äºŒï¼Œ ä»åŠ è½½çš„æºæ¥çœ‹ï¼ˆæ¯”å¦‚ xml,groovy,annotation ç­‰ï¼‰ï¼Œ è¡ç”Ÿå‡ºä¼—å¤šç±»å‹çš„ ApplicationContext, å…¸å‹æ¯”å¦‚</strong>:</p>
<ul>
<li><code>FileSystemXmlApplicationContext</code>ï¼š ä»æ–‡ä»¶ç³»ç»Ÿä¸‹çš„ä¸€ä¸ªæˆ–å¤šä¸ª xml é…ç½®æ–‡ä»¶ä¸­åŠ è½½ä¸Šä¸‹æ–‡å®šä¹‰ï¼Œä¹Ÿå°±æ˜¯è¯´ç³»ç»Ÿç›˜ç¬¦ä¸­åŠ è½½ xml é…ç½®æ–‡ä»¶ã€‚</li>
<li><code>ClassPathXmlApplicationContext</code>ï¼š ä»ç±»è·¯å¾„ä¸‹çš„ä¸€ä¸ªæˆ–å¤šä¸ª xml é…ç½®æ–‡ä»¶ä¸­åŠ è½½ä¸Šä¸‹æ–‡å®šä¹‰ï¼Œé€‚ç”¨äº xml é…ç½®çš„æ–¹å¼ã€‚</li>
<li><code>AnnotationConfigApplicationContext</code>ï¼š ä»ä¸€ä¸ªæˆ–å¤šä¸ªåŸºäº java çš„é…ç½®ç±»ä¸­åŠ è½½ä¸Šä¸‹æ–‡å®šä¹‰ï¼Œé€‚ç”¨äº java æ³¨è§£çš„æ–¹å¼ã€‚</li>
<li><code>ConfigurableApplicationContext</code>ï¼š æ‰©å±•äº ApplicationContextï¼Œå®ƒæ–°å¢åŠ äº†ä¸¤ä¸ªä¸»è¦çš„æ–¹æ³•ï¼š <code>refresh()</code> å’Œ <code>close()</code>ï¼Œè®© ApplicationContext å…·æœ‰å¯åŠ¨ã€åˆ·æ–°å’Œå…³é—­åº”ç”¨ä¸Šä¸‹æ–‡çš„èƒ½åŠ›ã€‚åœ¨åº”ç”¨ä¸Šä¸‹æ–‡å…³é—­çš„æƒ…å†µä¸‹è°ƒç”¨ <code>refresh()</code> å³å¯å¯åŠ¨åº”ç”¨ä¸Šä¸‹æ–‡ï¼Œåœ¨å·²ç»å¯åŠ¨çš„çŠ¶æ€ä¸‹ï¼Œè°ƒç”¨ <code>refresh()</code> åˆ™æ¸…é™¤ç¼“å­˜å¹¶é‡æ–°è£…è½½é…ç½®ä¿¡æ¯ï¼Œè€Œè°ƒç”¨ <code>close()</code> åˆ™å¯å…³é—­åº”ç”¨ä¸Šä¸‹æ–‡ã€‚</li>
</ul>
<p><strong>ç¬¬ä¸‰ï¼Œ æ›´è¿›ä¸€æ­¥ç†è§£</strong>ï¼š</p>
<p>***è®¾è®¡è€…åœ¨è®¾è®¡æ—¶ <code>AnnotationConfigApplicationContext</code> ä¸ºä»€ä¹ˆæ˜¯ç»§æ‰¿ <code>GenericApplicationContext</code>***ï¼Ÿ å› ä¸ºåŸºäºæ³¨è§£çš„é…ç½®ï¼Œæ˜¯ä¸å¤ªä¼šè¢«è¿è¡Œæ—¶ä¿®æ”¹çš„ï¼Œè¿™æ„å‘³ç€ä¸éœ€è¦è¿›è¡ŒåŠ¨æ€ Bean é…ç½®å’Œåˆ·æ–°å®¹å™¨ï¼Œæ‰€ä»¥åªéœ€è¦ <code>GenericApplicationContext</code>ã€‚</p>
<p>è€ŒåŸºäº XML è¿™ç§é…ç½®æ–‡ä»¶ï¼Œè¿™ç§æ–‡ä»¶æ˜¯å®¹æ˜“ä¿®æ”¹çš„ï¼Œéœ€è¦åŠ¨æ€æ€§åˆ·æ–° Bean çš„æ”¯æŒï¼Œæ‰€ä»¥ XML ç›¸å…³çš„é…ç½®å¿…ç„¶ç»§æ‰¿ <code>AbstractRefreshableApplicationContext</code>ï¼› ä¸”å­˜åœ¨å¤šç§ xml çš„åŠ è½½æ–¹å¼ï¼ˆä½ç½®ä¸åŒçš„è®¾è®¡ï¼‰ï¼Œæ‰€ä»¥å¿…ç„¶ä¼šè®¾è®¡å‡º <code>AbstractXmlApplicationContext</code>, å…¶ä¸­åŒ…å«å¯¹ XML é…ç½®è§£ææˆ BeanDefination çš„è¿‡ç¨‹ã€‚</p>
<p>é‚£ä¹ˆç»†å¿ƒçš„ä½ ä»ä¸Šå›¾å¯ä»¥***å‘ç° <code>AnnotationWebConfigApplicationContext</code> å´æ˜¯ç»§æ‰¿äº† <code>AbstractRefreshableApplicationContext</code> è€Œä¸æ˜¯ <code>GenericApplicationContext</code>***ï¼Ÿ å› ä¸ºç”¨æˆ·å¯ä»¥é€šè¿‡ ApplicationContextInitializer æ¥è®¾ç½® contextInitializerClassesï¼ˆcontext-param / init-paramï¼‰ï¼Œ åœ¨è¿™ç§æƒ…å†µä¸‹ç”¨æˆ·å€¾å‘äºåˆ·æ–° Bean çš„ï¼Œæ‰€ä»¥è®¾è®¡è€…é€‰æ‹©è®© <code>AnnotationWebConfigApplicationContext</code> ç»§æ‰¿äº† <code>AbstractRefreshableApplicationContext</code>ã€‚</p>
</blockquote>
<p>è¿™ä¸€æ®µè§£é‡Šå°ç¥ï¼Œæˆ‘ç›´æ¥å¤åˆ¶ç²˜è´´ğŸ˜†</p>
<p>å‚è€ƒï¼š</p>
<ul>
<li><a href="https://pdai.tech/md/spring/spring-x-framework-ioc-source-1.html" title="https://pdai.tech/md/spring/spring-x-framework-ioc-source-1.html">https://pdai.tech/md/spring/spring-x-framework-ioc-source-1.html</a></li>
</ul>
]]></content>
      <categories>
        <category>Springæºç ç³»åˆ—</category>
      </categories>
      <tags>
        <tag>IoC</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringBootå®ç°GitHubç¬¬ä¸‰æ–¹ç™»å½•</title>
    <url>/2023/05/14/SpringBoot%E5%AE%9E%E7%8E%B0GitHub%E7%AC%AC%E4%B8%89%E6%96%B9%E7%99%BB%E5%BD%95/</url>
    <content><![CDATA[<h2 id="Githubç™»å½•åŸç†"><a href="#Githubç™»å½•åŸç†" class="headerlink" title="Githubç™»å½•åŸç†"></a>Githubç™»å½•åŸç†</h2><p>Githubç™»å½•çš„åŸç†æ˜¯å€ŸåŠ©OAuth 2.0åè®®æ¥å®ç°ï¼Œå…·ä½“çš„æµç¨‹æ˜¯ï¼šé¦–å…ˆç”¨æˆ·è¢«é‡å®šå‘åˆ°GitHubçš„æˆæƒé¡µé¢ï¼Œè¯æ˜è‡ªå·±çš„èº«ä»½å¹¶åŒæ„æˆæƒåè·å–ä¸€ä¸ªæˆæƒç ï¼Œç„¶åå®¢æˆ·ç«¯æ‹¿ç€æˆæƒç è¯·æ±‚æˆæƒæœåŠ¡å™¨è·å¾—ä¸€ä¸ªAccess Token</p>
<p>ä¹‹åå®¢æˆ·ç«¯å°±å¯ä»¥é€šè¿‡Access Tokenæ¥ä¸èµ„æºæœåŠ¡å™¨è¿›è¡Œäº¤äº’ï¼Œè¿™ä¸ªtokenæ˜¯é•¿æœŸæœ‰æ•ˆçš„ï¼Œä¹Ÿå¯ä»¥æœåŠ¡ç«¯è‡ªè¡Œç•™å­˜ã€‚æœåŠ¡ç«¯æ‹¿ç€è¿™ä¸ªtokenå°±å¯ä»¥è¯·æ±‚GitHubå¹¶è·å¾—ç”¨æˆ·ä¿¡æ¯</p>
<p><img src="/../images/SpringBoot%E5%AE%9E%E7%8E%B0GitHub%E7%AC%AC%E4%B8%89%E6%96%B9%E7%99%BB%E5%BD%95/image_u3kxu-6By6.png"></p>
<p>æˆ‘ä»¬å¸¸è§çš„å•ç‚¹ç™»å½•å¹³å°ï¼Œå¦‚Casdoorã€logtoç­‰ç­‰ï¼Œä»–ä»¬ä¼šåœ¨ä¿å­˜æˆæƒåè·å¾—çš„Access Tokenï¼Œå¹¶ä½œä¸ºæˆæƒæœåŠ¡å™¨æä¾›æœåŠ¡ã€‚åˆ©ç”¨è¿™äº›å¹³å°æˆ‘ä»¬èƒ½æ›´æ–¹ä¾¿çš„ç®¡ç†è´¦å·ç³»ç»Ÿï¼Œä¸ç”¨å†å»å¯¹ä¸åŒçš„ç¬¬ä¸‰æ–¹å¹³å°åšä¸åŒçš„æˆæƒå®</p>
<span id="more"></span>

<p><img src="/../images/SpringBoot%E5%AE%9E%E7%8E%B0GitHub%E7%AC%AC%E4%B8%89%E6%96%B9%E7%99%BB%E5%BD%95/2760332-20220412195835959-694117279_q0bggeLtdi.gif"></p>
<h1 id="SpringBootå®ç°GitHubç™»å½•"><a href="#SpringBootå®ç°GitHubç™»å½•" class="headerlink" title="SpringBootå®ç°GitHubç™»å½•"></a>SpringBootå®ç°GitHubç™»å½•</h1><p>é¦–å…ˆï¼Œä½ éœ€è¦åœ¨GitHubä¸Šåˆ›å»ºä¸€ä¸ª<a href="https://github.com/settings/applications/new" title="Application">Application</a>ï¼Œå°†æˆ‘ä»¬çš„åº”ç”¨æ³¨å†Œåˆ°GitHub</p>
<p><img src="/../images/SpringBoot%E5%AE%9E%E7%8E%B0GitHub%E7%AC%AC%E4%B8%89%E6%96%B9%E7%99%BB%E5%BD%95/image_FUKgEjhTXM.png"></p>
<p>æ³¨æ„è¿™ä¸ªå›è°ƒåœ°å€ï¼Œå®ƒæ˜¯ç”¨æˆ·æˆæƒåGitHubé‡å®šå‘ç”¨æˆ·çš„åœ°å€</p>
<p>æ³¨å†Œå®Œæˆåï¼Œå°†<code>client_id</code>å’Œ<code>client_secret</code>é…ç½®åˆ°SpringBootåº”ç”¨ä¸­ï¼š</p>
<p><img src="/../images/SpringBoot%E5%AE%9E%E7%8E%B0GitHub%E7%AC%AC%E4%B8%89%E6%96%B9%E7%99%BB%E5%BD%95/image_qoOfOfER8X.png"></p>
<p>ä¸‹é¢æ˜¯Demoï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(path = "oauth")</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OAuthController</span> {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value("${github.client.id}")</span></span><br><span class="line">    <span class="keyword">private</span> String clientId;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Value("${github.client.secret}")</span></span><br><span class="line">    <span class="keyword">private</span> String clientSecret;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è·³è½¬åˆ°æˆæƒé¡µé¢</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> response</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(path = "github")</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">auth</span><span class="params">(HttpServletResponse response)</span> <span class="keyword">throws</span> IOException {</span><br><span class="line">        <span class="type">String</span> <span class="variable">authorizeUri</span> <span class="operator">=</span> <span class="string">"https://github.com/login/oauth/authorize"</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">redirectUri</span> <span class="operator">=</span> <span class="string">"http://localhost:8080/oauth/redirect"</span>;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> authorizeUri </span><br><span class="line">                + <span class="string">"?client_id="</span> + githubClientProperties.getClientId()</span><br><span class="line">                + <span class="string">"&amp;redirect_uri="</span> + redirectUri;</span><br><span class="line">        response.sendRedirect(url);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Githubå›è°ƒæ¥å£</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> requestToken æˆæƒç </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(path = "redirect")</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">handleRedirect</span><span class="params">(<span class="meta">@RequestParam("code")</span> String requestToken, HttpServletResponse response)</span> {</span><br><span class="line">        <span class="type">RestTemplate</span> <span class="variable">restTemplate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RestTemplate</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è·å–Token</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">tokenUrl</span> <span class="operator">=</span> <span class="string">"https://github.com/login/oauth/access_token"</span></span><br><span class="line">                + <span class="string">"?client_id="</span> + githubClientProperties.getClientId()</span><br><span class="line">                + <span class="string">"&amp;client_secret="</span> + githubClientProperties.getClientSecret()</span><br><span class="line">                + <span class="string">"&amp;code="</span> + requestToken;</span><br><span class="line"></span><br><span class="line">        <span class="type">AccessTokenResponse</span> <span class="variable">tokenResponse</span> <span class="operator">=</span> restTemplate.postForObject(tokenUrl, <span class="literal">null</span>, AccessTokenResponse.class);</span><br><span class="line">        <span class="type">String</span> <span class="variable">accessToken</span> <span class="operator">=</span> tokenResponse.getAccessToken();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è·å–ç”¨æˆ·ä¿¡æ¯</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">apiUrl</span> <span class="operator">=</span> <span class="string">"https://api.github.com/user"</span>;</span><br><span class="line">        <span class="type">HttpHeaders</span> <span class="variable">headers</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpHeaders</span>();</span><br><span class="line">        headers.set(<span class="string">"Authorization"</span>, <span class="string">"Bearer "</span> + accessToken);</span><br><span class="line">        HttpEntity&lt;String&gt; entity = <span class="keyword">new</span> <span class="title class_">HttpEntity</span>&lt;&gt;(<span class="string">"parameters"</span>, headers);</span><br><span class="line">        ResponseEntity&lt;String&gt; resp = restTemplate.exchange(apiUrl, HttpMethod.GET, entity, String.class);</span><br><span class="line">        <span class="type">String</span> <span class="variable">userData</span> <span class="operator">=</span> resp.getBody();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å°†tokenè¿”å›ç»™å®¢æˆ·ç«¯</span></span><br><span class="line">        <span class="type">Cookie</span> <span class="variable">githubToken</span> <span class="operator">=</span> newCookie(<span class="string">"github_token"</span>, accessToken, <span class="string">"/"</span>, COOKIE_AGE);</span><br><span class="line">        response.addCookie(githubToken);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ResVo.ok(userData);</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Cookie <span class="title function_">newCookie</span><span class="params">(String key, String session, String path, <span class="type">int</span> maxAge)</span> {</span><br><span class="line">        <span class="type">Cookie</span> <span class="variable">cookie</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Cookie</span>(key, session);</span><br><span class="line">        cookie.setPath(path);</span><br><span class="line">        cookie.setMaxAge(maxAge);</span><br><span class="line">        <span class="keyword">return</span> cookie;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<hr>
<p>ç›¸å…³æ–‡æ¡£ï¼š</p>
<ul>
<li><a href="https://docs.github.com/zh/apps/oauth-apps/building-oauth-apps/authorizing-oauth-apps#web-application-flow" title="https://docs.github.com/zh/apps/oauth-apps/building-oauth-apps/authorizing-oauth-apps#web-application-flow">https://docs.github.com/zh/apps/oauth-apps/building-oauth-apps/authorizing-oauth-apps#web-application-flow</a></li>
<li><a href="https://casdoor.org/docs/overview" title="https://casdoor.org/docs/overview">https://casdoor.org/docs/overview</a></li>
</ul>
]]></content>
      <categories>
        <category>æŠ€æœ¯æ–¹æ¡ˆ</category>
      </categories>
      <tags>
        <tag>oauth</tag>
      </tags>
  </entry>
  <entry>
    <title>Spring Environmentä½“ç³»</title>
    <url>/2024/06/21/Spring%20Environment%E4%BD%93%E7%B3%BB/</url>
    <content><![CDATA[<h2 id="æ¦‚è¦"><a href="#æ¦‚è¦" class="headerlink" title="æ¦‚è¦"></a>æ¦‚è¦</h2><ul>
<li><code>PropertySource</code>ï¼šç®¡ç†å„ç§é…ç½®æºçš„æŠ½è±¡ç±»ï¼Œå³å±æ€§æº</li>
<li><code>PropertySources</code>ï¼šç”¨äºç»Ÿä¸€ç®¡ç†å’Œè®¿é—®å¤šä¸ª PropertySource å®ä¾‹</li>
<li><code>PropertyResolver</code>ï¼šé€šç”¨å±æ€§è§£æ<ul>
<li><code>Environment</code>ï¼šåº”ç”¨ç¯å¢ƒè¡¨ç¤ºï¼Œæä¾›å±æ€§è®¿é—®ï¼Œæ”¯æŒprofileã€‚</li>
<li><code>ConfigurablePropertyResolver</code>ï¼šå±æ€§è§£æé…ç½®ï¼Œæ”¯æŒå ä½ç¬¦è§£æã€‚</li>
</ul>
</li>
<li><code>Binder</code>ï¼šé…ç½®ç»‘å®šå·¥å…·</li>
</ul>
<p>å¤§è‡´å…³ç³»å›¾ï¼š</p>
<p><img src="/../images/Spring-Environment%E4%BD%93%E7%B3%BB/image_98WWM6BQwA.png"></p>
<span id="more"></span>

<blockquote>
<p>å›¾ç‰‡æ¥è‡ª<a href="https://www.apolloconfig.com/#/zh/design/apollo-design?id=_31-%E5%92%8Cspring%E9%9B%86%E6%88%90%E7%9A%84%E5%8E%9F%E7%90%86" title="https://www.apolloconfig.com/#/zh/design/apollo-design?id=_31-å’Œspringé›†æˆçš„åŸç†">https://www.apolloconfig.com/#/zh/design/apollo-design?id=_31-å’Œspringé›†æˆçš„åŸç†</a></p>
</blockquote>
<h2 id="PropertySource"><a href="#PropertySource" class="headerlink" title="PropertySource"></a>PropertySource</h2><p><img src="/../images/Spring-Environment%E4%BD%93%E7%B3%BB/image_eZgD5dC_Ym.png"></p>
<p>PropertySourceæ˜¯ Spring æ¡†æ¶ä¸­çš„ä¸€ä¸ªå…³é”®æŠ½è±¡ç±»ï¼Œå°è£…äº†ä¸€ä¸ªå±æ€§æºï¼Œå±æ€§æºå¯ä»¥æ˜¯ä¸€ä¸ª<code>Map</code>ã€<code>Resource</code>å¯¹è±¡ã€ç³»ç»Ÿå˜é‡ç­‰ç­‰</p>
<h2 id="PropertySources"><a href="#PropertySources" class="headerlink" title="PropertySources"></a>PropertySources</h2><p><code>PropertySources</code> æ˜¯ä¸€ä¸ªSpringæ¡†æ¶ä¸­çš„æ¥å£ï¼Œç”¨äºè¡¨ç¤ºå’Œç®¡ç†ä¸€ç»„å±æ€§æºï¼ˆ<code>PropertySource</code>ï¼‰ï¼Œè¿™äº›å±æ€§æºåŒ…å«äº†åº”ç”¨ç¨‹åºç¯å¢ƒä¸­çš„é…ç½®æ•°æ®ã€‚è¯¥æ¥å£æä¾›äº†ä¸€ç³»åˆ—æ–¹æ³•æ¥æ£€ç´¢ã€æ·»åŠ ã€æ›¿æ¢å’Œåˆ é™¤è¿™äº›å±æ€§æºï¼Œå…è®¸å¼€å‘è€…ä»¥ç»Ÿä¸€çš„æ–¹å¼è®¿é—®ä¸åŒæ¥æºçš„é…ç½®ä¿¡æ¯ï¼Œå¦‚ç¯å¢ƒå˜é‡ã€ç³»ç»Ÿå±æ€§ã€é…ç½®æ–‡ä»¶ç­‰ã€‚</p>
<h2 id="PropertyResolver"><a href="#PropertyResolver" class="headerlink" title="PropertyResolver"></a>PropertyResolver</h2><p><code>PropertyResolver</code>æ˜¯ä¸€ä¸ªé¡¶å±‚æ¥å£ï¼Œæä¾›äº†ä¸€å¥—çµæ´»ä¸”å¼ºå¤§çš„æœºåˆ¶æ¥å¤„ç†åº”ç”¨ç¨‹åºé…ç½®å±æ€§ã€‚å®ƒå®šä¹‰äº†ä¸€äº›è·å–å±æ€§å€¼ï¼Œä»¥åŠè§£æå ä½ç¬¦çš„æ–¹æ³•ï¼Œç”¨äºè®¿é—®å’Œæ“çºµæ¥è‡ªå„ç§æºçš„å±æ€§å€¼ã€‚</p>
<p><img src="/../images/Spring-Environment%E4%BD%93%E7%B3%BB/image_TL0vgbMjbo.png"></p>
<h3 id="Environment"><a href="#Environment" class="headerlink" title="Environment"></a>Environment</h3><p><code>Environment</code> æ¥å£æ˜¯ Spring æ¡†æ¶ä¸­çš„ä¸€ä¸ªæ ¸å¿ƒéƒ¨åˆ†ï¼Œå®ƒæä¾›äº†ä¸€ä¸ªç»Ÿä¸€çš„æ–¹å¼æ¥è®¿é—®å„ç§å¤–éƒ¨åŒ–çš„é…ç½®æ•°æ®ï¼ˆç»§æ‰¿è‡ª<code>PropertyResolver</code>ï¼‰ï¼›æ”¯æŒé…ç½®æ–‡ä»¶ï¼ˆProfilesï¼‰çš„æ¦‚å¿µï¼Œå¯ä»¥åœ¨ä¸åŒç¯å¢ƒä¸‹è¿›è¡Œæ¡ä»¶æ€§çš„é…ç½®ï¼Œç®¡ç†å¤šä¸ªå±æ€§æºã€‚</p>
<p>å¯ä»¥çœ‹åˆ°<code>Environment</code>æ˜¯ç»§æ‰¿äº†<code>PropertyResolver</code>æ¥å£çš„ï¼Œ<strong>åªæ˜¯å¢åŠ äº†ä¸€äº›ç¯å¢ƒä¿¡æ¯æ–¹æ³•(profile)</strong></p>
<p>å…¶ä¸­<code>Environment</code>å®ä¾‹å…³äº<code>PropertyResolver</code>æ¥å£çš„æ–¹æ³•æ˜¯é€šè¿‡ç»„åˆæ¨¡å¼å®ç°çš„ï¼Œå†…éƒ¨æŒæœ‰ä¸€ä¸ª<code>PropertySourcesPropertyResolver</code>å®ä¾‹ã€‚</p>
<h3 id="ConfigurablePropertyResolver"><a href="#ConfigurablePropertyResolver" class="headerlink" title="ConfigurablePropertyResolver"></a>ConfigurablePropertyResolver</h3><p><code>ConfigurablePropertyResolver</code> æ¥å£åˆ™å¢åŠ äº†ä¸€äº›é…ç½®æ–¹æ³•ï¼Œåœ¨Springä¸­å…³é”®ä½œç”¨æ˜¯æä¾›çµæ´»çš„é…ç½®å±æ€§è§£æã€‚å®ƒæ”¯æŒ<strong>å ä½ç¬¦è§£æ</strong>ï¼Œå¹¶è§£æè¿™äº›å ä½ç¬¦ä¸ºå®é™…çš„é…ç½®å€¼ï¼Œæå‡é…ç½®çš„åŠ¨æ€æ€§å’Œçµæ´»æ€§ã€‚</p>
<h3 id="å…¶ä»–å®ç°"><a href="#å…¶ä»–å®ç°" class="headerlink" title="å…¶ä»–å®ç°"></a>å…¶ä»–å®ç°</h3><ul>
<li><code>ConfigurableEnvironment</code>ï¼Œå¢åŠ äº†ä¸€äº›é…ç½®çš„æ–¹æ³•ï¼Œä»¥åŠå¯ä»¥è·å–åˆ°å†…éƒ¨çš„<code>PropertySource</code>åˆ—è¡¨ã€‚</li>
<li><code>StandardEnvironment</code>ï¼Œéwebä¸Šä¸‹æ–‡ä½¿ç”¨çš„ç¯å¢ƒå®ä¾‹ã€‚</li>
<li><code>StandardServletEnvironment</code>ï¼Œwebä¸Šä¸‹æ–‡ä½¿ç”¨çš„ç¯å¢ƒå®ä¾‹ã€‚</li>
</ul>
<h2 id="å±æ€§ç»‘å®š"><a href="#å±æ€§ç»‘å®š" class="headerlink" title="å±æ€§ç»‘å®š"></a>å±æ€§ç»‘å®š</h2><h3 id="ConfigurationPropertySource"><a href="#ConfigurationPropertySource" class="headerlink" title="ConfigurationPropertySource"></a>ConfigurationPropertySource</h3><p>è¿™æ˜¯ä¸€ä¸ªæ–°çš„æ¥å£ï¼Œä¸è¿‡å®ƒçš„å®ç°ç±»ä¹Ÿæ˜¯å€ŸåŠ©äº†<code>PropertySource</code>æ¥å®ç°ï¼Œå°½ç®¡ä»–ä»¬ä¹‹é—´æ²¡æœ‰ä»»ä½•ç»§æ‰¿å…³ç³»ã€‚</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ConfigurationPropertySource</span> {</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ ¹æ®å±æ€§åè·å–å¯¹åº”çš„å€¼</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    ConfigurationProperty <span class="title function_">getConfigurationProperty</span><span class="params">(ConfigurationPropertyName name)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åˆ¤æ–­æ˜¯å¦åŒ…å«åä»£å±æ€§</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">default</span> ConfigurationPropertyState <span class="title function_">containsDescendantOf</span><span class="params">(ConfigurationPropertyName name)</span> {</span><br><span class="line">        <span class="keyword">return</span> ConfigurationPropertyState.UNKNOWN;</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ³¨å†Œåˆ«å</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">default</span> ConfigurationPropertySource <span class="title function_">withAliases</span><span class="params">(ConfigurationPropertyNameAliases aliases)</span> {</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">AliasedConfigurationPropertySource</span>(<span class="built_in">this</span>, aliases);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><code>ConfigurationPropertySources</code>æä¾›äº†ä»environmentä¸­è·å–å±æ€§æºæ„å»ºConfigurationPropertySourceçš„æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line">Iterable&lt;ConfigurationPropertySource&gt; sources = ConfigurationPropertySources.get(environment);</span><br></pre></td></tr></tbody></table></figure>

<h3 id="Binder"><a href="#Binder" class="headerlink" title="Binder"></a>Binder</h3><p>Springæä¾›äº†ä¸€ä¸ªå¾ˆå¼ºå¤§çš„å·¥å…·ç±»<code>Binder</code>ï¼Œä¾èµ–<code>ConfigurationPropertySource</code></p>
<p>ä½œç”¨ï¼š<em><strong>å¯ä»¥å°†<code>Environment</code>æˆ–è€…<code>ConfigurationPropertySource</code>ä¸­çš„å±æ€§ç»‘å®šåˆ°ä¸€ä¸ªJavaå¯¹è±¡ä¸­</strong></em>ï¼Œä¸”æ”¯æŒå ä½ç¬¦ï¼Œç±»å‹è½¬æ¢ï¼Œå®½æ¾ç»‘å®šã€‚</p>
<p>ä»–æœ‰ä¸¤ä¸ªé‡è¦æ–¹æ³•ï¼š<code>bind()</code>å’Œ<code>bindOrCreate()</code>ï¼Œä¸¤ä¸ªæ–¹æ³•æœ‰å¤šé‡é‡è½½æ–¹å¼ï¼Œè¿™é‡Œåˆ—ä¸¾äº†ä¸¤ç§</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Binder</span> {</span><br><span class="line">  <span class="comment">// Binder ç»´æŠ¤çš„å±æ€§æºï¼Œåœ¨æ„é€ Binderæ—¶æŒ‡å®š</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Iterable&lt;ConfigurationPropertySource&gt; sources;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// å°†PropertySourcesç»‘å®šåˆ°æŒ‡å®šçš„Bindable</span></span><br><span class="line">  <span class="keyword">public</span> &lt;T&gt; BindResult&lt;T&gt; <span class="title function_">bind</span><span class="params">(ConfigurationPropertyName name, Bindable&lt;T&gt; target, BindHandler handler)</span> {</span><br><span class="line">    <span class="type">T</span> <span class="variable">bound</span> <span class="operator">=</span> bind(name, target, handler, <span class="literal">false</span>);</span><br><span class="line">    <span class="keyword">return</span> BindResult.of(bound);</span><br><span class="line">  }</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// å°†PropertySourcesç»‘å®šåˆ°æŒ‡å®šçš„Bindableï¼Œæˆ–è€…å¦‚æœç»‘å®šçš„ç»“æœæ˜¯nullï¼Œåˆ™ä½¿ç”¨Bindableçš„ç±»å‹åˆ›å»ºæ–°å®ä¾‹</span></span><br><span class="line">  <span class="keyword">public</span> &lt;T&gt; T <span class="title function_">bindOrCreate</span><span class="params">(ConfigurationPropertyName name, Bindable&lt;T&gt; target, BindHandler handler)</span> {</span><br><span class="line">    <span class="keyword">return</span> bind(name, target, handler, <span class="literal">true</span>);</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<p><code>Binder</code>ç±»è¿˜æä¾›ä¸€ä¸ªé™æ€æ–¹æ³•<code>get()</code>æ¥æ„é€ <code>Binder</code>å®ä¾‹ï¼Œå¯ä»¥ä»<code>Environment</code>å®ä¾‹è·å–<code>PropertySources</code></p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Binder <span class="title function_">get</span><span class="params">(Environment environment)</span> {  </span><br><span class="line">    <span class="keyword">return</span> get(environment, <span class="literal">null</span>);  </span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Binder <span class="title function_">get</span><span class="params">(Environment environment, BindHandler defaultBindHandler)</span> {</span><br><span class="line">    Iterable&lt;ConfigurationPropertySource&gt; sources = ConfigurationPropertySources.get(environment);</span><br><span class="line">    <span class="type">PropertySourcesPlaceholdersResolver</span> <span class="variable">placeholdersResolver</span> <span class="operator">=</span> </span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">PropertySourcesPlaceholdersResolver</span>(environment);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Binder</span>(sources, placeholdersResolver, <span class="literal">null</span>, <span class="literal">null</span>, defaultBindHandler);</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<p>æˆ‘ä»¬é¡¹ç›®ä¸­å¸¸ç”¨äºé…ç½®æ³¨å…¥çš„<code>@ConfigurationProperties</code>ï¼Œå®ç°åŸç†ä¹Ÿæ˜¯é€šè¿‡Binder</p>
<h3 id="ConfigurationPropertieså®ç°åŸç†"><a href="#ConfigurationPropertieså®ç°åŸç†" class="headerlink" title="@ConfigurationPropertieså®ç°åŸç†"></a>@ConfigurationPropertieså®ç°åŸç†</h3><p><code>@ConfigurationProperties</code>æ³¨è§£åœ¨Spring Bootä¸­å¸¸ç”¨æ¥ç»‘å®šå±æ€§åˆ°Java Beanä¸­ï¼Œä¸éš¾çŒœå‡ºå†…éƒ¨åŸç†ä¾¿æ˜¯ä½¿ç”¨ä¸Šé¢æ‰€ä»‹ç»çš„<code>Binder</code>ç±»æ¥å®ç°çš„ã€‚</p>
<p>ä½¿ç”¨è¯¥æ³¨è§£æ—¶å¸¸å¸¸æ­é…<code>@EnableConfigurationProperties</code>æ³¨è§£ä¸€èµ·ä½¿ç”¨ï¼Œ<code>@EnableConfigurationProperties</code>çš„ä¸»è¦ä½œç”¨å°±æ˜¯æ³¨å†Œäº†ä¸€ä¸ª<code>ConfigurationPropertiesBindingPostProcessor</code>Bean</p>
<p>ç»‘å®šçš„æ ¸å¿ƒé€»è¾‘åœ¨<code>ConfigurationPropertiesBindingPostProcessor</code>ä¸­</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">postProcessBeforeInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException {</span><br><span class="line">  <span class="keyword">if</span> (!hasBoundValueObject(beanName)) {</span><br><span class="line">    bind(ConfigurationPropertiesBean.get(<span class="built_in">this</span>.applicationContext, bean, beanName));</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">return</span> bean;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">bind</span><span class="params">(ConfigurationPropertiesBean bean)</span> {</span><br><span class="line">  ...</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">try</span> {</span><br><span class="line">    <span class="built_in">this</span>.binder.bind(bean);</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">catch</span> (Exception ex) {</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ConfigurationPropertiesBindException</span>(bean, ex);</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line">BindResult&lt;?&gt; bind(ConfigurationPropertiesBean propertiesBean) {</span><br><span class="line">  Bindable&lt;?&gt; target = propertiesBean.asBindTarget();</span><br><span class="line">  <span class="type">ConfigurationProperties</span> <span class="variable">annotation</span> <span class="operator">=</span> propertiesBean.getAnnotation();</span><br><span class="line">  <span class="type">BindHandler</span> <span class="variable">bindHandler</span> <span class="operator">=</span> getBindHandler(target, annotation);</span><br><span class="line">  <span class="comment">// ç»‘å®šConfigurationPropertySourceä¸­çš„å±æ€§æºå’ŒConfigurationPropertiesBeanå¯¹è±¡</span></span><br><span class="line">  <span class="keyword">return</span> getBinder().bind(annotation.prefix(), target, bindHandler);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> Binder <span class="title function_">getBinder</span><span class="params">()</span> {</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">this</span>.binder == <span class="literal">null</span>) {</span><br><span class="line">    <span class="built_in">this</span>.binder = <span class="keyword">new</span> <span class="title class_">Binder</span>(getConfigurationPropertySources(), getPropertySourcesPlaceholdersResolver(),</span><br><span class="line">        getConversionServices(), getPropertyEditorInitializer(), <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">this</span>.binder;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä»æ³¨å…¥çš„å±æ€§æºæ„å»ºConfigurationPropertySource</span></span><br><span class="line"><span class="keyword">private</span> Iterable&lt;ConfigurationPropertySource&gt; <span class="title function_">getConfigurationPropertySources</span><span class="params">()</span> {</span><br><span class="line">  <span class="keyword">return</span> ConfigurationPropertySources.from(<span class="built_in">this</span>.propertySources);</span><br><span class="line">}</span><br><span class="line"><span class="comment">// ä»æ³¨å…¥çš„å±æ€§æºæ„å»ºPropertySourcesResolver, æ”¯æŒè§£æå ä½ç¬¦</span></span><br><span class="line"><span class="keyword">private</span> PropertySourcesPlaceholdersResolver <span class="title function_">getPropertySourcesPlaceholdersResolver</span><span class="params">()</span> {</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">PropertySourcesPlaceholdersResolver</span>(<span class="built_in">this</span>.propertySources);</span><br><span class="line">}</span><br><span class="line"><span class="comment">// ç±»å‹è½¬æ¢</span></span><br><span class="line"><span class="keyword">private</span> List&lt;ConversionService&gt; <span class="title function_">getConversionServices</span><span class="params">()</span> {</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ConversionServiceDeducer</span>(<span class="built_in">this</span>.applicationContext).getConversionServices();</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> Consumer&lt;PropertyEditorRegistry&gt; <span class="title function_">getPropertyEditorInitializer</span><span class="params">()</span> {</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">this</span>.applicationContext <span class="keyword">instanceof</span> ConfigurableApplicationContext configurableContext) {</span><br><span class="line">    <span class="keyword">return</span> configurableContext.getBeanFactory()::copyRegisteredEditorsTo;</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<p>å…³é”®ç‚¹åœ¨äºä½¿ç”¨Binderå°†<code>ConfigurationPropertySource</code>ä¸­çš„å±æ€§æºå’Œå®é™…çš„<code>ConfigurationPropertiesBean</code>å¯¹è±¡ç»‘å®šåœ¨äº†ä¸€èµ·ï¼Œå®ç°é…ç½®çš„æ³¨å…¥ã€‚æ³¨æ„<code>ConfigurationPropertySource</code>ä¸­çš„å±æ€§æºæ˜¯å¸¦æœ‰<code>prefix</code>çš„</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">PrefixedConfigurationPropertySource</span> <span class="keyword">implements</span> <span class="title class_">ConfigurationPropertySource</span> {</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> ConfigurationPropertySource source;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> ConfigurationPropertyName prefix;</span><br><span class="line"></span><br><span class="line">  PrefixedConfigurationPropertySource(ConfigurationPropertySource source, String prefix) {</span><br><span class="line">    Assert.notNull(source, <span class="string">"Source must not be null"</span>);</span><br><span class="line">    Assert.hasText(prefix, <span class="string">"Prefix must not be empty"</span>);</span><br><span class="line">    <span class="built_in">this</span>.source = source;</span><br><span class="line">    <span class="built_in">this</span>.prefix = ConfigurationPropertyName.of(prefix);</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<hr>
<p>å‚è€ƒï¼š</p>
<ul>
<li><a href="https://www.cnblogs.com/wt20/p/17588895.html" title="https://www.cnblogs.com/wt20/p/17588895.html">https://www.cnblogs.com/wt20/p/17588895.html</a></li>
<li><a href="https://spring.hhui.top/spring-blog/2023/06/18/230618-SpringBoot%E4%B9%8B%E7%BC%96%E7%A8%8B%E5%BC%8F%E5%B1%9E%E6%80%A7%E7%BB%91%E5%AE%9ABinder/" title="https://spring.hhui.top/spring-blog/2023/06/18/230618-SpringBootä¹‹ç¼–ç¨‹å¼å±æ€§ç»‘å®šBinder/">https://spring.hhui.top/spring-blog/2023/06/18/230618-SpringBootä¹‹ç¼–ç¨‹å¼å±æ€§ç»‘å®šBinder/</a></li>
</ul>
]]></content>
      <categories>
        <category>Springä½“ç³»ç»“æ„</category>
      </categories>
      <tags>
        <tag>Springæºç é˜…è¯»</tag>
      </tags>
  </entry>
  <entry>
    <title>âœğŸ» Springæºç é˜…è¯»è®°å½•</title>
    <url>/2024/03/31/Spring%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/</url>
    <content><![CDATA[<blockquote>
<p>æ ‡è®°çš„è¡¨ç¤ºå·²è¯»</p>
</blockquote>
<h1 id="Spring-Core"><a href="#Spring-Core" class="headerlink" title="Spring Core"></a>Spring Core</h1><h2 id="èµ„æºåŠ è½½ä¸è®¿é—®"><a href="#èµ„æºåŠ è½½ä¸è®¿é—®" class="headerlink" title="èµ„æºåŠ è½½ä¸è®¿é—®"></a>èµ„æºåŠ è½½ä¸è®¿é—®</h2><ul>
<li>Resourceï¼šæŠ½è±¡æ¥å£ï¼Œè¡¨ç¤ºæ–‡ä»¶ã€ç±»è·¯å¾„ç­‰ï¼Œç”¨äºè®¿é—®ä¸åŒæ¥æºçš„èµ„æºã€‚</li>
<li>ResourceLoaderï¼šèµ„æºè·å–æ ¸å¿ƒæ¥å£ï¼Œå®ç°ç»Ÿä¸€åŠ è½½ä¸åŒä½ç½®èµ„æºçš„ç­–ç•¥ã€‚</li>
<li>ResourcePatternResolverï¼šèµ„æºæ¨¡å¼è§£ææ¥å£ï¼Œç”¨äºçµæ´»åŠ è½½åº”ç”¨ä¸­çš„å¤šç§èµ„æºã€‚</li>
<li>DocumentLoaderï¼šXMLæ–‡æ¡£åŠ è½½è§£ææ ¸å¿ƒæ¥å£ï¼Œæ”¯æŒåå°è‡ªåŠ¨é…ç½®Springåº”ç”¨ã€‚</li>
</ul>
<span id="more"></span>

<h2 id="å…ƒæ•°æ®ä¸è¿‡æ»¤"><a href="#å…ƒæ•°æ®ä¸è¿‡æ»¤" class="headerlink" title="å…ƒæ•°æ®ä¸è¿‡æ»¤"></a>å…ƒæ•°æ®ä¸è¿‡æ»¤</h2><ul>
<li>MetadataReaderï¼šç±»å…ƒæ•°æ®è·å–æ ¸å¿ƒï¼Œæ”¯æŒç»„ä»¶æ‰«æã€æ¡ä»¶åŒ–æ³¨è§£ã€AOPç­‰é«˜çº§åŠŸèƒ½ã€‚</li>
<li>AnnotationMetadataï¼šåŠ¨æ€è·å–å’Œæ“ä½œè¿è¡Œæ—¶ç±»æ³¨è§£ä¿¡æ¯ã€‚</li>
<li>TypeFilterï¼šç»„ä»¶æ‰«ææ—¶è‡ªå®šä¹‰ç±»ç­›é€‰ï¼Œæ”¯æŒå¤æ‚æ¡ä»¶å’Œç²¾ç¡®è¿‡æ»¤ã€‚</li>
<li>Conditionï¼šæ¡ä»¶åˆ¤æ–­ï¼Œå†³å®šBeanåˆ›å»ºå’Œé…ç½®çš„çµæ´»æœºåˆ¶ã€‚</li>
</ul>
<h2 id="éªŒè¯ã€æ•°æ®ç»‘å®šå’Œç±»å‹è½¬æ¢"><a href="#éªŒè¯ã€æ•°æ®ç»‘å®šå’Œç±»å‹è½¬æ¢" class="headerlink" title="éªŒè¯ã€æ•°æ®ç»‘å®šå’Œç±»å‹è½¬æ¢"></a>éªŒè¯ã€æ•°æ®ç»‘å®šå’Œç±»å‹è½¬æ¢</h2><ul>
<li>Validatorï¼šæä¾›è‡ªå®šä¹‰æ•°æ®éªŒè¯é€»è¾‘ï¼Œç¡®ä¿æ¨¡å‹å¯¹è±¡æ»¡è¶³ä¸šåŠ¡è§„åˆ™ã€‚</li>
<li>PropertyEditorï¼šè‡ªå®šä¹‰JavaBeanå±æ€§çš„è½¬æ¢é€»è¾‘ï¼Œå¤„ç†å±æ€§ç±»å‹è½¬æ¢ã€‚</li>
<li>Converterï¼šç”¨äºä¸åŒç±»å‹é—´çš„è½¬æ¢ï¼Œå®šä¹‰ç®€å•çš„æºè‡³ç›®æ ‡ç±»å‹è½¬æ¢è§„åˆ™ã€‚</li>
<li>ConverterFactoryï¼šåˆ›å»ºé’ˆå¯¹ç‰¹å®šæºç±»å‹çš„è½¬æ¢å™¨ï¼Œç”¨äºç±»å‹è½¬æ¢ã€‚</li>
<li>GenericConverterï¼šæ›´å¤æ‚çš„è½¬æ¢å™¨ï¼Œæ”¯æŒå¤šç§æºå’Œç›®æ ‡ç±»å‹è½¬æ¢ã€‚</li>
<li>ConditionalConverterï¼šæ ¹æ®æ¡ä»¶é€‰æ‹©æ˜¯å¦æ‰§è¡Œè½¬æ¢çš„è½¬æ¢å™¨ã€‚</li>
<li>ConversionServiceï¼šæä¾›ç»Ÿä¸€çš„ç±»å‹è½¬æ¢æœåŠ¡æ¥å£ï¼Œç®¡ç†è½¬æ¢å™¨ã€‚</li>
<li>Printerï¼šç”¨äºå°†å¯¹è±¡æ ¼å¼åŒ–ä¸ºæ–‡æœ¬ï¼Œä¸“æ³¨äºæ ¼å¼åŒ–è¾“å‡ºã€‚</li>
<li>Parserï¼šç”¨äºå°†æ–‡æœ¬è§£æä¸ºå¯¹è±¡ï¼Œä¸“æ³¨äºè§£æé€»è¾‘ã€‚</li>
</ul>
<h2 id="Spring-è¡¨è¾¾å¼è¯­è¨€ï¼ˆSpELï¼‰"><a href="#Spring-è¡¨è¾¾å¼è¯­è¨€ï¼ˆSpELï¼‰" class="headerlink" title="Spring è¡¨è¾¾å¼è¯­è¨€ï¼ˆSpELï¼‰"></a>Spring è¡¨è¾¾å¼è¯­è¨€ï¼ˆSpELï¼‰</h2><ul>
<li>ExpressionParser: è§£æå­—ç¬¦ä¸²å½¢å¼çš„ SpEL è¡¨è¾¾å¼ï¼Œåˆ›å»ºå¹¶è¿”å› Expression å®ä¾‹ã€‚</li>
<li>Expression: å¯¹è¡¨è¾¾å¼å­—ç¬¦ä¸²è¿›è¡Œæ±‚å€¼çš„åŠŸèƒ½ï¼Œæ”¯æŒç±»å‹è½¬æ¢ã€è·å–åŸå§‹å­—ç¬¦ä¸²ç­‰æ“ä½œã€‚</li>
<li>EvaluationContext: ç®¡ç†SpELè¡¨è¾¾å¼çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚</li>
<li>PropertyAccessor: ç”¨äºè¯»å–å’Œå†™å…¥å¯¹è±¡çš„å±æ€§ï¼Œå¯ç”¨äºå®ç°è‡ªå®šä¹‰çš„å±æ€§è®¿é—®é€»è¾‘ã€‚</li>
<li>ConstructorResolver: è§£ææ„é€ å‡½æ•°ç¡®å®šbeançš„å®ä¾‹åŒ–æ–¹å¼ã€‚</li>
<li>MethodResolver: è§£æç±»æ–¹æ³•ï¼Œç¡®ä¿æ­£ç¡®è°ƒç”¨ï¼Œå¤„ç†é‡è½½å’Œå‚æ•°åŒ¹é…ã€‚</li>
<li>BeanResolver: è§£æbeanå®šä¹‰ï¼ŒåŒ…æ‹¬ä¾èµ–ã€å±æ€§è®¾ç½®ï¼Œå®ä¾‹åŒ–å¹¶è¿”å›ã€‚</li>
<li>TypeLocator: åŠ¨æ€æŸ¥æ‰¾ç±»ï¼Œè¿”å›Classå¯¹è±¡ï¼Œåœ¨è¡¨è¾¾å¼è§£æã€ç±»å‹è½¬æ¢ç­‰ã€‚</li>
<li>TypeConverter: ç±»å‹è½¬æ¢åŠŸèƒ½ï¼Œå°†è¡¨è¾¾å¼ä¸­çš„æ•°æ®ä»ä¸€ç§ç±»å‹è½¬æ¢ä¸ºå¦ä¸€ç§ç±»å‹ã€‚</li>
<li>TypeComparator: ç±»å‹æ¯”è¾ƒåŠŸèƒ½ï¼Œå®šä¹‰äº†æ¯”è¾ƒä¸¤ä¸ªå¯¹è±¡æ˜¯å¦ç›¸ç­‰çš„æ–¹æ³•ã€‚</li>
<li>OperatorOverloader: è¿ç®—ç¬¦é‡è½½åŠŸèƒ½ï¼Œå¯¹è¡¨è¾¾å¼ä¸­çš„è¿ç®—ç¬¦è¿›è¡Œè‡ªå®šä¹‰æ“ä½œçš„æ–¹æ³•ã€‚</li>
</ul>
<h2 id="Beanå®šä¹‰ä¸æ³¨å†Œ"><a href="#Beanå®šä¹‰ä¸æ³¨å†Œ" class="headerlink" title="Beanå®šä¹‰ä¸æ³¨å†Œ"></a>Beanå®šä¹‰ä¸æ³¨å†Œ</h2><ul>
<li><u>BeanDefinition</u>ï¼šè¯¦ç»†æè¿°Beanï¼Œæ”¯æŒä¾èµ–æ³¨å…¥ã€AOPã€ä½œç”¨åŸŸæ§åˆ¶ç­‰æ ¸å¿ƒåŠŸèƒ½ã€‚</li>
<li><u>BeanDefinitionHolder</u>ï¼šç®¡ç†å’Œæ“ä½œBeanDefinitionçš„å…³é”®ç±»ã€‚</li>
<li><u>BeanDefinitionRegistry</u>ï¼šBeanå®šä¹‰æ³¨å†Œç®¡ç†å…³é”®æ¥å£ï¼Œå¤„ç†Beanå…ƒæ•°æ®ã€‚</li>
</ul>
<h2 id="Beanå®šä¹‰è¯»å–ä¸æ‰«æ"><a href="#Beanå®šä¹‰è¯»å–ä¸æ‰«æ" class="headerlink" title="Beanå®šä¹‰è¯»å–ä¸æ‰«æ"></a>Beanå®šä¹‰è¯»å–ä¸æ‰«æ</h2><ul>
<li>XmlBeanDefinitionReaderï¼šåŠ è½½è§£æXMLé…ç½®ï¼Œæ„å»ºIOCå®¹å™¨ï¼Œæ³¨å†ŒBeanå®šä¹‰ã€‚</li>
<li>PropertiesBeanDefinitionReaderï¼šå±æ€§æ–‡ä»¶åŠ è½½ï¼Œè§£æä¸ºBeanå®šä¹‰ã€‚</li>
<li>GroovyBeanDefinitionReaderï¼šGroovyè„šæœ¬è§£æä¸ºBeanå®šä¹‰ã€‚</li>
<li>AnnotatedBeanDefinitionReaderï¼šæ³¨è§£é…ç½®ï¼Œè‡ªåŠ¨æ‰«ææ³¨å†ŒSpringç»„ä»¶ï¼Œç®€åŒ–Beanå®šä¹‰é…ç½®ã€‚</li>
<li><u>ClassPathBeanDefinitionScanner</u>ï¼šç±»è·¯å¾„æ‰«ææ³¨å†ŒSpring Beanï¼Œæ”¯æŒè‡ªåŠ¨è£…é…ã€‚</li>
</ul>
<h2 id="Beanå·¥å‚"><a href="#Beanå·¥å‚" class="headerlink" title="Beanå·¥å‚"></a>Beanå·¥å‚</h2><ul>
<li><u>BeanFactory</u>ï¼šSpringçš„æ ¸å¿ƒæ¥å£ï¼Œæä¾›å¯¹Beançš„é…ç½®ã€åˆ›å»ºã€ç®¡ç†çš„åŸºæœ¬åŠŸèƒ½ã€‚</li>
<li>ListableBeanFactoryï¼šæ”¯æŒæŒ‰ç±»å‹è·å–Beançš„é›†åˆã€‚</li>
<li>HierarchicalBeanFactoryï¼šæ”¯æŒçˆ¶å­å®¹å™¨å…³ç³»ï¼Œå®ç°Beanå®šä¹‰çš„å±‚æ¬¡ç»“æ„ã€‚</li>
<li>ConfigurableBeanFactoryï¼šæä¾›å¯¹BeanFactoryé…ç½®çš„æ‰©å±•ï¼Œå¦‚å±æ€§ç¼–è¾‘å™¨ã€ä½œç”¨åŸŸç­‰ã€‚</li>
<li>AutowireCapableBeanFactoryï¼šBeanåˆ›å»ºã€åˆå§‹åŒ–ã€æ³¨å…¥ã€é”€æ¯çš„æ ¸å¿ƒåŠŸèƒ½æ¥å£ã€‚</li>
<li><u>ConfigurableListableBeanFactory</u>ï¼šæ”¯æŒé…ç½®å’Œåˆ—è¡¨æ“ä½œçš„å¯é…ç½®Beanå·¥å‚æ¥å£ã€‚</li>
</ul>
<h2 id="å®¹å™¨ä¸Šä¸‹æ–‡"><a href="#å®¹å™¨ä¸Šä¸‹æ–‡" class="headerlink" title="å®¹å™¨ä¸Šä¸‹æ–‡"></a>å®¹å™¨ä¸Šä¸‹æ–‡</h2><ul>
<li><u>ClassPathXmlApplicationContext</u>ï¼šç±»è·¯å¾„ï¼ˆclasspathï¼‰åŠ è½½ XML é…ç½®æ–‡ä»¶çš„ä¸Šä¸‹æ–‡ã€‚</li>
<li><u>AnnotationConfigApplicationContext</u>ï¼šæ³¨è§£é…ç½®ç±»ä¸­åŠ è½½é…ç½®ä¿¡æ¯çš„ä¸Šä¸‹æ–‡ã€‚</li>
<li><u>GenericApplicationContext</u>ï¼šæ”¯æŒå¤šç§é…ç½®æ–¹å¼ï¼ŒXMLã€æ³¨è§£ã€æ‰‹åŠ¨æ³¨å†Œçš„ä¸Šä¸‹æ–‡ã€‚</li>
</ul>
<h2 id="Beanå®šä¹‰å¯¼å…¥ä¸ç»„åˆ"><a href="#Beanå®šä¹‰å¯¼å…¥ä¸ç»„åˆ" class="headerlink" title="Beanå®šä¹‰å¯¼å…¥ä¸ç»„åˆ"></a>Beanå®šä¹‰å¯¼å…¥ä¸ç»„åˆ</h2><ul>
<li><u>ImportBeanDefinitionRegistrar</u>ï¼šè¿è¡Œæ—¶åŠ¨æ€æ³¨å†Œ Beanï¼Œå®ç°çµæ´»é…ç½®ï¼Œæ‰©å±•é…ç½®ç±»åŠŸèƒ½ã€‚</li>
<li><u>ImportSelector</u>ï¼šè¿è¡Œæ—¶åŠ¨æ€å¯¼å…¥é…ç½®ç±»ï¼Œå®ç°æ¡ä»¶é€‰æ‹©å’Œçµæ´»é…ç½®ã€‚</li>
<li>DeferredImportSelectorï¼šè¿è¡Œæ—¶åŠ¨æ€å¯¼å…¥é…ç½®ï¼Œæ”¯æŒæ¡ä»¶é€‰æ‹©å’ŒæŒ‰ç»„åˆ«å»¶è¿ŸåŠ è½½ã€‚</li>
</ul>
<h2 id="Beanç”Ÿå‘½å‘¨æœŸ"><a href="#Beanç”Ÿå‘½å‘¨æœŸ" class="headerlink" title="Beanç”Ÿå‘½å‘¨æœŸ"></a>Beanç”Ÿå‘½å‘¨æœŸ</h2><ul>
<li><u>Beançš„å®šä¹‰æ³¨å†Œè¿‡ç¨‹</u>ï¼šåŠ è½½ä¸è§£æé…ç½®æ–‡ä»¶ï¼Œæ³¨å†Œè§£æBeanå®šä¹‰ï¼Œç±»åã€ä½œç”¨åŸŸã€å±æ€§ç­‰ã€‚</li>
<li><u>Beançš„åˆå§‹åŒ–è¿‡ç¨‹</u>ï¼šå®ä¾‹åŒ–ã€å±æ€§æ³¨å…¥ã€Awareå›è°ƒã€åç½®å¤„ç†å™¨ã€åˆå§‹åŒ–æ–¹æ³•è°ƒç”¨ã€‚</li>
<li><u>Beançš„ä¾èµ–è§£æè¿‡ç¨‹</u>ï¼šå£°æ˜ä¾èµ–ï¼ŒæŸ¥æ‰¾ä¾èµ–ï¼Œæ³¨å…¥ä¾èµ–ï¼Œå¤„ç†å¾ªç¯ä¾èµ–ï¼Œå»¶è¿Ÿä¾èµ–è§£æã€‚</li>
<li><u>Beançš„é”€æ¯è¿‡ç¨‹</u>ï¼šé”€æ¯æ–¹æ³•è°ƒç”¨ï¼Œæ¥å£å›è°ƒï¼Œåå¤„ç†æ¸…ç†ï¼Œé€šçŸ¥è§¦å‘ï¼ŒGCå›æ”¶èµ„æºã€‚</li>
</ul>
<h2 id="å±æ€§è§£æå’Œç¯å¢ƒé…ç½®"><a href="#å±æ€§è§£æå’Œç¯å¢ƒé…ç½®" class="headerlink" title="å±æ€§è§£æå’Œç¯å¢ƒé…ç½®"></a>å±æ€§è§£æå’Œç¯å¢ƒé…ç½®</h2><ul>
<li><u>PropertySource</u>ï¼šç®¡ç†å„ç§é…ç½®æºçš„æŠ½è±¡ç±»ï¼Œæ”¯æŒçµæ´»åœ°åŠ è½½å’Œè®¿é—®åº”ç”¨é…ç½®ã€‚</li>
<li><u>PropertySources</u>ï¼šç”¨äºç»Ÿä¸€ç®¡ç†å’Œè®¿é—®å¤šä¸ª PropertySource å®ä¾‹ï¼Œç®€åŒ–é…ç½®æ•°æ®çš„å¤„ç†ã€‚</li>
<li><u>PropertyResolver</u>ï¼šé€šç”¨å±æ€§è§£æï¼Œè·å–é…ç½®å€¼ï¼Œå¤„ç†å±æ€§ç¼ºå¤±ï¼Œç®€ä¾¿çµæ´»ã€‚</li>
<li><u>ConfigurablePropertyResolver</u>ï¼šå±æ€§è§£æé…ç½®ï¼Œå ä½ç¬¦è®¾ç½®ï¼Œé€‚åº”ä¸åŒé…ç½®éœ€æ±‚ã€‚</li>
<li><u>Environment</u>ï¼šåº”ç”¨ç¯å¢ƒè¡¨ç¤ºï¼Œæä¾›å±æ€§è®¿é—®ï¼Œæ”¯æŒé…ç½®æ–‡ä»¶ï¼Œå®ç°åŠ¨æ€é…ç½®ã€‚</li>
<li><u>ConfigurableEnvironment</u>ï¼šåŠ¨æ€é…ç½®åº”ç”¨ç¯å¢ƒï¼Œæ¿€æ´»ã€é»˜è®¤é…ç½®ï¼Œæå‡åº”ç”¨çµæ´»æ€§ã€‚</li>
</ul>
<h2 id="Beanåˆå§‹åŒ–ä¸æ‰©å±•ç‚¹"><a href="#Beanåˆå§‹åŒ–ä¸æ‰©å±•ç‚¹" class="headerlink" title="Beanåˆå§‹åŒ–ä¸æ‰©å±•ç‚¹"></a>Beanåˆå§‹åŒ–ä¸æ‰©å±•ç‚¹</h2><ul>
<li><u>InitializingBean</u>ï¼šæä¾›Beanåˆå§‹åŒ–æ—¶æ‰§è¡Œè‡ªå®šä¹‰é€»è¾‘çš„æ¥å£ã€‚</li>
<li>DisposableBeanï¼šå®šä¹‰Beané”€æ¯å‰æ‰§è¡Œæ¸…ç†æ“ä½œçš„æ¥å£ã€‚</li>
<li><u>BeanDefinitionRegistryPostProcessor</u>ï¼šåœ¨å®¹å™¨å¯åŠ¨æ—¶ï¼Œå¯¹BeanDefinitionåŠ¨æ€ä¿®æ”¹æˆ–æ·»åŠ ã€‚</li>
<li><u>BeanFactoryPostProcessor</u>ï¼šåœ¨Beanå®ä¾‹åŒ–å‰ï¼Œå¯¹BeanFactoryè¿›è¡Œå…¨å±€ä¿®æ”¹æˆ–é…ç½®ã€‚</li>
<li><u>BeanPostProcessor</u>ï¼šåœ¨Beanåˆå§‹åŒ–å‰åï¼Œè¿›è¡Œè‡ªå®šä¹‰å¤„ç†ï¼Œå¯å½±å“æ‰€æœ‰Beanã€‚</li>
<li>InstantiationAwareBeanPostProcessorï¼šæä¾›æ›´æ·±å±‚æ¬¡çš„å®ä¾‹åŒ–å’Œå±æ€§æ³¨å…¥æ§åˆ¶ã€‚</li>
<li>DestructionAwareBeanPostProcessorï¼š å…è®¸åœ¨Beané”€æ¯å‰è¿›è¡Œé¢å¤–çš„æ¸…ç†æ“ä½œã€‚</li>
<li>MergedBeanDefinitionPostProcessorï¼šåœ¨åˆå¹¶Beanå®šä¹‰æ—¶å¯¹BeanDefinitionè¿›è¡Œå¤„ç†ã€‚</li>
<li>SmartInstantiationAwareBeanPostProcessorï¼šæä¾›æ›´æ™ºèƒ½çš„å®ä¾‹åŒ–æ§åˆ¶ã€‚</li>
<li>SmartInitializingSingletonï¼šåœ¨æ‰€æœ‰å•ä¾‹Beanåˆå§‹åŒ–å®Œæˆåï¼Œæ‰§è¡Œè‡ªå®šä¹‰é€»è¾‘ã€‚</li>
</ul>
<h2 id="Awareæ¥å£ç³»åˆ—"><a href="#Awareæ¥å£ç³»åˆ—" class="headerlink" title="Awareæ¥å£ç³»åˆ—"></a>Awareæ¥å£ç³»åˆ—</h2><ul>
<li>BeanNameAwareï¼šè®©Beanè·å–è‡ªèº«åœ¨å®¹å™¨ä¸­çš„åå­—ã€‚</li>
<li>BeanClassLoaderAwareï¼šå…è®¸Beanè·å–å…¶ç±»åŠ è½½å™¨ã€‚</li>
<li>BeanFactoryAwareï¼šæä¾›Beanè·å–æ‰€å±çš„BeanFactoryã€‚</li>
<li><u>EnvironmentAware</u>ï¼šå…è®¸Beanè·å–åº”ç”¨ç¨‹åºç¯å¢ƒé…ç½®ã€‚</li>
<li>EmbeddedValueResolverAwareï¼šå…è®¸Beanè§£æåµŒå…¥å¼å€¼å ä½ç¬¦ã€‚</li>
<li>ResourceLoaderAwareï¼šå…è®¸Beanè·å–èµ„æºåŠ è½½å™¨ã€‚</li>
<li>ApplicationEventPublisherAwareï¼šå…è®¸Beanå‘å¸ƒåº”ç”¨ç¨‹åºäº‹ä»¶ã€‚</li>
<li>MessageSourceAwareï¼šå…è®¸Beanè·å–æ¶ˆæ¯æºã€‚</li>
<li><u>ApplicationContextAware</u>ï¼šå…è®¸Beanè·å–åº”ç”¨ç¨‹åºä¸Šä¸‹æ–‡ã€‚</li>
<li>ImportAwareï¼šå…è®¸è¢«å¯¼å…¥çš„é…ç½®ç±»è·å–å¯¼å…¥å®ƒçš„ç±»çš„ä¿¡æ¯ã€‚</li>
</ul>
<h2 id="æ ¸å¿ƒæ³¨è§£"><a href="#æ ¸å¿ƒæ³¨è§£" class="headerlink" title="æ ¸å¿ƒæ³¨è§£"></a>æ ¸å¿ƒæ³¨è§£</h2><ul>
<li><u>@Configuration</u>ï¼šå£°æ˜ç±»ä¸ºé…ç½®ç±»ï¼Œå®šä¹‰Beanå’ŒBeanä¹‹é—´çš„ä¾èµ–å…³ç³»ã€‚</li>
<li><u>@ComponentScan</u>ï¼šå¯ç”¨ç»„ä»¶æ‰«æï¼Œè‡ªåŠ¨å‘ç°å¹¶æ³¨å†Œæ ‡è®°ä¸ºç»„ä»¶çš„ç±»ã€‚</li>
<li><u>@Bean</u>ï¼šåœ¨é…ç½®ç±»ä¸­å£°æ˜æ–¹æ³•ï¼Œè¿”å›Beanå®ä¾‹ã€‚</li>
<li><u>@Import</u>ï¼šå¼•å…¥å…¶ä»–é…ç½®ç±»ï¼Œå°†å…¶Beanå®šä¹‰åˆå¹¶åˆ°å½“å‰å®¹å™¨ã€‚</li>
<li>@PropertySourceï¼šæŒ‡å®šå±æ€§æ–‡ä»¶ï¼ŒåŠ è½½å¤–éƒ¨é…ç½®åˆ°ç¯å¢ƒä¸­ã€‚</li>
<li>@DependsOnï¼šæŒ‡å®šBeançš„ä¾èµ–é¡ºåºï¼Œç¡®ä¿ç‰¹å®šBeanåœ¨å…¶ä»–Beanä¹‹å‰åˆå§‹åŒ–ã€‚</li>
<li><u>@Conditional</u>ï¼šæ ¹æ®æ¡ä»¶å†³å®šæ˜¯å¦åˆ›å»ºBeanã€‚</li>
<li>@Lazyï¼šæŒ‡å®šBeançš„å»¶è¿Ÿåˆå§‹åŒ–ï¼Œåªæœ‰åœ¨é¦–æ¬¡ä½¿ç”¨æ—¶æ‰åˆ›å»ºã€‚</li>
<li>@Valueï¼šæ³¨å…¥ç®€å•å€¼æˆ–è¡¨è¾¾å¼åˆ°Beançš„å­—æ®µæˆ–æ–¹æ³•å‚æ•°ã€‚</li>
<li><u>@Autowired</u>ï¼šè‡ªåŠ¨è£…é…Beanä¾èµ–ã€‚</li>
<li>@Primaryï¼šæŒ‡å®šåœ¨å¤šä¸ªå€™é€‰Beanä¸­ä¼˜å…ˆé€‰æ‹©çš„é¦–é€‰Beanã€‚</li>
<li>@Roleï¼šä¸ºBeanæä¾›è§’è‰²æç¤ºï¼Œç”¨äºåŒºåˆ†ç›¸ä¼¼ç±»å‹çš„Beanã€‚</li>
<li>@Indexedï¼š æ ‡è®°Beanç”¨äºç´¢å¼•ã€‚</li>
<li>@Orderï¼šæŒ‡å®šBeançš„åŠ è½½é¡ºåºã€‚</li>
</ul>
<h2 id="JSRè§„èŒƒ"><a href="#JSRè§„èŒƒ" class="headerlink" title="JSRè§„èŒƒ"></a>JSRè§„èŒƒ</h2><ul>
<li>@Injectï¼šJSR-330æ ‡å‡†çš„ä¾èµ–æ³¨å…¥æ³¨è§£ã€‚</li>
<li>@Namedï¼šJSR-330æ ‡å‡†çš„å‘½åæ³¨è§£ã€‚</li>
<li>@Resourceï¼šJava EEæ ‡å‡†çš„èµ„æºæ³¨å…¥æ³¨è§£ã€‚</li>
<li>@Qualifierï¼šç”¨äºé™å®šæ³¨å…¥çš„Beanã€‚</li>
<li>@Scopeï¼šæŒ‡å®šBeançš„ä½œç”¨åŸŸã€‚</li>
<li>@Singletonï¼šæŒ‡å®šBeanä¸ºå•ä¾‹ã€‚</li>
<li>@PostConstructï¼šæŒ‡å®šåˆå§‹åŒ–æ–¹æ³•ã€‚</li>
<li>@PreDestroyï¼šæŒ‡å®šé”€æ¯æ–¹æ³•ã€‚</li>
<li>Providerï¼šJavaæ ‡å‡†åº“æä¾›çš„é€šç”¨Beanå·¥å‚æ¥å£ã€‚</li>
</ul>
<h2 id="Spring-AOP"><a href="#Spring-AOP" class="headerlink" title="Spring AOP"></a>Spring AOP</h2><ul>
<li>JDKåŠ¨æ€ä»£ç†ï¼šæ¥å£å®ç°ï¼ŒåŠ¨æ€ç”Ÿæˆä»£ç†ç±»ï¼Œå¤„ç†æ–¹æ³•è°ƒç”¨ï¼Œç»Ÿä¸€æ¨ªåˆ‡å…³æ³¨ç‚¹ã€‚</li>
<li>CglibåŠ¨æ€ä»£ç†ï¼šåŸºäºå­—èŠ‚ç ç”Ÿæˆçš„åº“ï¼Œæ— éœ€æ¥å£ï¼Œå¯æ‹¦æˆªç±»æ–¹æ³•å¹¶è¿›è¡Œå¢å¼ºã€‚</li>
<li>ClassFilterï¼šç¡®å®šç±»æ˜¯å¦åŒ¹é…æ‹¦æˆªæ¡ä»¶ã€‚</li>
<li>MethodMatcherï¼šç¡®å®šæ–¹æ³•æ˜¯å¦åŒ¹é…æ‹¦æˆªæ¡ä»¶ã€‚</li>
<li>Pointcutï¼šå®šä¹‰åˆ‡å…¥ç‚¹ï¼ŒåŒ¹é…è¢«æ‹¦æˆªçš„æ–¹æ³•ã€‚</li>
<li>Adviceï¼šAOPä¸­å®šä¹‰å„ç§é€šçŸ¥ç±»å‹è¡Œä¸ºçš„æ ¸å¿ƒæ¥å£ã€‚</li>
<li>MethodInterceptorï¼šæ‹¦æˆªæ–¹æ³•æ‰§è¡Œï¼Œå…è®¸åœ¨å‰åæ·»åŠ é¢å¤–é€»è¾‘ã€‚</li>
<li>MethodBeforeAdviceï¼šå…è®¸åœ¨æ–¹æ³•è°ƒç”¨ä¹‹å‰æ’å…¥è‡ªå®šä¹‰é€»è¾‘ã€‚</li>
<li>AfterReturningAdviceï¼šå…è®¸åœ¨æ–¹æ³•è°ƒç”¨ä¹‹åæ’å…¥è‡ªå®šä¹‰é€»è¾‘ã€‚&lt;</li>
<li>ThrowsAdviceï¼šå¼‚å¸¸é€šçŸ¥ï¼Œæ•è·æ–¹æ³•æŠ›å‡ºçš„å¼‚å¸¸ï¼Œæ‰§è¡Œé¢å¤–é€»è¾‘ã€‚</li>
<li>IntroductionInterceptorï¼šåŠ¨æ€åœ°å‘ç›®æ ‡å¯¹è±¡å¼•å…¥æ–°çš„åŠŸèƒ½æˆ–å±æ€§ã€‚</li>
<li>Advisorï¼šç”¨äºå°†é€šçŸ¥å’Œåˆ‡ç‚¹ç»“åˆï¼Œå®ç°åˆ‡é¢ç¼–ç¨‹çš„æ¨ªåˆ‡å…³æ³¨ç‚¹ã€‚</li>
<li>Advisedï¼šé…ç½®AOPä»£ç†çš„é€šçŸ¥ã€é€šçŸ¥å™¨ã€ç›®æ ‡ç­‰ã€‚</li>
<li>ProxyFactoryï¼šä¸€ç§ä¾¿æ·çš„æ–¹å¼æ¥åˆ›å»ºä»£ç†å¯¹è±¡ã€‚</li>
<li>AopProxyFactoryï¼šåˆ›å»ºAOPä»£ç†å·¥å‚ï¼Œæ”¯æŒJDKå’ŒCGLIBã€‚</li>
<li>AopProxyï¼šåˆ›å»ºå’Œç®¡ç†AOPä»£ç†å¯¹è±¡ã€‚</li>
<li>AdvisorChainFactoryï¼šåˆ›å»ºAdvisoré“¾çš„å·¥å‚æ¥å£ã€‚</li>
<li>AdvisorAdapterRegistryï¼šé€‚é…å„ç§Adviceåˆ°AOPæ‹¦æˆªå™¨ï¼Œæ³¨å†Œå’Œç®¡ç†Advisoré€‚é…å™¨ã€‚</li>
<li>AdvisorAdapterï¼šé€‚é…ä¸åŒç±»å‹é€šçŸ¥åˆ°æ‹¦æˆªå™¨é“¾ã€‚</li>
<li>ProxyMethodInvocationï¼šAOPæ–¹æ³•è°ƒç”¨ä»£ç†ï¼Œå¤„ç†æ‹¦æˆªå™¨é“¾å’Œæ–¹æ³•è°ƒç”¨ã€‚</li>
<li>@EnableAspectJAutoProxyï¼šå¯ç”¨AspectJåˆ‡é¢è‡ªåŠ¨ä»£ç†ã€‚</li>
<li>AnnotationAwareAspectJAutoProxyCreatorï¼šåˆ›å»ºAOPä»£ç†ä»¥åº”ç”¨AspectJé£æ ¼çš„åˆ‡é¢ã€‚</li>
<li>BeanFactoryAdvisorRetrievalHelperï¼šå¸®åŠ©æ£€ç´¢å¹¶ç®¡ç†Spring AOP ä¸­çš„ Advisor Beansã€‚</li>
<li>BeanFactoryAspectJAdvisorsBuilderï¼šæ„å»º@AspectJæ³¨è§£åˆ‡é¢ï¼Œç”ŸæˆSpring AOP Advisorsã€‚</li>
<li>AspectInstanceFactoryï¼šåˆ›å»ºåˆ‡é¢å®ä¾‹ï¼Œæ”¯æŒå¤šç§å®ç°æ–¹å¼ã€‚</li>
<li>MetadataAwareAspectInstanceFactoryï¼šç®¡ç†åˆ‡é¢å®ä¾‹å’Œå…ƒæ•°æ®ï¼Œæ”¯æŒå¤šç§å®ä¾‹åŒ–ç­–ç•¥ã€‚</li>
<li>AspectJAdvisorFactoryï¼šåˆ›å»ºAspectJé€šçŸ¥å™¨å®ä¾‹ï¼Œç®¡ç†åˆ‡é¢é€šçŸ¥çš„åˆ›å»ºå’Œé…ç½®ã€‚</li>
<li>TargetSourceï¼šç®¡ç†AOPä»£ç†å¯¹è±¡çš„è·å–ä¸é‡Šæ”¾ã€‚</li>
<li>TargetSourceCreatorï¼šåˆ›å»ºç‰¹æ®Šçš„ç›®æ ‡æºï¼Œå®šåˆ¶ä»£ç†å¯¹è±¡çš„åˆ›å»ºå’Œç®¡ç†ã€‚</li>
<li>AopContextï¼šè·å–Spring AOPä»£ç†å¯¹è±¡çš„å·¥å…·ã€‚</li>
<li>ExposeInvocationInterceptorï¼šæš´éœ²Spring AOPæ–¹æ³•è°ƒç”¨ä¸Šä¸‹æ–‡çš„æ‹¦æˆªå™¨ã€‚</li>
<li>@EnableLoadTimeWeavingï¼šå¯ç”¨SpringåŠ è½½æ—¶ç¼–ç»‡ã€‚</li>
</ul>
<h2 id="Spring-äº‹åŠ¡"><a href="#Spring-äº‹åŠ¡" class="headerlink" title="Spring äº‹åŠ¡"></a>Spring äº‹åŠ¡</h2><ul>
<li>Connectionï¼šç®¡ç†æ•°æ®åº“è¿æ¥ï¼Œæ‰§è¡ŒSQLï¼Œå¤„ç†äº‹åŠ¡ã€‚</li>
<li>DataSourceï¼šæä¾›é«˜æ•ˆç®¡ç†æ•°æ®åº“è¿æ¥çš„æ¥å£ã€‚</li>
<li>DriverManagerï¼šç®¡ç†å’Œå»ºç«‹æ•°æ®åº“è¿æ¥çš„æ ¸å¿ƒç±»ã€‚</li>
<li>JdbcTemplateï¼šç®€åŒ–äº†JDBCæ“ä½œï¼Œæä¾›äº†æ–¹ä¾¿çš„æ•°æ®åº“è®¿é—®æŠ½è±¡ã€‚</li>
<li><u>TransactionDefinition</u>ï¼šå®šä¹‰äº‹åŠ¡çš„ä¼ æ’­è¡Œä¸ºå’Œéš”ç¦»çº§åˆ«ã€‚</li>
<li><u>TransactionAttributeSource</u>ï¼šç”¨äºè·å–äº‹åŠ¡å±æ€§çš„ç­–ç•¥æ¥å£ã€‚</li>
<li><u>PlatformTransactionManager</u>ï¼šç”¨äºç®¡ç†å’Œåè°ƒäº‹åŠ¡çš„ç”Ÿå‘½å‘¨æœŸå’Œæ‰§è¡Œã€‚</li>
<li><u>TransactionTemplate</u>ï¼šç®€åŒ–äº‹åŠ¡ç®¡ç†ï¼Œæ”¯æŒç¼–ç¨‹å¼äº‹åŠ¡æ§åˆ¶ä¸å¼‚å¸¸å¤„ç†ã€‚</li>
<li><u>SpringTransactionAnnotationParser</u>ï¼šè§£æ @Transactionalæ³¨è§£å¹¶è½¬æ¢ä¸ºäº‹åŠ¡é…ç½®ã€‚</li>
<li><u>TransactionInterceptor</u>ï¼šäº‹åŠ¡æ‹¦æˆªå™¨ï¼Œç”¨äºç®¡ç†æ–¹æ³•çº§åˆ«çš„äº‹åŠ¡å¤„ç†ã€‚</li>
<li><u>EnableTransactionManagement</u>ï¼šå¯ç”¨Springçš„æ³¨è§£é©±åŠ¨äº‹åŠ¡ç®¡ç†ã€‚</li>
</ul>
]]></content>
      <categories>
        <category>Springä½“ç³»ç»“æ„</category>
      </categories>
      <tags>
        <tag>Springæºç é˜…è¯»</tag>
      </tags>
  </entry>
  <entry>
    <title>ã€Šæ·±åº¦å­¦ä¹ è¿›é˜¶ï¼šè‡ªç„¶è¯­è¨€å¤„ç†ã€‹é˜…è¯»ç¬”è®°</title>
    <url>/2024/04/08/%E3%80%8A%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E8%BF%9B%E9%98%B6%EF%BC%9A%E8%87%AA%E7%84%B6%E8%AF%AD%E8%A8%80%E5%A4%84%E7%90%86%E3%80%8B%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/</url>
    <content><![CDATA[<h1 id="1-ç¥ç»ç½‘ç»œ"><a href="#1-ç¥ç»ç½‘ç»œ" class="headerlink" title="1 ç¥ç»ç½‘ç»œ"></a>1 ç¥ç»ç½‘ç»œ</h1><h2 id="1-1-å‘é‡"><a href="#1-1-å‘é‡" class="headerlink" title="1.1 å‘é‡"></a>1.1 å‘é‡</h2><p>å‘é‡å†…ç§¯å’ŒçŸ©é˜µä¹˜ç§¯ï¼š</p>
<p><img src="/../images/%E3%80%8A%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E8%BF%9B%E9%98%B6%EF%BC%9A%E8%87%AA%E7%84%B6%E8%AF%AD%E8%A8%80%E5%A4%84%E7%90%86%E3%80%8B%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/image_1bqyqcgBZu.png"></p>
<span id="more"></span>

<h2 id="1-2-æ¿€æ´»å‡½æ•°"><a href="#1-2-æ¿€æ´»å‡½æ•°" class="headerlink" title="1.2 æ¿€æ´»å‡½æ•°"></a>1.2 æ¿€æ´»å‡½æ•°</h2><h3 id="1-2-1-sigmoid"><a href="#1-2-1-sigmoid" class="headerlink" title="1.2.1 sigmoid"></a>1.2.1 sigmoid</h3><p><img src="/../images/%E3%80%8A%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E8%BF%9B%E9%98%B6%EF%BC%9A%E8%87%AA%E7%84%B6%E8%AF%AD%E8%A8%80%E5%A4%84%E7%90%86%E3%80%8B%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/image_9HSiif9JfV.png"></p>
<h3 id="1-2-2-tanh"><a href="#1-2-2-tanh" class="headerlink" title="1.2.2 tanh"></a>1.2.2 tanh</h3><p><img src="/../images/%E3%80%8A%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E8%BF%9B%E9%98%B6%EF%BC%9A%E8%87%AA%E7%84%B6%E8%AF%AD%E8%A8%80%E5%A4%84%E7%90%86%E3%80%8B%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/image_QIEQOJAnOF.png"></p>
<h2 id="1-3-Softmax"><a href="#1-3-Softmax" class="headerlink" title="1.3 Softmax"></a>1.3 Softmax</h2><p><img src="/../images/%E3%80%8A%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E8%BF%9B%E9%98%B6%EF%BC%9A%E8%87%AA%E7%84%B6%E8%AF%AD%E8%A8%80%E5%A4%84%E7%90%86%E3%80%8B%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/image_N3Vili_wTq.png"></p>
<p>ä½œç”¨ï¼šå°†è¾“å‡ºè½¬åŒ–ä¸ºæ¦‚ç‡å’Œä¸º1çš„æ¦‚ç‡åˆ†å¸ƒï¼ˆæ¦‚ç‡æ ‡å‡†åŒ–</p>
<p>äº¤å‰ç†µè¯¯å·®</p>
<p><img src="/../images/%E3%80%8A%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E8%BF%9B%E9%98%B6%EF%BC%9A%E8%87%AA%E7%84%B6%E8%AF%AD%E8%A8%80%E5%A4%84%E7%90%86%E3%80%8B%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/image_zZKfBVcMoO.png"></p>
<p><img src="/../images/%E3%80%8A%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E8%BF%9B%E9%98%B6%EF%BC%9A%E8%87%AA%E7%84%B6%E8%AF%AD%E8%A8%80%E5%A4%84%E7%90%86%E3%80%8B%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/image_Chw1F7Akcw.png"></p>
<p>é“¾å¼æ³•åˆ™</p>
<p>é“¾å¼æ³•åˆ™çš„é‡è¦ä¹‹å¤„åœ¨äºï¼Œæ— è®ºæˆ‘ä»¬è¦å¤„ç†çš„å‡½æ•°æœ‰å¤šå¤æ‚ï¼ˆæ— è®ºå¤åˆäº†å¤šå°‘ä¸ªå‡½æ•°ï¼‰ï¼Œéƒ½å¯ä»¥æ ¹æ®å®ƒä»¬å„è‡ªçš„å¯¼æ•°æ¥æ±‚å¤åˆå‡½æ•°çš„å¯¼æ•°ã€‚</p>
<p><img src="/../images/%E3%80%8A%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E8%BF%9B%E9%98%B6%EF%BC%9A%E8%87%AA%E7%84%B6%E8%AF%AD%E8%A8%80%E5%A4%84%E7%90%86%E3%80%8B%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/image_haS6PoUyjG.png" alt="è®¡ç®—å›¾" title="è®¡ç®—å›¾"></p>
<p><img src="/../images/%E3%80%8A%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E8%BF%9B%E9%98%B6%EF%BC%9A%E8%87%AA%E7%84%B6%E8%AF%AD%E8%A8%80%E5%A4%84%E7%90%86%E3%80%8B%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/image_UXq-rgO7SR.png"></p>
<h2 id="1-4-åå‘ä¼ æ’­"><a href="#1-4-åå‘ä¼ æ’­" class="headerlink" title="1.4 åå‘ä¼ æ’­"></a>1.4 åå‘ä¼ æ’­</h2><p>å…¬å¼</p>
<p><img src="/../images/%E3%80%8A%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E8%BF%9B%E9%98%B6%EF%BC%9A%E8%87%AA%E7%84%B6%E8%AF%AD%E8%A8%80%E5%A4%84%E7%90%86%E3%80%8B%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/image_3Nd6MpmQmw.png"></p>
<p><img src="/../images/%E3%80%8A%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E8%BF%9B%E9%98%B6%EF%BC%9A%E8%87%AA%E7%84%B6%E8%AF%AD%E8%A8%80%E5%A4%84%E7%90%86%E3%80%8B%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/image_Y-jRNJkCgn.png"></p>
<blockquote>
<p>æœ¬ä¹¦å°†çŸ©é˜µä¹˜ç§¯ç§°ä¸º MatMulï¼ˆMatrix Multiplyï¼‰èŠ‚ç‚¹ã€‚</p>
</blockquote>
<p>ä»£ç </p>
<p><img src="/../images/%E3%80%8A%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E8%BF%9B%E9%98%B6%EF%BC%9A%E8%87%AA%E7%84%B6%E8%AF%AD%E8%A8%80%E5%A4%84%E7%90%86%E3%80%8B%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/image_ikLUqD3eNu.png"></p>
<p>é“¾å¼æ³•åˆ™ï¼šå¤åˆå‡½æ•°çš„å¯¼æ•°å¯ä»¥æ ¹æ®å„ä¸ªç®€å•å‡½æ•°çš„å¯¼æ•°æ¥æ±‚ã€‚</p>
<p><img src="/../images/%E3%80%8A%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E8%BF%9B%E9%98%B6%EF%BC%9A%E8%87%AA%E7%84%B6%E8%AF%AD%E8%A8%80%E5%A4%84%E7%90%86%E3%80%8B%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/image_FjE1dwS714.png"></p>
<h3 id="1-4-1-Softmax-with-Loss-å±‚"><a href="#1-4-1-Softmax-with-Loss-å±‚" class="headerlink" title="1.4.1 Softmax with Loss å±‚"></a>1.4.1 Softmax with Loss å±‚</h3><p><img src="/../images/%E3%80%8A%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E8%BF%9B%E9%98%B6%EF%BC%9A%E8%87%AA%E7%84%B6%E8%AF%AD%E8%A8%80%E5%A4%84%E7%90%86%E3%80%8B%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/image_oi4iYIorJU.png"></p>
<figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># Softmax with Loss</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SoftmaxWithLoss</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.parame = []</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x, t</span>):</span><br><span class="line">        <span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line">        <span class="variable language_">self</span>.t = t</span><br><span class="line">        <span class="variable language_">self</span>.y = np.exp(x) / np.<span class="built_in">sum</span>(np.exp(x))</span><br><span class="line">        <span class="variable language_">self</span>.loss = -np.<span class="built_in">sum</span>(t * np.log(<span class="variable language_">self</span>.y))</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.loss</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">backward</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line">        dx = <span class="variable language_">self</span>.y - <span class="variable language_">self</span>.t</span><br><span class="line">        <span class="keyword">return</span> dx</span><br></pre></td></tr></tbody></table></figure>

<h2 id="1-5-æ¢¯åº¦ä¸‹é™"><a href="#1-5-æ¢¯åº¦ä¸‹é™" class="headerlink" title="1.5 æ¢¯åº¦ä¸‹é™"></a>1.5 æ¢¯åº¦ä¸‹é™</h2><p>éšæœºæ¢¯åº¦ä¸‹é™æ³•</p>
<p>æ¢¯åº¦ä¸‹é™ï¼šåœ¨è®­ç»ƒè¿‡ç¨‹ä¸­ï¼Œåå‘ä¼ æ’­å°†ä¸æ–­æ›´æ–°æƒé‡çš„æ¢¯åº¦ï¼Œè®©æŸå¤±ä¸æ–­é™ä½</p>
<p><img src="/../images/%E3%80%8A%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E8%BF%9B%E9%98%B6%EF%BC%9A%E8%87%AA%E7%84%B6%E8%AF%AD%E8%A8%80%E5%A4%84%E7%90%86%E3%80%8B%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/image_39HQB-HZlV.png"></p>
<p>é¦–å…ˆï¼Œé€‰æ‹© mini-batch æ•°æ®ï¼Œæ ¹æ®è¯¯å·®åå‘ä¼ æ’­æ³•è·å¾—æƒé‡çš„æ¢¯åº¦ã€‚è¿™ä¸ªæ¢¯åº¦æŒ‡å‘å½“å‰çš„æƒé‡å‚æ•°æ‰€å¤„ä½ç½®ä¸­æŸå¤±å¢åŠ æœ€å¤šçš„æ–¹å‘ã€‚å› æ­¤ï¼Œé€šè¿‡å°†å‚æ•°å‘è¯¥æ¢¯åº¦çš„åæ–¹å‘æ›´æ–°ï¼Œå¯ä»¥é™ä½æŸå¤±ã€‚è¿™å°±æ˜¯æ¢¯åº¦ä¸‹é™æ³•</p>
<p>æƒé‡æ›´æ–°æ–¹æ³•ï¼š</p>
<ul>
<li><p>éšæœºæ¢¯åº¦ä¸‹é™æ³• SGD</p>
<ul>
<li>â€œéšæœºâ€æ˜¯æŒ‡ä½¿ç”¨éšæœºé€‰æ‹©çš„æ•°æ®ï¼ˆmini-batchï¼‰çš„æ¢¯åº¦ã€‚<br><img src="/../images/%E3%80%8A%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E8%BF%9B%E9%98%B6%EF%BC%9A%E8%87%AA%E7%84%B6%E8%AF%AD%E8%A8%80%E5%A4%84%E7%90%86%E3%80%8B%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/image_hqK0eTi6_4.png"></li>
</ul>
<p>Î· è¡¨ç¤ºå­¦ä¹ ç‡</p>
</li>
<li><p>æ‰¹é‡æ¢¯åº¦ä¸‹é™ç®—æ³•BGD</p>
</li>
<li><p>å°æ‰¹é‡ æ¢¯åº¦ä¸‹é™ç®—æ³•MBGD</p>
</li>
</ul>
<h2 id="1-6-å•å±‚æ„ŸçŸ¥æœº"><a href="#1-6-å•å±‚æ„ŸçŸ¥æœº" class="headerlink" title="1.6 å•å±‚æ„ŸçŸ¥æœº"></a>1.6 å•å±‚æ„ŸçŸ¥æœº</h2><p><img src="/../images/%E3%80%8A%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E8%BF%9B%E9%98%B6%EF%BC%9A%E8%87%AA%E7%84%B6%E8%AF%AD%E8%A8%80%E5%A4%84%E7%90%86%E3%80%8B%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/image_oiKZuVifVq.png"></p>
<p>å•å±‚æ„ŸçŸ¥å™¨å±äºå•å±‚å‰å‘ç½‘ç»œï¼Œ<strong>å³é™¤è¾“å…¥å±‚å’Œè¾“å‡ºå±‚ä¹‹å¤–ï¼Œåªæ‹¥æœ‰ä¸€å±‚ç¥ç»å…ƒèŠ‚ç‚¹</strong>ã€‚å‰å‘ç½‘ç»œçš„ç‰¹ç‚¹æ˜¯ï¼Œè¾“å…¥æ•°æ®ä»è¾“å…¥å±‚ç»è¿‡éšè—å±‚å‘è¾“å‡ºå±‚é€å±‚ä¼ æ’­ï¼Œç›¸é‚»ä¸¤å±‚çš„ç¥ç»å…ƒä¹‹é—´ç›¸äº’è¿æ¥ï¼Œ åŒä¸€å±‚çš„ç¥ç»å…ƒä¹‹é—´åˆ™æ²¡æœ‰è¿æ¥ã€‚</p>
<h1 id="2-è‡ªç„¶è¯­è¨€å¤„ç†"><a href="#2-è‡ªç„¶è¯­è¨€å¤„ç†" class="headerlink" title="2 è‡ªç„¶è¯­è¨€å¤„ç†"></a>2 è‡ªç„¶è¯­è¨€å¤„ç†</h1><p>è¦æƒ³è®©è®¡ç®—æœºç†è§£è‡ªç„¶è¯­è¨€çš„å‰æå°±æ˜¯è®©å…¶ç†è§£æ¯ä¸ªå•è¯çš„å«ä¹‰ã€‚æˆ‘ä»¬ä¸»è¦æœ‰3ç§æ–¹æ³•å®ç°ï¼š</p>
<ul>
<li>åŸºäºåŒä¹‰è¯è¯å…¸çš„æ–¹æ³•<ul>
<li><strong>WordNet</strong></li>
</ul>
</li>
<li>åŸºäºè®¡æ•°çš„æ–¹æ³•</li>
<li>åŸºäºæ¨ç†çš„æ–¹æ³•ï¼ˆword2vecï¼‰</li>
</ul>
<h2 id="å•è¯çš„åˆ†å¸ƒå¼è¡¨ç¤º"><a href="#å•è¯çš„åˆ†å¸ƒå¼è¡¨ç¤º" class="headerlink" title="å•è¯çš„åˆ†å¸ƒå¼è¡¨ç¤º"></a><strong>å•è¯çš„åˆ†å¸ƒå¼è¡¨ç¤º</strong></h2><p>æˆ‘ä»¬èƒ½ä¸èƒ½å°†ç±»ä¼¼äºé¢œè‰²RGBè¡¨ç¤ºæ–¹æ³•è¿ç”¨åˆ°å•è¯ä¸Šå‘¢ï¼Ÿåœ¨å•è¯é¢†åŸŸæ„å»ºç´§å‡‘åˆç†çš„å‘é‡è¡¨ç¤ºï¼Œåœ¨è‡ªç„¶è¯­è¨€å¤„ç†é¢†åŸŸï¼Œè¿™ç§°ä¸º<strong>åˆ†å¸ƒå¼è¡¨ç¤º</strong>ã€‚å•è¯çš„åˆ†å¸ƒå¼è¡¨ç¤ºå°†å•è¯è¡¨ç¤ºä¸ºå›ºå®šé•¿åº¦çš„å‘é‡ã€‚è¿™ç§å‘é‡çš„ç‰¹å¾åœ¨äºå®ƒæ˜¯ç”¨å¯†é›†å‘é‡è¡¨ç¤ºçš„ã€‚</p>
<p><strong>å¯†é›†å‘é‡</strong>ï¼šå‘é‡çš„å„ä¸ªå…ƒç´ ï¼ˆå¤§å¤šæ•°ï¼‰æ˜¯ç”±é 0 å®æ•°è¡¨ç¤ºçš„ã€‚ä¾‹å¦‚ä¸‰ç»´åˆ†å¸ƒå¼è¡¨ç¤ºæ˜¯$[0.21,-0.45,0.83]$</p>
<p><strong>åˆ†å¸ƒå¼å‡è®¾</strong>ï¼šâ€œæŸä¸ªå•è¯çš„å«ä¹‰ç”±å®ƒå‘¨å›´çš„å•è¯å½¢æˆâ€ï¼Œç§°ä¸º<strong>åˆ†å¸ƒå¼å‡è®¾</strong>ã€‚</p>
<h2 id="2-2-åŸºäºè®¡æ•°çš„æ–¹æ³•"><a href="#2-2-åŸºäºè®¡æ•°çš„æ–¹æ³•" class="headerlink" title="2.2 åŸºäºè®¡æ•°çš„æ–¹æ³•"></a>2.2 åŸºäºè®¡æ•°çš„æ–¹æ³•</h2><p>åŸºäºè®¡æ•°çš„æ–¹æ³•æ ¹æ®ä¸€ä¸ªå•è¯å‘¨å›´çš„å•è¯çš„å‡ºç°é¢‘æ•°æ¥è¡¨ç¤ºè¯¥å•è¯ã€‚å…·ä½“æ¥è¯´ï¼Œå…ˆç”Ÿæˆæ‰€æœ‰å•è¯çš„å…±ç°çŸ©é˜µï¼Œå†å¯¹è¿™ä¸ªçŸ©é˜µè¿›è¡ŒSVDï¼Œä»¥è·å¾—å¯†é›†å‘é‡ï¼ˆå•è¯çš„åˆ†å¸ƒå¼è¡¨ç¤ºï¼‰ã€‚ä½†æ˜¯ï¼ŒåŸºäºè®¡æ•°çš„æ–¹æ³•åœ¨å¤„ç†å¤§è§„æ¨¡è¯­æ–™åº“æ—¶ä¼šå‡ºç°é—®é¢˜ã€‚</p>
<blockquote>
<p>å¥‡å¼‚å€¼åˆ†è§£ï¼ˆSingular Value Decompositionï¼ŒSVDï¼‰æ˜¯çŸ©é˜µåˆ†è§£çš„ä¸€ç§æ–¹æ³•ï¼Œå°†ä¸€ä¸ªçŸ©é˜µåˆ†è§£ä¸ºä¸‰ä¸ªçŸ©é˜µçš„ä¹˜ç§¯ï¼š$M = U \Sigma V^T$ï¼Œå…¶ä¸­ $U$ å’Œ $V$æ˜¯æ­£äº¤çŸ©é˜µï¼Œ$\Sigma$æ˜¯å¯¹è§’çŸ©é˜µï¼ŒåŒ…å«å¥‡å¼‚å€¼ã€‚</p>
</blockquote>
<p>é€šè¿‡SVDï¼Œå¯ä»¥å°†åŸå§‹é«˜ç»´ç¨€ç–çŸ©é˜µå‹ç¼©ä¸ºä½ç»´ç¨ å¯†çŸ©é˜µã€‚è¿™äº›ä½ç»´çŸ©é˜µçš„è¡Œå‘é‡æˆ–åˆ—å‘é‡å°±å¯ä»¥ä½œä¸ºå•è¯çš„å‘é‡è¡¨ç¤ºã€‚</p>
<p>SVDçš„ä½œç”¨ï¼šé™ç»´ã€å»å™ªã€ç¨ å¯†è¡¨ç¤ºç­‰</p>
<p>ç¼ºç‚¹ï¼šè®¡ç®—é‡å¤ªå¤§å¯¼è‡´è®¡ç®—æœºéš¾ä»¥å¤„ç†</p>
<h3 id="è¯­æ–™åº“çš„é¢„å¤„ç†"><a href="#è¯­æ–™åº“çš„é¢„å¤„ç†" class="headerlink" title="è¯­æ–™åº“çš„é¢„å¤„ç†"></a><strong>è¯­æ–™åº“çš„é¢„å¤„ç†</strong></h3><p>ç°åœ¨ï¼Œæˆ‘ä»¬å¯¹ä¸€ä¸ªéå¸¸å°çš„æ–‡æœ¬æ•°æ®ï¼ˆè¯­æ–™åº“ï¼‰è¿›è¡Œé¢„å¤„ç†ã€‚è¿™é‡Œæ‰€è¯´çš„é¢„å¤„ç†æ˜¯æŒ‡ï¼š</p>
<ol>
<li>å°†æ–‡æœ¬åˆ†å‰²æˆå•è¯</li>
<li>å•è¯åˆ—è¡¨è½¬åŒ–ä¸ºå•è¯IDåˆ—è¡¨</li>
</ol>
<h3 id="2-2-2-å…±ç°çŸ©é˜µ"><a href="#2-2-2-å…±ç°çŸ©é˜µ" class="headerlink" title="2.2.2 å…±ç°çŸ©é˜µ"></a>2.2.2 å…±ç°çŸ©é˜µ</h3><p>ç”¨è¡¨æ ¼è¡¨ç¤ºå•è¯çš„ä¸Šä¸‹æ–‡ä¸­åŒ…å«çš„å•è¯çš„é¢‘æ•°ï¼Œä½œä¸ºå•è¯çš„å‘é‡è¡¨ç¤º</p>
<p><img src="/../images/%E3%80%8A%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E8%BF%9B%E9%98%B6%EF%BC%9A%E8%87%AA%E7%84%B6%E8%AF%AD%E8%A8%80%E5%A4%84%E7%90%86%E3%80%8B%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/image_4rUGq7V2am.png"></p>
<p>å¯¹ä¸€ä¸ªå¥å­ä¸­æ‰€æœ‰çš„å•è¯è¿›è¡Œå¤„ç†ï¼Œå°±å¯ä»¥å¾—åˆ°å¦‚ä¸‹çš„å…±ç°çŸ©é˜µï¼š</p>
<p><img src="/../images/%E3%80%8A%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E8%BF%9B%E9%98%B6%EF%BC%9A%E8%87%AA%E7%84%B6%E8%AF%AD%E8%A8%80%E5%A4%84%E7%90%86%E3%80%8B%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/image_6Te4nILf4k.png"></p>
<h3 id="2-2-3-ä½™å¼¦ç›¸ä¼¼åº¦ï¼ˆcosine-similarityï¼‰"><a href="#2-2-3-ä½™å¼¦ç›¸ä¼¼åº¦ï¼ˆcosine-similarityï¼‰" class="headerlink" title="2.2.3 ä½™å¼¦ç›¸ä¼¼åº¦ï¼ˆcosine similarityï¼‰"></a>2.2.3 ä½™å¼¦ç›¸ä¼¼åº¦ï¼ˆcosine similarityï¼‰</h3><p>åœ¨æµ‹é‡å•è¯çš„å‘é‡è¡¨ç¤ºçš„ç›¸ä¼¼åº¦æ–¹é¢ï¼Œä½™å¼¦ç›¸ä¼¼åº¦æ˜¯å¾ˆå¸¸ç”¨çš„ã€‚</p>
<p><img src="/../images/%E3%80%8A%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E8%BF%9B%E9%98%B6%EF%BC%9A%E8%87%AA%E7%84%B6%E8%AF%AD%E8%A8%80%E5%A4%84%E7%90%86%E3%80%8B%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/image_K3SNNXUSNA.png"></p>
<h3 id="2-2-4-ç‚¹äº’ä¿¡æ¯"><a href="#2-2-4-ç‚¹äº’ä¿¡æ¯" class="headerlink" title="2.2.4 ç‚¹äº’ä¿¡æ¯"></a>2.2.4 ç‚¹äº’ä¿¡æ¯</h3><p>å…±ç°çŸ©é˜µçš„å…ƒç´ è¡¨ç¤ºä¸¤ä¸ªå•è¯åŒæ—¶å‡ºç°çš„æ¬¡æ•°ã€‚ä½†æ˜¯ï¼Œè¿™ç§â€œåŸå§‹â€çš„æ¬¡æ•°å¹¶ä¸å…·å¤‡å¥½çš„æ€§è´¨ã€‚</p>
<p>æ¯”å¦‚â€œthe carâ€¦â€è¿™æ ·çš„çŸ­è¯­ï¼Œå®ƒä»¬çš„å…±ç°æ¬¡æ•°å°†ä¼šå¾ˆå¤§ã€‚å¦å¤–ï¼Œcar å’Œ drive ä¹Ÿæ˜æ˜¾æœ‰å¾ˆå¼ºçš„ç›¸å…³æ€§ã€‚ä½†æ˜¯ï¼Œå¦‚æœåªçœ‹å•è¯çš„å‡ºç°æ¬¡æ•°ï¼Œé‚£ä¹ˆä¸ drive ç›¸æ¯”ï¼Œthe å’Œ car çš„ç›¸å…³æ€§æ›´å¼ºã€‚è¿™æ„å‘³ç€ï¼Œä»…ä»…å› ä¸º the æ˜¯ä¸ªå¸¸ç”¨è¯ï¼Œå®ƒå°±è¢«è®¤ä¸ºä¸ car æœ‰å¾ˆå¼ºçš„ç›¸å…³æ€§ï¼Œè¿™æ˜¾ç„¶ä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„ã€‚</p>
<p>ç‚¹äº’ä¿¡æ¯è¢«ç”¨äºè§£å†³è¿™ä¸€é—®é¢˜ï¼š</p>
<p><img src="/../images/%E3%80%8A%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E8%BF%9B%E9%98%B6%EF%BC%9A%E8%87%AA%E7%84%B6%E8%AF%AD%E8%A8%80%E5%A4%84%E7%90%86%E3%80%8B%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/image_VLIsIt84wg.png"></p>
<p>å…¶ä¸­ï¼ŒP(x) è¡¨ç¤º x å‘ç”Ÿçš„æ¦‚ç‡ï¼ŒP(y) è¡¨ç¤º y å‘ç”Ÿçš„æ¦‚ç‡ï¼ŒP(x, y) è¡¨ç¤º x å’Œ y åŒæ—¶å‘ç”Ÿçš„æ¦‚ç‡ã€‚PMI çš„å€¼è¶Šé«˜ï¼Œè¡¨æ˜ç›¸å…³æ€§è¶Šå¼ºã€‚</p>
<h4 id="2-2-4-1-æ­£çš„ç‚¹äº’ä¿¡æ¯"><a href="#2-2-4-1-æ­£çš„ç‚¹äº’ä¿¡æ¯" class="headerlink" title="2.2.4.1 æ­£çš„ç‚¹äº’ä¿¡æ¯"></a>2.2.4.1 æ­£çš„ç‚¹äº’ä¿¡æ¯</h4><p>è§£å†³å½“ä¸¤ä¸ªå•è¯çš„å…±ç°æ¬¡æ•°ä¸º 0 æ—¶ï¼Œlog20 = âˆ’âˆã€‚</p>
<p><img src="/../images/%E3%80%8A%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E8%BF%9B%E9%98%B6%EF%BC%9A%E8%87%AA%E7%84%B6%E8%AF%AD%E8%A8%80%E5%A4%84%E7%90%86%E3%80%8B%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/image_mvK3ZF2ygS.png"></p>
<p>å°½ç®¡PPMIçŸ©é˜µèƒ½å¤Ÿæ”¹å–„ä¹‹å‰å…±ç°çŸ©é˜µå­˜åœ¨çš„é«˜é¢‘è¯æ±‡é—®é¢˜ï¼Œä½†æ˜¯è¿™ä¸¤ç§æ–¹æ³•éƒ½å­˜åœ¨ä¸€ä¸ªå…±æ€§é—®é¢˜ï¼š<strong>éšç€å•è¯æ•°ç›®çš„å¢åŠ ï¼ŒçŸ©é˜µçš„ç»´æ•°ä¹Ÿåœ¨å¢åŠ ï¼Œè€Œå…¶ä¸­å¾ˆå¤šå…ƒç´ éƒ½ä¸º0(ä¸é‡è¦çš„å…ƒç´ )ï¼›å‘é‡å®¹æ˜“å—åˆ°å™ªå£°çš„å½±å“ï¼Œç¨³å®šæ€§å·®ã€‚</strong></p>
<hr>
<p>åŸºäºè®¡æ•°çš„æ–¹æ³•ä½¿ç”¨æ•´ä¸ªè¯­æ–™åº“çš„ç»Ÿè®¡æ•°æ®ï¼ˆå…±ç°çŸ©é˜µå’Œ PPMI ç­‰ ï¼‰ï¼Œé€šè¿‡ä¸€æ¬¡å¤„ç†ï¼ˆSVD ç­‰ï¼‰è·å¾—å•è¯çš„åˆ†å¸ƒå¼è¡¨ç¤ºã€‚è€ŒåŸºäºæ¨ç†çš„æ–¹æ³•ä½¿ç”¨ç¥ç»ç½‘ç»œï¼Œé€šå¸¸åœ¨ mini-batch æ•°æ®ä¸Šè¿›è¡Œå­¦ä¹ ã€‚è¿™æ„å‘³ç€ç¥ç»ç½‘ç»œä¸€æ¬¡åªéœ€è¦çœ‹ä¸€éƒ¨åˆ†å­¦ä¹ æ•°æ®ï¼ˆmini-batchï¼‰ï¼Œå¹¶åå¤æ›´æ–°æƒé‡ã€‚è¿™ç§å­¦ä¹ æœºåˆ¶ä¸Šçš„å·®å¼‚å¦‚å›¾ 3-1 æ‰€ç¤ºã€‚</p>
<p><img src="/../images/%E3%80%8A%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E8%BF%9B%E9%98%B6%EF%BC%9A%E8%87%AA%E7%84%B6%E8%AF%AD%E8%A8%80%E5%A4%84%E7%90%86%E3%80%8B%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/image_hUDNVonnr_.png"></p>
<h2 id="2-3-åŸºäºæ¨ç†çš„æ–¹æ³•"><a href="#2-3-åŸºäºæ¨ç†çš„æ–¹æ³•" class="headerlink" title="2.3 åŸºäºæ¨ç†çš„æ–¹æ³•"></a>2.3 åŸºäºæ¨ç†çš„æ–¹æ³•</h2><p>åŸºäºæ¨ç†çš„æ–¹æ³•çš„ä¸»è¦æ“ä½œæ˜¯â€œæ¨ç†â€ã€‚å½“ç»™å‡ºå‘¨å›´çš„å•è¯ï¼ˆä¸Šä¸‹æ–‡ï¼‰æ—¶ï¼Œé¢„æµ‹â€œï¼Ÿâ€å¤„ä¼šå‡ºç°ä»€ä¹ˆå•è¯ï¼Œè¿™å°±æ˜¯æ¨ç†ã€‚</p>
<p><img src="/../images/%E3%80%8A%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E8%BF%9B%E9%98%B6%EF%BC%9A%E8%87%AA%E7%84%B6%E8%AF%AD%E8%A8%80%E5%A4%84%E7%90%86%E3%80%8B%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/image_9BpxVzfK51.png"></p>
<h3 id="2-3-1-word2vec"><a href="#2-3-1-word2vec" class="headerlink" title="2.3.1 word2vec"></a>2.3.1 word2vec</h3><p>word2vec ä¸€è¯æœ€åˆç”¨æ¥æŒ‡ç¨‹åºæˆ–è€…å·¥å…·ï¼Œä½†æ˜¯éšç€è¯¥è¯çš„æµè¡Œï¼Œåœ¨æŸäº›è¯­å¢ƒä¸‹ï¼Œä¹ŸæŒ‡ç¥ç»ç½‘ç»œçš„æ¨¡å‹ã€‚</p>
<p>word2vec ä¸­ä½¿ç”¨çš„ä¸¤ä¸ªç¥ç»ç½‘ç»œåˆ†åˆ«æ˜¯CBOW æ¨¡å‹å’Œ skip-gram æ¨¡å‹</p>
<h4 id="2-3-1-1-CBOW-æ¨¡å‹"><a href="#2-3-1-1-CBOW-æ¨¡å‹" class="headerlink" title="2.3.1.1 CBOW æ¨¡å‹"></a>2.3.1.1 CBOW æ¨¡å‹</h4><p>continuous bag-of-wordsï¼ˆCBOWï¼‰è¿ç»­è¯è¢‹æ¨¡å‹</p>
<p><img src="/../images/%E3%80%8A%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E8%BF%9B%E9%98%B6%EF%BC%9A%E8%87%AA%E7%84%B6%E8%AF%AD%E8%A8%80%E5%A4%84%E7%90%86%E3%80%8B%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/image_tDuQKVJFk5.png"></p>
<blockquote>
<p>ä¸­é—´å±‚çš„ç¥ç»å…ƒæ•°é‡æ¯”è¾“å…¥å±‚å°‘è¿™ä¸€ç‚¹å¾ˆé‡è¦ã€‚ä¸­é—´å±‚éœ€è¦å°†é¢„æµ‹å•è¯æ‰€éœ€çš„ä¿¡æ¯å‹ç¼©ä¿å­˜ï¼Œä»è€Œäº§ç”Ÿå¯†é›†çš„å‘é‡è¡¨ç¤ºã€‚è¿™æ—¶ï¼Œä¸­é—´å±‚è¢«å†™å…¥äº†æˆ‘ä»¬äººç±»æ— æ³•è§£è¯»çš„ä»£ç ï¼Œè¿™ç›¸å½“äºâ€œç¼–ç â€å·¥ä½œã€‚è€Œä»ä¸­é—´å±‚çš„ä¿¡æ¯è·å¾—æœŸæœ›ç»“æœçš„è¿‡ç¨‹åˆ™ç§°ä¸ºâ€œè§£ç â€ã€‚è¿™ä¸€è¿‡ç¨‹å°†è¢«ç¼–ç çš„ä¿¡æ¯å¤åŸä¸ºæˆ‘ä»¬å¯ä»¥ç†è§£çš„å½¢å¼ã€‚</p>
</blockquote>
<hr>
<h5 id="2-3-1-1-1-CBOWæ¨¡å‹çš„å­¦ä¹ "><a href="#2-3-1-1-1-CBOWæ¨¡å‹çš„å­¦ä¹ " class="headerlink" title="2.3.1.1.1 CBOWæ¨¡å‹çš„å­¦ä¹ "></a>2.3.1.1.1 CBOWæ¨¡å‹çš„å­¦ä¹ </h5><p><img src="/../images/%E3%80%8A%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E8%BF%9B%E9%98%B6%EF%BC%9A%E8%87%AA%E7%84%B6%E8%AF%AD%E8%A8%80%E5%A4%84%E7%90%86%E3%80%8B%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/image_qsAFx46tbi.png"></p>
<p><img src="/../images/%E3%80%8A%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E8%BF%9B%E9%98%B6%EF%BC%9A%E8%87%AA%E7%84%B6%E8%AF%AD%E8%A8%80%E5%A4%84%E7%90%86%E3%80%8B%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/image_IJZAZJ2j13.png"></p>
<p>CBOWæ¨¡å‹åªæ˜¯å­¦ä¹ è¯­æ–™åº“ä¸­å•è¯çš„å‡ºç°æ¨¡å¼ã€‚å¦‚æœè¯­æ–™åº“ä¸ä¸€æ ·ï¼Œå­¦ä¹ åˆ°çš„å•è¯çš„åˆ†å¸ƒå¼è¡¨ç¤ºä¹Ÿä¸ä¸€æ ·ã€‚æ¯”å¦‚ï¼Œåªä½¿ç”¨â€œä½“è‚²â€ç›¸å…³çš„æ–‡ç« å¾—åˆ°çš„å•è¯çš„åˆ†å¸ƒå¼è¡¨ç¤ºï¼Œå’Œåªä½¿ç”¨â€œéŸ³ä¹â€ç›¸å…³çš„æ–‡ç« å¾—åˆ°çš„å•è¯çš„åˆ†å¸ƒå¼è¡¨ç¤ºå°†æœ‰å¾ˆå¤§ä¸åŒã€‚</p>
<h5 id="2-3-1-1-2-CBOWæŸå¤±å‡½æ•°"><a href="#2-3-1-1-2-CBOWæŸå¤±å‡½æ•°" class="headerlink" title="2.3.1.1.2 CBOWæŸå¤±å‡½æ•°"></a>2.3.1.1.2 CBOWæŸå¤±å‡½æ•°</h5><p><img src="/../images/%E3%80%8A%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E8%BF%9B%E9%98%B6%EF%BC%9A%E8%87%AA%E7%84%B6%E8%AF%AD%E8%A8%80%E5%A4%84%E7%90%86%E3%80%8B%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/image_8RkALBaVVW.png"></p>
<p>CBOW æ¨¡å‹å­¦ä¹ çš„ä»»åŠ¡å°±æ˜¯è®©æŸå¤±å‡½æ•°å°½å¯èƒ½åœ°å°ã€‚é‚£æ—¶çš„æƒé‡å‚æ•°å°±æ˜¯æˆ‘ä»¬æƒ³è¦çš„å•è¯çš„åˆ†å¸ƒå¼è¡¨ç¤ºã€‚</p>
<h4 id="2-3-1-2-word2vecçš„æƒé‡å’Œåˆ†å¸ƒå¼è¡¨ç¤º"><a href="#2-3-1-2-word2vecçš„æƒé‡å’Œåˆ†å¸ƒå¼è¡¨ç¤º" class="headerlink" title="2.3.1.2 word2vecçš„æƒé‡å’Œåˆ†å¸ƒå¼è¡¨ç¤º"></a>2.3.1.2 word2vecçš„æƒé‡å’Œåˆ†å¸ƒå¼è¡¨ç¤º</h4><p>word2vec ä¸­ä½¿ç”¨çš„ç½‘ç»œæœ‰ä¸¤ä¸ªæƒé‡ï¼Œåˆ†åˆ«æ˜¯è¾“å…¥ä¾§çš„å…¨è¿æ¥å±‚çš„æƒé‡ï¼ˆ$W_{in} $ï¼‰å’Œè¾“å‡ºä¾§çš„å…¨è¿æ¥å±‚çš„æƒé‡ï¼ˆ$W_{out} $ï¼‰ã€‚</p>
<p>å°± word2vecï¼ˆç‰¹åˆ«æ˜¯ skip-gram æ¨¡å‹ï¼‰è€Œè¨€ï¼Œæœ€å—æ¬¢è¿çš„æ˜¯åªä½¿ç”¨è¾“å…¥ä¾§çš„æƒé‡ã€‚</p>
<h3 id="2-3-2-skip-gramæ¨¡å‹"><a href="#2-3-2-skip-gramæ¨¡å‹" class="headerlink" title="2.3.2 skip-gramæ¨¡å‹"></a>2.3.2 skip-gramæ¨¡å‹</h3><p>skip-gram æ˜¯åè½¬äº† CBOW æ¨¡å‹å¤„ç†çš„ä¸Šä¸‹æ–‡å’Œç›®æ ‡è¯çš„æ¨¡å‹ã€‚</p>
<p><img src="/../images/%E3%80%8A%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E8%BF%9B%E9%98%B6%EF%BC%9A%E8%87%AA%E7%84%B6%E8%AF%AD%E8%A8%80%E5%A4%84%E7%90%86%E3%80%8B%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/image_NWBJQnGsQh.png"></p>
<p><img src="/../images/%E3%80%8A%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E8%BF%9B%E9%98%B6%EF%BC%9A%E8%87%AA%E7%84%B6%E8%AF%AD%E8%A8%80%E5%A4%84%E7%90%86%E3%80%8B%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/image_Nx1lhLuzli.png"></p>
<h1 id="3-word2vecçš„é«˜é€ŸåŒ–"><a href="#3-word2vecçš„é«˜é€ŸåŒ–" class="headerlink" title="3 word2vecçš„é«˜é€ŸåŒ–"></a>3 word2vecçš„é«˜é€ŸåŒ–</h1><p>TODO</p>
<h1 id="4-RNN"><a href="#4-RNN" class="headerlink" title="4 RNN"></a>4 RNN</h1><blockquote>
<p>å‰é¦ˆç¥ç»ç½‘ç»œFNNï¼šæœ€ç®€å•çš„ç½‘ç»œï¼Œå„ç¥ç»å…ƒåˆ†å±‚æ’åˆ—ï¼Œæ¯ä¸ªç¥ç»å…ƒåªä¸å‰ä¸€å±‚çš„ç¥ç»å…ƒç›¸è¿ã€‚æ¥æ”¶å‰ä¸€å±‚çš„è¾“å‡ºï¼Œå¹¶è¾“å‡ºç»™ä¸‹ä¸€å±‚ï¼Œå„å±‚é—´æ²¡æœ‰åé¦ˆ</p>
</blockquote>
<p>åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬çœ‹åˆ°çš„ç¥ç»ç½‘ç»œéƒ½æ˜¯å‰é¦ˆå‹ç¥ç»ç½‘ç»œã€‚è™½ç„¶å‰é¦ˆç½‘ç»œç»“æ„ç®€å•ã€æ˜“äºç†è§£ï¼Œä½†æ˜¯å¯ä»¥åº”ç”¨äºè®¸å¤šä»»åŠ¡ä¸­ã€‚ä¸è¿‡ï¼Œè¿™ç§ç½‘ç»œå­˜åœ¨ä¸€ä¸ªå¤§é—®é¢˜ï¼Œå°±æ˜¯ä¸èƒ½å¾ˆå¥½åœ°å¤„ç†æ—¶é—´åºåˆ—æ•°æ®ã€‚æ›´ç¡®åˆ‡åœ°è¯´ï¼Œå•çº¯çš„å‰é¦ˆç½‘ç»œæ— æ³•å……åˆ†å­¦ä¹ æ—¶åºæ•°æ®çš„æ€§è´¨ã€‚äºæ˜¯ï¼ŒRNNï¼ˆRecurrent Neural Networkï¼Œå¾ªç¯ç¥ç»ç½‘ç»œï¼‰ä¾¿åº”è¿è€Œç”Ÿã€‚</p>
<p><img src="/../images/%E3%80%8A%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E8%BF%9B%E9%98%B6%EF%BC%9A%E8%87%AA%E7%84%B6%E8%AF%AD%E8%A8%80%E5%A4%84%E7%90%86%E3%80%8B%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/image_SlgtJLs9XQ.png"></p>
<p>RNN çš„ç‰¹å¾å°±åœ¨äºæ‹¥æœ‰è¿™æ ·ä¸€ä¸ªç¯è·¯ã€‚è¿™ä¸ªç¯è·¯å¯ä»¥ä½¿æ•°æ®ä¸æ–­å¾ªç¯ã€‚é€šè¿‡æ•°æ®çš„å¾ªç¯ï¼ŒRNN ä¸€è¾¹è®°ä½è¿‡å»çš„æ•°æ®ï¼Œä¸€è¾¹æ›´æ–°åˆ°æœ€æ–°çš„æ•°æ®ã€‚</p>
<p><img src="/../images/%E3%80%8A%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E8%BF%9B%E9%98%B6%EF%BC%9A%E8%87%AA%E7%84%B6%E8%AF%AD%E8%A8%80%E5%A4%84%E7%90%86%E3%80%8B%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/image_OYNUHRviQU.png"></p>
<p>RNN æœ‰ä¸¤ä¸ªæƒé‡ï¼Œåˆ†åˆ«æ˜¯å°†è¾“å…¥ x è½¬åŒ–ä¸ºè¾“å‡º h çš„æƒé‡$  W_{x}  $å’Œå°†å‰ä¸€ä¸ª RNN å±‚çš„è¾“å‡ºè½¬åŒ–ä¸ºå½“å‰æ—¶åˆ»çš„è¾“å‡ºçš„æƒé‡ $W_{h}$ã€‚</p>
<p><img src="/../images/%E3%80%8A%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E8%BF%9B%E9%98%B6%EF%BC%9A%E8%87%AA%E7%84%B6%E8%AF%AD%E8%A8%80%E5%A4%84%E7%90%86%E3%80%8B%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/image_N7X68U_dRV.png" alt="RNNä¸‰ç»´è¡¨ç°" title="RNNä¸‰ç»´è¡¨ç°"></p>
<p>$$<br>\boldsymbol{h}<em>{t}=\tanh \left(\boldsymbol{h}</em>{t-1} \boldsymbol{W}<em>{h}+\boldsymbol{x}</em>{t} \boldsymbol{W}_{x}+\boldsymbol{b}\right)<br>$$</p>
<p>ä»å¦ä¸€ä¸ªè§’åº¦çœ‹ï¼Œè¿™å¯ä»¥è§£é‡Šä¸ºï¼ŒRNN å…·æœ‰â€œçŠ¶æ€â€$h$ï¼Œå¹¶ä»¥ä¸Šå¼çš„å½¢å¼è¢«æ›´æ–°ã€‚è¿™å°±æ˜¯è¯´RNNå±‚æ˜¯â€œå…·æœ‰çŠ¶æ€çš„å±‚â€æˆ–â€œå…·æœ‰å­˜å‚¨ï¼ˆè®°å¿†ï¼‰çš„å±‚â€çš„åŸå› ã€‚RNN çš„è¾“å‡º $h_{t}$ç§°ä¸º<strong>éšè—çŠ¶æ€</strong>æˆ–<strong>éšè—çŠ¶æ€å‘é‡</strong></p>
<p>RNNæœ‰ä¸¤ä¸ªæƒé‡ï¼š$W_{h}$å’Œ$W_{x}$</p>
<h2 id="4-1-Backpropagation-Through-Time"><a href="#4-1-Backpropagation-Through-Time" class="headerlink" title="4.1 Backpropagation Through Time"></a>4.1 Backpropagation Through Time</h2><p>RNNçš„è¯¯å·®åå‘ä¼ æ’­æ³•æ˜¯â€œæŒ‰æ—¶é—´é¡ºåºå±•å¼€çš„ç¥ç»ç½‘ç»œçš„è¯¯å·®åå‘ä¼ æ’­æ³•â€ï¼Œæ‰€ä»¥ç§°ä¸º Backpropagation Through Timeï¼ˆåŸºäºæ—¶é—´çš„åå‘ä¼ æ’­ï¼‰ï¼Œç®€ç§° BPTTã€‚</p>
<h3 id="4-1-1-Truncated-BPTT"><a href="#4-1-1-Truncated-BPTT" class="headerlink" title="4.1.1 Truncatedâ€ƒBPTT"></a>4.1.1 Truncatedâ€ƒBPTT</h3><p>åœ¨å¤„ç†é•¿æ—¶åºæ•°æ®æ—¶ï¼Œé€šå¸¸çš„åšæ³•æ˜¯å°†ç½‘ç»œè¿æ¥æˆªæˆé€‚å½“çš„é•¿åº¦ã€‚å…·ä½“æ¥è¯´ï¼Œå°±æ˜¯å°†æ—¶é—´è½´æ–¹å‘ä¸Šè¿‡é•¿çš„ç½‘ç»œåœ¨åˆé€‚çš„ä½ç½®è¿›è¡Œæˆªæ–­ï¼Œä»è€Œåˆ›å»ºå¤šä¸ªå°å‹ç½‘ç»œï¼Œç„¶åå¯¹æˆªå‡ºæ¥çš„å°å‹ç½‘ç»œæ‰§è¡Œè¯¯å·®åå‘ä¼ æ’­æ³•ï¼Œè¿™ä¸ªæ–¹æ³•ç§°ä¸º Truncated BPTTï¼ˆæˆªæ–­çš„ BPTTï¼‰ã€‚ </p>
<p><img src="/../images/%E3%80%8A%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E8%BF%9B%E9%98%B6%EF%BC%9A%E8%87%AA%E7%84%B6%E8%AF%AD%E8%A8%80%E5%A4%84%E7%90%86%E3%80%8B%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/image_elYrdSfgP7.png"></p>
<p>è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè™½ç„¶åå‘ä¼ æ’­çš„è¿æ¥ä¼šè¢«æˆªæ–­ï¼Œä½†æ˜¯æ­£å‘ä¼ æ’­çš„è¿æ¥ä¸ä¼šã€‚</p>
<h2 id="4-2-RNNåå‘ä¼ æ’­"><a href="#4-2-RNNåå‘ä¼ æ’­" class="headerlink" title="4.2 RNNåå‘ä¼ æ’­"></a>4.2 RNNåå‘ä¼ æ’­</h2><p><img src="/../images/%E3%80%8A%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E8%BF%9B%E9%98%B6%EF%BC%9A%E8%87%AA%E7%84%B6%E8%AF%AD%E8%A8%80%E5%A4%84%E7%90%86%E3%80%8B%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/image_0FJeCOAdIc.png" alt="RNNæ­£å‘ä¼ æ’­" title="RNNæ­£å‘ä¼ æ’­"></p>
<hr>
<p><img src="/../images/%E3%80%8A%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E8%BF%9B%E9%98%B6%EF%BC%9A%E8%87%AA%E7%84%B6%E8%AF%AD%E8%A8%80%E5%A4%84%E7%90%86%E3%80%8B%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/image_U92MnE7C6K.png" alt="RNNåå‘ä¼ æ’­" title="RNNåå‘ä¼ æ’­"></p>
<h2 id="4-3-RNNLM"><a href="#4-3-RNNLM" class="headerlink" title="4.3  RNNLM"></a>4.3  RNNLM</h2><p>åŸºäº RNN çš„è¯­è¨€æ¨¡å‹ç§°ä¸º RNNLMï¼ˆRNN Language Modelï¼ŒRNN è¯­è¨€æ¨¡å‹ï¼‰</p>
<p><img src="/../images/%E3%80%8A%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E8%BF%9B%E9%98%B6%EF%BC%9A%E8%87%AA%E7%84%B6%E8%AF%AD%E8%A8%80%E5%A4%84%E7%90%86%E3%80%8B%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/image_CkpsNamznS.png"></p>
<p><img src="/../images/%E3%80%8A%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E8%BF%9B%E9%98%B6%EF%BC%9A%E8%87%AA%E7%84%B6%E8%AF%AD%E8%A8%80%E5%A4%84%E7%90%86%E3%80%8B%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/image_tfhaOlgpid.png"></p>
<p> Embedding å±‚ï¼šå°†å•è¯ ID è½¬åŒ–ä¸ºå•è¯çš„åˆ†å¸ƒå¼è¡¨ç¤ºï¼ˆå•è¯å‘é‡ï¼‰</p>
<h3 id="4-3-1-æ¢¯åº¦æ¶ˆå¤±å’Œæ¢¯åº¦çˆ†ç‚¸"><a href="#4-3-1-æ¢¯åº¦æ¶ˆå¤±å’Œæ¢¯åº¦çˆ†ç‚¸" class="headerlink" title="4.3.1 æ¢¯åº¦æ¶ˆå¤±å’Œæ¢¯åº¦çˆ†ç‚¸"></a>4.3.1 æ¢¯åº¦æ¶ˆå¤±å’Œæ¢¯åº¦çˆ†ç‚¸</h3><blockquote>
<p>RNN å±‚é€šè¿‡å‘è¿‡å»ä¼ é€’â€œæœ‰æ„ä¹‰çš„æ¢¯åº¦â€ï¼Œèƒ½å¤Ÿå­¦ä¹ æ—¶é—´æ–¹å‘ä¸Šçš„ä¾èµ–å…³ç³»ã€‚æ­¤æ—¶æ¢¯åº¦ï¼ˆç†è®ºä¸Šï¼‰åŒ…å«äº†é‚£äº›åº”è¯¥å­¦åˆ°çš„æœ‰æ„ä¹‰çš„ä¿¡æ¯ï¼Œé€šè¿‡å°†è¿™äº›ä¿¡æ¯å‘è¿‡å»ä¼ é€’ï¼ŒRNN å±‚å­¦ä¹ é•¿æœŸçš„ä¾èµ–å…³ç³»ã€‚ä½†æ˜¯ï¼Œå¦‚æœè¿™ä¸ªæ¢¯åº¦åœ¨ä¸­é€”å˜å¼±ï¼ˆç”šè‡³æ²¡æœ‰åŒ…å«ä»»ä½•ä¿¡æ¯ï¼‰ï¼Œåˆ™æƒé‡å‚æ•°å°†ä¸ä¼šè¢«æ›´æ–°ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒRNN å±‚æ— æ³•å­¦ä¹ é•¿æœŸçš„ä¾èµ–å…³ç³»ã€‚ä¸å¹¸çš„æ˜¯ï¼Œéšç€æ—¶é—´çš„å›æº¯ï¼Œè¿™ä¸ªç®€å• RNN æœªèƒ½é¿å…æ¢¯åº¦å˜å°ï¼ˆæ¢¯åº¦æ¶ˆå¤±ï¼‰æˆ–è€…æ¢¯åº¦å˜å¤§ï¼ˆæ¢¯åº¦çˆ†ç‚¸ï¼‰çš„å‘½è¿ã€‚</p>
</blockquote>
<p><img src="/../images/%E3%80%8A%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E8%BF%9B%E9%98%B6%EF%BC%9A%E8%87%AA%E7%84%B6%E8%AF%AD%E8%A8%80%E5%A4%84%E7%90%86%E3%80%8B%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/image_TXW0mkOOdJ.png"></p>
<p><img src="/../images/%E3%80%8A%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E8%BF%9B%E9%98%B6%EF%BC%9A%E8%87%AA%E7%84%B6%E8%AF%AD%E8%A8%80%E5%A4%84%E7%90%86%E3%80%8B%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/image_Susys1EeV1.png"></p>
<p>å½“åå‘ä¼ æ’­çš„æ¢¯åº¦ç»è¿‡tanh èŠ‚ç‚¹æ—¶ï¼Œå®ƒçš„å€¼ä¼šè¶Šæ¥è¶Šå°ã€‚å› æ­¤ï¼Œå¦‚æœç»è¿‡ tanh å‡½æ•° T æ¬¡ï¼Œåˆ™æ¢¯åº¦ä¹Ÿä¼šå‡å° T æ¬¡ã€‚</p>
<blockquote>
<p>RNN å±‚çš„æ¿€æ´»å‡½æ•°ä¸€èˆ¬ä½¿ç”¨ tanh å‡½æ•°ï¼Œä½†æ˜¯å¦‚æœæ”¹ä¸º ReLU å‡½æ•°ï¼Œåˆ™æœ‰å¸Œæœ›æŠ‘åˆ¶æ¢¯åº¦æ¶ˆå¤±çš„é—®é¢˜ï¼ˆå½“ ReLU çš„è¾“å…¥ä¸º x æ—¶ï¼Œå®ƒçš„è¾“å‡ºæ˜¯max(0, x)ï¼‰ã€‚è¿™æ˜¯å› ä¸ºï¼Œåœ¨ ReLU çš„æƒ…å†µä¸‹ï¼Œå½“ x å¤§äº 0 æ—¶ï¼Œåå‘ä¼ æ’­å°†ä¸Šæ¸¸çš„æ¢¯åº¦åŸæ ·ä¼ é€’åˆ°ä¸‹æ¸¸ï¼Œæ¢¯åº¦ä¸ä¼šâ€œé€€åŒ–â€ã€‚</p>
</blockquote>
<h2 id="4-4-Gated-RNN"><a href="#4-4-Gated-RNN" class="headerlink" title="4.4 Gated RNN"></a>4.4 Gated RNN</h2><p>ä¸Šæ–‡æåˆ°çš„RNN ä¸æ“…é•¿å­¦ä¹ æ—¶åºæ•°æ®çš„é•¿æœŸä¾èµ–å…³ç³»ï¼ŒåŸå› æ˜¯ BPTT ä¼šå‘ç”Ÿæ¢¯åº¦æ¶ˆå¤±å’Œæ¢¯åº¦çˆ†ç‚¸çš„é—®é¢˜ã€‚</p>
<p>å½“æˆ‘ä»¬è¯´ RNN æ—¶ï¼Œæ›´å¤šçš„æ˜¯æŒ‡ LSTM å±‚ï¼Œè€Œä¸æ˜¯ä¸Šä¸€ç« çš„ RNNã€‚</p>
<p><img src="/../images/%E3%80%8A%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E8%BF%9B%E9%98%B6%EF%BC%9A%E8%87%AA%E7%84%B6%E8%AF%AD%E8%A8%80%E5%A4%84%E7%90%86%E3%80%8B%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/image_T4L3lbsK4w.png"></p>
<p>LSTM ä¸ RNN çš„æ¥å£çš„ä¸åŒä¹‹å¤„åœ¨äºï¼ŒLSTM è¿˜æœ‰è·¯å¾„ cã€‚è¿™ä¸ª c ç§°ä¸ºè®°å¿†å•å…ƒï¼ˆæˆ–è€…ç®€ç§°ä¸ºâ€œå•å…ƒâ€ï¼‰ï¼Œç›¸å½“äº LSTM ä¸“ç”¨çš„è®°å¿†éƒ¨é—¨ã€‚</p>
<p>è®°å¿†å•å…ƒçš„ç‰¹ç‚¹æ˜¯ï¼Œä»…åœ¨ LSTM å±‚å†…éƒ¨æ¥æ”¶å’Œä¼ é€’æ•°æ®ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œè®°å¿†å•å…ƒåœ¨ LSTM å±‚å†…éƒ¨ç»“æŸå·¥ä½œï¼Œä¸å‘å…¶ä»–å±‚è¾“å‡ºã€‚è€Œ LSTM çš„éšè—çŠ¶æ€ h å’Œ RNN å±‚ç›¸åŒï¼Œä¼šè¢«ï¼ˆå‘ä¸Šï¼‰è¾“å‡ºåˆ°å…¶ä»–å±‚ã€‚</p>
<h2 id="4-5-LSTM"><a href="#4-5-LSTM" class="headerlink" title="4.5 LSTM"></a>4.5 LSTM</h2><h3 id="4-5-1-è¾“å‡ºé—¨"><a href="#4-5-1-è¾“å‡ºé—¨" class="headerlink" title="4.5.1 è¾“å‡ºé—¨"></a>4.5.1 è¾“å‡ºé—¨</h3><p><img src="/../images/%E3%80%8A%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E8%BF%9B%E9%98%B6%EF%BC%9A%E8%87%AA%E7%84%B6%E8%AF%AD%E8%A8%80%E5%A4%84%E7%90%86%E3%80%8B%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/image_SOAi8mJDjY.png"></p>
<p><img src="/../images/%E3%80%8A%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E8%BF%9B%E9%98%B6%EF%BC%9A%E8%87%AA%E7%84%B6%E8%AF%AD%E8%A8%80%E5%A4%84%E7%90%86%E3%80%8B%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/image_J8SXWBJc3n.png"></p>
<p><img src="/../images/%E3%80%8A%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E8%BF%9B%E9%98%B6%EF%BC%9A%E8%87%AA%E7%84%B6%E8%AF%AD%E8%A8%80%E5%A4%84%E7%90%86%E3%80%8B%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/image_kYPB-1QNDR.png"></p>
<blockquote>
<p>sigmoid å‡½æ•°ç”¨ $Ïƒ()$ è¡¨ç¤º</p>
</blockquote>
<blockquote>
<p>tanhçš„è¾“å‡ºæ˜¯âˆ’1.0 ~ 1.0çš„å®æ•°ã€‚æˆ‘ä»¬å¯ä»¥è®¤ä¸ºè¿™ä¸ªâˆ’1.0 ~ 1.0çš„æ•°å€¼è¡¨ç¤ºæŸç§è¢«ç¼–ç çš„â€œä¿¡æ¯â€çš„å¼ºå¼±ï¼ˆç¨‹åº¦ï¼‰ã€‚è€Œsigmoid å‡½æ•°çš„è¾“å‡ºæ˜¯0.0~1.0çš„å®æ•°ï¼Œè¡¨ç¤ºæ•°æ®æµå‡ºçš„æ¯”ä¾‹ã€‚å› æ­¤ï¼Œåœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œé—¨ä½¿ç”¨sigmoidå‡½æ•°ä½œä¸ºæ¿€æ´»å‡½æ•°ï¼Œè€ŒåŒ…å«å®è´¨ä¿¡æ¯çš„æ•°æ®åˆ™ä½¿ç”¨tanhå‡½æ•°ä½œä¸ºæ¿€æ´»å‡½æ•°ã€‚</p>
</blockquote>
<h3 id="4-5-2-é—å¿˜é—¨"><a href="#4-5-2-é—å¿˜é—¨" class="headerlink" title="4.5.2 é—å¿˜é—¨"></a>4.5.2 é—å¿˜é—¨</h3><p><img src="/../images/%E3%80%8A%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E8%BF%9B%E9%98%B6%EF%BC%9A%E8%87%AA%E7%84%B6%E8%AF%AD%E8%A8%80%E5%A4%84%E7%90%86%E3%80%8B%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/image_YIl0qmaVTK.png"></p>
<h3 id="4-5-3-æ–°çš„è®°å¿†å•å…ƒ"><a href="#4-5-3-æ–°çš„è®°å¿†å•å…ƒ" class="headerlink" title="4.5.3 æ–°çš„è®°å¿†å•å…ƒ"></a>4.5.3 æ–°çš„è®°å¿†å•å…ƒ</h3><p><img src="/../images/%E3%80%8A%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E8%BF%9B%E9%98%B6%EF%BC%9A%E8%87%AA%E7%84%B6%E8%AF%AD%E8%A8%80%E5%A4%84%E7%90%86%E3%80%8B%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/image_h4Nin6H2kA.png"></p>
<p><img src="/../images/%E3%80%8A%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E8%BF%9B%E9%98%B6%EF%BC%9A%E8%87%AA%E7%84%B6%E8%AF%AD%E8%A8%80%E5%A4%84%E7%90%86%E3%80%8B%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/image_J-HmVurGyH.png"></p>
<h3 id="4-5-4-è¾“å…¥é—¨"><a href="#4-5-4-è¾“å…¥é—¨" class="headerlink" title="4.5.4 è¾“å…¥é—¨"></a>4.5.4 è¾“å…¥é—¨</h3><p><img src="/../images/%E3%80%8A%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E8%BF%9B%E9%98%B6%EF%BC%9A%E8%87%AA%E7%84%B6%E8%AF%AD%E8%A8%80%E5%A4%84%E7%90%86%E3%80%8B%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/image_ThsOkpY5xe.png"></p>
<p><img src="/../images/%E3%80%8A%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E8%BF%9B%E9%98%B6%EF%BC%9A%E8%87%AA%E7%84%B6%E8%AF%AD%E8%A8%80%E5%A4%84%E7%90%86%E3%80%8B%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/image_soLXg37NZ1.png"></p>
<h3 id="4-5-5-LSTMçš„å®ç°"><a href="#4-5-5-LSTMçš„å®ç°" class="headerlink" title="4.5.5 LSTMçš„å®ç°"></a>4.5.5 LSTMçš„å®ç°</h3><p><img src="/../images/%E3%80%8A%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E8%BF%9B%E9%98%B6%EF%BC%9A%E8%87%AA%E7%84%B6%E8%AF%AD%E8%A8%80%E5%A4%84%E7%90%86%E3%80%8B%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/image_cQJVJXL5NX.png"></p>
<p>ç®€åŒ–åï¼š</p>
<p><img src="/../images/%E3%80%8A%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E8%BF%9B%E9%98%B6%EF%BC%9A%E8%87%AA%E7%84%B6%E8%AF%AD%E8%A8%80%E5%A4%84%E7%90%86%E3%80%8B%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/image_N71KUQFLnj.png"></p>
<h1 id="5-Attention"><a href="#5-Attention" class="headerlink" title="5 Attention"></a>5 Attention</h1><h2 id="5-1-seq2seqæ”¹è¿›"><a href="#5-1-seq2seqæ”¹è¿›" class="headerlink" title="5.1 seq2seqæ”¹è¿›"></a>5.1 seq2seqæ”¹è¿›</h2><p>seq2seqå­˜åœ¨çš„é—®é¢˜ï¼šæ— è®ºè¾“å…¥è¯­å¥å¤šé•¿ï¼Œç¼–ç å™¨éƒ½å°†å…¶å¡å…¥å›ºå®šé•¿åº¦çš„å‘é‡ä¸­ï¼Œæœ‰ç”¨çš„ä¿¡æ¯ä¹Ÿä¼šä»å‘é‡ä¸­æº¢å‡ºã€‚</p>
<h3 id="5-1-1-ç¼–ç å™¨ä¼˜åŒ–"><a href="#5-1-1-ç¼–ç å™¨ä¼˜åŒ–" class="headerlink" title="5.1.1 ç¼–ç å™¨ä¼˜åŒ–"></a>5.1.1 ç¼–ç å™¨ä¼˜åŒ–</h3><p><img src="/../images/%E3%80%8A%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E8%BF%9B%E9%98%B6%EF%BC%9A%E8%87%AA%E7%84%B6%E8%AF%AD%E8%A8%80%E5%A4%84%E7%90%86%E3%80%8B%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/image_7o88_Ids4Y.png"></p>
<p>ä½¿ç”¨å„ä¸ªæ—¶åˆ»ï¼ˆå„ä¸ªå•è¯ï¼‰çš„éšè—çŠ¶æ€å‘é‡ï¼Œå¯ä»¥è·å¾—å’Œè¾“å…¥çš„å•è¯æ•°ç›¸åŒæ•°é‡çš„å‘é‡ã€‚</p>
<p>ç¼–ç å™¨è¾“å‡ºçš„ $h_{s}$ çŸ©é˜µå°±å¯ä»¥è§†ä¸ºå„ä¸ªå•è¯å¯¹åº”çš„å‘é‡é›†åˆã€‚</p>
<p>è¿™æ ·ä¸€æ¥ï¼Œç¼–ç å™¨å°±æ‘†è„±äº†â€œä¸€ä¸ªå›ºå®šé•¿åº¦çš„å‘é‡â€çš„åˆ¶çº¦ã€‚</p>
<h3 id="5-1-2-è§£ç å™¨çš„æ”¹è¿›"><a href="#5-1-2-è§£ç å™¨çš„æ”¹è¿›" class="headerlink" title="5.1.2 è§£ç å™¨çš„æ”¹è¿›"></a>5.1.2 è§£ç å™¨çš„æ”¹è¿›</h3><p><img src="/../images/%E3%80%8A%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E8%BF%9B%E9%98%B6%EF%BC%9A%E8%87%AA%E7%84%B6%E8%AF%AD%E8%A8%80%E5%A4%84%E7%90%86%E3%80%8B%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/image_bSlinKoTI_.png"></p>
<hr>
<p><img src="/../images/%E3%80%8A%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E8%BF%9B%E9%98%B6%EF%BC%9A%E8%87%AA%E7%84%B6%E8%AF%AD%E8%A8%80%E5%A4%84%E7%90%86%E3%80%8B%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/image_HLsC5sqpbj.png"></p>
<p>ç½‘ç»œæ‰€åšçš„å·¥ä½œæ˜¯æå–å•è¯å¯¹é½ä¿¡æ¯ã€‚å…·ä½“æ¥è¯´ï¼Œå°±æ˜¯ä» $h_{s}$ ä¸­é€‰å‡ºä¸å„ä¸ªæ—¶åˆ»è§£ç å™¨è¾“å‡ºçš„å•è¯æœ‰å¯¹åº”å…³ç³»çš„å•è¯å‘é‡ã€‚ä½†æ˜¯â€œé€‰æ‹©â€è¿™ä¸€æ“ä½œæ˜¯ä¸å¯å¾®åˆ†çš„ï¼Œè¿™é‡Œä½¿ç”¨äº†å•è¯é‡è¦åº¦çš„æƒé‡$a$ï¼Œè®¡ç®—$a$å’Œ$h_{s}$ åŠ æƒå’Œå¯ä»¥è·å¾—ç›®æ ‡å‘é‡ï¼š</p>
<p><img src="/../images/%E3%80%8A%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E8%BF%9B%E9%98%B6%EF%BC%9A%E8%87%AA%E7%84%B6%E8%AF%AD%E8%A8%80%E5%A4%84%E7%90%86%E3%80%8B%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/image_q4blJe5wuo.png"></p>
<p>ä¸Šä¸‹æ–‡å‘é‡ c ä¸­åŒ…å«äº†å½“å‰æ—¶åˆ»è¿›è¡Œå˜æ¢ï¼ˆç¿»è¯‘ï¼‰æ‰€éœ€çš„ä¿¡æ¯ã€‚æ›´ç¡®åˆ‡åœ°è¯´ï¼Œæ¨¡å‹è¦ä»æ•°æ®ä¸­å­¦ä¹ å‡ºè¿™ç§èƒ½åŠ›ã€‚ </p>
<hr>
<p><strong>å¦‚ä½•è·å–</strong>$a$<strong>ï¼Ÿ</strong></p>
<p><img src="/../images/%E3%80%8A%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E8%BF%9B%E9%98%B6%EF%BC%9A%E8%87%AA%E7%84%B6%E8%AF%AD%E8%A8%80%E5%A4%84%E7%90%86%E3%80%8B%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/image_P7kOhf1xaa.png"></p>
<p><img src="/../images/%E3%80%8A%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E8%BF%9B%E9%98%B6%EF%BC%9A%E8%87%AA%E7%84%B6%E8%AF%AD%E8%A8%80%E5%A4%84%E7%90%86%E3%80%8B%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/image_onuLtYwAEz.png"></p>
<p> $h$ è¡¨ç¤ºè§£ç å™¨çš„ LSTM å±‚çš„éšè—çŠ¶æ€å‘é‡ï¼Œç”¨$h$å’Œ$h_{s}$çš„å†…ç§¯è¡¨ç¤ºè¿™ä¸ª h åœ¨å¤šå¤§ç¨‹åº¦ä¸Šå’Œ hs çš„å„ä¸ªå•è¯å‘é‡â€œç›¸ä¼¼â€ï¼Œå¹¶å°†å…¶ç»“æœè¡¨ç¤ºä¸º sï¼Œæ­£åˆ™åŒ–åå°±å¾—åˆ°äº†a</p>
<p><img src="/../images/%E3%80%8A%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E8%BF%9B%E9%98%B6%EF%BC%9A%E8%87%AA%E7%84%B6%E8%AF%AD%E8%A8%80%E5%A4%84%E7%90%86%E3%80%8B%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/image_lSZYS8dvFC.png"></p>
<h3 id="5-1-3-Attentionç»“æ„"><a href="#5-1-3-Attentionç»“æ„" class="headerlink" title="5.1.3 Attentionç»“æ„"></a>5.1.3 Attentionç»“æ„</h3><p>æ€»ç»“ï¼š</p>
<p><img src="/../images/%E3%80%8A%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E8%BF%9B%E9%98%B6%EF%BC%9A%E8%87%AA%E7%84%B6%E8%AF%AD%E8%A8%80%E5%A4%84%E7%90%86%E3%80%8B%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/image_XPq89glvv-.png"></p>
<p><img src="/../images/%E3%80%8A%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E8%BF%9B%E9%98%B6%EF%BC%9A%E8%87%AA%E7%84%B6%E8%AF%AD%E8%A8%80%E5%A4%84%E7%90%86%E3%80%8B%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/image_ZxHnftpiMc.png"></p>
<p>æˆ‘ä»¬ä¸Šé¢å¯¹seq2seqçš„ä¼˜åŒ–å®é™…å°±æ˜¯åŠ äº†ä¸€å±‚Attentionå±‚ï¼š</p>
<p><img src="/../images/%E3%80%8A%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E8%BF%9B%E9%98%B6%EF%BC%9A%E8%87%AA%E7%84%B6%E8%AF%AD%E8%A8%80%E5%A4%84%E7%90%86%E3%80%8B%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/image_wE13ZakECp.png"></p>
<hr>
]]></content>
      <categories>
        <category>AI</category>
      </categories>
      <tags>
        <tag>NLP</tag>
      </tags>
  </entry>
  <entry>
    <title>ThreadPoolExecutorè¯¦è§£</title>
    <url>/2024/09/13/ThreadPoolExecutor%E8%AF%A6%E8%A7%A3/</url>
    <content><![CDATA[<h1 id="ThreadPoolExecutoræºç é˜…è¯»"><a href="#ThreadPoolExecutoræºç é˜…è¯»" class="headerlink" title="ThreadPoolExecutoræºç é˜…è¯»"></a>ThreadPoolExecutoræºç é˜…è¯»</h1><blockquote>
<p>æœ€è¿‘åœ¨å‡†å¤‡ç§‹æ‹›ï¼Œå¤ä¹ çº¿ç¨‹æ± ç›¸å…³çŸ¥è¯†ç‚¹çš„æ—¶å€™çœ‹åˆ°äº†å‡ ä¸ªæ¯”è¾ƒæœ‰æ„æ€çš„é¢è¯•é¢˜ï¼š</p>
<ul>
<li>çº¿ç¨‹æ± æ‰§è¡Œä»»åŠ¡çš„æ—¶å€™ï¼Œä¸æ˜¾ç¤ºçš„è¿›è¡Œå¼‚å¸¸æ•è·ï¼Œä»»åŠ¡æ‰§è¡Œé‡åˆ°å¼‚å¸¸ä¼šæ€ä¹ˆæ ·ï¼Ÿçº¿ç¨‹ä¼šå´©æºƒå—ï¼Ÿ</li>
<li>ä¸ºä»€ä¹ˆé˜Ÿåˆ—æ»¡äº†å†è¿›è¡Œåˆ›å»ºæ™®é€šçº¿ç¨‹æ‰§è¡Œä»»åŠ¡ï¼Ÿ</li>
</ul>
</blockquote>
<p>çœ‹åˆ°è¿™ä¸¤ä¸ªé—®é¢˜æˆ‘çœ‹åˆ°çš„æ—¶å€™å°±å‘ç°è¿™å—æ˜¯è‡ªå·±çŸ¥è¯†ç›²åŒºï¼Œä¸è¯»æºç æˆ‘è§‰å¾—æ˜¯æä¸æ˜ç™½çš„ğŸ¤¨ï¼Œå› æ­¤æœ¬æ–‡ä»¥æ­¤é—®é¢˜ä¸ºåˆ‡å…¥ç‚¹æ¥è¯»è¯»ThreadPoolExecutorçš„æ ¸å¿ƒæºä»£ç </p>
<h2 id="1-Executor-ä½“ç³»"><a href="#1-Executor-ä½“ç³»" class="headerlink" title="1 Executor ä½“ç³»"></a>1 Executor ä½“ç³»</h2><p>åœ¨é˜…è¯»æºç ä¹‹å‰ï¼Œæœ€å¥½å…ˆç†Ÿæ‚‰ä¸€ä¸‹æ•´ä¸ªç›¸å…³ä½“ç³»ï¼Œå¯ä»¥è®©æˆ‘ä»¬æœ‰ä¸€ä¸ªå…¨å±€è§‚ï¼Œä¸å®¹æ˜“è¢«å¸¦åï¼ˆä¸ªäººçš„ä¸€ç‚¹å¿ƒå¾—ï¼‰</p>
<p><img src="/../images/ThreadPoolExecutor%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/image_TfZn6_FFY5.png"></p>
<p>ExecutorServiceæä¾›äº†çº¿ç¨‹æ± çš„é¡¶çº§æŠ½è±¡ï¼Œä»¥ä¸‹æ˜¯å®ƒçš„æ ¸å¿ƒæ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Executor</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(Runnable command)</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ExecutorService</span> <span class="keyword">extends</span> <span class="title class_">Executor</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">shutdown</span><span class="params">()</span>;</span><br><span class="line">    </span><br><span class="line">    List&lt;Runnable&gt; <span class="title function_">shutdownNow</span><span class="params">()</span>; </span><br><span class="line">    </span><br><span class="line">    &lt;T&gt; Future&lt;T&gt; <span class="title function_">submit</span><span class="params">(Callable&lt;T&gt; task)</span>;</span><br><span class="line">    </span><br><span class="line">    &lt;T&gt; Future&lt;T&gt; <span class="title function_">submit</span><span class="params">(Callable&lt;T&gt; task)</span>;</span><br><span class="line">    </span><br><span class="line">    Future&lt;?&gt; submit(Runnable task);</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h2 id="2-ThreadPoolExecutoræºç "><a href="#2-ThreadPoolExecutoræºç " class="headerlink" title="2 ThreadPoolExecutoræºç "></a>2 ThreadPoolExecutoræºç </h2><h3 id="2-1-Execute"><a href="#2-1-Execute" class="headerlink" title="2.1 Execute()"></a><code>2.1 Execute()</code></h3><p>ThreadPoolExecutorå¯¹ExecutorServiceçš„æ–¹æ³•åšäº†å®ç°ï¼Œä½¿ç”¨<code>execute()</code>æ–¹æ³•æäº¤ä¸€ä¸ªä»»åŠ¡ã€‚</p>
<p>æˆ‘ä»¬ä»æºç åˆ†æä¸€ä¸‹çº¿ç¨‹æ± çš„ä»»åŠ¡æ‰§è¡Œæµç¨‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// è¿™ä¸ªå˜é‡å¾ˆå·§å¦™ï¼ŒåŒæ—¶å­˜æ”¾äº†çº¿ç¨‹æ± çš„è¿è¡ŒçŠ¶æ€ (runState) å’Œçº¿ç¨‹æ± å†…æœ‰æ•ˆçº¿ç¨‹çš„æ•°é‡ (workerCount)</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">AtomicInteger</span> <span class="variable">ctl</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>(ctlOf(RUNNING, <span class="number">0</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">workerCountOf</span><span class="params">(<span class="type">int</span> c)</span> {</span><br><span class="line">    <span class="keyword">return</span> c &amp; CAPACITY;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">//ä»»åŠ¡é˜Ÿåˆ—</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> BlockingQueue&lt;Runnable&gt; workQueue;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(Runnable command)</span> {</span><br><span class="line">    <span class="comment">// å¦‚æœä»»åŠ¡ä¸ºnullï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ã€‚</span></span><br><span class="line">    <span class="keyword">if</span> (command == <span class="literal">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>();</span><br><span class="line">    <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> ctl.get();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1. å½“å‰çº¿ç¨‹æ•°é‡ &lt; corePoolSize </span></span><br><span class="line">    <span class="comment">// é€šè¿‡addWorker(command, true)æ–°å»ºä¸€ä¸ªçº¿ç¨‹ï¼Œå°†ä»»åŠ¡æ·»åŠ åˆ°è¯¥çº¿ç¨‹ä¸­å¹¶æ‰§è¡Œ</span></span><br><span class="line">    <span class="keyword">if</span> (workerCountOf(c) &lt; corePoolSize) {</span><br><span class="line">        <span class="keyword">if</span> (addWorker(command, <span class="literal">true</span>))</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        c = ctl.get();</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// 2. å½“å‰çº¿ç¨‹æ•°é‡ &gt; corePoolSize </span></span><br><span class="line">    <span class="comment">// å°è¯•å°†ä»»åŠ¡åŠ å…¥é˜Ÿåˆ—ï¼Œå¦‚æœå·¥ä½œé˜Ÿåˆ—æœªæ»¡åˆ™åŠ å…¥æˆåŠŸ</span></span><br><span class="line">    <span class="keyword">if</span> (isRunning(c) &amp;&amp; workQueue.offer(command)) {</span><br><span class="line">        <span class="type">int</span> <span class="variable">recheck</span> <span class="operator">=</span> ctl.get();</span><br><span class="line">        <span class="comment">// å†æ¬¡è·å–çº¿ç¨‹æ± çŠ¶æ€ï¼Œå¦‚æœä¸æ˜¯ RUNNING çŠ¶æ€å°±éœ€è¦ä»ä»»åŠ¡é˜Ÿåˆ—ä¸­ç§»é™¤ä»»åŠ¡ï¼Œå¹¶å°è¯•åˆ¤æ–­çº¿ç¨‹æ˜¯å¦å…¨éƒ¨æ‰§è¡Œå®Œæ¯•ã€‚åŒæ—¶æ‰§è¡Œæ‹’ç»ç­–ç•¥ã€‚</span></span><br><span class="line">        <span class="keyword">if</span> (!isRunning(recheck) &amp;&amp; remove(command))</span><br><span class="line">            reject(command);</span><br><span class="line">            <span class="comment">// å¦‚æœå½“å‰å·¥ä½œçº¿ç¨‹æ•°é‡ä¸º0ï¼Œæ–°åˆ›å»ºä¸€ä¸ªçº¿ç¨‹å¹¶æ‰§è¡Œã€‚</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (workerCountOf(recheck) == <span class="number">0</span>)</span><br><span class="line">            addWorker(<span class="literal">null</span>, <span class="literal">false</span>);</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">     <span class="comment">// 3.é˜Ÿåˆ—å·²æ»¡åå°è¯•æ·»åŠ worker</span></span><br><span class="line">    <span class="comment">// æ³¨æ„è¿™é‡Œæ˜¯å…ˆæ‰§è¡ŒaddWorkerå†åˆ¤æ–­ï¼Œå¦‚æœaddWorkerè¿”å›falseï¼ˆæ„å‘³ç€å½“å‰çº¿ç¨‹æ•°è¶…è¿‡maxï¼‰æ‰ä¼šèµ°æ‹’ç»ç­–ç•¥ </span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (!addWorker(command, <span class="literal">false</span>))</span><br><span class="line">        <span class="comment">// 4.é˜Ÿåˆ—å·²æ»¡ä¸”æ— æ³•æ·»åŠ çº¿ç¨‹å°†ä¼šæ‹’ç»</span></span><br><span class="line">        reject(command);  </span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>æ ¹æ®ä¸Šé¢çš„æºç ï¼Œçº¿ç¨‹æ± å¤§è‡´æäº¤ä»»åŠ¡çš„æµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="/../images/ThreadPoolExecutor%E8%AF%A6%E8%A7%A3/image_UPNOPts0OI.png"></p>
<p>æ€»ç»“ä¸€ä¸‹å°±æ˜¯ï¼š</p>
<ol>
<li>å¦‚æœå½“å‰æ ¸å¿ƒçº¿ç¨‹æœ‰ç©ºé—²ï¼Œå°±å°†ä»»åŠ¡åˆ†é…ç»™æ ¸å¿ƒçº¿ç¨‹æ‰§è¡Œï¼›</li>
<li>å¦‚æœæ ¸å¿ƒçº¿ç¨‹æ»¡äº†ï¼Œå°±å°†ä»»åŠ¡æš‚æ—¶æ”¾åœ¨å·¥ä½œé˜Ÿåˆ—ä¸­ï¼›</li>
<li>å¦‚æœå·¥ä½œé˜Ÿåˆ—ä¹Ÿæ»¡äº†ï¼Œåˆ›å»ºæ™®é€šçº¿ç¨‹æ¥æ‰§è¡Œä»»åŠ¡ï¼Œæ ¸å¿ƒ+æ™®é€šçº¿ç¨‹çš„æ•°é‡ä¸è¶…è¿‡maxPoolï¼›</li>
<li>å¦‚æœéƒ½ä¸è¡Œï¼Œå°±æ‰§è¡Œæ‹’ç»ç­–ç•¥</li>
</ol>
<h3 id="2-2-addWorker"><a href="#2-2-addWorker" class="headerlink" title="2.2 addWorker()"></a><code>2.2 addWorker()</code></h3><p>åœ¨ä¸Šé¢çš„æºç ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°å½“éœ€è¦åˆ›å»ºçº¿ç¨‹æ—¶ä¼šè°ƒç”¨<code>addWorker()</code>æ–¹æ³•ã€‚<code>addWorker()</code>èƒ½å¤Ÿæ·»åŠ æ–°çš„å·¥ä½œçº¿ç¨‹åˆ°çº¿ç¨‹æ± ï¼Œè¯¥æ–¹æ³•æ¶‰åŠåˆ°çº¿ç¨‹æ± çš„ä¸€äº›é‡è¦èµ„æºï¼š</p>
<ul>
<li><code>largestPoolSize</code>ï¼ˆçº¿ç¨‹æ± æœ€å¤§å¤§å°ï¼‰å’Œ<code>workers</code>ï¼ˆå·¥ä½œçº¿ç¨‹é›†åˆï¼‰éƒ½å±äºä¸´ç•Œèµ„æºï¼Œä¼šæœ‰å¤šçº¿ç¨‹ç«äº‰é—®é¢˜ï¼Œå› æ­¤é€šè¿‡å…¨å±€é”æ¥è¿›è¡Œäº’æ–¥</li>
<li>è€Œ<code>ctl</code>ï¼ˆå·¥ä½œçº¿ç¨‹æ•°é‡ï¼‰åˆ™æ˜¯é€šè¿‡CASå»ä¿è¯çº¿ç¨‹å®‰å…¨çš„ã€‚</li>
</ul>
<p>ä»¥ä¸‹æ˜¯å†…éƒ¨å®ç°ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// å…¨å±€é”ï¼Œå¹¶å‘æ“ä½œå¿…å¤‡ </span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">ReentrantLock</span> <span class="variable">mainLock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>();</span><br><span class="line"> <span class="comment">// è·Ÿè¸ªçº¿ç¨‹æ± çš„æœ€å¤§å¤§å° ï¼Œåªæœ‰åœ¨æŒæœ‰å…¨å±€é”mainLockçš„å‰æä¸‹æ‰èƒ½è®¿é—®æ­¤é›†åˆ</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">int</span> largestPoolSize;</span><br><span class="line"> <span class="comment">// å·¥ä½œçº¿ç¨‹é›†åˆ ï¼Œå­˜æ”¾çº¿ç¨‹æ± ä¸­æ‰€æœ‰çš„ï¼ˆæ´»è·ƒçš„ï¼‰å·¥ä½œçº¿ç¨‹ï¼Œåªæœ‰åœ¨æŒæœ‰å…¨å±€é”mainLockçš„å‰æä¸‹æ‰èƒ½è®¿é—®æ­¤é›†åˆ</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> HashSet&lt;Worker&gt; workers = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line"><span class="comment">// è·å–çº¿ç¨‹æ± çŠ¶æ€</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">runStateOf</span><span class="params">(<span class="type">int</span> c)</span> { <span class="keyword">return</span> c &amp; ~CAPACITY; }</span><br><span class="line"><span class="comment">// åˆ¤æ–­çº¿ç¨‹æ± çš„çŠ¶æ€æ˜¯å¦ä¸º Running</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">isRunning</span><span class="params">(<span class="type">int</span> c)</span> {</span><br><span class="line">    <span class="keyword">return</span> c &lt; SHUTDOWN;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ·»åŠ æ–°çš„å·¥ä½œçº¿ç¨‹åˆ°çº¿ç¨‹æ± </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> firstTask æ‰§è¡Œçš„ä»»åŠ¡</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> coreå‚æ•°ä¸ºtrueçš„è¯è¡¨ç¤ºä½¿ç”¨çº¿ç¨‹æ± çš„åŸºæœ¬å¤§å°ï¼Œä¸ºfalseä½¿ç”¨çº¿ç¨‹æ± æœ€å¤§å¤§å°</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> æ·»åŠ æˆåŠŸå°±è¿”å›trueå¦åˆ™è¿”å›false</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">addWorker</span><span class="params">(Runnable firstTask, <span class="type">boolean</span> core)</span> {</span><br><span class="line">    retry:</span><br><span class="line">    <span class="keyword">for</span> (;;) {</span><br><span class="line">        <span class="comment">//è¿™ä¸¤å¥ç”¨æ¥è·å–çº¿ç¨‹æ± çš„çŠ¶æ€</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> ctl.get();</span><br><span class="line">        <span class="type">int</span> <span class="variable">rs</span> <span class="operator">=</span> runStateOf(c);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Check if queue empty only if necessary.</span></span><br><span class="line">        <span class="keyword">if</span> (rs &gt;= SHUTDOWN &amp;&amp;</span><br><span class="line">            ! (rs == SHUTDOWN &amp;&amp;</span><br><span class="line">               firstTask == <span class="literal">null</span> &amp;&amp;</span><br><span class="line">               ! workQueue.isEmpty()))</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (;;) {</span><br><span class="line">           <span class="comment">//è·å–çº¿ç¨‹æ± ä¸­å·¥ä½œçš„çº¿ç¨‹çš„æ•°é‡</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">wc</span> <span class="operator">=</span> workerCountOf(c);</span><br><span class="line">            <span class="comment">// coreå‚æ•°ä¸ºfalseçš„è¯è¡¨æ˜é˜Ÿåˆ—ä¹Ÿæ»¡äº†ï¼Œçº¿ç¨‹æ± å¤§å°å˜ä¸º maximumPoolSize</span></span><br><span class="line">            <span class="keyword">if</span> (wc &gt;= CAPACITY ||</span><br><span class="line">                wc &gt;= (core ? corePoolSize : maximumPoolSize))</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">           <span class="comment">//åŸå­æ“ä½œå°†workcountçš„æ•°é‡åŠ 1</span></span><br><span class="line">            <span class="keyword">if</span> (compareAndIncrementWorkerCount(c))</span><br><span class="line">                <span class="keyword">break</span> retry;</span><br><span class="line">            <span class="comment">// å¦‚æœçº¿ç¨‹çš„çŠ¶æ€æ”¹å˜äº†å°±å†æ¬¡æ‰§è¡Œä¸Šè¿°æ“ä½œ</span></span><br><span class="line">            c = ctl.get();</span><br><span class="line">            <span class="keyword">if</span> (runStateOf(c) != rs)</span><br><span class="line">                <span class="keyword">continue</span> retry;</span><br><span class="line">            <span class="comment">// else CASå¤±è´¥æ—¶å› ä¸ºworkerCountæ”¹å˜äº†ï¼Œç»§ç»­å†…å±‚å¾ªç¯å°è¯•CASå¯¹workeræ•°é‡+1</span></span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// æ ‡è®°å·¥ä½œçº¿ç¨‹æ˜¯å¦å¯åŠ¨æˆåŠŸ</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">workerStarted</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="comment">// æ ‡è®°å·¥ä½œçº¿ç¨‹æ˜¯å¦åˆ›å»ºæˆåŠŸ</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">workerAdded</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="type">Worker</span> <span class="variable">w</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line"></span><br><span class="line">        w = <span class="keyword">new</span> <span class="title class_">Worker</span>(firstTask);</span><br><span class="line">        <span class="keyword">final</span> <span class="type">Thread</span> <span class="variable">t</span> <span class="operator">=</span> w.thread;  <span class="comment">// è¿™é‡Œçš„threadæ˜¯workeræœ¬èº«</span></span><br><span class="line">        <span class="keyword">if</span> (t != <span class="literal">null</span>) {</span><br><span class="line">          <span class="comment">// åŠ é”</span></span><br><span class="line">            <span class="keyword">final</span> <span class="type">ReentrantLock</span> <span class="variable">mainLock</span> <span class="operator">=</span> <span class="built_in">this</span>.mainLock;</span><br><span class="line">            mainLock.lock();</span><br><span class="line">            <span class="keyword">try</span> {</span><br><span class="line">               <span class="comment">//è·å–çº¿ç¨‹æ± çŠ¶æ€</span></span><br><span class="line">                <span class="type">int</span> <span class="variable">rs</span> <span class="operator">=</span> runStateOf(ctl.get());</span><br><span class="line">               <span class="comment">// çº¿ç¨‹æ± æ˜¯å¦æ˜¯å¯æ·»åŠ workerçŠ¶æ€</span></span><br><span class="line">                <span class="keyword">if</span> (rs &lt; SHUTDOWN ||</span><br><span class="line">                    (rs == SHUTDOWN &amp;&amp; firstTask == <span class="literal">null</span>)) {</span><br><span class="line">                    <span class="keyword">if</span> (t.isAlive()) <span class="comment">// precheck that t is startable</span></span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalThreadStateException</span>();</span><br><span class="line">                    workers.add(w);</span><br><span class="line">                   <span class="comment">//æ›´æ–°å½“å‰å·¥ä½œçº¿ç¨‹çš„æœ€å¤§å®¹é‡</span></span><br><span class="line">                    <span class="type">int</span> <span class="variable">s</span> <span class="operator">=</span> workers.size();</span><br><span class="line">                    <span class="keyword">if</span> (s &gt; largestPoolSize)</span><br><span class="line">                        largestPoolSize = s;</span><br><span class="line">                  <span class="comment">// å·¥ä½œçº¿ç¨‹æ˜¯å¦å¯åŠ¨æˆåŠŸ</span></span><br><span class="line">                    workerAdded = <span class="literal">true</span>;</span><br><span class="line">                }</span><br><span class="line">            } <span class="keyword">finally</span> {</span><br><span class="line">                <span class="comment">// é‡Šæ”¾é”</span></span><br><span class="line">                mainLock.unlock();</span><br><span class="line">            }</span><br><span class="line">            <span class="comment">//// å¦‚æœæˆåŠŸæ·»åŠ å·¥ä½œçº¿ç¨‹ï¼Œåˆ™è°ƒç”¨Workerå†…éƒ¨çš„çº¿ç¨‹å®ä¾‹tçš„Thread#start()æ–¹æ³•å¯åŠ¨çœŸå®çš„çº¿ç¨‹å®ä¾‹</span></span><br><span class="line">            <span class="keyword">if</span> (workerAdded) {</span><br><span class="line">                t.start();    <span class="comment">// worker.run()è°ƒç”¨runWorker() </span></span><br><span class="line">              <span class="comment">/// æ ‡è®°çº¿ç¨‹å¯åŠ¨æˆåŠŸ</span></span><br><span class="line">                workerStarted = <span class="literal">true</span>;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    } <span class="keyword">finally</span> {</span><br><span class="line">       <span class="comment">// çº¿ç¨‹å¯åŠ¨å¤±è´¥ï¼Œéœ€è¦ä»å·¥ä½œçº¿ç¨‹ä¸­ç§»é™¤å¯¹åº”çš„Worker</span></span><br><span class="line">        <span class="keyword">if</span> (! workerStarted)</span><br><span class="line">            addWorkerFailed(w);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> workerStarted;</span><br><span class="line">} ThreadPoolExecutor.java</span><br></pre></td></tr></tbody></table></figure>

<p>æ”¾ä¸€ä¸ªå¤§ä½¬æ€»ç»“çš„æµç¨‹å›¾</p>
<p><img src="/../images/ThreadPoolExecutor%E8%AF%A6%E8%A7%A3/image_vaHY6IYtZP.png"></p>
<h3 id="2-3-Workerå†…éƒ¨å®ç°"><a href="#2-3-Workerå†…éƒ¨å®ç°" class="headerlink" title="2.3 Workerå†…éƒ¨å®ç°"></a>2.3 Workerå†…éƒ¨å®ç°</h3><p><strong>Worker****æ˜¯åŸºäºAQSå®ç°çš„ï¼Œå†…éƒ¨å®ç°äº†ä¸€ä¸ªä¸å¯é‡å…¥é”ï¼Œè¿™ä¸ªé”çš„ä½œç”¨æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ</strong></p>
<p>Workerçš„é”ä¸»è¦çš„ç›®çš„æ˜¯ä¸ºäº†æ§åˆ¶ä¸­æ–­ã€‚è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆä¸ç›´æ¥æ‰§è¡Œ<code>execute(command)</code>æäº¤çš„commandï¼Œè€Œè¦åœ¨å¤–é¢åŒ…ä¸€å±‚Workerçš„åŸå› </p>
<p><em>Tipsï¼šworkerçš„é”æ˜¯ç”¨æ¥æ§åˆ¶ä¸­æ–­çš„ï¼Ÿå±…ç„¶è¿˜æœ‰è¿™ç§ç”¨æ³•ï¼Ÿï¼Ÿæˆ‘ç›´æ¥æƒŠäº†</em>ğŸ˜®</p>
<p><strong>å¦‚ä½•æ§åˆ¶å‘¢ï¼Ÿ</strong></p>
<p>ç”¨AQSé”ï¼Œå½“è¿è¡Œæ—¶ä¸Šé”ï¼Œä¸­æ–­å¿…é¡»è·å–é”ï¼Œè¿™æ ·å°±ä¿è¯äº†workerä¸ä¼šåœ¨è¿è¡Œçš„æ—¶å€™è¢«çªç„¶å™¶æ‰</p>
<p>TreadPoolExecutoråœ¨è°ƒç”¨<code>shutdown()</code>æ–¹æ³•ä¸­æ–­workerå‰éƒ½è¦è·å–workeré”</p>
<p>å·²å¯åŠ¨çš„workeråªæœ‰åœ¨å¤„äºç­‰å¾…çŠ¶æ€ï¼Œå³å°è¯•ä»workQueueä¸­è·å–ä»»åŠ¡<code>getTask()</code>æ—¶æ‰èƒ½è¢«ä¸­æ–­</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">Worker</span> <span class="keyword">extends</span> <span class="title class_">AbstractQueuedSynchronizer</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> Thread thread; <span class="comment">//åˆ©ç”¨ThreadFactoryå’ŒWorkerè¿™ä¸ªRunnableåˆ›å»ºçš„çº¿ç¨‹å¯¹è±¡</span></span><br><span class="line">    </span><br><span class="line">    Runnable firstTask;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">volatile</span> <span class="type">long</span> completedTasks;</span><br><span class="line"> </span><br><span class="line">    Worker(Runnable firstTask) {</span><br><span class="line">        <span class="comment">// è®¾ç½®AQSçš„åŒæ­¥çŠ¶æ€state=-1ï¼Œstateæ˜¯AQSçš„ä¸€ä¸ªè®¡æ•°å™¨ï¼Œå¤§äº0ä»£è¡¨é”å·²ç»è¢«è·å–</span></span><br><span class="line">        <span class="comment">// åœ¨è°ƒç”¨runWorker()å‰ï¼Œç¦æ­¢interruptä¸­æ–­ï¼Œåœ¨interruptIfStarted()æ–¹æ³•ä¸­ä¼šåˆ¤æ–­ getState()&gt;=0</span></span><br><span class="line">        <span class="comment">// state=-1è¡¨ç¤ºå½“å‰workeræœªå¯åŠ¨ï¼Œçº¿ç¨‹è¿˜æ²¡è¿è¡Œï¼Œå› æ­¤ä¸éœ€è¦ä¸­æ–­</span></span><br><span class="line">        setState(-<span class="number">1</span>); </span><br><span class="line">        <span class="built_in">this</span>.firstTask = firstTask;</span><br><span class="line">        <span class="comment">// æ ¹æ®å½“å‰workeråˆ›å»ºä¸€ä¸ªçº¿ç¨‹å¯¹è±¡</span></span><br><span class="line">        <span class="comment">// å½“å‰workeræœ¬èº«å°±æ˜¯ä¸€ä¸ªrunnableä»»åŠ¡ï¼Œä¹Ÿå°±æ˜¯ä¸ä¼šç”¨å‚æ•°çš„firstTaskåˆ›å»ºçº¿ç¨‹ï¼Œè€Œæ˜¯è°ƒç”¨å½“å‰worker.run()æ—¶è°ƒç”¨firstTask.run()</span></span><br><span class="line">        <span class="built_in">this</span>.thread = getThreadFactory().newThread(<span class="built_in">this</span>); </span><br><span class="line">    }</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> {</span><br><span class="line">        runWorker(<span class="built_in">this</span>); <span class="comment">//runWorker()æ˜¯ThreadPoolExecutorçš„æ–¹æ³•ï¼Œç”¨äºå¯åŠ¨worker</span></span><br><span class="line">    }</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 0ä»£è¡¨â€œæ²¡è¢«é”å®šâ€çŠ¶æ€</span></span><br><span class="line">    <span class="comment">// 1ä»£è¡¨â€œé”å®šâ€çŠ¶æ€</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">isHeldExclusively</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> getState() != <span class="number">0</span>;</span><br><span class="line">    }</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å°è¯•è·å–é”</span></span><br><span class="line"><span class="comment">     * é‡å†™AQSçš„tryAcquire()</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">tryAcquire</span><span class="params">(<span class="type">int</span> unused)</span> {</span><br><span class="line">        <span class="comment">//å°è¯•ä¸€æ¬¡å°†stateä»0è®¾ç½®ä¸º1ï¼Œå³â€œé”å®šâ€çŠ¶æ€ï¼Œä½†ç”±äºæ¯æ¬¡éƒ½æ˜¯state 0-&gt;1ï¼Œè€Œä¸æ˜¯+1ï¼Œé‚£ä¹ˆè¯´æ˜ä¸å¯é‡å…¥</span></span><br><span class="line">        <span class="comment">//ä¸”state==-1æ—¶ä¹Ÿä¸ä¼šè·å–åˆ°é”</span></span><br><span class="line">        <span class="keyword">if</span> (compareAndSetState(<span class="number">0</span>, <span class="number">1</span>)) {</span><br><span class="line">            setExclusiveOwnerThread(Thread.currentThread()); <span class="comment">//è®¾ç½®exclusiveOwnerThread=å½“å‰çº¿ç¨‹</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    }</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å°è¯•é‡Šæ”¾é”</span></span><br><span class="line"><span class="comment">     * ä¸æ˜¯state-1ï¼Œè€Œæ˜¯ç½®ä¸º0</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">tryRelease</span><span class="params">(<span class="type">int</span> unused)</span> {</span><br><span class="line">        setExclusiveOwnerThread(<span class="literal">null</span>); </span><br><span class="line">        setState(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    }</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">lock</span><span class="params">()</span>        { acquire(<span class="number">1</span>); }</span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">tryLock</span><span class="params">()</span>  { <span class="keyword">return</span> tryAcquire(<span class="number">1</span>); }</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unlock</span><span class="params">()</span>      { release(<span class="number">1</span>); }</span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isLocked</span><span class="params">()</span> { <span class="keyword">return</span> isHeldExclusively(); }</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ä¸­æ–­ï¼ˆå¦‚æœè¿è¡Œï¼‰</span></span><br><span class="line"><span class="comment">     * shutdownNowæ—¶ä¼šå¾ªç¯å¯¹workerçº¿ç¨‹æ‰§è¡Œ</span></span><br><span class="line"><span class="comment">     * ä¸”ä¸éœ€è¦è·å–workeré”ï¼Œå³ä½¿åœ¨workerè¿è¡Œæ—¶ä¹Ÿå¯ä»¥ä¸­æ–­</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">interruptIfStarted</span><span class="params">()</span> {</span><br><span class="line">        Thread t;</span><br><span class="line">        <span class="comment">//å¦‚æœstate&gt;=0ã€t!=nullã€ä¸”tæ²¡æœ‰è¢«ä¸­æ–­</span></span><br><span class="line">        <span class="comment">//new Worker()æ—¶state==-1ï¼Œè¯´æ˜ä¸èƒ½ä¸­æ–­</span></span><br><span class="line">        <span class="keyword">if</span> (getState() &gt;= <span class="number">0</span> &amp;&amp; (t = thread) != <span class="literal">null</span> &amp;&amp; !t.isInterrupted()) {</span><br><span class="line">            <span class="keyword">try</span> {</span><br><span class="line">                t.interrupt();</span><br><span class="line">            } <span class="keyword">catch</span> (SecurityException ignore) {</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>æ³¨æ„ï¼Œworkerå†…éƒ¨çš„é”æ˜¯<strong>ä¸å¯é‡å…¥çš„äº’æ–¥é”</strong>ï¼Œè€Œä¸æ˜¯ç”¨ReentrantLockå¯é‡å…¥é”</p>
<p>è¿™æ˜¯å› ä¸ºæˆ‘ä»¬ä¸æƒ³è®©åœ¨è°ƒç”¨æ¯”å¦‚<code>setCorePoolSize()</code>è¿™ç§çº¿ç¨‹æ± æ§åˆ¶æ–¹æ³•æ—¶å¯ä»¥å†æ¬¡è·å–é”(é‡å…¥)ï¼Œå› ä¸º<code>setCorePoolSize()</code>æ—¶å¯èƒ½ä¼š<code>interruptIdleWorkers()</code>ï¼Œåœ¨å¯¹ä¸€ä¸ªçº¿ç¨‹interruptæ—¶ä¼šè¦<code>w.tryLock()</code>ã€‚å¦‚æœå¯é‡å…¥ï¼Œå°±å¯èƒ½ä¼šåœ¨å¯¹çº¿ç¨‹æ± æ“ä½œçš„æ–¹æ³•ä¸­ä¸­æ–­çº¿ç¨‹ï¼Œç±»ä¼¼æ–¹æ³•è¿˜æœ‰ï¼š</p>
<ul>
<li><code>setMaximumPoolSize()</code></li>
<li><code>setKeppAliveTime()</code></li>
<li><code>allowCoreThreadTimeOut()</code></li>
<li><code>shutdown()</code></li>
</ul>
<p>è¿˜æœ‰ä¸€ä¸ªç»†èŠ‚ï¼Œåœ¨<code>new Worker()</code>æ—¶åˆå§‹state=-1ï¼Œè¿™æ˜¯ä¸ºäº†è®©çº¿ç¨‹çœŸæ­£å¼€å§‹åæ‰å¯ä»¥ä¸­æ–­ï¼Œåˆå§‹åŒ–state=-1ï¼Œåœ¨å¼€å§‹<code>runWorker()</code>æ—¶å°†stateç½®ä¸º0ï¼Œè€Œstate&gt;=0æ‰å¯ä»¥è¢«ä¸­æ–­</p>
<h3 id="2-4-runWorker"><a href="#2-4-runWorker" class="headerlink" title="2.4 runWorker()"></a><code>2.4 runWorker()</code></h3><p>workerçš„å¯åŠ¨æ–¹æ³•ï¼Œä¸€æ—¦å¯åŠ¨åï¼Œä¼šä¸€ç›´å¾ªç¯ä»é˜Ÿåˆ—ä¸­è·å–ä»»åŠ¡æ‰§è¡Œï¼Œæ‰§è¡Œä»»åŠ¡æ—¶ä¼šé”ä½workerï¼Œåªæœ‰åœ¨<code>getTask()</code>æ–¹æ³•é˜¶æ®µæ‰ä¼šé‡Šæ”¾é”</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">runWorker</span><span class="params">(Worker w)</span> {</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">wt</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">    <span class="type">Runnable</span> <span class="variable">task</span> <span class="operator">=</span> w.firstTask;</span><br><span class="line">    w.firstTask = <span class="literal">null</span>;</span><br><span class="line">    w.unlock(); <span class="comment">// allow interrupts</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">completedAbruptly</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        <span class="keyword">while</span> (task != <span class="literal">null</span> || (task = getTask()) != <span class="literal">null</span>) {</span><br><span class="line">            w.lock();</span><br><span class="line">            <span class="comment">// If pool is stopping, ensure thread is interrupted;</span></span><br><span class="line">            <span class="comment">// if not, ensure thread is not interrupted.  This</span></span><br><span class="line">            <span class="comment">// requires a recheck in second case to deal with</span></span><br><span class="line">            <span class="comment">// shutdownNow race while clearing interrupt</span></span><br><span class="line">            <span class="keyword">if</span> ((runStateAtLeast(ctl.get(), STOP) ||</span><br><span class="line">                 (Thread.interrupted() &amp;&amp;</span><br><span class="line">                  runStateAtLeast(ctl.get(), STOP))) &amp;&amp;</span><br><span class="line">                !wt.isInterrupted())</span><br><span class="line">                wt.interrupt();</span><br><span class="line">            <span class="keyword">try</span> {</span><br><span class="line">                beforeExecute(wt, task);</span><br><span class="line">                <span class="keyword">try</span> {</span><br><span class="line">                    task.run();</span><br><span class="line">                    afterExecute(task, <span class="literal">null</span>);</span><br><span class="line">                } <span class="keyword">catch</span> (Throwable ex) {</span><br><span class="line">                    afterExecute(task, ex);</span><br><span class="line">                    <span class="keyword">throw</span> ex;</span><br><span class="line">                }</span><br><span class="line">            } <span class="keyword">finally</span> {</span><br><span class="line">                task = <span class="literal">null</span>;</span><br><span class="line">                w.completedTasks++;</span><br><span class="line">                w.unlock();</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        completedAbruptly = <span class="literal">false</span>;</span><br><span class="line">    } <span class="keyword">finally</span> {</span><br><span class="line">        processWorkerExit(w, completedAbruptly);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<p>æµç¨‹å›¾</p>
<p><img src="/../images/ThreadPoolExecutor%E8%AF%A6%E8%A7%A3/image_PolOIn-pLa.png"></p>
<h3 id="2-5-getTask"><a href="#2-5-getTask" class="headerlink" title="2.5 getTask()"></a><code>2.5 getTask()</code></h3><p>ä¸‹é¢æ¥çœ‹ä¸€ä¸‹<code>getTask()</code>æ–¹æ³•ï¼Œè¿™é‡Œé¢æ¶‰åŠåˆ°<code>keepAliveTime</code>çš„ä½¿ç”¨ä»¥åŠç©ºé—²workerçš„é”€æ¯</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> Runnable <span class="title function_">getTask</span><span class="params">()</span> {</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">timedOut</span> <span class="operator">=</span> <span class="literal">false</span>; <span class="comment">// æ˜¯å¦è¶…æ—¶</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (;;) {</span><br><span class="line">        <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> ctl.get();</span><br><span class="line">        <span class="type">int</span> <span class="variable">rs</span> <span class="operator">=</span> runStateOf(c);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Check if queue empty only if necessary.</span></span><br><span class="line">        <span class="keyword">if</span> (rs &gt;= SHUTDOWN &amp;&amp; (rs &gt;= STOP || workQueue.isEmpty())) {</span><br><span class="line">            decrementWorkerCount();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> <span class="variable">wc</span> <span class="operator">=</span> workerCountOf(c);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// allowCoreThreadTimeOut=falseï¼Œçº¿ç¨‹å³ä½¿ç©ºé—²ä¹Ÿä¸ä¼šè¢«é”€æ¯ï¼›å€˜è‹¥ä¸ºtureï¼Œåœ¨keepAliveTimeå†…ä»ç©ºé—²åˆ™ä¼šè¢«é”€æ¯ã€‚</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">timed</span> <span class="operator">=</span> allowCoreThreadTimeOut || wc &gt; corePoolSize;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((wc &gt; maximumPoolSize || (timed &amp;&amp; timedOut))</span><br><span class="line">            &amp;&amp; (wc &gt; <span class="number">1</span> || workQueue.isEmpty())) {</span><br><span class="line">            <span class="keyword">if</span> (compareAndDecrementWorkerCount(c))</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="type">Runnable</span> <span class="variable">r</span> <span class="operator">=</span> timed ?</span><br><span class="line">                workQueue.poll(keepAliveTime, TimeUnit.NANOSECONDS) :</span><br><span class="line">                workQueue.take();</span><br><span class="line">            <span class="keyword">if</span> (r != <span class="literal">null</span>)</span><br><span class="line">                <span class="keyword">return</span> r;</span><br><span class="line">            timedOut = <span class="literal">true</span>;</span><br><span class="line">        } <span class="keyword">catch</span> (InterruptedException retry) {</span><br><span class="line">            timedOut = <span class="literal">false</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<ul>
<li>å¦‚æœ<strong>çº¿ç¨‹å…è®¸ç©ºé—²å¹¶ä¸”å½“å‰çº¿ç¨‹æ•°å¤§äºæ ¸å¿ƒçº¿ç¨‹æ•°</strong>ï¼Œåˆ™æ‰§è¡Œ<code>workQueue.take</code>ï¼šå¦‚æœé˜»å¡é˜Ÿåˆ—ä¸ºç©ºï¼Œå½“å‰çº¿ç¨‹ä¼šè¢«æŒ‚èµ·ç­‰å¾…ï¼›å½“é˜Ÿåˆ—ä¸­æœ‰ä»»åŠ¡åŠ å…¥æ—¶ï¼Œçº¿ç¨‹è¢«å”¤é†’ï¼Œtakeæ–¹æ³•è¿”å›ä»»åŠ¡ï¼Œå¹¶æ‰§è¡Œï¼›</li>
<li>å¦‚æœ<strong>çº¿ç¨‹ä¸å…è®¸ç©ºé—²æˆ–è€…å½“å‰çº¿ç¨‹æ•°å°äºæ ¸å¿ƒçº¿ç¨‹æ•°****ï¼Œ</strong> åˆ™æ‰§è¡Œ<code>workQueue.poll</code>: å¦‚æœåœ¨<code>keepAliveTime</code>æ—¶é—´å†…ï¼Œé˜»å¡é˜Ÿåˆ—è¿˜æ˜¯æ²¡æœ‰ä»»åŠ¡ï¼Œåˆ™è¿”å›nullå¹¶åˆ é™¤ä¸€ä¸ªworkerï¼›</li>
</ul>
<blockquote>
<p><strong>åªæœ‰åœ¨çº¿ç¨‹æ•°å°äºcoreSizeå¹¶ä¸”æ²¡æœ‰ä»»åŠ¡çš„æƒ…å†µä¸‹æ‰ä¼šåˆ é™¤worker</strong></p>
</blockquote>
<h2 id="3-ThreadPoolExecutorå…³é—­"><a href="#3-ThreadPoolExecutorå…³é—­" class="headerlink" title="3 ThreadPoolExecutorå…³é—­"></a>3 ThreadPoolExecutorå…³é—­</h2><p>çº¿ç¨‹æ± æœ‰ä¸¤ä¸ªå…³é—­çš„æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// é˜»æ­¢æäº¤ä»»åŠ¡ï¼Œåœ¨æ‰€æœ‰çº¿ç¨‹æ‰§è¡Œå®Œåç»“æŸ</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">shutdown</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨shutdownNow()åè§¦å‘ï¼Œçº¿ç¨‹æ± ä¸å†æ¥å—æ–°çš„ä»»åŠ¡ï¼Œå°è¯•ç»ˆæ­¢æ‰€æœ‰æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡</span></span><br><span class="line">List&lt;Runnable&gt; <span class="title function_">shutdownNow</span><span class="params">()</span>; </span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<p>é‚£ä¹ˆæœ‰ä»¥ä¸‹å‡ ä¸ªé—®é¢˜ï¼š</p>
<ul>
<li>çº¿ç¨‹æ± å…³é—­çš„æµç¨‹æ˜¯æ€ä¹ˆæ ·çš„å‘¢ï¼Ÿ</li>
<li>çº¿ç¨‹æ± çš„æ¢æ´»æœºåˆ¶ï¼Ÿï¼ˆå¿«æ‰‹é¢è¯•åŸé¢˜ï¼‰</li>
</ul>
<h3 id="3-1-shutdown"><a href="#3-1-shutdown" class="headerlink" title="3.1 shutdown"></a>3.1 shutdown</h3><p><code>shutdown()</code>æ–¹æ³•çš„æ­¥éª¤ï¼š</p>
<ol>
<li>CASæ›´æ–°çº¿ç¨‹æ± çŠ¶æ€ä¸ºshutdown</li>
<li><code>interruptIdleWorkers()</code>ä¸­æ–­æ‰€æœ‰ç©ºé—²çº¿ç¨‹</li>
<li><code>tryTerminated()</code>å°è¯•ç»ˆæ­¢çº¿ç¨‹æ± </li>
</ol>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">shutdown</span><span class="params">()</span> {</span><br><span class="line">    <span class="keyword">final</span> <span class="type">ReentrantLock</span> <span class="variable">mainLock</span> <span class="operator">=</span> <span class="built_in">this</span>.mainLock;</span><br><span class="line">    mainLock.lock(); <span class="comment">//ä¸Šé”</span></span><br><span class="line">     </span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        <span class="comment">//åˆ¤æ–­è°ƒç”¨è€…æ˜¯å¦æœ‰æƒé™shutdownçº¿ç¨‹æ± </span></span><br><span class="line">        checkShutdownAccess();</span><br><span class="line">         </span><br><span class="line">        <span class="comment">//CASå¾ªç¯è®¾ç½®çº¿ç¨‹æ± çŠ¶æ€ä¸ºshutdown</span></span><br><span class="line">        advanceRunState(SHUTDOWN);</span><br><span class="line">         </span><br><span class="line">        <span class="comment">//ä¸­æ–­æ‰€æœ‰ç©ºé—²çº¿ç¨‹</span></span><br><span class="line">        interruptIdleWorkers();</span><br><span class="line">         </span><br><span class="line">        onShutdown(); <span class="comment">// hook for ScheduledThreadPoolExecutor</span></span><br><span class="line">    } </span><br><span class="line">    <span class="keyword">finally</span> {</span><br><span class="line">        mainLock.unlock(); <span class="comment">//è§£é”</span></span><br><span class="line">    }</span><br><span class="line">     </span><br><span class="line">    <span class="comment">//å°è¯•ç»ˆæ­¢çº¿ç¨‹æ± </span></span><br><span class="line">    tryTerminate();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><code>interruptIdleWorkers()</code>ä¼šä¸­æ–­æ‰€æœ‰å¯èƒ½æ­£åœ¨ç­‰å¾…ä»»åŠ¡çš„çº¿ç¨‹ï¼Œå³æœªè¢«é”å®šçš„worker</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">interruptIdleWorkers</span><span class="params">(<span class="type">boolean</span> onlyOne)</span> {</span><br><span class="line">    <span class="keyword">final</span> <span class="type">ReentrantLock</span> <span class="variable">mainLock</span> <span class="operator">=</span> <span class="built_in">this</span>.mainLock;</span><br><span class="line">    mainLock.lock();</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        <span class="keyword">for</span> (Worker w : workers) {</span><br><span class="line">            <span class="type">Thread</span> <span class="variable">t</span> <span class="operator">=</span> w.thread;</span><br><span class="line">            <span class="keyword">if</span> (!t.isInterrupted() &amp;&amp; w.tryLock()) {</span><br><span class="line">                <span class="keyword">try</span> {</span><br><span class="line">                    t.interrupt();</span><br><span class="line">                } <span class="keyword">catch</span> (SecurityException ignore) {</span><br><span class="line">                } <span class="keyword">finally</span> {</span><br><span class="line">                    w.unlock();</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">if</span> (onlyOne)</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        }</span><br><span class="line">    } <span class="keyword">finally</span> {</span><br><span class="line">        mainLock.unlock();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="3-2-shutdownNow"><a href="#3-2-shutdownNow" class="headerlink" title="3.2 shutdownNow"></a>3.2 shutdownNow</h3><p><code>shutdown()</code>æ–¹æ³•çš„æ­¥éª¤ï¼š</p>
<ol>
<li>CASæ›´æ–°çº¿ç¨‹æ± çŠ¶æ€ä¸ºSTOP</li>
<li><code>interruptWorkers()</code>ä¸­æ–­æ‰€æœ‰ç©ºé—²çº¿ç¨‹</li>
<li><code>tryTerminated()</code>å°è¯•ç»ˆæ­¢çº¿ç¨‹æ± </li>
</ol>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"> <span class="keyword">public</span> List&lt;Runnable&gt; <span class="title function_">shutdownNow</span><span class="params">()</span> {</span><br><span class="line">    List&lt;Runnable&gt; tasks;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">ReentrantLock</span> <span class="variable">mainLock</span> <span class="operator">=</span> <span class="built_in">this</span>.mainLock;</span><br><span class="line">    mainLock.lock();</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        checkShutdownAccess();</span><br><span class="line">        advanceRunState(STOP);</span><br><span class="line">        interruptWorkers();</span><br><span class="line">        tasks = drainQueue();</span><br><span class="line">    } <span class="keyword">finally</span> {</span><br><span class="line">        mainLock.unlock();</span><br><span class="line">    }</span><br><span class="line">    tryTerminate();</span><br><span class="line">    <span class="keyword">return</span> tasks;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><code>interruptWorkers()</code>ä¼šä¸­æ–­æ‰€æœ‰å·²å¯åŠ¨çš„workerï¼Œå³ä½¿workerå¤„äºæ´»è·ƒçŠ¶æ€</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">interruptWorkers</span><span class="params">()</span> {</span><br><span class="line">    <span class="comment">// assert mainLock.isHeldByCurrentThread();</span></span><br><span class="line">    <span class="keyword">for</span> (Worker w : workers)</span><br><span class="line">        w.interruptIfStarted();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h2 id="4-æ‹“å±•é¢è¯•é¢˜"><a href="#4-æ‹“å±•é¢è¯•é¢˜" class="headerlink" title="4 æ‹“å±•é¢è¯•é¢˜"></a>4 æ‹“å±•é¢è¯•é¢˜</h2><p>äº†è§£äº†ä¸Šé¢çš„æ ¸å¿ƒåŸç†ï¼Œç°åœ¨å°±å¯ä»¥å›ç­”æœ€å¼€å§‹çš„é¢è¯•é¢˜äº†ï¼š</p>
<h3 id="4-1-ä¸€ä¸ªçº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹å¼‚å¸¸äº†ï¼Œé‚£ä¹ˆçº¿ç¨‹æ± ä¼šæ€ä¹ˆå¤„ç†è¿™ä¸ªçº¿ç¨‹"><a href="#4-1-ä¸€ä¸ªçº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹å¼‚å¸¸äº†ï¼Œé‚£ä¹ˆçº¿ç¨‹æ± ä¼šæ€ä¹ˆå¤„ç†è¿™ä¸ªçº¿ç¨‹" class="headerlink" title="4.1 ä¸€ä¸ªçº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹å¼‚å¸¸äº†ï¼Œé‚£ä¹ˆçº¿ç¨‹æ± ä¼šæ€ä¹ˆå¤„ç†è¿™ä¸ªçº¿ç¨‹?"></a>4.1 ä¸€ä¸ªçº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹å¼‚å¸¸äº†ï¼Œé‚£ä¹ˆçº¿ç¨‹æ± ä¼šæ€ä¹ˆå¤„ç†è¿™ä¸ªçº¿ç¨‹?</h3><blockquote>
<p>ğŸ“Œä¸»è¦åˆ†ä¸‰ç‚¹å›ç­”ï¼š</p>
<ol>
<li>æ˜¯å¦ä¼šæŠ›å‡ºå †æ ˆå¼‚å¸¸ï¼Ÿ</li>
<li>æ˜¯å¦ä¼šå½±å“å…¶ä»–çº¿ç¨‹ä»»åŠ¡ï¼Ÿ</li>
<li>å¼‚å¸¸çº¿ç¨‹è¢«ä¸¢å¼ƒè¿˜æ˜¯æ”¾å›ï¼Ÿ</li>
</ol>
</blockquote>
<h4 id="4-1-1-æ˜¯å¦ä¼šæŠ›å‡ºå †æ ˆå¼‚å¸¸ï¼Ÿ"><a href="#4-1-1-æ˜¯å¦ä¼šæŠ›å‡ºå †æ ˆå¼‚å¸¸ï¼Ÿ" class="headerlink" title="4.1.1 æ˜¯å¦ä¼šæŠ›å‡ºå †æ ˆå¼‚å¸¸ï¼Ÿ"></a>4.1.1 æ˜¯å¦ä¼šæŠ›å‡ºå †æ ˆå¼‚å¸¸ï¼Ÿ</h4><p>æ˜¯å¦ä¼šæŠ›å‡ºå †æ ˆå¼‚å¸¸è·Ÿä»»åŠ¡æäº¤æ–¹å¼æœ‰å…³ã€‚ExecutorServiceæä¾›äº†ä¸¤ç§ä»»åŠ¡æäº¤çš„æ–¹å¼ï¼š<code>execute()</code>å’Œ<code>submit()</code>ã€‚ä¸Šé¢å·²ç»ä»‹ç»è¿‡äº†<code>execute()</code>ï¼Œæˆ‘ä»¬å†æ¥çœ‹çœ‹<code>submit()</code>æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Future&lt;?&gt; submit(Runnable task) {</span><br><span class="line">    <span class="keyword">if</span> (task == <span class="literal">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>();</span><br><span class="line">    RunnableFuture&lt;Void&gt; ftask = newTaskFor(task, <span class="literal">null</span>);</span><br><span class="line">    execute(ftask);</span><br><span class="line">    <span class="keyword">return</span> ftask;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// FutureTask</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FutureTask</span>&lt;V&gt; <span class="keyword">implements</span> <span class="title class_">RunnableFuture</span>&lt;V&gt; {</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> {</span><br><span class="line">      <span class="keyword">if</span> (state != NEW || !UNSAFE.compareAndSwapObject(<span class="built_in">this</span>, runnerOffset,</span><br><span class="line">                                       <span class="literal">null</span>, Thread.currentThread()))</span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">      <span class="keyword">try</span> {</span><br><span class="line">          Callable&lt;V&gt; c = callable;</span><br><span class="line">          <span class="comment">// 1ã€çŠ¶æ€æ£€æŸ¥</span></span><br><span class="line">          <span class="keyword">if</span> (c != <span class="literal">null</span> &amp;&amp; state == NEW) {</span><br><span class="line">              V result;</span><br><span class="line">              <span class="type">boolean</span> ran;</span><br><span class="line">              <span class="keyword">try</span> {</span><br><span class="line">                  <span class="comment">// 2ã€è°ƒç”¨åŒ…è£…å‰çš„å®é™…æ–¹æ³•æ‰§è¡Œå¹¶è·å–è¿”å›å€¼</span></span><br><span class="line">                  result = c.call();</span><br><span class="line">                  ran = <span class="literal">true</span>;</span><br><span class="line">              } <span class="keyword">catch</span> (Throwable ex) {</span><br><span class="line">                  <span class="comment">// 3ã€å¦‚æœæ‰§è¡Œå¤±è´¥ï¼Œåˆ™ä¿å­˜å¼‚å¸¸ä¿¡æ¯</span></span><br><span class="line">                  result = <span class="literal">null</span>;</span><br><span class="line">                  ran = <span class="literal">false</span>;</span><br><span class="line">                  setException(ex);</span><br><span class="line">              }</span><br><span class="line">              <span class="comment">// 4ã€å¦‚æœæ‰§è¡ŒæˆåŠŸï¼Œåˆ™å°†è¿”å›å€¼ä¿å­˜èµ·æ¥</span></span><br><span class="line">              <span class="keyword">if</span> (ran)</span><br><span class="line">                  set(result);</span><br><span class="line">          }</span><br><span class="line">      } <span class="keyword">finally</span> {</span><br><span class="line">          runner = <span class="literal">null</span>;</span><br><span class="line">          <span class="type">int</span> <span class="variable">s</span> <span class="operator">=</span> state;</span><br><span class="line">          <span class="keyword">if</span> (s &gt;= INTERRUPTING)</span><br><span class="line">              handlePossibleCancellationInterrupt(s);</span><br><span class="line">      }</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"> AbstractExecutorService.java</span><br></pre></td></tr></tbody></table></figure>

<p>å¯ä»¥çœ‹åˆ°<code>submit()</code>å°†ä»»åŠ¡å°è£…æˆäº†<code>RunnableFuture</code>ï¼ˆæ— è®ºæ˜¯Runnableè¿˜æ˜¯Callableï¼‰ï¼Œä½†æœ¬è´¨ä¸Šè¿˜æ˜¯æ‰§è¡Œäº†<code>execute()</code></p>
<p>å› æ­¤ä¸¤è€…æœ€æ ¹æœ¬çš„åŒºåˆ«åœ¨<code>RunnableFuture.run()</code>æ–¹æ³•é‡Œï¼ŒFutureTaskä¼šæ•è·å¼‚å¸¸å¹¶ä¿å­˜å †æ ˆä¿¡æ¯ã€‚<em><strong>å› æ­¤å¦‚æœé‡åˆ°çº¿ç¨‹æ‰§è¡Œå¼‚å¸¸ï¼Œæ‰§è¡Œ</strong></em>***<code>submit()</code><strong><strong><strong>ä»»åŠ¡çš„çº¿ç¨‹ä¸ä¼šå´©æºƒé€€å‡ºï¼Œå¹¶èƒ½é€šè¿‡</strong></strong></strong><code>get()</code><strong><strong><strong>è·å–åˆ°å¼‚å¸¸ä¿¡æ¯ï¼Œå¦‚æœä¸getå°±å•¥ä¹Ÿä¸ä¼šå‘ç”Ÿï¼Œè€Œ</strong></strong></strong><code>execute()</code>***<em><strong>å†…éƒ¨æ˜¯æ²¡æœ‰è¿›è¡Œå¼‚å¸¸æ•è·çš„ï¼Œå› æ­¤ä¼šè®©çº¿ç¨‹å´©æºƒ</strong></em></p>
<h4 id="4-1-2-æ˜¯å¦ä¼šå½±å“å…¶ä»–çº¿ç¨‹ä»»åŠ¡ï¼Ÿ"><a href="#4-1-2-æ˜¯å¦ä¼šå½±å“å…¶ä»–çº¿ç¨‹ä»»åŠ¡ï¼Ÿ" class="headerlink" title="4.1.2 æ˜¯å¦ä¼šå½±å“å…¶ä»–çº¿ç¨‹ä»»åŠ¡ï¼Ÿ"></a>4.1.2 æ˜¯å¦ä¼šå½±å“å…¶ä»–çº¿ç¨‹ä»»åŠ¡ï¼Ÿ</h4><p>ç­”æ¡ˆæ˜¯ä¸ä¼šçš„ï¼Œè‡ªå·±å®éªŒä¸€ä¸‹å°±çŸ¥é“äº†ï¼Œè¿™é‡Œä¸å¤šèµ˜è¿°</p>
<h4 id="4-1-3-å¼‚å¸¸çº¿ç¨‹è¢«ä¸¢å¼ƒè¿˜æ˜¯æ”¾å›ï¼Ÿ"><a href="#4-1-3-å¼‚å¸¸çº¿ç¨‹è¢«ä¸¢å¼ƒè¿˜æ˜¯æ”¾å›ï¼Ÿ" class="headerlink" title="4.1.3 å¼‚å¸¸çº¿ç¨‹è¢«ä¸¢å¼ƒè¿˜æ˜¯æ”¾å›ï¼Ÿ"></a>4.1.3 å¼‚å¸¸çº¿ç¨‹è¢«ä¸¢å¼ƒè¿˜æ˜¯æ”¾å›ï¼Ÿ</h4><p>é™¤äº†æŠ¥é”™ä¿¡æ¯å¤–ï¼Œçº¿ç¨‹æ± ä¼šæ€ä¹ˆå¤„ç†å¼‚å¸¸çº¿ç¨‹å‘¢ï¼Ÿ</p>
<p>å…¶å®çº¿ç¨‹æ± æ˜¯å¯ä»¥è®¾ç½®å¼‚å¸¸å¤„ç†å™¨çš„ï¼Œä¹Ÿå°±æ˜¯<code>uncaughtException</code></p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// new Thread()</span></span><br><span class="line"><span class="type">Thread</span> <span class="variable">t</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>();</span><br><span class="line">t.setUncaughtExceptionHandler(<span class="keyword">new</span> <span class="title class_">Thread</span>.UncaughtExceptionHandler() {</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">uncaughtException</span><span class="params">(Thread t, Throwable e)</span> {</span><br><span class="line">        <span class="comment">// TODO</span></span><br><span class="line">    }</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line"><span class="comment">// çº¿ç¨‹æ± </span></span><br><span class="line"><span class="type">ExecutorService</span> <span class="variable">threadPool</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">1</span>, thread -&gt; {</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">t</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(thread);</span><br><span class="line">    t.setUncaughtExceptionHandler((t1, e) -&gt; {</span><br><span class="line">        <span class="comment">// TODO</span></span><br><span class="line">    });</span><br><span class="line">    <span class="keyword">return</span> t;</span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure>

<p><img src="/../images/ThreadPoolExecutor%E8%AF%A6%E8%A7%A3/image_S273_MFQcN.png"></p>
<p>æ³¨æ„ï¼Œè¿™é‡Œä»»åŠ¡æ‰§è¡Œå¼‚å¸¸åï¼Œå¼‚å¸¸ä¼šç»§ç»­å‘ä¸ŠæŠ›å‡ºï¼Œ<code>processWorkerExit()</code>ä¼šè¢«æ‰§è¡Œã€‚è€Œ<code>processWorkerExit()</code>çš„æ ¸å¿ƒæ“ä½œå°±æ˜¯<em><strong>ç§»é™¤å¼‚å¸¸çš„workerï¼Œå¹¶åˆ›å»ºä¸€ä¸ªæ–°çš„worker</strong></em>ï¼š</p>
<p><img src="/../images/ThreadPoolExecutor%E8%AF%A6%E8%A7%A3/image_1f4ENk9yEy.png"></p>
<p>è¿™ä¹Ÿå°±ä¼šé€ æˆä¸€ä¸ªå¾ˆæœ‰æ„æ€çš„ç°è±¡ï¼š</p>
<p><img src="/../images/ThreadPoolExecutor%E8%AF%A6%E8%A7%A3/image_fMZrKPWUAu.png"></p>
<h3 id="4-2-ä¸ºä»€ä¹ˆé˜Ÿåˆ—æ»¡äº†å†è¿›è¡Œåˆ›å»ºæ™®é€šçº¿ç¨‹æ‰§è¡Œä»»åŠ¡ï¼Ÿ"><a href="#4-2-ä¸ºä»€ä¹ˆé˜Ÿåˆ—æ»¡äº†å†è¿›è¡Œåˆ›å»ºæ™®é€šçº¿ç¨‹æ‰§è¡Œä»»åŠ¡ï¼Ÿ" class="headerlink" title="4.2 ä¸ºä»€ä¹ˆé˜Ÿåˆ—æ»¡äº†å†è¿›è¡Œåˆ›å»ºæ™®é€šçº¿ç¨‹æ‰§è¡Œä»»åŠ¡ï¼Ÿ"></a>4.2 ä¸ºä»€ä¹ˆé˜Ÿåˆ—æ»¡äº†å†è¿›è¡Œåˆ›å»ºæ™®é€šçº¿ç¨‹æ‰§è¡Œä»»åŠ¡ï¼Ÿ</h3><p>æ™®é€šçº¿ç¨‹æœ‰ä¸€ä¸ªåˆ«åï¼Œå«æ€¥æ•‘çº¿ç¨‹ï¼Œæ„åœ¨é¢ä¸´å·¥ä½œé˜Ÿåˆ—æº¢å‡ºçš„æƒ…å†µä¸‹å¸®åŠ©å¤„ç†ä»»åŠ¡ã€‚ä»–ä»¬å°±ç›¸å½“äºå‚é‡Œçš„ä¸´æ—¶å·¥ï¼Œåªæœ‰åœ¨æ­£å¼å‘˜å·¥ï¼ˆæ ¸å¿ƒçº¿ç¨‹ï¼‰å¿™ä¸è¿‡æ¥ä¸”ä»“åº“ï¼ˆå·¥ä½œé˜Ÿåˆ—ï¼‰æ²¡ç©ºé—´çš„æ—¶å€™æ‰ä¼šç”¨åˆ°ï¼Œå› æ­¤è¿™æ ·è®¾è®¡çš„å¥½å¤„æ˜¯èŠ‚çº¦ç³»ç»Ÿçš„èµ„æºï¼Œåˆ›å»ºçº¿ç¨‹éœ€è¦è·å–å…¨å±€é”ï¼Œå¼€é”€è¾ƒå¤§ï¼›è€Œæ”¾å…¥é˜Ÿåˆ—å¼€é”€ç›¸å¯¹è¾ƒä½</p>
<p>ä½†æ˜¯åƒ Tomcat çº¿ç¨‹æ± çš„åšæ³•æ˜¯ï¼Œé‡åˆ°è¶…é‡çš„ä»»åŠ¡ï¼Œå…ˆåˆ›å»ºæ™®é€šçº¿ç¨‹ï¼Œæ™®é€šçº¿ç¨‹ä¸å¤Ÿäº†å†å¾€é˜Ÿåˆ—é‡Œä¸¢ ï¼Œè¿™æ ·åšçš„åŸå› æ˜¯Tomcat é¢ä¸´å¤§é‡ç½‘ç»œI/Oè¯·æ±‚ã€çŸ­è¿æ¥ï¼Œæ”¾å…¥é˜Ÿåˆ—æ„å‘³ç€ç”¨æˆ·éœ€è¦ä¸€ç›´ç­‰å¾…ï¼Œç”¨æˆ·è‚¯å®šä¸ä¹æ„ï¼Œæœ¬ç€ç‰©å°½å…¶ç”¨çš„é“ç†ï¼Œè°ä¹Ÿåˆ«æƒ³é—²ç€ã€‚</p>
<h3 id="4-3-Tomcatçº¿ç¨‹æ± æ˜¯å¦‚ä½•åšçš„"><a href="#4-3-Tomcatçº¿ç¨‹æ± æ˜¯å¦‚ä½•åšçš„" class="headerlink" title="4.3 Tomcatçº¿ç¨‹æ± æ˜¯å¦‚ä½•åšçš„?"></a>4.3 T<strong>omcatçº¿ç¨‹æ± æ˜¯å¦‚ä½•åšçš„?</strong></h3><p>ç®€å•çš„è¯´ï¼š</p>
<ol>
<li>æ–°çº¿ç¨‹æ± ç»§æ‰¿JDKçº¿ç¨‹æ± æ¥å£ï¼Œé‡å†™äº†<code>execute()</code>æ–¹æ³•ï¼šå½“æŠ›å‡ºæ‹’ç»ç­–ç•¥äº†å†ç»™ä¸€æ¬¡æœºä¼šï¼Œå°è¯•å¾€é˜»å¡é˜Ÿåˆ—é‡Œæ’ä»»åŠ¡ï¼Œå°½æœ€å¤§åŠªåŠ›çš„å»æ‰§è¡Œä»»åŠ¡ <em>(æ„æ€æ˜¯ä¸æŠ›å¼ƒä¸æ”¾å¼ƒï¼Œå…å¾—ç”¨æˆ·è¯·æ±‚å¤±è´¥)</em></li>
<li>æ–°é˜»å¡é˜Ÿåˆ—ç»§æ‰¿äº†LinkedBlockingQueueï¼Œé‡å†™äº†<code>offer()</code>æ–¹æ³•ï¼šæ¯æ¬¡å‘é˜Ÿåˆ—æ’å…¥ä»»åŠ¡ï¼Œåˆ¤æ–­å¦‚æœå½“å‰çº¿ç¨‹æ•°å°äºæœ€å¤§çº¿ç¨‹æ•°åˆ™æ’å…¥å¤±è´¥ï¼Œæ’å…¥å¤±è´¥åå°±ä¼šå°è¯•åˆ›å»ºæ–°çš„çº¿ç¨‹ï¼Œä»¥æ­¤æ¥é€¼è¿«çº¿ç¨‹æ± åˆ›å»ºæ–°çº¿ç¨‹æ¥å¤„ç†ä»»åŠ¡ <em>(æ„æ€ä½ åˆ«æƒ³å·æ‡’ï¼ŒæŠŠä»»åŠ¡ä¸¢åˆ°é˜Ÿåˆ—å°±ä¸ç®¡äº†)</em></li>
</ol>
<h3 id="4-4-shutDownçš„æ¢æ´»æœºåˆ¶ï¼Ÿ"><a href="#4-4-shutDownçš„æ¢æ´»æœºåˆ¶ï¼Ÿ" class="headerlink" title="4.4 shutDownçš„æ¢æ´»æœºåˆ¶ï¼Ÿ"></a>4.4 shutDownçš„æ¢æ´»æœºåˆ¶ï¼Ÿ</h3><p>æ¢æ´»æœºåˆ¶æŒ‡shutDownå¦‚ä½•å‘ç°æ­£åœ¨æ‰§è¡Œä»»åŠ¡çš„workerå¹¶ä¸”ä¸ç›´æ¥ä¸­æ–­ä»–ä»¬</p>
<p>workeråœ¨æ‰§è¡Œä»»åŠ¡æ—¶ï¼Œä¼šé”å®šå†…éƒ¨çš„AQSé”ï¼Œå¹¶ä¸”æ˜¯ä¸å¯é‡å…¥çš„ï¼ŒshutDownå…³é—­workeræ—¶ï¼Œä¼šè°ƒç”¨<code>interruptIdleWorkers()</code>æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¼šå…ˆå°è¯•è·å–å†…éƒ¨é”ï¼Œè·å–åˆ°åå†æ‰§è¡Œä¸­æ–­</p>
<hr>
<p>å‚è€ƒï¼š</p>
<ul>
<li><a href="https://www.cnblogs.com/thisiswhy/p/12221335.html" title="æœ‰çš„çº¿ç¨‹å®ƒæ­»äº†ï¼Œäºæ˜¯å®ƒå˜æˆä¸€é“é¢è¯•é¢˜">æœ‰çš„çº¿ç¨‹å®ƒæ­»äº†ï¼Œäºæ˜¯å®ƒå˜æˆä¸€é“é¢è¯•é¢˜</a></li>
<li><a href="https://www.cnblogs.com/trust-freedom/p/6681948.html#label_3_3" title="Javaçº¿ç¨‹æ± ThreadPoolExecutorä½¿ç”¨å’Œåˆ†æ(äºŒ) - execute()åŸç† ">Javaçº¿ç¨‹æ± ThreadPoolExecutorä½¿ç”¨å’Œåˆ†æ(äºŒ) - execute()åŸç† </a></li>
<li><a href="https://www.cnblogs.com/ttaall/p/15220042.html" title="æµ…èŠTomcatçº¿ç¨‹æ± ">æµ…èŠTomcatçº¿ç¨‹æ± </a></li>
</ul>
]]></content>
      <categories>
        <category>å¹¶å‘ç¼–ç¨‹</category>
      </categories>
      <tags>
        <tag>JUC</tag>
        <tag>çº¿ç¨‹æ± </tag>
      </tags>
  </entry>
  <entry>
    <title>å¾®æœåŠ¡ç†è®ºä½“ç³»</title>
    <url>/2023/02/08/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E7%90%86%E8%AE%BA%E4%BD%93%E7%B3%BB/</url>
    <content><![CDATA[<blockquote>
<p>æ•™ç¨‹æ¥è‡ª æå®¢æ—¶é—´ã€Šä»0å¼€å§‹å­¦å¾®æœåŠ¡ã€‹</p>
</blockquote>
<h1 id="1-å¾®æœåŠ¡å‘å±•å†å²"><a href="#1-å¾®æœåŠ¡å‘å±•å†å²" class="headerlink" title="1 å¾®æœåŠ¡å‘å±•å†å²"></a>1 å¾®æœåŠ¡å‘å±•å†å²</h1><ul>
<li><p><em><strong>å•ä½“åº”ç”¨é˜¶æ®µ</strong></em></p>
<p>æ—©æœŸäº’è”ç½‘å…¬å¸çš„æ¶æ„ï¼š</p>
<ul>
<li>LAMPï¼ˆLinux + Apache + MySQL + PHPï¼‰</li>
<li>MVCï¼ˆSpring + iBatis/Hibernate + Tomcatï¼‰</li>
</ul>
<p>ç‰¹ç‚¹ï¼šå›¢é˜Ÿè§„æ¨¡ä¸€èˆ¬ä¸è¶…è¿‡5äºº</p>
</li>
<li><p><em><strong>æœåŠ¡åŒ–æ€æƒ³</strong></em></p>
<p>æŠŠåŸæ¥æ•´ä¸ªå¤§çš„é¡¹ç›®ç²—ç•¥åˆ†ä¸ºä¸åŒçš„ä¸šåŠ¡æ¨¡å—ï¼Œæ‹†åˆ†å‡ºæ¥è¿›è¡Œç‹¬ç«‹éƒ¨ç½²ï¼Œå¹¶ä»¥RPCæ¥å£çš„å½¢å¼å¯¹å¤–æä¾›æœåŠ¡ã€‚è¿™æ ·åŸæ¥çš„æ¨¡å—å°±ä¼šç”±è¿›ç¨‹å†…è°ƒç”¨å˜ä¸ºè¿œç¨‹RPCè°ƒç”¨ï¼Œä¹Ÿå°±å¯ä»¥ç‹¬ç«‹å¼€å‘ã€æµ‹è¯•ã€ä¸Šçº¿å’Œè¿ç»´ï¼Œç”šè‡³äº¤ç»™ä¸åŒçš„å›¢é˜Ÿå»åšã€‚</p>
</li>
<li><p><em><strong>å¾®æœåŠ¡é˜¶æ®µ</strong></em></p>
<p>ç›¸æ¯”äºæœåŠ¡åŒ–ï¼Œå¾®æœåŠ¡æ‹†åˆ†ç²’åº¦æ›´ç»†ï¼ŒæœåŠ¡ä¹‹é—´æ›´åŠ ç‹¬ç«‹ï¼Œå¹¶ä¸”ç”±äºæ‹†åˆ†åçš„æœåŠ¡æ›´å¤šï¼Œéœ€è¦æœ‰ä¸€ä¸ªåŒä¸€ä¸ªç®¡ç†å¹³å°å»ç»´æŠ¤ï¼Œéœ€è¦åšæœåŠ¡ç›‘æ§ã€æœåŠ¡è¿½è¸ªã€æœåŠ¡æ²»ç†ç­‰å»ç®¡ç†</p>
</li>
</ul>
<span id="more"></span>

<h2 id="1-1-æœåŠ¡å‘å¸ƒå’Œå¼•ç”¨"><a href="#1-1-æœåŠ¡å‘å¸ƒå’Œå¼•ç”¨" class="headerlink" title="1.1 æœåŠ¡å‘å¸ƒå’Œå¼•ç”¨"></a>1.1 æœåŠ¡å‘å¸ƒå’Œå¼•ç”¨</h2><blockquote>
<p>ğŸ“Œæœ€å¸¸è§çš„æœåŠ¡å‘å¸ƒå’Œå¼•ç”¨çš„æ–¹å¼æœ‰ä¸‰ç§ï¼š</p>
<ul>
<li>RESTful API</li>
<li>XMLé…ç½®</li>
<li>IDLæ–‡ä»¶</li>
</ul>
</blockquote>
<h3 id="1-1-1-RESTful-API"><a href="#1-1-1-RESTful-API" class="headerlink" title="1.1.1 RESTful API"></a>1.1.1 RESTful API</h3><p>ä¸»è¦è¢«<strong>ç”¨ä½œHTTPæˆ–è€…HTTPSåè®®çš„æ¥å£å®šä¹‰</strong>ï¼Œå³ä½¿åœ¨éå¾®æœåŠ¡æ¶æ„ä½“ç³»ä¸‹ï¼Œä¹Ÿè¢«å¹¿æ³›é‡‡ç”¨ã€‚</p>
<p>æœåŠ¡æä¾›è€…å’Œæ¶ˆè´¹è€…é—´é€šè¿‡HTTPåè®®è¿›è¡Œäº¤äº’ï¼Œé€‚åˆéœ€è¦å‘å…¶ä»–ä¸šåŠ¡éƒ¨åˆ†æä¾›æœåŠ¡æˆ–è€…ç»™å¤–ç½‘æä¾›æœåŠ¡çš„åœºæ™¯</p>
<h3 id="1-1-2-XMLé…ç½®"><a href="#1-1-2-XMLé…ç½®" class="headerlink" title="1.1.2 XMLé…ç½®"></a>1.1.2 XMLé…ç½®</h3><p>è¿™ç§æ–¹å¼çš„æœåŠ¡å‘å¸ƒå’Œå¼•ç”¨ä¸»è¦åˆ†ä¸‰ä¸ªæ­¥éª¤ï¼š</p>
<ul>
<li>æœåŠ¡æä¾›è€…å®šä¹‰æ¥å£ï¼Œå¹¶å®ç°æ¥å£ã€‚</li>
<li>æœåŠ¡æä¾›è€…è¿›ç¨‹å¯åŠ¨æ—¶ï¼Œé€šè¿‡åŠ è½½server.xmlé…ç½®æ–‡ä»¶å°†æ¥å£æš´éœ²å‡ºå»ã€‚</li>
<li>æœåŠ¡æ¶ˆè´¹è€…è¿›ç¨‹å¯åŠ¨æ—¶ï¼Œé€šè¿‡åŠ è½½client.xmlé…ç½®æ–‡ä»¶æ¥å¼•å…¥è¦è°ƒç”¨çš„æ¥å£ã€‚</li>
</ul>
<p>æœåŠ¡æä¾›è€…å’ŒæœåŠ¡æ¶ˆè´¹è€…ä¹‹é—´ç»´æŒä¸€ä»½å¯¹ç­‰çš„XMLé…ç½®æ–‡ä»¶ï¼Œæ¥ä¿è¯æœåŠ¡æ¶ˆè´¹è€…æŒ‰ç…§æœåŠ¡æä¾›è€…çš„çº¦å®šæ¥è¿›è¡ŒæœåŠ¡è°ƒç”¨ã€‚åœ¨è¿™ç§æ–¹å¼ä¸‹ï¼Œå¦‚æœæœåŠ¡æä¾›è€…å˜æ›´äº†æ¥å£å®šä¹‰ï¼Œä¸ä»…éœ€è¦æ›´æ–°server.xmlï¼Œè¿˜éœ€è¦åŒæ—¶æ›´æ–°client.xmlã€‚</p>
<p>é€‚ç”¨åœºæ™¯ï¼š</p>
<ul>
<li>ç§æœ‰RPCæ¡†æ¶ï¼ˆæ€§èƒ½è¦æ±‚é«˜ï¼‰</li>
<li>å…¬å¸å†…éƒ¨è”ç³»æ¯”è¾ƒç´§å¯†çš„ä¸šåŠ¡</li>
</ul>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span> </span></span><br><span class="line"><span class="tag">      <span class="attr">xmlns:context</span>=<span class="string">"http://www.springframework.org/schema/context"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">xmlns:aop</span>=<span class="string">"http://www.springframework.org/schema/aop"</span> </span></span><br><span class="line"><span class="tag">     <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/context</span></span></span><br><span class="line"><span class="string"><span class="tag">            http://www.springframework.org/schema/context/spring-context-2.5.xsd</span></span></span><br><span class="line"><span class="string"><span class="tag">http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-2.5.xsd</span></span></span><br><span class="line"><span class="string"><span class="tag">http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop-2.5.xsd</span></span></span><br><span class="line"><span class="string"><span class="tag">"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">   <span class="tag">&lt;<span class="name">motan:service</span> <span class="attr">ref</span>=<span class="string">"userLastStatusLocalService"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">requestTimeout</span>=<span class="string">"50"</span> <span class="attr">retries</span>=<span class="string">"2"</span>    <span class="attr">interface</span>=<span class="string">"com.weibo.api.common.status.service.UserLastStatusService"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">basicService</span>=<span class="string">"serviceBasicConfig"</span> <span class="attr">export</span>=<span class="string">"motan:8882"</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">motan:method</span> <span class="attr">name</span>=<span class="string">"getLastStatusId"</span> <span class="attr">requestTimeout</span>=<span class="string">"300"</span></span></span><br><span class="line"><span class="tag">              <span class="attr">retries</span>=<span class="string">"0"</span> /&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">motan:method</span> <span class="attr">name</span>=<span class="string">"getLastStatusIds"</span> <span class="attr">requestTimeout</span>=<span class="string">"300"</span></span></span><br><span class="line"><span class="tag">              <span class="attr">retries</span>=<span class="string">"0"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">motan:service</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h3 id="1-1-3-IDLæ–‡ä»¶"><a href="#1-1-3-IDLæ–‡ä»¶" class="headerlink" title="1.1.3 IDLæ–‡ä»¶"></a>1.1.3 IDLæ–‡ä»¶</h3><p>é€šè¿‡ä¸€ç§ä¸­ç«‹çš„æ–¹å¼æ¥æè¿°æ¥å£ï¼Œä½¿å¾—åœ¨ä¸åŒçš„å¹³å°ä¸Šè¿è¡Œçš„å¯¹è±¡å’Œä¸åŒè¯­è¨€ç¼–å†™çš„ç¨‹åºå¯ä»¥ç›¸äº’é€šä¿¡äº¤æµã€‚</p>
<p>æœ‰ä¸¤ç§æœ€å¸¸ç”¨çš„IDLï¼š</p>
<ul>
<li>Facebookå¼€æºçš„<strong>Thriftåè®®</strong></li>
<li>Googleå¼€æºçš„<strong>gRPCåè®®</strong>ã€‚</li>
</ul>
<h2 id="1-2-æ³¨å†Œä¸­å¿ƒ"><a href="#1-2-æ³¨å†Œä¸­å¿ƒ" class="headerlink" title="1.2 æ³¨å†Œä¸­å¿ƒ"></a>1.2 æ³¨å†Œä¸­å¿ƒ</h2><ul>
<li>æœåŠ¡æ³¨å†Œ</li>
<li>æœåŠ¡å‘ç°</li>
</ul>
<h3 id="1-2-1-æ³¨å†Œä¸­å¿ƒåŸç†"><a href="#1-2-1-æ³¨å†Œä¸­å¿ƒåŸç†" class="headerlink" title="1.2.1 æ³¨å†Œä¸­å¿ƒåŸç†"></a>1.2.1 æ³¨å†Œä¸­å¿ƒåŸç†</h3><p><img src="/../images/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E7%90%86%E8%AE%BA%E4%BD%93%E7%B3%BB/image_qRiIliPDtc.png"></p>
<ul>
<li>RPC Serveræä¾›æœåŠ¡ï¼Œåœ¨å¯åŠ¨æ—¶ï¼Œæ ¹æ®æœåŠ¡å‘å¸ƒæ–‡ä»¶server.xmlä¸­çš„é…ç½®çš„ä¿¡æ¯ï¼Œå‘Registryæ³¨å†Œè‡ªèº«æœåŠ¡ï¼Œå¹¶å‘Registryå®šæœŸå‘é€å¿ƒè·³æ±‡æŠ¥å­˜æ´»çŠ¶æ€ã€‚</li>
<li>RPC Clientè°ƒç”¨æœåŠ¡ï¼Œåœ¨å¯åŠ¨æ—¶ï¼Œæ ¹æ®æœåŠ¡å¼•ç”¨æ–‡ä»¶client.xmlä¸­é…ç½®çš„ä¿¡æ¯ï¼Œå‘Registryè®¢é˜…æœåŠ¡ï¼ŒæŠŠRegistryè¿”å›çš„æœåŠ¡èŠ‚ç‚¹åˆ—è¡¨ç¼“å­˜åœ¨æœ¬åœ°å†…å­˜ä¸­ï¼Œå¹¶ä¸RPC Severå»ºç«‹è¿æ¥ã€‚</li>
<li>å½“RPC ServerèŠ‚ç‚¹å‘ç”Ÿå˜æ›´æ—¶ï¼ŒRegistryä¼šåŒæ­¥å˜æ›´ï¼ŒRPC Clientæ„ŸçŸ¥åä¼šåˆ·æ–°æœ¬åœ°å†…å­˜ä¸­ç¼“å­˜çš„æœåŠ¡èŠ‚ç‚¹åˆ—è¡¨ã€‚</li>
<li>RPC Clientä»æœ¬åœ°ç¼“å­˜çš„æœåŠ¡èŠ‚ç‚¹åˆ—è¡¨ä¸­ï¼Œ<strong>åŸºäºè´Ÿè½½å‡è¡¡ç®—æ³•</strong>é€‰æ‹©ä¸€å°RPC Severå‘èµ·è°ƒç”¨ã€‚</li>
</ul>
<h3 id="1-2-2-æ³¨å†Œä¸­å¿ƒå®ç°æ–¹å¼"><a href="#1-2-2-æ³¨å†Œä¸­å¿ƒå®ç°æ–¹å¼" class="headerlink" title="1.2.2 æ³¨å†Œä¸­å¿ƒå®ç°æ–¹å¼"></a>1.2.2 æ³¨å†Œä¸­å¿ƒå®ç°æ–¹å¼</h3><h4 id="æ³¨å†Œä¸­å¿ƒAPI"><a href="#æ³¨å†Œä¸­å¿ƒAPI" class="headerlink" title="æ³¨å†Œä¸­å¿ƒAPI"></a><strong>æ³¨å†Œä¸­å¿ƒAPI</strong></h4><ul>
<li>æœåŠ¡æ³¨å†Œæ¥å£ï¼šæœåŠ¡æä¾›è€…é€šè¿‡è°ƒç”¨æœåŠ¡æ³¨å†Œæ¥å£æ¥å®ŒæˆæœåŠ¡æ³¨å†Œã€‚</li>
<li>æœåŠ¡åæ³¨å†Œæ¥å£ï¼šæœåŠ¡æä¾›è€…é€šè¿‡è°ƒç”¨æœåŠ¡åæ³¨å†Œæ¥å£æ¥å®ŒæˆæœåŠ¡æ³¨é”€ã€‚</li>
<li>å¿ƒè·³æ±‡æŠ¥æ¥å£ï¼šæœåŠ¡æä¾›è€…é€šè¿‡è°ƒç”¨å¿ƒè·³æ±‡æŠ¥æ¥å£å®ŒæˆèŠ‚ç‚¹å­˜æ´»çŠ¶æ€ä¸ŠæŠ¥ã€‚</li>
<li>æœåŠ¡è®¢é˜…æ¥å£ï¼šæœåŠ¡æ¶ˆè´¹è€…é€šè¿‡è°ƒç”¨æœåŠ¡è®¢é˜…æ¥å£å®ŒæˆæœåŠ¡è®¢é˜…ï¼Œè·å–å¯ç”¨çš„æœåŠ¡æä¾›è€…èŠ‚ç‚¹åˆ—è¡¨ã€‚</li>
<li>æœåŠ¡å˜æ›´æŸ¥è¯¢æ¥å£ï¼šæœåŠ¡æ¶ˆè´¹è€…é€šè¿‡è°ƒç”¨æœåŠ¡å˜æ›´æŸ¥è¯¢æ¥å£ï¼Œè·å–æœ€æ–°çš„å¯ç”¨æœåŠ¡èŠ‚ç‚¹åˆ—è¡¨ã€‚</li>
<li>æœåŠ¡æŸ¥è¯¢æ¥å£ï¼šæŸ¥è¯¢æ³¨å†Œä¸­å¿ƒå½“å‰æ³¨å†Œäº†å“ªäº›æœåŠ¡ä¿¡æ¯ã€‚</li>
<li>æœåŠ¡ä¿®æ”¹æ¥å£ï¼šä¿®æ”¹æ³¨å†Œä¸­å¿ƒä¸­æŸä¸€æœåŠ¡çš„ä¿¡æ¯ã€‚</li>
</ul>
<h4 id="1-2-2-2-é›†ç¾¤éƒ¨ç½²"><a href="#1-2-2-2-é›†ç¾¤éƒ¨ç½²" class="headerlink" title="1.2.2.2 é›†ç¾¤éƒ¨ç½²"></a>1.2.2.2 é›†ç¾¤éƒ¨ç½²</h4><p>æ³¨å†Œä¸­å¿ƒä½œä¸ºæœåŠ¡æä¾›è€…å’ŒæœåŠ¡æ¶ˆè´¹è€…ä¹‹é—´æ²Ÿé€šçš„æ¡¥æ¢ï¼Œå®ƒçš„é‡è¦æ€§ä¸è¨€è€Œå–»ã€‚æ‰€ä»¥æ³¨å†Œä¸­å¿ƒä¸€èˆ¬éƒ½æ˜¯é‡‡ç”¨é›†ç¾¤éƒ¨ç½²æ¥ä¿è¯é«˜å¯ç”¨æ€§ï¼Œå¹¶é€šè¿‡åˆ†å¸ƒå¼ä¸€è‡´æ€§åè®®æ¥ç¡®ä¿é›†ç¾¤ä¸­ä¸åŒèŠ‚ç‚¹ä¹‹é—´çš„æ•°æ®ä¿æŒä¸€è‡´ã€‚</p>
<p>ä»¥ZooKeeperä¸ºä¾‹ï¼ŒZooKeeperé›†ç¾¤ä¸­åŒ…å«å¤šä¸ªèŠ‚ç‚¹ï¼ŒæœåŠ¡æä¾›è€…å’ŒæœåŠ¡æ¶ˆè´¹è€…å¯ä»¥åŒä»»æ„ä¸€ä¸ªèŠ‚ç‚¹é€šä¿¡ï¼Œå› ä¸ºå®ƒä»¬çš„æ•°æ®ä¸€å®šæ˜¯ç›¸åŒçš„ã€‚ZooKeeperçš„å·¥ä½œåŸç†ï¼š</p>
<p><img src="/../images/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E7%90%86%E8%AE%BA%E4%BD%93%E7%B3%BB/image_o-_tuXD8rn.png"></p>
<ul>
<li>æ¯ä¸ªServeråœ¨å†…å­˜ä¸­å­˜å‚¨äº†ä¸€ä»½æ•°æ®ï¼ŒClientçš„è¯»è¯·æ±‚å¯ä»¥è¯·æ±‚ä»»æ„ä¸€ä¸ªServer</li>
<li>ZooKeeperå¯åŠ¨æ—¶ï¼Œå°†ä»å®ä¾‹ä¸­é€‰ä¸¾ä¸€ä¸ªleaderï¼ˆPaxosåè®®ï¼‰</li>
<li>Leaderè´Ÿè´£å¤„ç†æ•°æ®æ›´æ–°ç­‰æ“ä½œï¼ˆZABåè®®ï¼‰</li>
<li>ä¸€ä¸ªæ›´æ–°æ“ä½œæˆåŠŸï¼Œå½“ä¸”ä»…å½“å¤§å¤šæ•°Serveråœ¨å†…å­˜ä¸­æˆåŠŸä¿®æ”¹ </li>
</ul>
<p>é€šè¿‡ä¸Šé¢è¿™ç§æ–¹å¼ï¼ŒZooKeeperä¿è¯äº†<strong>é«˜å¯ç”¨æ€§</strong>ä»¥åŠ<strong>æ•°æ®ä¸€è‡´æ€§</strong></p>
<h4 id="ç›®å½•å­˜å‚¨"><a href="#ç›®å½•å­˜å‚¨" class="headerlink" title="ç›®å½•å­˜å‚¨"></a><strong>ç›®å½•å­˜å‚¨</strong></h4><p>è¿˜æ˜¯ä»¥ZooKeeperä¸ºä¾‹ï¼Œæ³¨å†Œä¸­å¿ƒå­˜å‚¨æœåŠ¡ä¿¡æ¯ä¸€èˆ¬é‡‡ç”¨å±‚æ¬¡åŒ–çš„ç›®å½•ç»“æ„ï¼š</p>
<ul>
<li>æ¯ä¸ªç›®å½•åœ¨ZooKeeperä¸­å«ä½œznodeï¼Œå¹¶ä¸”å…¶æœ‰ä¸€ä¸ªå”¯ä¸€çš„è·¯å¾„æ ‡è¯†ã€‚</li>
<li>znodeå¯ä»¥åŒ…å«æ•°æ®å’Œå­znodeã€‚</li>
<li>znodeä¸­çš„æ•°æ®å¯ä»¥æœ‰å¤šä¸ªç‰ˆæœ¬ï¼Œæ¯”å¦‚æŸä¸€ä¸ªznodeä¸‹å­˜æœ‰å¤šä¸ªæ•°æ®ç‰ˆæœ¬ï¼Œé‚£ä¹ˆæŸ¥è¯¢è¿™ä¸ªè·¯å¾„ä¸‹çš„æ•°æ®éœ€å¸¦ä¸Šç‰ˆæœ¬ä¿¡æ¯ã€‚</li>
</ul>
<p><img src="/../images/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E7%90%86%E8%AE%BA%E4%BD%93%E7%B3%BB/image_gn7reAdS58.png"></p>
<h4 id="æœåŠ¡å¥åº·çŠ¶æ€æ£€æµ‹"><a href="#æœåŠ¡å¥åº·çŠ¶æ€æ£€æµ‹" class="headerlink" title="æœåŠ¡å¥åº·çŠ¶æ€æ£€æµ‹"></a><strong>æœåŠ¡å¥åº·çŠ¶æ€æ£€æµ‹</strong></h4><p>ä¸€æ—¦æ³¨å†Œä¸­å¿ƒæ¢æµ‹åˆ°æœ‰æœåŠ¡æä¾›è€…èŠ‚ç‚¹æ–°åŠ å…¥æˆ–è€…è¢«å‰”é™¤ï¼Œå°±å¿…é¡»ç«‹åˆ»é€šçŸ¥æ‰€æœ‰è®¢é˜…è¯¥æœåŠ¡çš„æœåŠ¡æ¶ˆè´¹è€…ï¼Œåˆ·æ–°æœ¬åœ°ç¼“å­˜çš„æœåŠ¡èŠ‚ç‚¹ä¿¡æ¯ï¼Œç¡®ä¿æœåŠ¡è°ƒç”¨ä¸ä¼šè¯·æ±‚ä¸å¯ç”¨çš„æœåŠ¡æä¾›è€…èŠ‚ç‚¹ã€‚</p>
<p>ç»§ç»­ä»¥ZooKeeperä¸ºä¾‹ï¼ŒåŸºäºZooKeeperçš„<strong>Watcheræœºåˆ¶</strong>ï¼Œæ¥å®ç°æœåŠ¡çŠ¶æ€å˜æ›´é€šçŸ¥ç»™æœåŠ¡æ¶ˆè´¹è€…çš„ã€‚æœåŠ¡æ¶ˆè´¹è€…åœ¨è°ƒç”¨ZooKeeperçš„getDataæ–¹æ³•è®¢é˜…æœåŠ¡æ—¶ï¼Œè¿˜å¯ä»¥é€šè¿‡ç›‘å¬å™¨Watcherçš„processæ–¹æ³•è·å–æœåŠ¡çš„å˜æ›´ï¼Œç„¶åè°ƒç”¨getDataæ–¹æ³•æ¥è·å–å˜æ›´åçš„æ•°æ®ï¼Œåˆ·æ–°æœ¬åœ°ç¼“å­˜çš„æœåŠ¡èŠ‚ç‚¹ä¿¡æ¯ã€‚</p>
<h4 id="1-2-2-5-ç™½åå•æœºåˆ¶"><a href="#1-2-2-5-ç™½åå•æœºåˆ¶" class="headerlink" title="1.2.2.5 ç™½åå•æœºåˆ¶"></a>1.2.2.5 ç™½åå•æœºåˆ¶</h4><p>åœ¨å®é™…åº”ç”¨ä¸­ï¼Œæ³¨å†Œä¸­å¿ƒå¯ä»¥æä¾›ä¸€ä¸ªç™½åå•æœºåˆ¶ï¼Œåªæœ‰æ·»åŠ åˆ°æ³¨å†Œä¸­å¿ƒç™½åå•å†…çš„RPC Serverï¼Œæ‰èƒ½å¤Ÿè°ƒç”¨æ³¨å†Œä¸­å¿ƒçš„æ³¨å†Œæ¥å£ï¼Œè¿™æ ·çš„è¯å¯ä»¥é¿å…æµ‹è¯•ç¯å¢ƒä¸­çš„èŠ‚ç‚¹æ„å¤–è·‘åˆ°çº¿ä¸Šç¯å¢ƒä¸­å»ã€‚</p>
<h2 id="1-3-RPCè¿œç¨‹è°ƒç”¨"><a href="#1-3-RPCè¿œç¨‹è°ƒç”¨" class="headerlink" title="1.3 RPCè¿œç¨‹è°ƒç”¨"></a>1.3 RPCè¿œç¨‹è°ƒç”¨</h2><blockquote>
<p>RPCåè®®çš„ä¸»è¦ç›®çš„æ˜¯åšåˆ°ä¸åŒæœåŠ¡é—´è°ƒç”¨æ–¹æ³•åƒåŒä¸€æœåŠ¡é—´è°ƒç”¨æœ¬åœ°æ–¹æ³•ä¸€æ ·</p>
</blockquote>
<p>ç”±æœåŠ¡æä¾›è€…ç»™å‡ºä¸šåŠ¡æ¥å£å£°æ˜ï¼Œåœ¨è°ƒç”¨æ–¹çš„ç¨‹åºé‡Œé¢ï¼ŒRPCæ¡†æ¶æ ¹æ®è°ƒç”¨çš„æœåŠ¡æ¥å£æå‰ç”ŸæˆåŠ¨æ€ä»£ç†å®ç°ç±»ï¼Œå¹¶é€šè¿‡ä¾èµ–æ³¨å…¥ç­‰æŠ€æœ¯æ³¨å…¥åˆ°å£°æ˜äº†è¯¥æ¥å£çš„ç›¸å…³ä¸šåŠ¡é€»è¾‘é‡Œé¢ã€‚è¯¥ä»£ç†å®ç°ç±»ä¼šæ‹¦æˆªæ‰€æœ‰çš„æ–¹æ³•è°ƒç”¨ï¼Œåœ¨æä¾›çš„æ–¹æ³•å¤„ç†é€»è¾‘é‡Œé¢å®Œæˆä¸€æ•´å¥—çš„è¿œç¨‹è°ƒç”¨ï¼Œå¹¶æŠŠè¿œç¨‹è°ƒç”¨ç»“æœè¿”å›ç»™è°ƒç”¨æ–¹ï¼Œè¿™æ ·è°ƒç”¨æ–¹åœ¨è°ƒç”¨è¿œç¨‹æ–¹æ³•çš„æ—¶å€™å°±è·å¾—äº†åƒè°ƒç”¨æœ¬åœ°æ¥å£ä¸€æ ·çš„ä½“éªŒã€‚</p>
<p><img src="/../images/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E7%90%86%E8%AE%BA%E4%BD%93%E7%B3%BB/image_cSeWjwsfhb.png"></p>
<p>è¦å®Œæˆä¸€æ¬¡RPCè°ƒç”¨ï¼Œå°±å¿…é¡»å…ˆå»ºç«‹ç½‘ç»œè¿æ¥ã€‚å»ºç«‹è¿æ¥åï¼ŒåŒæ–¹è¿˜å¿…é¡»æŒ‰ç…§æŸç§çº¦å®šçš„åè®®è¿›è¡Œç½‘ç»œé€šä¿¡ï¼Œè¿™ä¸ªåè®®å°±æ˜¯é€šä¿¡åè®®ã€‚åŒæ–¹èƒ½å¤Ÿæ­£å¸¸é€šä¿¡åï¼ŒæœåŠ¡ç«¯æ¥æ”¶åˆ°è¯·æ±‚æ—¶ï¼Œéœ€è¦ä»¥æŸç§æ–¹å¼è¿›è¡Œå¤„ç†ï¼Œå¤„ç†æˆåŠŸåï¼ŒæŠŠè¯·æ±‚ç»“æœè¿”å›ç»™å®¢æˆ·ç«¯ã€‚ä¸ºäº†å‡å°‘ä¼ è¾“çš„æ•°æ®å¤§å°ï¼Œè¿˜è¦å¯¹æ•°æ®è¿›è¡Œå‹ç¼©ï¼Œä¹Ÿå°±æ˜¯å¯¹æ•°æ®è¿›è¡Œåºåˆ—åŒ–ã€‚</p>
<h3 id="1-3-1-å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯å¦‚ä½•å»ºç«‹ç½‘ç»œè¿æ¥ï¼Ÿ"><a href="#1-3-1-å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯å¦‚ä½•å»ºç«‹ç½‘ç»œè¿æ¥ï¼Ÿ" class="headerlink" title="1.3.1 å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯å¦‚ä½•å»ºç«‹ç½‘ç»œè¿æ¥ï¼Ÿ"></a>1.3.1 å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯å¦‚ä½•å»ºç«‹ç½‘ç»œè¿æ¥ï¼Ÿ</h3><ol>
<li><p>HTTPé€šä¿¡</p>
</li>
<li><p>Socketé€šä¿¡</p>
<p>Socketé€šä¿¡æ˜¯åŸºäºTCP/IPåè®®çš„å°è£…ï¼Œå»ºç«‹ä¸€æ¬¡Socketè¿æ¥è‡³å°‘éœ€è¦ä¸€å¯¹å¥—æ¥å­—ï¼Œå…¶ä¸­ä¸€ä¸ªè¿è¡Œäºå®¢æˆ·ç«¯ï¼Œç§°ä¸ºClientSocketï¼›å¦ä¸€ä¸ªè¿è¡ŒäºæœåŠ¡å™¨ç«¯ï¼Œç§°ä¸ºServerSocketã€‚Socketé€šä¿¡çš„è¿‡ç¨‹åˆ†ä¸ºå››ä¸ªæ­¥éª¤ï¼šæœåŠ¡å™¨ç›‘å¬ã€å®¢æˆ·ç«¯è¯·æ±‚ã€è¿æ¥ç¡®è®¤ã€æ•°æ®ä¼ è¾“ã€‚</p>
</li>
</ol>
<h3 id="1-3-2-æœåŠ¡ç«¯å¦‚ä½•å¤„ç†è¯·æ±‚ï¼Ÿ"><a href="#1-3-2-æœåŠ¡ç«¯å¦‚ä½•å¤„ç†è¯·æ±‚ï¼Ÿ" class="headerlink" title="1.3.2 æœåŠ¡ç«¯å¦‚ä½•å¤„ç†è¯·æ±‚ï¼Ÿ"></a>1.3.2 æœåŠ¡ç«¯å¦‚ä½•å¤„ç†è¯·æ±‚ï¼Ÿ</h3><p>ä¸‰ç§å¤„ç†æ–¹å¼ï¼š</p>
<ul>
<li><p>åŒæ­¥é˜»å¡æ–¹å¼ï¼ˆBIOï¼‰ï¼šå®¢æˆ·ç«¯æ¯å‘ä¸€æ¬¡è¯·æ±‚ï¼ŒæœåŠ¡ç«¯å°±ç”Ÿæˆä¸€ä¸ªçº¿ç¨‹å»å¤„ç†ã€‚</p>
<p>é€‚ç”¨äºè¿æ¥æ•°æ¯”è¾ƒå°çš„ä¸šåŠ¡åœºæ™¯ï¼Œè¿™æ ·çš„è¯ä¸è‡³äºç³»ç»Ÿä¸­æ²¡æœ‰å¯ç”¨çº¿ç¨‹å»å¤„ç†è¯·æ±‚ã€‚è¿™ç§æ–¹å¼å†™çš„ç¨‹åºä¹Ÿæ¯”è¾ƒç®€å•ç›´è§‚ï¼Œæ˜“äºç†è§£ã€‚</p>
</li>
<li><p>åŒæ­¥éé˜»å¡æ–¹å¼ (NIO)ï¼šå®¢æˆ·ç«¯æ¯å‘ä¸€æ¬¡è¯·æ±‚ï¼ŒæœåŠ¡ç«¯å¹¶ä¸æ˜¯æ¯æ¬¡éƒ½åˆ›å»ºä¸€ä¸ªæ–°çº¿ç¨‹æ¥å¤„ç†ï¼Œè€Œæ˜¯é€šè¿‡I/Oå¤šè·¯å¤ç”¨æŠ€æœ¯è¿›è¡Œå¤„ç†ã€‚å°±æ˜¯æŠŠå¤šä¸ªI/Oçš„é˜»å¡å¤ç”¨åˆ°åŒä¸€ä¸ªselectçš„é˜»å¡ä¸Šï¼Œä»è€Œä½¿ç³»ç»Ÿåœ¨å•çº¿ç¨‹çš„æƒ…å†µä¸‹å¯ä»¥åŒæ—¶å¤„ç†å¤šä¸ªå®¢æˆ·ç«¯è¯·æ±‚ã€‚</p>
<p>é€‚ç”¨äºè¿æ¥æ•°æ¯”è¾ƒå¤šå¹¶ä¸”è¯·æ±‚æ¶ˆè€—æ¯”è¾ƒè½»çš„ä¸šåŠ¡åœºæ™¯ï¼Œæ¯”å¦‚èŠå¤©æœåŠ¡å™¨ã€‚è¿™ç§æ–¹å¼ç›¸æ¯”BIOï¼Œç›¸å¯¹æ¥è¯´ç¼–ç¨‹æ¯”è¾ƒå¤æ‚ã€‚</p>
</li>
<li><p>å¼‚æ­¥éé˜»å¡æ–¹å¼ï¼ˆAIOï¼‰ï¼šå®¢æˆ·ç«¯åªéœ€è¦å‘èµ·ä¸€ä¸ªI/Oæ“ä½œç„¶åç«‹å³è¿”å›ï¼Œç­‰I/Oæ“ä½œçœŸæ­£å®Œæˆä»¥åï¼Œå®¢æˆ·ç«¯ä¼šå¾—åˆ°I/Oæ“ä½œå®Œæˆçš„é€šçŸ¥ï¼Œæ­¤æ—¶å®¢æˆ·ç«¯åªéœ€è¦å¯¹æ•°æ®è¿›è¡Œå¤„ç†å°±å¥½äº†ï¼Œä¸éœ€è¦è¿›è¡Œå®é™…çš„I/Oè¯»å†™æ“ä½œï¼Œå› ä¸ºçœŸæ­£çš„I/Oè¯»å–æˆ–è€…å†™å…¥æ“ä½œå·²ç»ç”±å†…æ ¸å®Œæˆäº†ã€‚</p>
<p>é€‚ç”¨äºè¿æ¥æ•°æ¯”è¾ƒå¤šè€Œä¸”è¯·æ±‚æ¶ˆè€—æ¯”è¾ƒé‡çš„ä¸šåŠ¡åœºæ™¯ï¼Œæ¯”å¦‚æ¶‰åŠI/Oæ“ä½œçš„ç›¸å†ŒæœåŠ¡å™¨ã€‚è¿™ç§æ–¹å¼ç›¸æ¯”å¦å¤–ä¸¤ç§ï¼Œç¼–ç¨‹éš¾åº¦æœ€å¤§ï¼Œç¨‹åºä¹Ÿä¸æ˜“äºç†è§£ã€‚</p>
</li>
</ul>
<p>ä¸Šé¢ä¸¤ä¸ªé—®é¢˜å°±æ˜¯â€œ<em><strong>é€šä¿¡æ¡†æ¶</strong></em>â€è¦è§£å†³çš„é—®é¢˜ï¼Œå¸¸ç”¨å¼€æºé€šä¿¡æ¡†æ¶æœ‰Nettyã€MINAç­‰</p>
<h3 id="1-3-3-æ•°æ®ä¼ è¾“é‡‡ç”¨ä»€ä¹ˆåè®®ï¼Ÿ"><a href="#1-3-3-æ•°æ®ä¼ è¾“é‡‡ç”¨ä»€ä¹ˆåè®®ï¼Ÿ" class="headerlink" title="1.3.3 æ•°æ®ä¼ è¾“é‡‡ç”¨ä»€ä¹ˆåè®®ï¼Ÿ"></a>1.3.3 æ•°æ®ä¼ è¾“é‡‡ç”¨ä»€ä¹ˆåè®®ï¼Ÿ</h3><ul>
<li>å¼€æ”¾åè®®ï¼šå¦‚æœ€å¸¸ç”¨çš„Http</li>
<li>ç§æœ‰åè®®ï¼šå¦‚Dubbo</li>
</ul>
<p>åè®®çš„ä½œç”¨å°±æ˜¯â€œçº¦å®šâ€ã€‚æ¶ˆè´¹è€…æŒ‰ç…§çº¦å®šå¯¹æ•°æ®è¿›è¡ŒåŠ å¯†ä¼ è¾“ï¼Œæä¾›è€…æŒ‰ç…§çº¦å®šè§£ç æ•°æ®å¹¶è¿›è¡Œå¤„ç†ï¼Œæœ€åå†åŠ å¯†å‘ç»™æ¶ˆè´¹è€…ã€‚</p>
<h3 id="1-3-4-æ•°æ®è¯¥å¦‚ä½•åºåˆ—åŒ–å’Œååºåˆ—åŒ–ï¼Ÿ"><a href="#1-3-4-æ•°æ®è¯¥å¦‚ä½•åºåˆ—åŒ–å’Œååºåˆ—åŒ–ï¼Ÿ" class="headerlink" title="1.3.4 æ•°æ®è¯¥å¦‚ä½•åºåˆ—åŒ–å’Œååºåˆ—åŒ–ï¼Ÿ"></a>1.3.4 æ•°æ®è¯¥å¦‚ä½•åºåˆ—åŒ–å’Œååºåˆ—åŒ–ï¼Ÿ</h3><p>å¸¸ç”¨çš„åºåˆ—åŒ–æ–¹å¼åˆ†ä¸ºä¸¤ç±»ï¼šæ–‡æœ¬ç±»å¦‚<code>XML/JSON</code>ç­‰ï¼ŒäºŒè¿›åˆ¶ç±»å¦‚<code>PB/Thrift</code>ç­‰ï¼Œè€Œå…·ä½“é‡‡ç”¨å“ªç§åºåˆ—åŒ–æ–¹å¼ï¼Œä¸»è¦å–å†³äºä¸‰ä¸ªæ–¹é¢çš„å› ç´ ã€‚</p>
<h2 id="1-4-æœåŠ¡ç›‘æ§"><a href="#1-4-æœåŠ¡ç›‘æ§" class="headerlink" title="1.4 æœåŠ¡ç›‘æ§"></a>1.4 æœåŠ¡ç›‘æ§</h2><p>æœåŠ¡ç›‘æ§çš„ä¸‰ä¸ªå…³é”®ç‚¹ï¼š</p>
<h3 id="1-4-1-ç›‘æ§å¯¹è±¡"><a href="#1-4-1-ç›‘æ§å¯¹è±¡" class="headerlink" title="1.4.1 ç›‘æ§å¯¹è±¡"></a>1.4.1 ç›‘æ§å¯¹è±¡</h3><ul>
<li>ç”¨æˆ·ç«¯ç›‘æ§</li>
<li>æ¥å£ç›‘æ§</li>
<li>èµ„æºç›‘æ§</li>
<li>åŸºç¡€ç›‘æ§</li>
</ul>
<h3 id="1-4-2-ç›‘æ§æŒ‡æ ‡"><a href="#1-4-2-ç›‘æ§æŒ‡æ ‡" class="headerlink" title="1.4.2 ç›‘æ§æŒ‡æ ‡"></a>1.4.2 ç›‘æ§æŒ‡æ ‡</h3><ul>
<li>è¯·æ±‚é‡</li>
<li>å“åº”æ—¶é—´</li>
<li>é”™è¯¯ç‡</li>
</ul>
<h3 id="1-4-3-ç›‘æ§ç³»ç»ŸåŸç†"><a href="#1-4-3-ç›‘æ§ç³»ç»ŸåŸç†" class="headerlink" title="1.4.3 ç›‘æ§ç³»ç»ŸåŸç†"></a>1.4.3 ç›‘æ§ç³»ç»ŸåŸç†</h3><p>ç›‘æ§ç³»ç»Ÿä¸»è¦åŒ…æ‹¬å››ä¸ªç¯èŠ‚ï¼šæ•°æ®é‡‡é›†ã€æ•°æ®ä¼ è¾“ã€æ•°æ®å¤„ç†å’Œæ•°æ®å±•ç¤º</p>
<h4 id="æ•°æ®é‡‡é›†"><a href="#æ•°æ®é‡‡é›†" class="headerlink" title="æ•°æ®é‡‡é›†"></a><strong>æ•°æ®é‡‡é›†</strong></h4><p>é€šå¸¸æœ‰ä¸¤ç§æ•°æ®é‡‡é›†æ–¹å¼ï¼š</p>
<ul>
<li>æœåŠ¡ä¸»åŠ¨ä¸ŠæŠ¥</li>
<li>ä»£ç†æ”¶é›†</li>
</ul>
<h4 id="æ•°æ®ä¼ è¾“"><a href="#æ•°æ®ä¼ è¾“" class="headerlink" title="æ•°æ®ä¼ è¾“"></a><strong>æ•°æ®ä¼ è¾“</strong></h4><ul>
<li>UDPä¼ è¾“</li>
<li>Kafkaä¼ è¾“</li>
</ul>
<h4 id="æ•°æ®å¤„ç†"><a href="#æ•°æ®å¤„ç†" class="headerlink" title="æ•°æ®å¤„ç†"></a><strong>æ•°æ®å¤„ç†</strong></h4><ul>
<li>æ¥å£ç»´åº¦èšåˆ</li>
<li>æœºå™¨ç»´åº¦èšåˆ</li>
</ul>
<p><strong>æ•°æ®å±•ç¤º</strong></p>
<p>å¦‚å¸¸è§çš„æ›²çº¿å›¾ã€é¥¼çŠ¶å›¾ç­‰ç­‰ï¼Œä»¥Dashboardæ–¹å¼å±•ç¤ºç»™ç”¨æˆ·</p>
<p>è¡¥å……ï¼š</p>
<p><strong>â‘ ç›‘æ§æ¶æ„</strong></p>
<blockquote>
<p>ä¸‹é¢çš„å›¾æ˜¯å¤§éƒ¨åˆ†å…¬å¸çš„ä¸€ç§ç›‘æ§æ¶æ„å›¾ã€‚æ¯ä¸€ä¸ªæœåŠ¡éƒ½æœ‰ä¸€ä¸ª Agentï¼ŒAgent æ”¶é›†åˆ°å…³é”®ä¿¡æ¯ï¼Œä¼šä¼ åˆ°ä¸€äº› MQ ä¸­ï¼Œä¸ºäº†è§£è€¦ã€‚</p>
<p>åŒæ—¶å°†æ—¥å¿—ä¼ å…¥ ELKï¼Œå°† Metrics ä¼ å…¥ InfluxDB æ—¶é—´åºåˆ—åº“ã€‚è€Œåƒ Nagiosï¼Œå¯ä»¥å®šæœŸå‘ Agent å‘èµ·ä¿¡æ¯æ£€æŸ¥å¾®æœåŠ¡ã€‚</p>
<p><img src="https://pic4.zhimg.com/v2-2b4b839b0246785af5e3f47872a81987_b.jpg"></p>
</blockquote>
<h2 id="1-5-æœåŠ¡è¿½è¸ª"><a href="#1-5-æœåŠ¡è¿½è¸ª" class="headerlink" title="1.5 æœåŠ¡è¿½è¸ª"></a>1.5 æœåŠ¡è¿½è¸ª</h2><p>æœåŠ¡è¿½è¸ªå¯ä»¥è·Ÿè¸ªè®°å½•ç”¨æˆ·çš„ä¸€æ¬¡è¯·æ±‚éƒ½å‘èµ·äº†å“ªäº›è°ƒç”¨ï¼Œç»è¿‡å“ªäº›æœåŠ¡å¤„ç†ï¼Œå¹¶è®°å½•æ¯ä¸€æ¬¡è°ƒç”¨æ‰€æ¶‰åŠçš„æœåŠ¡çš„è¯¦ç»†ä¿¡æ¯ã€‚åœ¨å‡ºç°è°ƒç”¨å¤±è´¥çš„æ—¶å€™ï¼Œå°±å¯ä»¥ç¬¬ä¸€æ—¶é—´å®šä½åˆ°é—®é¢˜å‡ºç°çš„åœ°æ–¹ã€‚</p>
<p><img src="/../images/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E7%90%86%E8%AE%BA%E4%BD%93%E7%B3%BB/image_jNdoYfL_Si.png"></p>
<h3 id="1-5-1-æœåŠ¡è¿½è¸ªç³»ç»ŸåŸç†"><a href="#1-5-1-æœåŠ¡è¿½è¸ªç³»ç»ŸåŸç†" class="headerlink" title="1.5.1 æœåŠ¡è¿½è¸ªç³»ç»ŸåŸç†"></a>1.5.1 æœåŠ¡è¿½è¸ªç³»ç»ŸåŸç†</h3><p>æœåŠ¡è¿½è¸ªç³»ç»Ÿçš„é¼»ç¥–ï¼šGoogleå‘å¸ƒçš„ä¸€ç¯‡çš„è®ºæ–‡<a href="http://bigbully.github.io/Dapper-translation/" title="Dapper, a Large-Scale Distributed Systems Tracing Infrastructure">Dapper, a Large-Scale Distributed Systems Tracing Infrastructure</a>ï¼Œé‡Œé¢è¯¦ç»†è®²è§£äº†æœåŠ¡è¿½è¸ªç³»ç»Ÿçš„å®ç°åŸç†ã€‚å®ƒçš„æ ¸å¿ƒç†å¿µå°±æ˜¯<strong>è°ƒç”¨é“¾</strong>ï¼šé€šè¿‡ä¸€ä¸ªå…¨å±€å”¯ä¸€çš„IDå°†åˆ†å¸ƒåœ¨å„ä¸ªæœåŠ¡èŠ‚ç‚¹ä¸Šçš„åŒä¸€æ¬¡è¯·æ±‚ä¸²è”èµ·æ¥ï¼Œä»è€Œè¿˜åŸåŸæœ‰çš„è°ƒç”¨å…³ç³»ï¼Œå¯ä»¥è¿½è¸ªç³»ç»Ÿé—®é¢˜ã€åˆ†æè°ƒç”¨æ•°æ®å¹¶ç»Ÿè®¡å„ç§ç³»ç»ŸæŒ‡æ ‡ã€‚</p>
<p>å¯ä»¥è¯´åé¢çš„è¯ç”Ÿå„ç§æœåŠ¡è¿½è¸ªç³»ç»Ÿéƒ½æ˜¯åŸºäºDapperè¡ç”Ÿå‡ºæ¥çš„ï¼Œæ¯”è¾ƒæœ‰åçš„æœ‰Twitterçš„<a href="http://zipkin.io/" title="Zipkin">Zipkin</a>ã€é˜¿é‡Œçš„<a href="http://www.slideshare.net/terryice/eagleeye-with-taobaojavaone" title="é¹°çœ¼">é¹°çœ¼</a>ã€ç¾å›¢çš„<a href="http://tech.meituan.com/mt_mtrace.html" title="MTrace">MTrace</a>ç­‰ã€‚</p>
<p>åŸºæœ¬æ¦‚å¿µï¼š<code>traceId</code>ã€<code>spanId</code>ã€<code>annonation</code></p>
<ul>
<li><code>traceId</code>ï¼Œç”¨äºæ ‡è¯†æŸä¸€æ¬¡å…·ä½“çš„è¯·æ±‚IDã€‚å½“ç”¨æˆ·çš„è¯·æ±‚è¿›å…¥ç³»ç»Ÿåï¼Œä¼šåœ¨RPCè°ƒç”¨ç½‘ç»œçš„ç¬¬ä¸€å±‚ç”Ÿæˆä¸€ä¸ªå…¨å±€å”¯ä¸€çš„traceIdï¼Œå¹¶ä¸”ä¼šéšç€æ¯ä¸€å±‚çš„RPCè°ƒç”¨ï¼Œä¸æ–­å¾€åä¼ é€’ï¼Œè¿™æ ·çš„è¯é€šè¿‡traceIdå°±å¯ä»¥æŠŠä¸€æ¬¡ç”¨æˆ·è¯·æ±‚åœ¨ç³»ç»Ÿä¸­è°ƒç”¨çš„è·¯å¾„ä¸²è”èµ·æ¥ã€‚</li>
<li><code>spanId</code>ï¼Œç”¨äºæ ‡è¯†ä¸€æ¬¡RPCè°ƒç”¨åœ¨åˆ†å¸ƒå¼è¯·æ±‚ä¸­çš„ä½ç½®ã€‚å½“ç”¨æˆ·çš„è¯·æ±‚è¿›å…¥ç³»ç»Ÿåï¼Œå¤„åœ¨RPCè°ƒç”¨ç½‘ç»œçš„ç¬¬ä¸€å±‚Aæ—¶spanIdåˆå§‹å€¼æ˜¯0ï¼Œè¿›å…¥ä¸‹ä¸€å±‚RPCè°ƒç”¨Bçš„æ—¶å€™spanIdæ˜¯0.1ï¼Œç»§ç»­è¿›å…¥ä¸‹ä¸€å±‚RPCè°ƒç”¨Cæ—¶spanIdæ˜¯0.1.1ï¼Œè€Œä¸Bå¤„åœ¨åŒä¸€å±‚çš„RPCè°ƒç”¨Eçš„spanIdæ˜¯0.2ï¼Œè¿™æ ·çš„è¯é€šè¿‡spanIdå°±å¯ä»¥å®šä½æŸä¸€æ¬¡RPCè¯·æ±‚åœ¨ç³»ç»Ÿè°ƒç”¨ä¸­æ‰€å¤„çš„ä½ç½®ï¼Œä»¥åŠå®ƒçš„ä¸Šä¸‹æ¸¸ä¾èµ–åˆ†åˆ«æ˜¯è°ã€‚</li>
<li><code>annotation</code>ï¼Œç”¨äºä¸šåŠ¡è‡ªå®šä¹‰åŸ‹ç‚¹æ•°æ®ï¼Œå¯ä»¥æ˜¯ä¸šåŠ¡æ„Ÿå…´è¶£çš„æƒ³ä¸Šä¼ åˆ°åç«¯çš„æ•°æ®ï¼Œæ¯”å¦‚ä¸€æ¬¡è¯·æ±‚çš„ç”¨æˆ·UIDã€‚</li>
</ul>
<p><img src="/../images/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E7%90%86%E8%AE%BA%E4%BD%93%E7%B3%BB/image_CSQOKCBHqX.png"></p>
<h3 id="1-5-2-æœåŠ¡è¿½è¸ªç³»ç»Ÿå®ç°"><a href="#1-5-2-æœåŠ¡è¿½è¸ªç³»ç»Ÿå®ç°" class="headerlink" title="1.5.2 æœåŠ¡è¿½è¸ªç³»ç»Ÿå®ç°"></a>1.5.2 æœåŠ¡è¿½è¸ªç³»ç»Ÿå®ç°</h3><p><img src="/../images/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E7%90%86%E8%AE%BA%E4%BD%93%E7%B3%BB/image_HPN1q5xycN.png"></p>
<ul>
<li>æ•°æ®é‡‡é›†å±‚ï¼Œè´Ÿè´£æ•°æ®åŸ‹ç‚¹å¹¶ä¸ŠæŠ¥ã€‚</li>
<li>æ•°æ®å¤„ç†å±‚ï¼Œè´Ÿè´£æ•°æ®çš„å­˜å‚¨ä¸è®¡ç®—ã€‚</li>
<li>æ•°æ®å±•ç¤ºå±‚ï¼Œè´Ÿè´£æ•°æ®çš„å›¾å½¢åŒ–å±•ç¤ºã€‚</li>
</ul>
<h4 id="1-5-2-1-æ•°æ®åŸ‹ç‚¹çš„æµç¨‹"><a href="#1-5-2-1-æ•°æ®åŸ‹ç‚¹çš„æµç¨‹" class="headerlink" title="1.5.2.1 æ•°æ®åŸ‹ç‚¹çš„æµç¨‹"></a>1.5.2.1 æ•°æ®åŸ‹ç‚¹çš„æµç¨‹</h4><p><img src="/../images/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E7%90%86%E8%AE%BA%E4%BD%93%E7%B3%BB/image_eKHdGZHbKl.png"></p>
<p>ä»¥çº¢è‰²æ–¹æ¡†é‡Œåœˆå‡ºçš„Aè°ƒç”¨Bçš„è¿‡ç¨‹ä¸ºä¾‹ï¼Œä¸€æ¬¡RPCè¯·æ±‚å¯ä»¥åˆ†ä¸ºå››ä¸ªé˜¶æ®µã€‚</p>
<ul>
<li>CSï¼ˆClient Sendï¼‰é˜¶æ®µ : å®¢æˆ·ç«¯å‘èµ·è¯·æ±‚ï¼Œå¹¶ç”Ÿæˆè°ƒç”¨çš„ä¸Šä¸‹æ–‡ã€‚</li>
<li>SRï¼ˆServer Recieveï¼‰é˜¶æ®µ : æœåŠ¡ç«¯æ¥æ”¶è¯·æ±‚ï¼Œå¹¶ç”Ÿæˆä¸Šä¸‹æ–‡ã€‚</li>
<li>SSï¼ˆServer Sendï¼‰é˜¶æ®µ : æœåŠ¡ç«¯è¿”å›è¯·æ±‚ï¼Œè¿™ä¸ªé˜¶æ®µä¼šå°†æœåŠ¡ç«¯ä¸Šä¸‹æ–‡æ•°æ®ä¸ŠæŠ¥ï¼Œä¸‹é¢è¿™å¼ å›¾å¯ä»¥è¯´æ˜ä¸ŠæŠ¥çš„æ•°æ®æœ‰ï¼š<code>traceId=123456ï¼ŒspanId=0.1ï¼ŒappKey=Bï¼Œmethod=B.methodï¼Œstart=103ï¼Œduration=38</code></li>
<li>CRï¼ˆClient Recieveï¼‰é˜¶æ®µ : å®¢æˆ·ç«¯æ¥æ”¶è¿”å›ç»“æœï¼Œè¿™ä¸ªé˜¶æ®µä¼šå°†å®¢æˆ·ç«¯ä¸Šä¸‹æ–‡æ•°æ®ä¸ŠæŠ¥ï¼Œä¸ŠæŠ¥çš„æ•°æ®æœ‰ï¼š<code>traceid=123456ï¼ŒspanId=0.1ï¼ŒappKey=Aï¼Œmethod=B.methodï¼Œstart=103ï¼Œduration=38</code></li>
</ul>
<h2 id="1-6-æœåŠ¡æ²»ç†"><a href="#1-6-æœåŠ¡æ²»ç†" class="headerlink" title="1.6 æœåŠ¡æ²»ç†"></a>1.6 æœåŠ¡æ²»ç†</h2><p>æœåŠ¡è°ƒç”¨å‡ºç°é—®é¢˜ï¼š</p>
<ul>
<li>æ³¨å†Œä¸­å¿ƒå®•æœºï¼›</li>
<li>æœåŠ¡æä¾›è€…æœ‰èŠ‚ç‚¹å®•æœºï¼›</li>
<li>æœåŠ¡æ¶ˆè´¹è€…/æä¾›è€…ä¸æ³¨å†Œä¸­å¿ƒä¹‹é—´çš„ç½‘ç»œä¸é€šï¼›</li>
<li>æœåŠ¡æ¶ˆè´¹è€…å’ŒæœåŠ¡æä¾›è€…ä¹‹é—´çš„ç½‘ç»œä¸é€šï¼›</li>
</ul>
<h3 id="1-6-1-èŠ‚ç‚¹ç®¡ç†"><a href="#1-6-1-èŠ‚ç‚¹ç®¡ç†" class="headerlink" title="1.6.1 èŠ‚ç‚¹ç®¡ç†"></a>1.6.1 èŠ‚ç‚¹ç®¡ç†</h3><ol>
<li>æ³¨å†Œä¸­å¿ƒä¸»åŠ¨æ‘˜é™¤æœºåˆ¶</li>
<li>æœåŠ¡æ¶ˆè´¹è€…æ‘˜é™¤æœºåˆ¶</li>
</ol>
<h3 id="1-6-2-è´Ÿè½½å‡è¡¡"><a href="#1-6-2-è´Ÿè½½å‡è¡¡" class="headerlink" title="1.6.2 è´Ÿè½½å‡è¡¡"></a>1.6.2 è´Ÿè½½å‡è¡¡</h3><ul>
<li><strong>éšæœºç®—æ³•</strong></li>
<li><strong>è½®è¯¢ç®—æ³•</strong></li>
<li><strong>æœ€å°‘æ´»è·ƒè°ƒç”¨ç®—æ³•</strong></li>
<li><strong>ä¸€è‡´æ€§Hashç®—æ³•</strong></li>
</ul>
<h1 id="2-DevOps"><a href="#2-DevOps" class="headerlink" title="2 DevOps"></a>2 DevOps</h1><p>ä¼ ç»Ÿä¸šåŠ¡æµç¨‹ï¼šå¼€å‘â†’æµ‹è¯•â†’è¿ç»´</p>
<p>DevOpsï¼š</p>
<ul>
<li>CIï¼ˆContinuous Integrationï¼‰ï¼ŒæŒç»­é›†æˆã€‚å¼€å‘å®Œæˆä»£ç å¼€å‘åï¼Œèƒ½è‡ªåŠ¨åœ°è¿›è¡Œä»£ç æ£€æŸ¥ã€å•å…ƒæµ‹è¯•ã€æ‰“åŒ…éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒï¼Œè¿›è¡Œé›†æˆæµ‹è¯•ï¼Œè·‘è‡ªåŠ¨åŒ–æµ‹è¯•ç”¨ä¾‹ã€‚</li>
<li>CDï¼ˆContinuous Deployï¼‰ï¼ŒæŒç»­éƒ¨ç½²/æŒç»­äº¤ä»˜ã€‚ä»£ç æµ‹è¯•é€šè¿‡åï¼Œèƒ½è‡ªåŠ¨éƒ¨ç½²åˆ°ç±»ç”Ÿäº§ç¯å¢ƒä¸­è¿›è¡Œé›†æˆæµ‹è¯•ï¼Œæµ‹è¯•é€šè¿‡åå†è¿›è¡Œå°æµé‡çš„ç°åº¦éªŒè¯ï¼ŒéªŒè¯é€šè¿‡åä»£ç å°±è¾¾åˆ°çº¿ä¸Šå‘å¸ƒçš„è¦æ±‚äº†ï¼Œå°±å¯ä»¥æŠŠä»£ç è‡ªåŠ¨éƒ¨ç½²åˆ°çº¿ä¸Šã€‚</li>
</ul>
<p><img src="/../images/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E7%90%86%E8%AE%BA%E4%BD%93%E7%B3%BB/image_kcPQoyjIJ3.png"></p>
]]></content>
      <categories>
        <category>å­¦ä¹ ç¬”è®°</category>
      </categories>
      <tags>
        <tag>å¾®æœåŠ¡</tag>
      </tags>
  </entry>
  <entry>
    <title>çº¿ç¨‹æ± åœ¨ä¸šåŠ¡ä¸­çš„å®è·µä»¥åŠå¯¹åº”å‚æ•°å¦‚ä½•è®¾è®¡</title>
    <url>/2024/02/03/%E7%BA%BF%E7%A8%8B%E6%B1%A0%E5%9C%A8%E4%B8%9A%E5%8A%A1%E4%B8%AD%E7%9A%84%E5%AE%9E%E8%B7%B5%E4%BB%A5%E5%8F%8A%E5%AF%B9%E5%BA%94%E5%8F%82%E6%95%B0%E5%A6%82%E4%BD%95%E8%AE%BE%E8%AE%A1/</url>
    <content><![CDATA[<blockquote>
<p>å‚è€ƒï¼š<a href="https://tech.meituan.com/2020/04/02/java-pooling-pratice-in-meituan.html">Javaçº¿ç¨‹æ± å®ç°åŸç†åŠå…¶åœ¨ç¾å›¢ä¸šåŠ¡ä¸­çš„å®è·µ - ç¾å›¢æŠ€æœ¯å›¢é˜Ÿ</a></p>
</blockquote>
<h1 id="çº¿ç¨‹æ± æ ¸å¿ƒå‚æ•°"><a href="#çº¿ç¨‹æ± æ ¸å¿ƒå‚æ•°" class="headerlink" title="çº¿ç¨‹æ± æ ¸å¿ƒå‚æ•°"></a>çº¿ç¨‹æ± æ ¸å¿ƒå‚æ•°</h1><ol>
<li>æ ¸å¿ƒçº¿ç¨‹æ•°<code>corePoolSize</code><br>å¦‚æœé¡¹ç›®æœ‰å›ºå®šçš„çº¿ç¨‹å¼€é”€å¯ä»¥ä½¿ç”¨æ ¸å¿ƒçº¿ç¨‹</li>
<li>æœ€å¤§çº¿ç¨‹<code>maximumPoolSize</code><br>å¦‚æœé¡¹ç›®ä¸­å¤šçº¿ç¨‹çš„åœºæ™¯ä¸æ˜¯å¾ˆå¤šï¼Œå°†çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹å…¨éƒ¨è®¾ç½®ä¸ºæ™®é€šçº¿ç¨‹ï¼Œç”¨å®Œåå°±é‡Šæ”¾ï¼Œå‡å°‘èµ„æºå ç”¨</li>
<li>å·¥ä½œé˜Ÿåˆ—<code>workQueue</code><br>æŒ‡å®šæœ‰ç•Œæˆ–æ— ç•Œé˜Ÿåˆ—ï¼Œé˜Ÿåˆ—é•¿åº¦ï¼Œä¸€èˆ¬æˆ‘ä»¬é€‰æ‹©æœ‰ç•Œé˜Ÿåˆ—ï¼Œæ— ç•Œé˜Ÿåˆ—å®¹æ˜“å¯¼è‡´OOM</li>
</ol>
<span id="more"></span>

<h3 id="åœºæ™¯ä¸€ï¼šå¿«é€Ÿå“åº”ç”¨æˆ·è¯·æ±‚"><a href="#åœºæ™¯ä¸€ï¼šå¿«é€Ÿå“åº”ç”¨æˆ·è¯·æ±‚" class="headerlink" title="åœºæ™¯ä¸€ï¼šå¿«é€Ÿå“åº”ç”¨æˆ·è¯·æ±‚"></a>åœºæ™¯ä¸€ï¼šå¿«é€Ÿå“åº”ç”¨æˆ·è¯·æ±‚</h3><p>åœºæ™¯ï¼šéœ€è¦å¿«é€Ÿå“åº”çš„åœºæ™¯ï¼Œå¦‚<strong>é¦–å±åŠ è½½</strong>ã€å•†å“è¯¦æƒ…é¡µåŠ è½½è¿™ç§è¶Šå¿«è¶Šå¥½çš„åœºæ™¯</p>
<p><strong>åº”è¯¥ä¸è®¾ç½®é˜Ÿåˆ—å»ç¼“å†²å¹¶å‘ä»»åŠ¡ï¼Œè€Œæ˜¯è°ƒé«˜<code>corePoolSize</code>å’Œ<code>maxPoolSize</code>å»å°½å¯èƒ½åˆ›é€ å¤šçš„çº¿ç¨‹å¿«é€Ÿæ‰§è¡Œä»»åŠ¡ã€‚</strong></p>
<p><img src="/../images/%E7%BA%BF%E7%A8%8B%E6%B1%A0%E5%9C%A8%E4%B8%9A%E5%8A%A1%E4%B8%AD%E7%9A%84%E5%AE%9E%E8%B7%B5%E4%BB%A5%E5%8F%8A%E5%AF%B9%E5%BA%94%E5%8F%82%E6%95%B0%E5%A6%82%E4%BD%95%E8%AE%BE%E8%AE%A1/image_dAKT_1wRJI.png"></p>
<h3 id="åœºæ™¯2ï¼šå¿«é€Ÿå¤„ç†æ‰¹é‡ä»»åŠ¡"><a href="#åœºæ™¯2ï¼šå¿«é€Ÿå¤„ç†æ‰¹é‡ä»»åŠ¡" class="headerlink" title="åœºæ™¯2ï¼šå¿«é€Ÿå¤„ç†æ‰¹é‡ä»»åŠ¡"></a>åœºæ™¯2ï¼šå¿«é€Ÿå¤„ç†æ‰¹é‡ä»»åŠ¡</h3><p><strong>æè¿°</strong>ï¼šç¦»çº¿çš„å¤§é‡è®¡ç®—ä»»åŠ¡ï¼Œéœ€è¦å¿«é€Ÿæ‰§è¡Œã€‚æ¯”å¦‚è¯´ï¼Œç»Ÿè®¡æŸä¸ªæŠ¥è¡¨ï¼Œéœ€è¦è®¡ç®—å‡ºå…¨å›½å„ä¸ªé—¨åº—ä¸­æœ‰å“ªäº›å•†å“æœ‰æŸç§å±æ€§ï¼Œç”¨äºåç»­è¥é”€ç­–ç•¥çš„åˆ†æï¼Œé‚£ä¹ˆæˆ‘ä»¬éœ€è¦æŸ¥è¯¢å…¨å›½æ‰€æœ‰é—¨åº—ä¸­çš„æ‰€æœ‰å•†å“ï¼Œå¹¶ä¸”è®°å½•å…·æœ‰æŸå±æ€§çš„å•†å“ï¼Œç„¶åå¿«é€Ÿç”ŸæˆæŠ¥è¡¨ã€‚</p>
<p><strong>åˆ†æ</strong>ï¼šè¿™ç§åœºæ™¯éœ€è¦æ‰§è¡Œå¤§é‡çš„ä»»åŠ¡ï¼Œæˆ‘ä»¬ä¹Ÿä¼šå¸Œæœ›ä»»åŠ¡æ‰§è¡Œçš„è¶Šå¿«è¶Šå¥½ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œä¹Ÿåº”è¯¥ä½¿ç”¨å¤šçº¿ç¨‹ç­–ç•¥ï¼Œå¹¶è¡Œè®¡ç®—ã€‚ä½†ä¸å“åº”é€Ÿåº¦ä¼˜å…ˆçš„åœºæ™¯åŒºåˆ«åœ¨äºï¼Œ<strong>è¿™ç±»åœºæ™¯ä»»åŠ¡é‡å·¨å¤§ï¼Œå¹¶ä¸éœ€è¦ç¬æ—¶çš„å®Œæˆï¼Œè€Œæ˜¯å…³æ³¨å¦‚ä½•ä½¿ç”¨æœ‰é™çš„èµ„æºï¼Œå°½å¯èƒ½åœ¨å•ä½æ—¶é—´å†…å¤„ç†æ›´å¤šçš„ä»»åŠ¡ï¼Œä¹Ÿå°±æ˜¯ååé‡ä¼˜å…ˆçš„é—®é¢˜ã€‚</strong>æ‰€ä»¥<strong>åº”è¯¥è®¾ç½®é˜Ÿåˆ—å»ç¼“å†²å¹¶å‘ä»»åŠ¡ï¼Œè°ƒæ•´åˆé€‚çš„corePoolSizeå»è®¾ç½®å¤„ç†ä»»åŠ¡çš„çº¿ç¨‹æ•°</strong>ã€‚<strong>åœ¨è¿™é‡Œï¼Œè®¾ç½®çš„çº¿ç¨‹æ•°è¿‡å¤šå¯èƒ½è¿˜ä¼šå¼•å‘çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢é¢‘ç¹çš„é—®é¢˜ï¼Œä¹Ÿä¼šé™ä½å¤„ç†ä»»åŠ¡çš„é€Ÿåº¦ï¼Œé™ä½ååé‡ã€‚</strong></p>
<p><img src="/../images/%E7%BA%BF%E7%A8%8B%E6%B1%A0%E5%9C%A8%E4%B8%9A%E5%8A%A1%E4%B8%AD%E7%9A%84%E5%AE%9E%E8%B7%B5%E4%BB%A5%E5%8F%8A%E5%AF%B9%E5%BA%94%E5%8F%82%E6%95%B0%E5%A6%82%E4%BD%95%E8%AE%BE%E8%AE%A1/image_uK86I9zjp7.png"></p>
<h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>è€ƒè™‘åˆ°åœ¨å®é™…åº”ç”¨ä¸­æˆ‘ä»¬è·å–å¹¶å‘æ€§çš„åœºæ™¯ä¸»è¦æ˜¯ä¸¤ç§ï¼š</p>
<ol>
<li>å¹¶è¡Œæ‰§è¡Œå­ä»»åŠ¡ï¼Œæé«˜å“åº”é€Ÿåº¦ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œåº”è¯¥ä½¿ç”¨åŒæ­¥é˜Ÿåˆ—ï¼Œæ²¡æœ‰ä»€ä¹ˆä»»åŠ¡åº”è¯¥è¢«ç¼“å­˜ä¸‹æ¥ï¼Œè€Œæ˜¯åº”è¯¥ç«‹å³æ‰§è¡Œ</li>
<li>å¹¶è¡Œæ‰§è¡Œå¤§æ‰¹æ¬¡ä»»åŠ¡ï¼Œæå‡ååé‡ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œåº”è¯¥ä½¿ç”¨æœ‰ç•Œé˜Ÿåˆ—ï¼Œä½¿ç”¨é˜Ÿåˆ—å»ç¼“å†²å¤§æ‰¹é‡çš„ä»»åŠ¡ï¼Œé˜Ÿåˆ—å®¹é‡å¿…é¡»å£°æ˜ï¼Œé˜²æ­¢ä»»åŠ¡æ— é™åˆ¶å †ç§¯ã€‚æ‰€ä»¥çº¿ç¨‹æ± åªéœ€è¦æä¾›è¿™ä¸‰ä¸ªå…³é”®å‚æ•°çš„é…ç½®ï¼Œå¹¶ä¸”æä¾›ä¸¤ç§é˜Ÿåˆ—çš„é€‰æ‹©ï¼Œå°±å¯ä»¥æ»¡è¶³ç»å¤§å¤šæ•°çš„ä¸šåŠ¡éœ€æ±‚ï¼ŒLess is More</li>
</ol>
]]></content>
      <categories>
        <category>å¹¶å‘ç¼–ç¨‹</category>
      </categories>
      <tags>
        <tag>çº¿ç¨‹æ± </tag>
      </tags>
  </entry>
  <entry>
    <title>ğŸ˜æ‰‹æ“ä¸€ä¸ªåŠ¨æ€é…ç½®ç®¡ç†å™¨</title>
    <url>/2024/07/31/%E6%89%8B%E6%90%93%E4%B8%80%E4%B8%AA%E5%8A%A8%E6%80%81%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86%E5%99%A8/</url>
    <content><![CDATA[<h2 id="å¼•è¨€"><a href="#å¼•è¨€" class="headerlink" title="å¼•è¨€"></a>å¼•è¨€</h2><p>æœ€è¿‘åˆåœ¨æˆ‘çš„è®ºå›é¡¹ç›®ä¸­é€ è½®å­ï¼Œåœºæ™¯æ˜¯ç”±äºä¸€äº›ä¸šåŠ¡åŸå› ï¼Œæ¯”å¦‚æ¥å…¥äº†ChatGPTï¼Œ<code>openai_key</code>å¯èƒ½ä¼šé¢‘ç¹çš„æ›´æ–°ï¼Œæˆ–è€…æ·»åŠ æ–°çš„æ•æ„Ÿè¯ç­‰ç­‰éƒ½ä¼šé€ æˆé¡¹ç›®ä¸­é…ç½®çš„å˜åŒ–ï¼Œæ¯æ¬¡å˜åŠ¨éƒ½éœ€è¦ä¿®æ”¹é…ç½®æ–‡ä»¶å¹¶é‡æ–°éƒ¨ç½²åº”ç”¨ï¼Œè¿™æ ·æ˜¯éå¸¸ä¸æ–¹ä¾¿çš„ï¼ŒåŠ¨æ€çš„æ›´æ–°è¿™äº›å†…å­˜ä¸­çš„é…ç½®æ˜¯éœ€è¦è§£å†³çš„é—®é¢˜ã€‚</p>
<p>å¸¸è§çš„åšæ³•æ˜¯æ¥å…¥ä¸€ä¸ªé…ç½®ä¸­å¿ƒï¼Œå¦‚Apolloã€ZKç­‰ç­‰ï¼Œä½†æ˜¯ç›®å‰é¡¹ç›®ä¸­æ˜¯æ²¡æœ‰ç”¨åˆ°è¿™äº›ä¸­é—´ä»¶çš„ï¼Œæ¥å…¥è¿™äº›é…ç½®ä¸­å¿ƒå¯èƒ½ä¼šç»™é¡¹ç›®å¸¦æ¥ä¸€äº›é£é™©ï¼Œå†µä¸”æˆ‘è¿™æ˜¯ä¸ªå•ä½“é¡¹ç›®ï¼Œç”¨è¿™äº›å¤æ‚çš„é…ç½®ä¸­å¿ƒæœ‰ç‚¹å¤§æå°ç”¨äº†ï¼Œå†è¯´ç›´æ¥æ‹¿æ¥å°±ç”¨æ²¡ä»€ä¹ˆæ„æ€</p>
<p>é‰´äºæ­¤ï¼Œæˆ‘å‚è€ƒäº†ç½‘ä¸Šå’ŒApolloé…ç½®ä¸­å¿ƒçš„ä¸€äº›æŠ€æœ¯æ–¹æ¡ˆï¼Œå®ç°äº†ä¸€ä¸ªéå¸¸å®ç”¨çš„é…ç½®æ‹“å±•ï¼Œæ”¯æŒä»è‡ªå®šä¹‰æ•°æ®æºä¸­è·å–é…ç½®ï¼Œå¹¶æ³¨å…¥åˆ°Environmentä¸­ï¼Œä¸”ä¼˜å…ˆçº§æœ€é«˜ï¼ŒåŒæ—¶ä¹Ÿæ”¯æŒé…ç½®çš„åŠ¨æ€åˆ·æ–°ğŸ˜</p>
<span id="more"></span>

<blockquote>
<p>ä¸ºäº†æ›´å¥½çš„ç†è§£æœ¬æ–‡çš„é€»è¾‘ï¼Œä½ å¯èƒ½éœ€è¦ä»¥ä¸‹å‰ç½®çŸ¥è¯†ç‚¹ï¼š<a href="/2024/06/21/Spring%20Environment%E4%BD%93%E7%B3%BB/">Spring Environmentä½“ç³»</a></p>
</blockquote>
<h2 id="è§£å†³æ–¹æ¡ˆ"><a href="#è§£å†³æ–¹æ¡ˆ" class="headerlink" title="è§£å†³æ–¹æ¡ˆ"></a>è§£å†³æ–¹æ¡ˆ</h2><p><u><em><strong>ç›´æ¥è¯´æ€è·¯ï¼š</strong></em></u></p>
<ol>
<li>å€ŸåŠ©Mysqlï¼Œç»´æŠ¤ä¸€ä¸ªé…ç½®è¡¨<code>global_config</code>ï¼Œæ–¹ä¾¿æˆ‘ä»¬æ„é€ è‡ªå®šä¹‰å±æ€§æºå’ŒæŒä¹…åŒ–ç”¨æˆ·é…ç½®</li>
<li>åœ¨Springå¯åŠ¨æ—¶ï¼Œè¯»å–æ•°æ®åº“ä¸­çš„é…ç½®æ„é€ ä¸€ä¸ªè‡ªå®šä¹‰å±æ€§æºï¼Œæ³¨å…¥åˆ°<code>Environment</code>ä¸­ï¼Œå¹¶è®¾ç½®ä¼˜å…ˆçº§ä¸ºæœ€é«˜</li>
<li>å†<strong>åˆ©ç”¨<code>Binder</code>æ›´æ–°</strong>å†…å­˜ä¸­çš„<code>ConfigurationProperties</code>å¯¹è±¡ï¼Œè¿™æ ·å°±å¯ä»¥å®ç°è¦†ç›–<code>properties</code>æ–‡ä»¶ä¸­çš„é…ç½®</li>
</ol>
<h2 id="å…·ä½“ç»†èŠ‚"><a href="#å…·ä½“ç»†èŠ‚" class="headerlink" title="å…·ä½“ç»†èŠ‚"></a>å…·ä½“ç»†èŠ‚</h2><p>æˆ‘çš„é¡¹ç›®ä¸­é…ç½®çš„ä½¿ç”¨å§¿åŠ¿ä¸»è¦åˆ†ä¸¤ç§ï¼š</p>
<ol>
<li>é€šè¿‡<code>@ConfigurationProperties</code>æ³¨å…¥çš„<code>Property</code>å¯¹è±¡</li>
<li>é€šè¿‡<code>@Value</code>æ³¨å…¥çš„é…ç½®å­—æ®µ</li>
</ol>
<p>ä¸¤ä¸ªéƒ¨åˆ†éœ€è¦ä¸åŒçš„æ›´æ–°æ–¹å¼ï¼Œå› æ­¤é…ç½®çš„æ›´æ–°æ–¹å¼åˆ†ä¸ºä»¥ä¸‹ä¸¤éƒ¨åˆ†ï¼š</p>
<h3 id="ConfigurationProperties"><a href="#ConfigurationProperties" class="headerlink" title="@ConfigurationProperties"></a><code>@ConfigurationProperties</code></h3><ul>
<li>åœ¨åˆå§‹åŒ–é˜¶æ®µï¼šè¯»å–æ•°æ®åº“ä¸­çš„é…ç½®è¡¨ â†’ ç”Ÿæˆè‡ªå®šä¹‰<code>MapPropertySource</code> â†’ <strong>å°†è‡ªå®šä¹‰<code>MapPropertySource</code>æ·»åŠ åˆ°Environmentä¸­å¹¶è®¾ç½®ä¸ºæœ€é«˜ä¼˜å…ˆçº§</strong></li>
<li>ç›‘å¬åˆ°é…ç½®å˜æ›´ï¼šæ£€æŸ¥DBä¸­çš„æ•°æ®åº“ä¸å½“å‰ç¼“å­˜ä¸­çš„<code>MapPropertySource</code>æ˜¯å¦ä¸€è‡´ ï¼Œå¦‚æœä¸ä¸€è‡´å°±è°ƒç”¨<code>refresh()</code>æ–¹æ³•åˆ·æ–°Environmentä¸­çš„<code>MapPropertySource</code>ã€‚refreshæ–¹æ³•çš„é€»è¾‘å…¶å®å°±æ˜¯<strong>é‡æ–°ä½¿ç”¨Binderç»‘å®šå†…å­˜ä¸­çš„<code>ConfigurationProperties</code></strong></li>
</ul>
<h3 id="Value"><a href="#Value" class="headerlink" title="@Value"></a><code>@Value</code></h3><p>è¿™éƒ¨åˆ†çš„é…ç½®æ›´æ–°å‚è€ƒäº†<a href="https://github.com/apolloconfig/apollo/pull/972">Apollo PR#972</a>çš„å®ç°ï¼šåˆ©ç”¨ä¸€ä¸ª<strong>æ‹¬å·åŒ¹é…</strong>ç®—æ³•ï¼Œåœ¨<code>BeanPostProcessor</code>é˜¶æ®µæ‰«ææ‰€æœ‰å¸¦<code>@Value</code>å ä½ç¬¦çš„Beanï¼ŒåŒ…æ‹¬è¡¨è¾¾å¼ã€å ä½ç¬¦ç­‰ç­‰ï¼Œè¿å¸¦å¯¹åº”çš„Beanå¼•ç”¨å…¨éƒ¨å­˜èµ·æ¥</p>
<p>å½“æœ‰ç›¸å…³çš„keyå˜åŒ–æ—¶ï¼Œé€šè¿‡Beançš„å¼•ç”¨åå°„æ›´æ–°å¯¹åº”çš„Beanå­—æ®µï¼Œä½ ä¹Ÿå¯ä»¥ä½¿ç”¨è§‚å¯Ÿè€…æ¨¡å¼ç›‘å¬å¯¹åº”çš„keyçš„å˜åŒ–ï¼Œå°±å¯ä»¥åšåˆ°å½“é…ç½®å˜åŒ–åè‡ªåŠ¨è§¦å‘å¯¹åº”Beanå­—æ®µçš„æ›´æ–°</p>
<blockquote>
<p> ğŸ“Œ è¿™é‡Œä¸¤ç§æ–¹å¼ä¸åŒæ˜¯å› ä¸º<code>@ConfigurationProperties</code>æ˜¯å€ŸåŠ©<code>Environment</code>ä¸­çš„å±æ€§æºå®ç°çš„ï¼Œè€Œ<code>@Value</code>çš„å®ç°åˆ™æ˜¯ä¾èµ–äº<code>ConfigurablePropertyResolver</code>ï¼Œä¸¤è€…è™½ç„¶éƒ½å®ç°äº†PropertyResolverä½†æ˜¯æ²¡æœ‰ä»»ä½•ç›´æ¥å…³ç³»ï¼Œå±äºä¸åŒçš„å±æ€§è§£æå™¨ï¼Œå› æ­¤æ”¹å˜<code>Environment</code>ä¸­çš„å±æ€§æºå¹¶ä¸èƒ½å½±å“<code>@Value</code>ï¼Œéœ€è¦é¢å¤–å¯¹<code>@Value</code>é…ç½®çš„å±æ€§åšæ›´æ–°</p>
<p><img src="/../images/Spring%E5%AE%9E%E7%8E%B0%E5%8A%A8%E6%80%81%E6%9B%B4%E6%96%B0%E9%85%8D%E7%BD%AE/image_env.png"></p>
</blockquote>
<h2 id="ä»£ç å®ç°"><a href="#ä»£ç å®ç°" class="headerlink" title="ä»£ç å®ç°"></a>ä»£ç å®ç°</h2><p>è¿™éƒ¨åˆ†çš„ä»£ç å…·ä½“å®ç°å…¶å®ä¹Ÿå‚è€ƒäº†<code>ConfigurationProperties</code>çš„æ³¨å…¥åŸç†â€”â€”</p>
<p>ï¼ˆ<code>ConfigurationPropertiesBindingPostProcessor</code>ï¼‰çš„å®ç°ã€‚ä¸ºäº†ç¼©å‡ç¯‡å¹…åˆ é™¤äº†ä¸€äº›éæ ¸å¿ƒé€»è¾‘ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è‡ªå®šä¹‰çš„åŠ¨æ€é…ç½®å·¥å‚ç±»</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> qing</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2024/8/10</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DynamicConfigContainer</span></span><br><span class="line">        <span class="keyword">implements</span> <span class="title class_">ApplicationContextAware</span>, InitializingBean, EnvironmentAware, CommandLineRunner {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ConfigurableEnvironment environment;</span><br><span class="line">    <span class="keyword">private</span> ApplicationContext applicationContext;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å­˜å‚¨dbä¸­çš„å…¨å±€é…ç½®ï¼Œä¼˜å…ˆçº§æœ€é«˜</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Getter</span></span><br><span class="line">    <span class="keyword">public</span> Map&lt;String, Object&gt; cache;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> DynamicConfigBinder binder;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterPropertiesSet</span><span class="params">()</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        cache = Maps.newHashMap();</span><br><span class="line">        <span class="built_in">this</span>.binder = <span class="keyword">new</span> <span class="title class_">DynamicConfigBinder</span>(<span class="built_in">this</span>.applicationContext, environment.getPropertySources());</span><br><span class="line">        bindBeansFromLocalCache(<span class="string">"dbConfig"</span>, cache);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ä»dbä¸­è·å–å…¨é‡çš„é…ç½®ä¿¡æ¯</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> true è¡¨ç¤ºæœ‰ä¿¡æ¯å˜æ›´; false è¡¨ç¤ºæ— ä¿¡æ¯å˜æ›´</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">loadAllConfigFromDb</span><span class="params">()</span> {</span><br><span class="line">        <span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> <span class="string">"select `key`, `value` from global_conf where deleted = 0"</span>;</span><br><span class="line">        List&lt;Map&lt;String, Object&gt;&gt; list = applicationContext.getBean(JdbcTemplate.class).queryForList(sql);</span><br><span class="line">        Map&lt;String, Object&gt; val = Maps.newHashMapWithExpectedSize(list.size());</span><br><span class="line">        <span class="keyword">for</span> (Map&lt;String, Object&gt; conf : list) {</span><br><span class="line">            val.put(conf.get(<span class="string">"key"</span>).toString(), conf.get(<span class="string">"value"</span>).toString());</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">if</span> (val.equals(cache)) {</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        }</span><br><span class="line">        cache.clear();</span><br><span class="line">        cache.putAll(val);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">bindBeansFromLocalCache</span><span class="params">(String namespace, Map&lt;String, Object&gt; cache)</span> {</span><br><span class="line">        <span class="comment">// å°†å†…å­˜çš„é…ç½®ä¿¡æ¯è®¾ç½®ä¸ºæœ€é«˜ä¼˜å…ˆçº§</span></span><br><span class="line">        <span class="type">MapPropertySource</span> <span class="variable">propertySource</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MapPropertySource</span>(namespace, cache);</span><br><span class="line">        environment.getPropertySources().addFirst(propertySource);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">bind</span><span class="params">(Bindable bindable)</span> {</span><br><span class="line">        binder.bind(bindable);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç›‘å¬é…ç½®çš„å˜æ›´</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">reloadConfig</span><span class="params">()</span> {</span><br><span class="line">        <span class="type">String</span> <span class="variable">before</span> <span class="operator">=</span> JsonUtil.toStr(cache);</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">toRefresh</span> <span class="operator">=</span> loadAllConfigFromDb();</span><br><span class="line">        <span class="keyword">if</span> (toRefresh) {</span><br><span class="line">            refreshConfig();</span><br><span class="line">            log.info(<span class="string">"config update! Old:{}, New:{}"</span>, before, JsonUtil.toStr(cache));</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ”¯æŒé…ç½®çš„åŠ¨æ€åˆ·æ–°</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">refreshConfig</span><span class="params">()</span> {</span><br><span class="line">        applicationContext.getBeansWithAnnotation(ConfigurationProperties.class).values().forEach(bean -&gt; {</span><br><span class="line">            Bindable&lt;?&gt; target = Bindable.ofInstance(bean).withAnnotations(AnnotationUtils.findAnnotation(bean.getClass(), ConfigurationProperties.class));</span><br><span class="line">            bind(target);</span><br><span class="line">        });</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åº”ç”¨å¯åŠ¨ä¹‹åï¼Œæ‰§è¡Œçš„åŠ¨æ€é…ç½®åˆå§‹åŒ–</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> args</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">(String... args)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        reloadConfig();</span><br><span class="line">        <span class="comment">// SpringValueRegistry.updateAll();</span></span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DynamicConfigBinder</span> {</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ApplicationContext applicationContext;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> PropertySources propertySources;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> Binder binder;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">DynamicConfigBinder</span><span class="params">(ApplicationContext applicationContext, PropertySources propertySources)</span> {</span><br><span class="line">        <span class="built_in">this</span>.applicationContext = applicationContext;</span><br><span class="line">        <span class="built_in">this</span>.propertySources = propertySources;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="keyword">void</span> <span class="title function_">bind</span><span class="params">(Bindable&lt;T&gt; bindable)</span> {</span><br><span class="line">        <span class="type">ConfigurationProperties</span> <span class="variable">propertiesAno</span> <span class="operator">=</span> bindable.getAnnotation(ConfigurationProperties.class);</span><br><span class="line">        <span class="keyword">if</span> (propertiesAno != <span class="literal">null</span>) {</span><br><span class="line">            <span class="type">BindHandler</span> <span class="variable">bindHandler</span> <span class="operator">=</span> getBindHandler(propertiesAno);</span><br><span class="line">            getBinder().bind(propertiesAno.prefix(), bindable, bindHandler);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="keyword">void</span> <span class="title function_">bind</span><span class="params">(String prefix, Bindable&lt;T&gt; bindable, BindHandler bindHandler)</span> {</span><br><span class="line">        getBinder().bind(prefix, bindable, bindHandler);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> BindHandler <span class="title function_">getBindHandler</span><span class="params">(ConfigurationProperties annotation)</span> {</span><br><span class="line">        <span class="type">BindHandler</span> <span class="variable">handler</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IgnoreTopLevelConverterNotFoundBindHandler</span>();</span><br><span class="line">        <span class="keyword">if</span> (annotation.ignoreInvalidFields()) {</span><br><span class="line">            handler = <span class="keyword">new</span> <span class="title class_">IgnoreErrorsBindHandler</span>(handler);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">if</span> (!annotation.ignoreUnknownFields()) {</span><br><span class="line">            <span class="type">UnboundElementsSourceFilter</span> <span class="variable">filter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UnboundElementsSourceFilter</span>();</span><br><span class="line">            handler = <span class="keyword">new</span> <span class="title class_">NoUnboundElementsBindHandler</span>(handler, filter);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> handler;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å‚è€ƒConfigurationPropertiesBindingPostProcessor</span></span><br><span class="line">    <span class="keyword">private</span> Binder <span class="title function_">getBinder</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.binder == <span class="literal">null</span>) {</span><br><span class="line">            <span class="keyword">synchronized</span> (<span class="built_in">this</span>) {</span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">this</span>.binder == <span class="literal">null</span>) {</span><br><span class="line">                    <span class="built_in">this</span>.binder = <span class="keyword">new</span> <span class="title class_">Binder</span>(getConfigurationPropertySources(),</span><br><span class="line">                            getPropertySourcesPlaceholdersResolver(), getConversionService(),</span><br><span class="line">                            getPropertyEditorInitializer());</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.binder;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<p><img src="/../images/Spring%E5%AE%9E%E7%8E%B0%E5%8A%A8%E6%80%81%E6%9B%B4%E6%96%B0%E9%85%8D%E7%BD%AE/image_Spring%E5%AE%9E%E7%8E%B0%E5%8A%A8%E6%80%81%E6%9B%B4%E6%96%B0%E9%85%8D%E7%BD%AE.png"></p>
<p>è¿™é‡Œå°±å¯ä»¥çœ‹åˆ°æˆ‘ä»¬è‡ªå®šä¹‰çš„å±æ€§æº<code>dbConfig</code>å·²ç»è¢«æ³¨å…¥æˆåŠŸå•¦ğŸ˜ƒ</p>
<p>é™¤æ­¤ä¹‹å¤–ï¼Œå½“ç›‘å¬åˆ°å¯¹åº”çš„é…ç½®æ›´æ–°æ—¶ï¼Œé™¤äº†æ›´æ–°æ•°æ®åº“ï¼Œè¿˜éœ€è¦æ¨é€å¯¹åº”çš„æ¶ˆæ¯ï¼Œåœ¨è¿™é‡Œç”±äºæˆ‘é¡¹ç›®ä¸­ä½¿ç”¨çš„æ˜¯Spring Eventå®ç°çš„æ¶ˆæ¯æœºåˆ¶ï¼Œå› æ­¤ç›‘å¬è€…çš„æ“ä½œå¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onApplicationEvent</span><span class="params">(ConfigRefreshEvent event)</span> {</span><br><span class="line">    dynamicConfigContainer.reloadConfig();</span><br><span class="line">    <span class="comment">// SpringValueRegistry.updateValue(event.getKey());</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>è‡³äº<code>@Value</code>çš„éƒ¨åˆ†ï¼Œä»£ç æ¯”è¾ƒå¤šå°±ä¸è´´äº†ï¼Œå…·ä½“å¯ä»¥å‚è€ƒåœ¨<a href="https://github.com/qing-wq/SAI-Forum-backend/tree/rabbitmq/sai-core/src/main/java/ink/whi/core/autoconf/apollo">https://github.com/qing-wq/SAI-Forum-backend/tree/rabbitmq/sai-core/src/main/java/ink/whi/core/autoconf/apollo</a></p>
<h2 id="ä¸€äº›æ€è€ƒ"><a href="#ä¸€äº›æ€è€ƒ" class="headerlink" title="ä¸€äº›æ€è€ƒ"></a>ä¸€äº›æ€è€ƒ</h2><p>é€šè¿‡ä¸Šé¢çš„æ“ä½œï¼Œå¾ˆæ–¹ä¾¿çš„å®ç°äº†é…ç½®åŠ¨æ€æ›´æ–°çš„é—®é¢˜ï¼Œä½†æ˜¯ç»è¿‡å®é™…ä½¿ç”¨åå‘ç°è¯¥æ–¹æ¡ˆè¿˜æ˜¯å­˜åœ¨ä¸€äº›éšæ‚£ï¼šä¸ç»Ÿä¸€çš„é…ç½®å¯èƒ½ä¼šå¸¦æ¥çš„éš¾ä»¥ç®¡ç†çš„é—®é¢˜</p>
<p>ç›¸æ¯”äºä¼ ç»Ÿçš„é…ç½®ç®¡ç†æ–¹æ¡ˆï¼Œè¦ä¹ˆä½¿ç”¨ç»Ÿä¸€çš„æ³¨å†Œä¸­å¿ƒï¼Œè¦ä¹ˆéƒ½å†™åœ¨é…ç½®æ–‡ä»¶ä¸­ï¼Œä¸Šè¿°æ–¹æ¡ˆåŒæ—¶ä½¿ç”¨ä¸¤ä»½é…ç½®ï¼ˆMySQLå’Œé…ç½®æ–‡ä»¶ï¼‰ï¼Œä¼šå­˜åœ¨ä¼˜å…ˆçº§é—®é¢˜ï¼Œå¯èƒ½ä¼šé€ æˆéš¾ä»¥å®šä½çš„çº¿ä¸ŠBugã€‚ä½†æ˜¯å¯¹äºä¸€ä¸ªç”¨æˆ·é‡ä¸å¤§çš„ä¸€ä¸ªå°é¡¹ç›®æ¥è¯´ï¼Œè¯¥æ–¹æ¡ˆèƒ½å¿«é€Ÿå®ç°è¿­ä»£æ›´æ–°ï¼Œæˆ‘è®¤ä¸ºè¿˜æ˜¯ä¸€ä¸ªä¸é”™çš„é€‰æ‹©</p>
<hr>
<blockquote>
<p>å†™åœ¨æœ€åï¼šå…¶å®åœ¨ä¸Šæ–‡ã€Œè§£å†³æ–¹æ¡ˆã€ä¸­å­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯å¦‚æœèƒ½åœ¨<code>PropertySourcesPropertyResolver</code>çš„é…ç½®è§£æé˜¶æ®µå°±å°†è‡ªå®šä¹‰çš„å±æ€§æºæ³¨å…¥ï¼Œé‚£ä¹ˆåˆå§‹åŒ–åçš„<code>ConfigurationProperties</code>å¯¹è±¡æ ‡è®°çš„å­—æ®µæœ¬èº«å°±æ˜¯æˆ‘ä»¬è‡ªå®šä¹‰æ•°æ®æºä¸­çš„é…ç½®ï¼Œä¹Ÿå°±ä¸éœ€è¦ç¬¬ä¸‰æ­¥â€”â€”å³å¯åŠ¨æ—¶ç”¨Binderå†æ¬¡æ›´æ–°ä¸€é<code>ConfigurationProperties</code>å¯¹è±¡</p>
<p>ä½†æˆ‘å°è¯•åå‘ç°æ— è®ºå¦‚ä½•éƒ½æ— æ³•åœ¨è§£æå‰å°†è‡ªå®šä¹‰æ•°æ®æºæ³¨å…¥åˆ°Environmentä¸­ï¼Œå› æ­¤ç›®å‰çš„åšæ³•åªèƒ½åœ¨é¡¹ç›®å®Œå…¨å¯åŠ¨ååˆ·æ–°æ‰€æœ‰é…ç½®ï¼ˆç•™ä¸ªå‘ï¼‰ï¼Œå¦‚æœæœ‰å¤§ä½¬çŸ¥é“è§£å†³æ–¹æ¡ˆæ¬¢è¿æŒ‡å‡ºğŸ¥³<br><img src="/../images/Spring%E5%AE%9E%E7%8E%B0%E5%8A%A8%E6%80%81%E6%9B%B4%E6%96%B0%E9%85%8D%E7%BD%AE/image_Secure2_Image.png"></p>
</blockquote>
]]></content>
      <categories>
        <category>æŠ€æœ¯æ–¹æ¡ˆ</category>
      </categories>
  </entry>
  <entry>
    <title>SpringMVC å¤„ç†æµç¨‹</title>
    <url>/2024/03/12/SpringMVC-%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B/</url>
    <content><![CDATA[<p>å…ˆçœ‹ä¸€ä¸‹SpringMVCçš„å¤„ç†æµç¨‹ï¼š</p>
<p><img src="/../images/SpringMVC-%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/image_HJ0Hg7mzst.png"></p>
<p>å„ä¸ªç»„ä»¶çš„ä½œç”¨ï¼š</p>
<ul>
<li><code>DispatcherServlet</code>ï¼šåˆ†å‘è¯·æ±‚</li>
<li><code>HandlerMapping</code>ï¼šæ ¹æ®URLåŒ¹é…èƒ½å¤Ÿå¤„ç†å½“å‰<code>request</code>çš„<code>Handler</code>ï¼ˆä¹Ÿå°±æ˜¯æˆ‘ä»¬çš„ <code>Controller</code> ï¼‰å’Œæ‹¦æˆªå™¨</li>
<li><code>HandlerAdapter</code>ï¼šè´Ÿè´£å®é™…æ‰§è¡Œ<code>Handler</code>çš„å¤„ç†æ–¹æ³•ï¼Œå¹¶è¿”å›<code>ModelAndView</code></li>
<li><code>ViewResolver</code>ï¼šå°†<code>ModelAndView</code>è§£æä¸ºå®é™…çš„è§†å›¾</li>
</ul>
<span id="more"></span>

<h2 id="å…·ä½“è¿‡ç¨‹"><a href="#å…·ä½“è¿‡ç¨‹" class="headerlink" title="å…·ä½“è¿‡ç¨‹"></a>å…·ä½“è¿‡ç¨‹</h2><ol>
<li><strong>é¦–å…ˆç”¨æˆ·å‘é€è¯·æ±‚ â€”&gt; DispatcherServlet</strong>ï¼Œå‰ç«¯æ§åˆ¶å™¨æ”¶åˆ°è¯·æ±‚åè‡ªå·±ä¸è¿›è¡Œå¤„ç†ï¼Œè€Œæ˜¯å§”æ‰˜ç»™å…¶ä»–çš„è§£æå™¨è¿›è¡Œ å¤„ç†ï¼Œä½œä¸ºç»Ÿä¸€è®¿é—®ç‚¹ï¼Œè¿›è¡Œå…¨å±€çš„æµç¨‹æ§åˆ¶ï¼›</li>
<li><strong>DispatcherServlet â€”&gt; HandlerMapping</strong>ï¼Œ HandlerMapping å°†ä¼šæŠŠè¯·æ±‚æ˜ å°„ä¸º <code>HandlerExecutionChain</code> å¯¹è±¡ï¼ˆåŒ…å«Handler å¤„ç†å™¨å’Œ<code>HandlerInterceptor</code> æ‹¦æˆªå™¨ï¼‰å¯¹è±¡</li>
<li><strong>DispatcherServlet â€”&gt; HandlerAdapter</strong>ï¼ŒHandlerAdapter å°†ä¼šæ ¹æ®é€‚é…çš„ç»“æœè°ƒç”¨çœŸæ­£çš„å¤„ç†å™¨çš„åŠŸèƒ½å¤„ç†æ–¹æ³•ï¼Œå®ŒæˆåŠŸèƒ½å¤„ç†ï¼Œå¹¶è¿”å› ModelAndViewï¼›</li>
<li><strong>ModelAndView â€”&gt; ViewResolver</strong>ï¼ŒViewResolver å°†æŠŠModelAndViewä¸­çš„é€»è¾‘è§†å›¾åè§£æä¸ºå…·ä½“çš„ View</li>
<li><strong>View â€”&gt; æ¸²æŸ“</strong>ï¼ŒView ä¼šæ ¹æ®ä¼ è¿›æ¥çš„ Model æ¨¡å‹æ•°æ®è¿›è¡Œæ¸²æŸ“</li>
<li><strong>è¿”å›æ§åˆ¶æƒç»™ DispatcherServlet</strong>ï¼Œç”± DispatcherServlet è¿”å›å“åº”ç»™ç”¨æˆ·ï¼Œåˆ°æ­¤ä¸€ä¸ªæµç¨‹ç»“æŸã€‚</li>
</ol>
<hr>
<p>ä¸Šé¢çš„æµç¨‹æœ‰ä¸¤ä¸ªå…³é”®ç‚¹ï¼š<code>HandlerMapping</code>å’Œ<code>HandlerAdapter</code>ï¼Œ<code>HandlerAdapter</code>æ®è¯´æ˜¯ä½¿ç”¨äº†é€‚é…å™¨æ¨¡å¼ï¼Œä½†å…·ä½“é€‚é…äº†ä»€ä¹ˆï¼Œæˆ‘ä¸€ç›´ä¸çŸ¥é“ğŸ¤¨ï¼Œç›´åˆ°åé¢çœ‹åˆ°äº†ä¸€ç¯‡åšå®¢æ‰æ˜ç™½ã€‚è‡³äºå®ƒä¿©çš„ä½œç”¨ï¼Œè¿˜å¾—ä»Controllerçš„å®šä¹‰æ–¹å¼è¯´èµ·</p>
<p>SpringMVCä¸­å®šä¹‰Controllerçš„æ–¹å¼æœ‰ä¸‰ç§ï¼š</p>
<ul>
<li><code>@RequestMapping</code>æœ€æœ€æœ€å¸¸ç”¨çš„æ–¹å¼ï¼Œé™¤äº†è¿™ä¸ªéƒ½ä¸çŸ¥é“å…¶ä»–çš„äº†ğŸ¤£</li>
<li>ç»§æ‰¿ org.springframework.web.servlet.mvc.Controlleræ¥å£ï¼Œå¤§æ¦‚æ˜¯è¿™æ ·ï¼š</li>
</ul>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Component("/home")</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HomeController</span> <span class="keyword">implements</span> <span class="title class_">Controller</span> {</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> ModelAndView <span class="title function_">handleRequest</span><span class="params">(HttpServletRequest request, </span></span><br><span class="line"><span class="params">            HttpServletResponse response)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ç»§æ‰¿ org.springframework.web.HttpRequestHandleræ¥å£</li>
</ul>
<p>ä¸ç®¡åé¢ä¸¤ä¸ªæ€ä¹ˆå®ç°ï¼Œæ€»ä¹‹ï¼Œä»–ä»¬ä»¨çš„å¤„ç†æ–¹å¼æ˜¯ä¸ä¸€æ ·çš„ï¼Œéœ€è¦ç”¨åˆ°ä¸åŒçš„<code>HandlerMapping</code>å’Œ<code>HandlerAdapter</code>å¤„ç†ï¼Œæ¯”å¦‚ï¼š</p>
<ul>
<li><code>@RequestMapping</code>â†’<code>RequestMappingHandlerMapping</code>å’Œ<code>RequestMappingHandlerAdapter</code></li>
<li><code>Controller</code>æ¥å£ â†’ <code>BeanNameUrlHandlerMapping</code>å’Œ<code>HttpRequestHandlerAdapter</code></li>
<li><code>HttpRequestHandler</code>æ¥å£ â†’ <code>BeanNameUrlHandlerMapping</code>å’Œ<code>HttpRequestHandlerAdapter</code></li>
</ul>
<h2 id="HandlerMapping"><a href="#HandlerMapping" class="headerlink" title="HandlerMapping"></a>HandlerMapping</h2><p><code>HandlerMapping</code>å¤„ç†åæ‰€æœ‰çš„URLå’Œå¯¹åº”çš„Handleréƒ½ä¼šè¢«æ”¾åœ¨ä¸€ä¸ªMapé‡Œåšæ˜ å°„ï¼Œè¿™é‡Œå…¶å®æ˜¯ç”¨äº†ä¸€ä¸ª<em><strong>ç­–ç•¥æ¨¡å¼</strong></em>ï¼Œ<u><em><strong>æ ¹æ®Controllerå®šä¹‰æ–¹å¼çš„ä¸åŒä½¿ç”¨ä¸åŒç­–ç•¥çš„<code>HandlerMapping</code>å»å¤„ç†</strong></em></u></p>
<p>  <code>HandlerMapping</code> æ˜¯ä¸€ä¸ªç­–ç•¥æ¥å£ï¼Œ<code>RequestMappingHandlerMapping</code>å’Œ<code>BeanNameUrlHandlerMapping</code>æ˜¯å¯¹åº”çš„å…·ä½“ç­–ç•¥</p>
<p>  <code>HandlerExecutionChain</code>æ˜¯ä¸€ä¸ªå°è£…ç­–ç•¥çš„ä¸Šä¸‹æ–‡è§’è‰²</p>
<p>æ¥çœ‹ä¸€ä¸‹å¦‚ä½•æ ¹æ®<code>request</code>æ¥è·å–<code>HandlerMapping</code>ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> HandlerExecutionChain <span class="title function_">getHandler</span><span class="params">(HttpServletRequest request)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.handlerMappings != <span class="literal">null</span>) {</span><br><span class="line">      <span class="keyword">for</span> (HandlerMapping mapping : <span class="built_in">this</span>.handlerMappings) {</span><br><span class="line">        <span class="type">HandlerExecutionChain</span> <span class="variable">handler</span> <span class="operator">=</span> mapping.getHandler(request);</span><br><span class="line">        <span class="keyword">if</span> (handler != <span class="literal">null</span>) {</span><br><span class="line">          <span class="keyword">return</span> handler;</span><br><span class="line">        }</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  }</span><br></pre></td></tr></tbody></table></figure>

<h2 id="HandlerAdapter"><a href="#HandlerAdapter" class="headerlink" title="HandlerAdapter"></a>HandlerAdapter</h2><p>è¯´å®Œ<code>HandlerMapping</code>ä¹‹åï¼Œä¸‹é¢å°±è¦æ¥ä»‹ç»<code>HandlerAdapter</code>äº†ã€‚</p>
<p>æ—¢ç„¶<code>Handler</code>æœ‰å¤šç§å®ç°å½¢å¼ï¼Œä½†æ˜¯Servletéœ€è¦çš„å¤„ç†æ–¹æ³•çš„ç»“æ„å´æ˜¯å›ºå®šçš„ï¼Œéƒ½æ˜¯ä»¥<code>request</code>å’Œ<code>response</code>ä½œä¸ºæ–¹æ³•å…¥å‚ï¼Œå› æ­¤<code>HandlerAdapter</code>çš„å®ç°ç±»éƒ½å®ç°äº†ç»Ÿä¸€çš„<code>handle()</code>æ–¹æ³•æ¥å¤„ç†Servlet</p>
<p>ä¸è¿‡ç”±äºä¸Šé¢æåˆ°çš„<code>Handler</code>çš„å½¢å¼ä¸åŒï¼Œ<u><em><strong><code>@RequestMapping</code>å¯¹åº”çš„<code>Handler</code>æ˜¯ä¸€ä¸ªæ–¹æ³•ï¼Œè€Œå…¶ä»–ä¸¤ä¸ªå¯¹åº”çš„<code>Handler</code>æ˜¯ä¸€ä¸ªç±»ï¼Œ</strong></em></u>è€ŒHandlerAdapterä½¿ç”¨äº†<em><strong>é€‚é…å™¨æ¨¡å¼</strong></em>èƒ½å¤Ÿæ¨¡ç³Šæ‰å…·ä½“çš„å®ç°ï¼Œä»è€Œå°±èƒ½æä¾›ç»Ÿä¸€è®¿é—®æ¥å£ï¼ˆå¦™ğŸ˜ï¼‰</p>
<p>æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹<code>getHandlerAdapter()</code>æ–¹æ³•ï¼Œæ³¨æ„<code>Handler</code>æ˜¯Objectç±»å‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> HandlerAdapter <span class="title function_">getHandlerAdapter</span><span class="params">(Object handler)</span> </span><br><span class="line">        <span class="keyword">throws</span> ServletException {</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">this</span>.handlerAdapters != <span class="literal">null</span>) {</span><br><span class="line">    <span class="keyword">for</span> (HandlerAdapter adapter : <span class="built_in">this</span>.handlerAdapters) {</span><br><span class="line">      <span class="keyword">if</span> (adapter.supports(handler)) {</span><br><span class="line">        <span class="keyword">return</span> adapter;</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h2 id="DispatcherServletçš„åˆ†å‘æµç¨‹"><a href="#DispatcherServletçš„åˆ†å‘æµç¨‹" class="headerlink" title="DispatcherServletçš„åˆ†å‘æµç¨‹"></a>DispatcherServletçš„åˆ†å‘æµç¨‹</h2><p>æœ€åçœ‹ä¸€ä¸‹<code>DispatcherServlet#doDispatch()</code>çš„åˆ†å‘æµç¨‹ï¼Œæ³¨æ„<code>DispatcherServlet</code>æ˜¯å¦‚ä½•ä½¿ç”¨<code>HandlerMapping</code>å’Œ<code>HandlerAdapter</code>ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doDispatch</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">//1ã€æ ¹æ®URLï¼ˆå½“ç„¶ä¸ä¸€å®šéå¾—æ˜¯URLï¼‰åŒ¹é…åˆ°ä¸€ä¸ªå¤„ç†å™¨</span></span><br><span class="line">    mappedHandler = getHandler(processedRequest);</span><br><span class="line">    <span class="keyword">if</span> (mappedHandler == <span class="literal">null</span>) {</span><br><span class="line">      <span class="comment">// è‹¥åŒ¹é…ä¸åˆ°Handlerå¤„ç†å™¨ï¼Œå°±404äº†</span></span><br><span class="line">      noHandlerFound(processedRequest, response);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2ã€ä»HandlerExecutionChainé‡Œæ‹¿å‡ºHandlerï¼Œç„¶åæ‰¾åˆ°å±äºå®ƒçš„é€‚é…å™¨</span></span><br><span class="line">    <span class="type">HandlerAdapter</span> <span class="variable">ha</span> <span class="operator">=</span> getHandlerAdapter(mappedHandler.getHandler());</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">//3ã€æ‰§è¡ŒHandlerä¸Šçš„æ‰€æœ‰æ‹¦æˆªå™¨çš„Preæ–¹æ³•</span></span><br><span class="line">    <span class="keyword">if</span> (!mappedHandler.applyPreHandle(processedRequest, response)) {</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//4ã€çœŸæ­£æ‰§è¡Œhandleæ–¹æ³•ï¼Œå¾—åˆ°ä¸€ä¸ªModelAndView</span></span><br><span class="line">    mv = ha.handle(processedRequest, response, mappedHandler.getHandler());</span><br><span class="line"></span><br><span class="line">    <span class="comment">//5ã€è§†å›¾æ¸²æŸ“</span></span><br><span class="line">    applyDefaultViewName(processedRequest, mv);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//6ã€æ‰§è¡Œæ‹¦æˆªå™¨çš„postæ–¹æ³•ï¼ˆè§†å›¾æ¸²æŸ“å®Œæˆåæ‰§è¡Œï¼‰</span></span><br><span class="line">    mappedHandler.applyPostHandle(processedRequest, response, mv);</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">//7ã€æ‰§è¡Œæ‹¦æˆªå™¨çš„afterCompletionæ–¹æ³•ï¼ˆä¸ç®¡æŠ›å‡ºä¸å¦ï¼‰</span></span><br><span class="line">  }</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<p>å‚è€ƒï¼š</p>
<ul>
<li><a href="https://blog.csdn.net/zxd1435513775/article/details/103000992">https://blog.csdn.net/zxd1435513775/article/details/103000992</a></li>
</ul>
]]></content>
      <categories>
        <category>Springæºç ç³»åˆ—</category>
      </categories>
      <tags>
        <tag>Springæºç é˜…è¯»</tag>
        <tag>SpringMVC</tag>
      </tags>
  </entry>
  <entry>
    <title>å‡¤å‡°æ¶æ„-ç¬”è®°Part1-åˆ†å¸ƒå¼äº‹åŠ¡</title>
    <url>/2024/10/12/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/</url>
    <content><![CDATA[<blockquote>
<p>å‚è€ƒï¼š<a href="https://icyfenix.cn/">https://icyfenix.cn/</a></p>
</blockquote>
<h1 id="æœ¬åœ°äº‹åŠ¡"><a href="#æœ¬åœ°äº‹åŠ¡" class="headerlink" title="æœ¬åœ°äº‹åŠ¡"></a>æœ¬åœ°äº‹åŠ¡</h1><p>æˆ‘ä»¬éƒ½çŸ¥é“äº‹åŠ¡æœ‰å››å¤§åŸåˆ™ï¼šåŸå­æ€§ã€ä¸€è‡´æ€§ã€éš”ç¦»æ€§ã€æŒä¹…æ€§ã€‚å…·ä½“æ˜¯å¦‚ä½•å®ç°çš„å‘¢ï¼Ÿ</p>
<h2 id="å®ç°åŸå­æ€§å’ŒæŒä¹…æ€§"><a href="#å®ç°åŸå­æ€§å’ŒæŒä¹…æ€§" class="headerlink" title="å®ç°åŸå­æ€§å’ŒæŒä¹…æ€§"></a>å®ç°åŸå­æ€§å’ŒæŒä¹…æ€§</h2><p><strong>äº‹åŠ¡çš„åŸå­æ€§å’ŒæŒä¹…æ€§å®ç°æ–¹å¼</strong></p>
<ul>
<li>é€šè¿‡æ—¥å¿—ï¼šå¸¸è§ï¼Œä¸»æµæ–¹æ¡ˆ</li>
<li>Shadow Pagingï¼ˆå½±å­åˆ†é¡µï¼‰ï¼ŒSQLiteå°±é‡‡ç”¨è¯¥ç§æ–¹å¼</li>
</ul>
<p><strong>æ—¥å¿—ä¸¤ç§å®ç°æ–¹å¼ï¼š</strong></p>
<ul>
<li>Commit Loggingï¼ˆæäº¤æ—¥å¿—ï¼‰<ul>
<li>åœ¨æ—¥å¿—æ²¡æœ‰æäº¤ä¹‹å‰ä¸å…è®¸æŒä¹…åŒ–æ•°æ®ï¼ŒåŸå› æ˜¯å¦‚æœäº‹åŠ¡å›æ»šï¼Œé‚£ä¹ˆæŒä¹…åŒ–çš„æ•°æ®æ˜¯é”™è¯¯çš„</li>
<li>å­˜åœ¨çš„é—®é¢˜ï¼šä¼šå ç”¨éå¸¸å¤šçš„ç£ç›˜ç¼“å†²åŒºï¼Œä¸¥é‡æ‹–å®æ•ˆç‡</li>
</ul>
</li>
<li>Write-Ahead Loggingï¼ˆæå‰å†™å…¥ï¼‰<ul>
<li><p>å…è®¸äº‹åŠ¡æœªæäº¤å°±æŒä¹…åŒ–æ•°æ®ï¼Œåˆ©ç”¨undo logå®ç°æŒä¹…åŒ–æ•°æ®å›æ»šçš„èƒ½åŠ›</p>
</li>
<li><p>å´©æºƒæ¢å¤æ­¥éª¤ï¼š</p>
<p>ä»æœ€åä¸€æ¬¡checkpointï¼ˆcheckpointä¹‹å‰çš„æ‰€æœ‰æ•°æ®éƒ½å·²ç»å®‰å…¨è½ç›˜ï¼‰å¼€å§‹æ‰«ææ—¥å¿—ï¼Œå°†æ‰«æåˆ°çš„äº‹åŠ¡åˆ†ä¸ºä¸¤ä¸ªé˜Ÿåˆ—ï¼š</p>
<ul>
<li>Redo listï¼šå¯¹äºå·²ç»æäº¤çš„äº‹åŠ¡ï¼ŒæŒ‰ç…§æ—¥å¿—è¿›è¡Œé‡åšï¼›</li>
<li>Undo listï¼šå¯¹äºæœªæäº¤çš„äº‹åŠ¡ï¼Œå°†å·²ç»æ‰§è¡Œçš„æ“ä½œå›æ»šï¼›</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="å®ç°éš”ç¦»æ€§"><a href="#å®ç°éš”ç¦»æ€§" class="headerlink" title="å®ç°éš”ç¦»æ€§"></a>å®ç°éš”ç¦»æ€§</h2><p>é€šè¿‡åŠ é”</p>
<h3 id="äº‹åŠ¡çš„éš”ç¦»çº§åˆ«"><a href="#äº‹åŠ¡çš„éš”ç¦»çº§åˆ«" class="headerlink" title="äº‹åŠ¡çš„éš”ç¦»çº§åˆ«"></a>äº‹åŠ¡çš„éš”ç¦»çº§åˆ«</h3><p>æ ¹æ®ARIES ç†è®ºä¸­å®šä¹‰ï¼š</p>
<ul>
<li><strong>å¯ä¸²è¡ŒåŒ–</strong>ï¼šå¯¹äº‹åŠ¡æ‰€æœ‰è¯»ã€å†™çš„æ•°æ®å…¨éƒ½åŠ ä¸Šè¯»é”ã€å†™é”å’ŒèŒƒå›´é”</li>
<li><strong>å¯é‡å¤è¯»</strong>ï¼šå¯¹äº‹åŠ¡æ‰€æ¶‰åŠçš„æ•°æ®åŠ è¯»é”å’Œå†™é”ï¼Œä¸”ä¸€ç›´æŒæœ‰è‡³äº‹åŠ¡ç»“æŸï¼Œä½†ä¸å†åŠ èŒƒå›´é”ã€‚<ul>
<li>å‡ºç°å¹»è¯»é—®é¢˜<blockquote>
<p>âœğŸ»MySQL InnoDB çš„å¯é‡å¤è¯»çº§åˆ«åœ¨åªè¯»äº‹åŠ¡ä¸­å¯ä»¥å®Œå…¨é¿å…å¹»è¯»é—®é¢˜</p>
</blockquote>
</li>
</ul>
</li>
<li><strong>è¯»å·²æäº¤</strong>ï¼šå¯¹äº‹åŠ¡æ¶‰åŠçš„æ•°æ®åŠ çš„å†™é”ä¼šä¸€ç›´æŒç»­åˆ°äº‹åŠ¡ç»“æŸï¼Œä½†åŠ çš„è¯»é”åœ¨æŸ¥è¯¢æ“ä½œå®Œæˆåå°±é©¬ä¸Šä¼šé‡Šæ”¾<ul>
<li>ä¸å¯é‡å¤è¯»é—®é¢˜</li>
</ul>
</li>
<li><strong>è¯»æœªæäº¤</strong>ï¼šå¯¹äº‹åŠ¡æ¶‰åŠçš„æ•°æ®åªåŠ å†™é”ï¼Œä¼šä¸€ç›´æŒç»­åˆ°äº‹åŠ¡ç»“æŸï¼Œä½†å®Œå…¨ä¸åŠ è¯»é”ã€‚<ul>
<li>è„è¯»é—®é¢˜</li>
</ul>
</li>
</ul>
<p><em><strong>ä»¥é”ä¸ºæ‰‹æ®µæ¥å®ç°éš”ç¦»æ€§æ‰æ˜¯æ•°æ®åº“è¡¨ç°å‡ºä¸åŒéš”ç¦»çº§åˆ«çš„æ ¹æœ¬åŸå› ã€‚</strong></em></p>
<h1 id="å…¨å±€äº‹åŠ¡XA"><a href="#å…¨å±€äº‹åŠ¡XA" class="headerlink" title="å…¨å±€äº‹åŠ¡XA"></a>å…¨å±€äº‹åŠ¡XA</h1><p>XAï¼ˆ eXtended Architectureï¼‰æ˜¯æœ€æ—©æå‡ºçš„åˆ†å¸ƒå¼äº‹åŠ¡å¤„ç†æ¶æ„ï¼Œå…¶æ ¸å¿ƒå†…å®¹æ˜¯å®šä¹‰äº†å…¨å±€çš„äº‹åŠ¡ç®¡ç†å™¨ï¼ˆTransaction Managerï¼‰å’Œå±€éƒ¨çš„èµ„æºç®¡ç†å™¨ï¼ˆResource Managerï¼Œç”¨äºé©±åŠ¨æœ¬åœ°äº‹åŠ¡ï¼‰ä¹‹é—´çš„é€šä¿¡æ¥å£</p>
<p>XA æ¥å£æ˜¯åŒå‘çš„ï¼Œèƒ½åœ¨ä¸€ä¸ªäº‹åŠ¡ç®¡ç†å™¨å’Œå¤šä¸ªèµ„æºç®¡ç†å™¨ä¹‹é—´å½¢æˆé€šä¿¡æ¡¥æ¢ï¼Œé€šè¿‡åè°ƒå¤šä¸ªæ•°æ®æºçš„ä¸€è‡´åŠ¨ä½œï¼Œå®ç°å…¨å±€äº‹åŠ¡çš„ç»Ÿä¸€æäº¤æˆ–è€…ç»Ÿä¸€å›æ»šã€‚</p>
<p>JATï¼ˆ<strong>JSR 907 Java Transaction APIï¼‰</strong>å®šä¹‰äº†åŸºäº XA æ¨¡å¼åœ¨ Java è¯­è¨€ä¸­çš„å®ç°äº†å…¨å±€äº‹åŠ¡å¤„ç†çš„æ ‡å‡†ã€‚JTA æœ€ä¸»è¦çš„ä¸¤ä¸ªæ¥å£æ˜¯ï¼š</p>
<ul>
<li>äº‹åŠ¡ç®¡ç†å™¨çš„æ¥å£ï¼š <code>javax.transaction.TransactionManager</code> </li>
<li>æ»¡è¶³ XA è§„èŒƒçš„èµ„æºå®šä¹‰æ¥å£ï¼š<code>javax.transaction.xa.XAResource</code>ï¼Œä»»ä½•èµ„æºï¼ˆJDBCã€JMS ç­‰ç­‰ï¼‰å¦‚æœæƒ³è¦æ”¯æŒ JTAï¼Œåªè¦å®ç° XAResource æ¥å£ä¸­çš„æ–¹æ³•å³å¯ã€‚</li>
</ul>
<p>å…¨å±€äº‹åŠ¡å»ºç«‹åœ¨<strong>å•ä¸ªæœåŠ¡å¤šä¸ªæ•°æ®æº</strong>çš„åœºæ™¯ä¸‹ï¼Œå¦‚ç”¨æˆ·ä¹°ä¹¦ï¼Œè€Œä¹¦åº—çš„ç”¨æˆ·ã€å•†å®¶ã€ä»“åº“åˆ†åˆ«å¤„äºä¸åŒçš„æ•°æ®æºä¸­ï¼š</p>
<p><img src="/../images/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/image_MsOVu4dKys.png"></p>
<h3 id="ä¸¤æ®µå¼æäº¤"><a href="#ä¸¤æ®µå¼æäº¤" class="headerlink" title="ä¸¤æ®µå¼æäº¤"></a>ä¸¤æ®µå¼æäº¤</h3><p>XA å°†äº‹åŠ¡æäº¤æ‹†åˆ†æˆä¸ºä¸¤é˜¶æ®µè¿‡ç¨‹ï¼ˆ<em><strong>ä¸¤æ®µå¼æäº¤ï¼Œ2 Phase Commitï¼Œ2PC</strong></em>ï¼‰ï¼š</p>
<ul>
<li><strong>å‡†å¤‡é˜¶æ®µ</strong>ï¼šåˆå«ä½œæŠ•ç¥¨é˜¶æ®µï¼Œåœ¨è¿™ä¸€é˜¶æ®µï¼Œåè°ƒè€…è¯¢é—®äº‹åŠ¡çš„æ‰€æœ‰å‚ä¸è€…æ˜¯å¦å‡†å¤‡å¥½æäº¤ï¼Œå‚ä¸è€…å¦‚æœå·²ç»å‡†å¤‡å¥½æäº¤åˆ™å›å¤ Preparedï¼Œå¦åˆ™å›å¤ Non-Preparedã€‚<ul>
<li><em>è¿™ä¸ªé˜¶æ®µç¦»çœŸæ­£çš„æäº¤åªå·®äº†ä¸€ä¸ªCommitæ—¥å¿—è®°å½•</em></li>
</ul>
</li>
<li><strong>æäº¤é˜¶æ®µ</strong>ï¼šåˆå«ä½œæ‰§è¡Œé˜¶æ®µ<ul>
<li>åè°ƒè€…å¦‚æœåœ¨ä¸Šä¸€é˜¶æ®µæ”¶åˆ°æ‰€æœ‰äº‹åŠ¡å‚ä¸è€…å›å¤çš„ Prepared æ¶ˆæ¯ï¼Œåˆ™å…ˆè‡ªå·±åœ¨æœ¬åœ°æŒä¹…åŒ–äº‹åŠ¡çŠ¶æ€ä¸º Commitï¼Œå®Œæˆåå‘æ‰€æœ‰å‚ä¸è€…å‘é€ Commit æŒ‡ä»¤ï¼Œæ‰€æœ‰å‚ä¸è€…ç«‹å³æ‰§è¡Œæäº¤æ“ä½œï¼›<ul>
<li><em>æŒä¹…åŒ–ä¸€æ¡ Commit è®°å½•</em></li>
</ul>
</li>
<li>å¦åˆ™ï¼Œä»»æ„ä¸€ä¸ªå‚ä¸è€…å›å¤äº† Non-Prepared æ¶ˆæ¯æˆ–è€…è¶…æ—¶æœªå›å¤ï¼Œåè°ƒè€…å°†è‡ªå·±çš„äº‹åŠ¡çŠ¶æ€æŒä¹…åŒ–ä¸º Abort ä¹‹åï¼Œå‘æ‰€æœ‰å‚ä¸è€…å‘é€ Abort æŒ‡ä»¤ï¼Œå‚ä¸è€…ç«‹å³æ‰§è¡Œå›æ»šæ“ä½œã€‚<ul>
<li><em>æ ¹æ®å›æ»šæ—¥å¿—æ¸…ç†å·²æäº¤çš„æ•°æ®</em></li>
</ul>
</li>
</ul>
</li>
</ul>
<p><img src="/../images/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/image_t2l87tkvf3.png"></p>
<p><strong>ä¸¤æ®µå¼æäº¤å­˜åœ¨çš„é—®é¢˜</strong></p>
<ul>
<li><p>å•ç‚¹é—®é¢˜ï¼šåè°ƒè€…å®•æœº</p>
</li>
<li><p>æ€§èƒ½é—®é¢˜ï¼šå¤šæ¬¡æœåŠ¡è°ƒç”¨</p>
<p><strong>æœ¨æ¡¶æ•ˆåº”</strong>ï¼šå‡†å¤‡é˜¶æ®µå¿…é¡»ç­‰å¾…æ‰€æœ‰æ•°æ®æºéƒ½è¿”å›æˆåŠŸåï¼Œåè°ƒè€…æ‰èƒ½ç»Ÿä¸€å‘å‡º Commit å‘½ä»¤ï¼Œæ‰€æœ‰æ¶‰åŠçš„é”å’Œèµ„æºéƒ½éœ€è¦ç­‰å¾…åˆ°æœ€æ…¢çš„äº‹åŠ¡å®Œæˆåæ‰èƒ½ç»Ÿä¸€é‡Šæ”¾</p>
</li>
<li><p>ä¸€è‡´æ€§é£é™©ï¼šæ²¡æœ‰å®•æœºæ¢å¤èƒ½åŠ›ã€‚</p>
<p>å¦‚æœåè°ƒè€…åœ¨æäº¤äº†æœ¬åœ°çš„äº‹åŠ¡åçªç„¶æ–­å¼€ï¼Œå°±ä¼šå¯¼è‡´éƒ¨åˆ†æ•°æ®ï¼ˆåè°ƒè€…çš„ï¼‰å·²æäº¤ï¼Œä½†éƒ¨åˆ†æ•°æ®ï¼ˆå‚ä¸è€…çš„ï¼‰æ—¢æœªæäº¤ï¼Œä¹Ÿæ²¡æœ‰åŠæ³•å›æ»šï¼Œäº§ç”Ÿäº†æ•°æ®ä¸ä¸€è‡´çš„é—®é¢˜ã€‚</p>
</li>
</ul>
<p><em><strong>FLP ä¸å¯èƒ½åŸç†</strong></em><em>ï¼šå¦‚æœä¸èƒ½ä¿è¯å®•æœºæ¢å¤èƒ½åŠ›ï¼Œé‚£å°±ä¸å­˜åœ¨ä»»ä½•ä¸€ç§åˆ†å¸ƒå¼åè®®å¯ä»¥æ­£ç¡®åœ°è¾¾æˆä¸€è‡´æ€§ç»“æœã€‚ï¼ˆæˆ‘çš„ç†è§£ï¼‰</em></p>
<h3 id="ä¸‰æ®µå¼æäº¤"><a href="#ä¸‰æ®µå¼æäº¤" class="headerlink" title="ä¸‰æ®µå¼æäº¤"></a>ä¸‰æ®µå¼æäº¤</h3><p>ä¸‰æ®µå¼æäº¤æŠŠå‡†å¤‡é˜¶æ®µå†ç»†åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼Œåˆ†åˆ«ç§°ä¸º CanCommitã€PreCommitï¼ŒæŠŠæäº¤é˜¶æ®µæ”¹ç§°ä¸º DoCommit é˜¶æ®µã€‚è¿™æ ·åšçš„ç›®çš„æ˜¯ä¸ºäº†å‡å°‘ä¸¤æ®µå¼ä¸­<strong>å‡†å¤‡é˜¶æ®µ</strong>è¿™ä¸€é‡é‡æ“ä½œå¸¦æ¥çš„å¼€é”€</p>
<ul>
<li><strong>CanCommit</strong>ï¼šè¯¢é—®é˜¶æ®µï¼Œåè°ƒè€…è®©æ¯ä¸ªå‚ä¸è€…æ ¹æ®è‡ªèº«çŠ¶æ€ï¼Œè¯„ä¼°è¯¥äº‹åŠ¡æ˜¯å¦æœ‰å¯èƒ½é¡ºåˆ©å®Œæˆã€‚</li>
<li><strong>PreCommit</strong>ï¼šå‡†å¤‡é˜¶æ®µï¼Œå‡†å¤‡æäº¤äº‹åŠ¡</li>
<li><strong>DoCommit</strong>ï¼šæäº¤é˜¶æ®µï¼Œåè°ƒè€…å‘é€CommitæŒ‡ä»¤</li>
</ul>
<p><img src="/../images/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/image_BDrIsTxVGB.png"></p>
<p><strong>ä¸‰æ®µå¼æäº¤çš„å½±å“</strong></p>
<ul>
<li>æ”¹å–„å•ç‚¹é—®é¢˜ï¼šå¦‚æœåè°ƒè€…æ•…éšœï¼Œé‚£ä¹ˆå‚ä¸è€…é»˜è®¤ä¼šæäº¤äº‹åŠ¡</li>
<li>å‡å°‘å›æ»šï¼šå…ˆè®©å‚ä¸è€…åˆ¤æ–­è‡ªèº«æ˜¯å¦æœ‰èƒ½åŠ›æäº¤äº‹åŠ¡ï¼Œé¿å…æ•…éšœå¯¼è‡´å…¶ä»–å‚ä¸è€…åšPreparedæ— ç”¨åŠŸ</li>
<li>ä¸€è‡´æ€§é—®é¢˜æ²¡æœ‰è§£å†³ï¼Œåè€ŒåŠ é‡</li>
</ul>
<h1 id="åˆ†å¸ƒå¼äº‹åŠ¡"><a href="#åˆ†å¸ƒå¼äº‹åŠ¡" class="headerlink" title="åˆ†å¸ƒå¼äº‹åŠ¡"></a>åˆ†å¸ƒå¼äº‹åŠ¡</h1><p>è¿™é‡Œç‰¹æŒ‡<strong>å¤šä¸ªæœåŠ¡åŒæ—¶è®¿é—®å¤šä¸ªæ•°æ®æº</strong>çš„äº‹åŠ¡å¤„ç†æœºåˆ¶</p>
<h2 id="CAPå’ŒBase"><a href="#CAPå’ŒBase" class="headerlink" title="CAPå’ŒBase"></a><strong>CAPå’Œ</strong>Base</h2><p>ä¸€ä¸ªåˆ†å¸ƒå¼çš„ç³»ç»Ÿä¸­ï¼Œæ¶‰åŠå…±äº«æ•°æ®é—®é¢˜æ—¶ï¼Œä»¥ä¸‹ä¸‰ä¸ªç‰¹æ€§æœ€å¤šåªèƒ½åŒæ—¶æ»¡è¶³å…¶ä¸­ä¸¤ä¸ª</p>
<ul>
<li>ä¸€è‡´æ€§</li>
<li>å¯ç”¨æ€§</li>
<li>åˆ†åŒºå®¹å¿æ€§</li>
</ul>
<hr>
<ul>
<li>CAæ¶æ„ï¼šæ„å‘³ç€å‡è®¾èŠ‚ç‚¹ä¹‹é—´çš„é€šä¿¡æ°¸è¿œæ˜¯å¯é çš„ï¼Œå¿…å®šä¸å¯èƒ½å®ç°<ul>
<li>ä¾‹å­ï¼šä¼ ç»Ÿçš„å…³ç³»æ•°æ®åº“é›†ç¾¤ï¼Œä»–ä»¬ä¸ä¾èµ–ç½‘ç»œå®ç°å…±äº«ï¼Œè€Œæ˜¯é€šè¿‡æ—¥å¿—ï¼Œå¦‚MySQLçš„bin log</li>
</ul>
</li>
<li>CPæ¶æ„ï¼šä¸€èˆ¬ç”¨äºå¯¹æ•°æ®è´¨é‡å¾ˆé«˜çš„åœºåˆä¸­<ul>
<li>egï¼šHBaseã€å‰é¢è®¨è®ºçš„å…¨å±€äº‹åŠ¡</li>
</ul>
</li>
<li>APæ¶æ„ï¼šä¸»æµé€‰æ‹©ï¼Œæ”¾å¼ƒå¼ºä¸€è‡´æ€§ï¼Œé€‰æ‹©æœ€ç»ˆä¸€è‡´æ€§</li>
</ul>
<p>æœ€ç»ˆä¸€è‡´æ€§çš„èµ·æºï¼š<strong>BASEç†è®º</strong></p>
<p>BASE åˆ†åˆ«æ˜¯åŸºæœ¬å¯ç”¨æ€§ã€æŸ”æ€§äº‹åŠ¡å’Œæœ€ç»ˆä¸€è‡´æ€§çš„ç¼©å†™</p>
<h2 id="å¯é äº‹ä»¶é˜Ÿåˆ—"><a href="#å¯é äº‹ä»¶é˜Ÿåˆ—" class="headerlink" title="å¯é äº‹ä»¶é˜Ÿåˆ—"></a>å¯é äº‹ä»¶é˜Ÿåˆ—</h2><p>å¯é æ¶ˆæ¯é˜Ÿåˆ—æ˜¯é€šè¿‡<em><strong>æŒç»­é‡è¯•æ¥ä¿è¯å¯é æ€§</strong></em>çš„ä¸€ç§æ–¹æ¡ˆï¼Œä¹Ÿè¢«ç§°ä¸º<strong>ã€Œæœ€å¤§åŠªåŠ›äº¤ä»˜ã€</strong>ï¼Œå¦‚TCPçš„ACKé‡ä¼ æœºåˆ¶</p>
<p>å¯é äº‹ä»¶é˜Ÿåˆ—åªè¦ç¬¬ä¸€æ­¥ä¸šåŠ¡å®Œæˆäº†ï¼Œåç»­å°±æ²¡æœ‰å¤±è´¥å›æ»šçš„æ¦‚å¿µï¼Œåªè®¸æˆåŠŸï¼Œä¸è®¸å¤±è´¥ã€‚</p>
<p>å¯é æ¶ˆæ¯é˜Ÿåˆ—è™½ç„¶èƒ½ä¿è¯æœ€ç»ˆçš„ç»“æœæ˜¯ç›¸å¯¹å¯é çš„ï¼Œä½†å®Œå…¨æ²¡æœ‰éš”ç¦»æ€§å¯è¨€ï¼Œå¦‚å¯èƒ½å¯¼è‡´ã€Œè¶…å”®ã€é—®é¢˜</p>
<p><img src="/../images/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/image_y2pcU-VxsW.png"></p>
<h2 id="TCC-äº‹åŠ¡"><a href="#TCC-äº‹åŠ¡" class="headerlink" title="TCC äº‹åŠ¡"></a>TCC äº‹åŠ¡</h2><p>TCC ï¼ˆTry-Confirm-Cancelï¼‰æ˜¯å¦ä¸€ç§å¸¸è§çš„åˆ†å¸ƒå¼äº‹åŠ¡æœºåˆ¶ï¼Œå…·æœ‰è¾ƒå¼ºçš„<strong>éš”ç¦»æ€§</strong></p>
<p>TCCçš„ä¸‰ä¸ªé˜¶æ®µï¼š</p>
<ul>
<li><strong>Try</strong>ï¼šå°è¯•æ‰§è¡Œé˜¶æ®µï¼Œå®Œæˆæ‰€æœ‰ä¸šåŠ¡å¯æ‰§è¡Œæ€§çš„æ£€æŸ¥<strong>ï¼ˆä¿éšœä¸€è‡´æ€§ï¼‰</strong>ï¼Œå¹¶ä¸”é¢„ç•™å¥½å…¨éƒ¨éœ€ç”¨åˆ°çš„ä¸šåŠ¡èµ„æº<strong>ï¼ˆä¿éšœéš”ç¦»æ€§ï¼‰</strong>ã€‚</li>
<li><strong>Confirm</strong>ï¼šç¡®è®¤æ‰§è¡Œé˜¶æ®µï¼Œä¸è¿›è¡Œä»»ä½•ä¸šåŠ¡æ£€æŸ¥ï¼Œç›´æ¥ä½¿ç”¨ Try é˜¶æ®µå‡†å¤‡çš„èµ„æºæ¥å®Œæˆä¸šåŠ¡å¤„ç†ã€‚Confirm é˜¶æ®µå¯èƒ½ä¼šé‡å¤æ‰§è¡Œï¼Œéœ€è¦å…·å¤‡<strong>å¹‚ç­‰æ€§</strong>ã€‚</li>
<li><strong>Cancel</strong>ï¼šå–æ¶ˆæ‰§è¡Œé˜¶æ®µï¼Œé‡Šæ”¾ Try é˜¶æ®µé¢„ç•™çš„ä¸šåŠ¡èµ„æºã€‚Cancel é˜¶æ®µä¹Ÿéœ€è¦æ»¡è¶³<strong>å¹‚ç­‰æ€§</strong></li>
</ul>
<p><img src="/../images/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/image_d3MwlmWL0j.png"></p>
<p>ä¼˜åŠ¿ï¼šTCC åœ¨ä¸šåŠ¡æ‰§è¡Œæ—¶åªæ“ä½œé¢„ç•™èµ„æºï¼Œå‡ ä¹ä¸ä¼šæ¶‰åŠé”å’Œèµ„æºçš„äº‰ç”¨ï¼Œå…·æœ‰å¾ˆé«˜çš„æ€§èƒ½æ½œåŠ›ã€‚</p>
<p>ç¼ºç‚¹ï¼šä¸ä¸šåŠ¡è€¦åˆè¾ƒé«˜</p>
<h2 id="SAGA-äº‹åŠ¡"><a href="#SAGA-äº‹åŠ¡" class="headerlink" title="SAGA äº‹åŠ¡"></a>SAGA äº‹åŠ¡</h2><p>è§£å†³TCCç¬¬ä¸€æ­¥æ— æ³•æ–½è¡Œçš„åœºæ™¯</p>
<blockquote>
<p> ç”±äºä¸­å›½ç½‘ç»œæ”¯ä»˜æ—¥ç›Šç››è¡Œï¼Œç°åœ¨ç”¨æˆ·å’Œå•†å®¶åœ¨ä¹¦åº—ç³»ç»Ÿä¸­å¯ä»¥é€‰æ‹©ä¸å†å¼€è®¾å……å€¼è´¦å·ï¼Œå¦‚æœç”¨æˆ·ã€å•†å®¶çš„è´¦å·ä½™é¢ç”±é“¶è¡Œç®¡ç†çš„è¯ï¼Œé€šå¸¸æ— æ³•å®Œæˆå†»ç»“æ¬¾é¡¹ã€è§£å†»ã€æ‰£å‡è¿™æ ·çš„æ“ä½œï¼Œå› ä¸ºé“¶è¡Œä¸€èˆ¬ä¸ä¼šé…åˆä½ çš„æ“ä½œã€‚æ‰€ä»¥ TCC ä¸­çš„ç¬¬ä¸€æ­¥ Try é˜¶æ®µå¾€å¾€æ— æ³•æ–½è¡Œã€‚</p>
</blockquote>
<p>SAGA ç”±ä¸¤éƒ¨åˆ†æ“ä½œç»„æˆï¼š</p>
<ul>
<li><p>å¤§äº‹åŠ¡æ‹†åˆ†è‹¥å¹²ä¸ªå°äº‹åŠ¡ï¼Œå°†æ•´ä¸ªåˆ†å¸ƒå¼äº‹åŠ¡ T åˆ†è§£ä¸º n ä¸ªå­äº‹åŠ¡ï¼Œå‘½åä¸º T1ï¼ŒT2ï¼Œâ€¦ï¼ŒTiï¼Œâ€¦ï¼ŒTnã€‚æ¯ä¸ªå­äº‹åŠ¡éƒ½åº”è¯¥æ˜¯æˆ–è€…èƒ½è¢«è§†ä¸ºæ˜¯åŸå­è¡Œä¸ºã€‚å¦‚æœåˆ†å¸ƒå¼äº‹åŠ¡èƒ½å¤Ÿæ­£å¸¸æäº¤ï¼Œå…¶å¯¹æ•°æ®çš„å½±å“ï¼ˆæœ€ç»ˆä¸€è‡´æ€§ï¼‰åº”ä¸è¿ç»­æŒ‰é¡ºåºæˆåŠŸæäº¤ Tiç­‰ä»·ã€‚</p>
</li>
<li><p>ä¸ºæ¯ä¸€ä¸ªå­äº‹åŠ¡è®¾è®¡å¯¹åº”çš„è¡¥å¿åŠ¨ä½œï¼Œå‘½åä¸º C1ï¼ŒC2ï¼Œâ€¦ï¼ŒCiï¼Œâ€¦ï¼ŒCnã€‚Tiä¸ Ciå¿…é¡»æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ï¼š</p>
<ul>
<li><p>Tiä¸ Ciéƒ½å…·å¤‡å¹‚ç­‰æ€§ã€‚</p>
</li>
<li><p>Tiä¸ Ciæ»¡è¶³äº¤æ¢å¾‹ï¼Œå³å…ˆæ‰§è¡Œ Tiè¿˜æ˜¯å…ˆæ‰§è¡Œ Ciï¼Œå…¶æ•ˆæœéƒ½æ˜¯ä¸€æ ·çš„ã€‚</p>
</li>
<li><p>Ciå¿…é¡»èƒ½æˆåŠŸæäº¤ï¼Œå³ä¸è€ƒè™‘ Ciæœ¬èº«æäº¤å¤±è´¥è¢«å›æ»šçš„æƒ…å½¢ï¼Œå¦‚å‡ºç°å°±å¿…é¡»æŒç»­é‡è¯•ç›´è‡³æˆåŠŸï¼Œæˆ–è€…è¦äººå·¥ä»‹å…¥ã€‚</p>
</li>
</ul>
</li>
</ul>
<p>å¦‚æœ T1åˆ° Tnå‡æˆåŠŸæäº¤ï¼Œé‚£äº‹åŠ¡é¡ºåˆ©å®Œæˆï¼Œå¦åˆ™ï¼Œè¦é‡‡å–ä»¥ä¸‹ä¸¤ç§æ¢å¤ç­–ç•¥ä¹‹ä¸€ï¼š</p>
<ul>
<li><strong>æ­£å‘æ¢å¤</strong>ï¼šå¦‚æœ Tiäº‹åŠ¡æäº¤å¤±è´¥ï¼Œåˆ™ä¸€ç›´å¯¹ Tiè¿›è¡Œé‡è¯•ï¼Œç›´è‡³æˆåŠŸä¸ºæ­¢ï¼ˆæœ€å¤§åŠªåŠ›äº¤ä»˜ï¼‰ã€‚è¿™ç§æ¢å¤æ–¹å¼ä¸éœ€è¦è¡¥å¿ï¼Œé€‚ç”¨äºäº‹åŠ¡æœ€ç»ˆéƒ½è¦æˆåŠŸçš„åœºæ™¯ï¼Œè­¬å¦‚åœ¨åˆ«äººçš„é“¶è¡Œè´¦å·ä¸­æ‰£äº†æ¬¾ï¼Œå°±ä¸€å®šè¦ç»™åˆ«äººå‘è´§ã€‚æ­£å‘æ¢å¤çš„æ‰§è¡Œæ¨¡å¼ä¸ºï¼šT1ï¼ŒT2ï¼Œâ€¦ï¼ŒTiï¼ˆå¤±è´¥ï¼‰ï¼ŒTiï¼ˆé‡è¯•ï¼‰â€¦ï¼ŒTi+1ï¼Œâ€¦ï¼ŒTnã€‚</li>
<li><strong>åå‘æ¢å¤</strong>ï¼šå¦‚æœ Tiäº‹åŠ¡æäº¤å¤±è´¥ï¼Œåˆ™ä¸€ç›´æ‰§è¡Œ Ciå¯¹ Tiè¿›è¡Œè¡¥å¿ï¼Œç›´è‡³æˆåŠŸä¸ºæ­¢ï¼ˆæœ€å¤§åŠªåŠ›äº¤ä»˜ï¼‰ã€‚è¿™é‡Œè¦æ±‚ Ciå¿…é¡»ï¼ˆåœ¨æŒç»­é‡è¯•åï¼‰æ‰§è¡ŒæˆåŠŸã€‚åå‘æ¢å¤çš„æ‰§è¡Œæ¨¡å¼ä¸ºï¼šT1ï¼ŒT2ï¼Œâ€¦ï¼ŒTiï¼ˆå¤±è´¥ï¼‰ï¼ŒCiï¼ˆè¡¥å¿ï¼‰ï¼Œâ€¦ï¼ŒC2ï¼ŒC1ã€‚</li>
</ul>
<p><em><strong>SAGA å¿…é¡»ä¿è¯æ‰€æœ‰å­äº‹åŠ¡éƒ½å¾—ä»¥æäº¤æˆ–è€…è¡¥å¿</strong></em></p>
<hr>
<p> GTSçš„ATäº‹åŠ¡æ¨¡å¼ï¼šåŸºäºæ•°æ®è¡¥å¿æ¥ä»£æ›¿å›æ»šçš„æ€è·¯</p>
<p>è§£å†³äº†XA 2PCå¸¦æ¥çš„æœ¨æ¡¶æ•ˆåº”</p>
<p>åŸºäºè¿™ç§è¡¥å¿æ–¹å¼ï¼Œåˆ†å¸ƒå¼äº‹åŠ¡ä¸­æ‰€æ¶‰åŠçš„æ¯ä¸€ä¸ªæ•°æ®æºéƒ½å¯ä»¥å•ç‹¬æäº¤ï¼Œç„¶åç«‹åˆ»é‡Šæ”¾é”å’Œèµ„æºã€‚è¿™ç§å¼‚æ­¥æäº¤çš„æ¨¡å¼ï¼Œç›¸æ¯”èµ· 2PC æå¤§åœ°æå‡äº†ç³»ç»Ÿçš„ååé‡æ°´å¹³ã€‚è€Œä»£ä»·å°±æ˜¯å¤§å¹…åº¦åœ°ç‰ºç‰²äº†éš”ç¦»æ€§ï¼Œç”šè‡³ç›´æ¥å½±å“åˆ°äº†åŸå­æ€§ã€‚å› ä¸ºåœ¨ç¼ºä¹éš”ç¦»æ€§çš„å‰æä¸‹ï¼Œä»¥è¡¥å¿ä»£æ›¿å›æ»šå¹¶ä¸ä¸€å®šæ˜¯æ€»èƒ½æˆåŠŸçš„ã€‚è­¬å¦‚ï¼Œå½“æœ¬åœ°äº‹åŠ¡æäº¤ä¹‹åã€åˆ†å¸ƒå¼äº‹åŠ¡å®Œæˆä¹‹å‰ï¼Œè¯¥æ•°æ®è¢«è¡¥å¿ä¹‹å‰åˆè¢«å…¶ä»–æ“ä½œä¿®æ”¹è¿‡ï¼Œå³å‡ºç°äº†è„å†™ï¼ˆDirty Writ eï¼‰ï¼Œè¿™æ—¶å€™ä¸€æ—¦å‡ºç°åˆ†å¸ƒå¼äº‹åŠ¡éœ€è¦å›æ»šï¼Œå°±ä¸å¯èƒ½å†é€šè¿‡è‡ªåŠ¨çš„é€†å‘ SQL æ¥å®ç°è¡¥å¿ï¼Œåªèƒ½ç”±äººå·¥ä»‹å…¥å¤„ç†äº†ã€‚ğŸ¤¨</p>
]]></content>
      <categories>
        <category>åˆ†å¸ƒå¼ç†è®ºä½“ç³»</category>
      </categories>
  </entry>
</search>
